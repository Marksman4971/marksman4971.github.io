<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2); }
            to { text-shadow: 2px 2px 4px rgba(255,255,255,0.4), 0 0 20px rgba(0,0,0,0.3); }
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: white;
            padding: 15px 25px;
            margin: 5px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: 600px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page h2 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        /* Login/Edit Password Modal Styles */
        .login-overlay { /* Used for original login (now hidden by default) and edit password */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .login-box { /* Shared style for login/edit password containers */
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-box h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-input { /* Shared style for password inputs */
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        #permanent-card-desc {
            resize: vertical;
        }

        .login-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn { /* Shared style for login/edit password confirm buttons */
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .login-error { /* Shared style for password error messages */
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #ffebee;
            border-radius: 8px;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected { background: #27ae60; }
        .connection-status.disconnected { background: #e74c3c; }
        .connection-status.connecting { background: #f39c12; }

        .daily-schedule { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .daily-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .daily-table th, .daily-table td { padding: 12px; text-align: center; border: 2px solid #e9ecef; }
        .daily-table th { background: linear-gradient(45deg, #3498db, #2980b9); color: white; font-weight: bold; }
        .daily-table tr:nth-child(even) { background-color: #f8f9fa; }
        .daily-table tr:hover { background-color: #e3f2fd; transform: scale(1.01); transition: all 0.3s ease; }

        .points-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin: 30px 0; }
        .points-section, .weekly-rewards-section, .warehouse-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-top: 5px solid; margin-bottom: 30px; }
        .points-1 { border-top-color: #2ecc71; } .points-2 { border-top-color: #f39c12; } .points-3 { border-top-color: #e74c3c; } .points-5 { border-top-color: #9b59b6; } .points-10 { border-top-color: #34495e; } .points-20 { border-top-color: #e67e22; }
        .points-iou { border-top-color: #f39c12; } /* Added for IOU cards */
        .weekly-rewards-section { border-top-color: #1abc9c; }
        .warehouse-section { border-top-color: #3498db; }
        /* Custom Card section style */
        .custom-cards-section {
            background: white; /* Match other sections */
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #9b59b6; /* Purple border for custom cards */
            margin-bottom: 30px;
        }
        .points-section h3, .weekly-rewards-section h3, .warehouse-section h3 { /* Removed custom-cards-section h3 from here */
            text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #2c3e50;
        }

        /* NEW: Styles for centering and bolding the custom cards section heading */
        .custom-cards-section h3 {
            text-align: center; /* ç¡®ä¿æ–‡å­—å†…å®¹å±…ä¸­ */
            font-weight: bold; /* åŠ ç²—æ–‡å­— */
            /* è¦†ç›– flex å¸ƒå±€ï¼Œè®©å†…å®¹å—çº§å±…ä¸­ */
            display: block; 
            width: 100%; /* ç¡®ä¿å æ®çˆ¶å…ƒç´ å…¨éƒ¨å®½åº¦ä»¥ä¾¿text-alignç”Ÿæ•ˆ */
            position: relative; /* ä¸ºå†…éƒ¨çš„ç»å¯¹å®šä½æŒ‰é’®æä¾›å‚è€ƒ */
            margin-top: 0px; /* ç¡®ä¿ä¸è¢«ä¹‹å‰çš„æ ·å¼å½±å“åˆ° */
            margin-bottom: 20px; /* ä¿æŒä¸å…¶ä»–H3çš„é—´è· */
            font-size: 1.8em; /* ä¿æŒä¸å…¶ä»–H3çš„å­—ä½“å¤§å°ä¸€è‡´ */
            color: #2c3e50; /* ä¿æŒä¸å…¶ä»–H3çš„é¢œè‰²ä¸€è‡´ */
        }

        /* ä¸ºäº†ä¸å½±å“æ—è¾¹çš„â€œâŠ• æ·»åŠ â€æŒ‰é’®ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæŒ‰é’®å•ç‹¬è®¾ç½®å®šä½ */
        .custom-cards-section h3 .add-card-to-section-btn {
            position: absolute; /* ç»å¯¹å®šä½ */
            right: 0px; /* æ ¹æ®éœ€è¦è°ƒæ•´è·ç¦»å³ä¾§çš„è·ç¦»ï¼Œè¿™é‡Œè®¾ç½®ä¸º0ï¼Œè®©æŒ‰é’®è´´ç€å³ä¾§ */
            top: 50%; /* å‚ç›´å±…ä¸­ */
            transform: translateY(-50%); /* ç²¾ç¡®å‚ç›´å±…ä¸­ */
        }
        /* End NEW styles */
        
        .card-item { background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 10px; border-left: 4px solid #3498db; transition: all 0.3s ease; cursor: pointer; position: relative; /* For delete button */ }
        .card-item.info-card { border-left-color: #1abc9c; }
        .card-item:hover:not(.info-card) { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-item.info-card[data-type="special-reward"]:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 1.1em; }
        .card-desc { color: #7f8c8d; font-size: 0.95em; line-height: 1.5; }

        /* Delete Button on Cards */
        .card-item .delete-card-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 13px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 1; /* Ensure it's above card content */
        }
        .card-item .delete-card-btn:hover { opacity: 1; background: #c0392b; transform: scale(1.1); }

        /* Style for the "Add Card to Section" button */
        /* Removed flex properties from here as they are now handled by .custom-cards-section h3 */
        .add-card-to-section-btn {
            background-color: #5dade2; /* Light blue */
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 0.8em;
            /* margin-left: 10px; */ /* Let flexbox handle spacing */
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .add-card-to-section-btn:hover {
            background-color: #2e86c1; /* Darker blue */
        }


        .warehouse-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .warehouse-owner-column h4 { text-align: center; font-size: 1.3em; color: #34495e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #bdc3c7; }
        .warehouse-card-item { background: #ecf0f1; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #2980b9; }
        .warehouse-card-info .name { font-weight: bold; font-size: 1em; }
        .warehouse-card-info .qty { font-size: 0.9em; color: #7f8c8d; }
        .warehouse-card-item .use-card-btn { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .warehouse-card-item .use-card-btn:hover { background: #229954; }
        .no-cards-text { text-align: center; color: #95a5a6; padding: 20px; }

        .penalty-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0; }
        .penalty-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .penalty-left { border-top: 5px solid #e74c3c; } .penalty-right { border-top: 5px solid #27ae60; }
        .penalty-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .penalty-table th, .penalty-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .penalty-table th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        .penalty-score { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; text-align: center; min-width: 40px; display: inline-block; }
        .penalty-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .penalty-item:last-child { border-bottom: none; }
        .penalty-item-info { display: flex; align-items: center; gap: 10px; }
        .penalty-action-buttons button { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 5px; transition: background-color 0.3s; }
        .penalty-action-buttons button:hover { background: #c0392b; }
        .penalty-action-buttons button.custom-penalty-btn { background: #f39c12; }
        .penalty-action-buttons button.custom-penalty-btn:hover { background: #e67e22; }

        .bank-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin: 30px 0; }
        .week-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-top: 5px solid #3498db; }
        .week-title { text-align: center; font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 10px; }
        .week-table { width: 100%; border-collapse: collapse; }
        .week-table th, .week-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        .week-table th { background: #f8f9fa; font-weight: bold; font-size: 0.9em; }
        .stats-overview { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-item { background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 20px; border-radius: 10px; transition: transform 0.3s ease; }
        .stat-item:hover { transform: scale(1.05); }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .clickable-cell { cursor: pointer; transition: all 0.3s ease; user-select: none; }
        .clickable-cell:hover { background-color: #e3f2fd !important; transform: scale(1.05); }
        .cell-negative { background-color: #ffebee !important; color: #c62828; }
        .cell-zero { background-color: #ffffff !important; color: #333; }
        .cell-positive { background-color: #e8f5e8 !important; color: #2e7d32; }
        .reward-0 { background-color: #f0f0f0 !important; } .reward-1 { background-color: #e3f2fd !important; } .reward-2 { background-color: #ede7f6 !important; } .reward-3 { background-color: #fff3e0 !important; }
        .reward-cell {}
        .small-input { width: 50px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center; background: #fff; font-size: 0.85em; }
        .small-input[readonly] { background-color: #f8f9fa; color: #555; border: 1px solid #eee; }
        .week-summary { text-align: center; margin-top: 15px; padding: 15px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border-radius: 10px; font-size: 1.1em; font-weight: bold; line-height: 1.8; }
        .total-scores { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .score-boards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .score-board { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .player-name { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
        .total-score-input { font-size: 2.5em; font-weight: bold; margin: 10px 0; background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; text-align: center; border-radius: 8px; padding: 10px; width: 100%; }
        .total-score-input::placeholder { color: rgba(255,255,255,0.7); }
        .control-buttons { text-align: center; margin-top: 20px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 5px; font-size: 1em; transition: all 0.3s ease; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; } .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #7f8c8d; } .btn-secondary:hover { background: #6c7a7d; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 450px; width: 90%; animation: slideIn 0.3s ease-out; }
        .modal-content h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8em; }
        .modal-buttons button { color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 8px 5px; transition: all 0.3s ease; min-width: 100px; }
        .modal-buttons button:hover { transform: translateY(-2px); }
        .modal-buttons button.confirm-btn { background: linear-gradient(45deg, #3498db, #2980b9); }
        .modal-buttons button.confirm-btn:hover { box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
        .modal-buttons button.cancel-btn { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .modal-buttons button.cancel-btn:hover { box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3); }
        .penalty-modal-buttons button.confirm-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .penalty-modal-buttons button.confirm-btn:hover { box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); }
        .week-card .btn-secondary { display: block; margin: 15px auto 0; }
        
        #history .table-container { max-height: 600px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; }
        #score-history-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9em; }
        #score-history-table th, #score-history-table td { padding: 10px 12px; text-align: left; border: 1px solid #e0e0e0; vertical-align: top; }
        #score-history-table th { background: linear-gradient(45deg, #3498db, #2980b9); color: white; font-weight: bold; text-align: center; }
        #score-history-table tr:nth-child(even) { background-color: #f8f9fa; }
        #score-history-table tr:hover { background-color: #e9f5ff; }
        #score-history-table td.player-qiqi { color: #9b59b6; font-weight: bold; }
        #score-history-table td.player-yiyi { color: #3498db; font-weight: bold; }
        #score-history-table td.total-highlight { font-weight: bold; color: #27ae60; text-align: center; }
        #score-history-table td.num-center { text-align: center; }
        #score-history-table ul { margin: 0; padding-left: 15px; font-size: 0.9em; }
        #score-history-table ul li { margin-bottom: 3px; }
        #score-history-table .no-details { color: #999; font-style: italic; text-align: center; }
        #score-history-table .basic-score-details ul { padding-left: 10px; font-size: 0.85em; list-style-type: disc; }
        #score-history-table .basic-score-details li { margin-bottom: 2px; }

        /* ç§¯åˆ†äº¤æ˜“ç³»ç»Ÿæ ·å¼ */
        .trade-system {
            background: linear-gradient(45deg, #a8e6cf 0%, #88d8a3 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .trade-system h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .trade-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .trade-input-group {
            display: flex;
            flex-direction: column;
        }

        .trade-input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .trade-input, .trade-select, .trade-textarea {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.95);
            color: #333;
            transition: all 0.3s ease;
        }

        .trade-input:focus, .trade-select:focus, .trade-textarea:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }

        .trade-textarea {
            resize: vertical;
            min-height: 40px;
        }

        .trade-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-height: 46px;
        }

        .trade-btn:hover {
            background: white;
            color: #88d8a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }


        @media (max-width: 768px) {
            .container { padding: 5px; } .header h1 { font-size: 1.8em; } .header p { font-size: 1em; }
            .content { padding: 15px; margin: 10px 5px; } .penalty-section { grid-template-columns: 1fr; gap: 20px; }
            .nav-tabs { flex-direction: row; flex-wrap: wrap; padding: 5px;} .nav-tab { padding: 10px 15px; font-size: 0.9em; margin: 2px;}
            .score-boards { grid-template-columns: 1fr; gap: 15px;} .week-table { font-size: 0.75em;}
            .week-table th, .week-table td { padding: 3px 2px; font-size: 0.75em;}
            .small-input {width: 30px; font-size: 0.7em; padding: 1px;}
            .week-table-container, #history .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch;}
            .clickable-cell { min-width: 30px;} .connection-status { top: 10px; right: 10px; padding: 8px 12px; font-size: 0.8em;}
            #score-history-table { font-size: 0.8em;} #score-history-table th, #score-history-table td { padding: 6px 4px;}
            .warehouse-grid { grid-template-columns: 1fr; }
            .trade-form { grid-template-columns: 1fr; gap: 10px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5em;} .nav-tab { padding: 8px 10px; font-size: 0.75em;}
            .content { padding: 10px;} .week-table th, .week-table td { padding: 2px 1px; font-size: 0.65em;}
            .small-input { width: 25px; font-size: 0.6em; padding: 1px;}
            .total-score-input { font-size: 1.8em;} .stat-number { font-size: 1.3em;} .stat-label { font-size: 0.8em;}
            #score-history-table { font-size: 0.7em;} #score-history-table th, #score-history-table td { padding: 4px 2px;}
            #score-history-table ul { padding-left: 10px; font-size: 0.85em; }
            #score-history-table .basic-score-details ul { font-size: 0.8em; }
            .clickable-cell { min-width: 25px;}
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="login-overlay" style="display: none;">
        <div class="login-box">
            <h2>ğŸ” ç§¯åˆ†ç³»ç»Ÿç™»å½•</h2>
            <p style="margin-bottom: 20px; color: #666;">è¯·è¾“å…¥å¯†ç è®¿é—®ç³»ç»Ÿ</p>
            <input type="password" id="password-input" placeholder="è¾“å…¥è®¿é—®å¯†ç " class="login-input">
            <button onclick="checkPassword()" class="login-btn">ç™»å½•</button>
            <div id="login-error" class="login-error" style="display: none;">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</div>
        </div>
    </div>

    <div id="edit-password-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="login-box">
            <h2>ğŸ”’ ç¼–è¾‘æƒé™éªŒè¯</h2>
            <p style="margin-bottom: 20px; color: #666;">è¯·è¾“å…¥ç¼–è¾‘å¯†ç ä»¥ä¿®æ”¹æ•°æ®</p>
            <input type="password" id="edit-password-input" placeholder="è¾“å…¥ç¼–è¾‘å¯†ç " class="login-input">
            <div id="edit-login-error" class="login-error" style="display: none;">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button onclick="handleEditPasswordSubmit()" class="login-btn" style="width:auto; padding: 12px 25px; margin: 5px;">ç¡®è®¤</button>
                <button onclick="cancelEditPassword()" class="cancel-btn" style="width:auto; padding: 12px 25px; margin: 5px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="buyer-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>é€‰æ‹©è´­ä¹°è€… <span id="buyer-modal-card-name" style="color: #3498db; font-weight:bold;"></span></h3>
            <div style="margin: 15px 0;">
                <label for="buy-card-quantity" style="display: block; margin-bottom: 8px; color: #555;">è´­ä¹°æ•°é‡:</label>
                <input type="number" id="buy-card-quantity" value="1" min="1" max="10" class="modal-input">
            </div>
            <div class="modal-buttons">
                <button onclick="selectBuyer('qiqi')" class="confirm-btn">ä¸ƒä¸ƒ</button>
                <button onclick="selectBuyer('yiyi')" class="confirm-btn">ä¸€ä¸€</button>
                <button onclick="closeBuyerModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="penalty-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="penalty-modal-title">é€‰æ‹©æ‰£åˆ†å¯¹è±¡</h3>
            <div class="modal-buttons penalty-modal-buttons">
                <button onclick="applyPenaltyToPlayer('qiqi')" class="confirm-btn">ä¸ƒä¸ƒ</button>
                <button onclick="applyPenaltyToPlayer('yiyi')" class="confirm-btn">ä¸€ä¸€</button>
                <button onclick="closePenaltyModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div id="custom-penalty-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>è‡ªå®šä¹‰æ‰£åˆ†</h3>
            <input type="number" id="custom-penalty-points" placeholder="æ‰£åˆ†æ•°å€¼ (å¦‚: 2 è¡¨ç¤ºæ‰£2åˆ†)" class="modal-input">
            <input type="text" id="custom-penalty-desc" placeholder="æ‰£åˆ†åŸå› /å¤‡æ³¨" class="modal-input" maxlength="100">
            <p style="font-size:0.9em; color:#666; margin-bottom:15px;">ä¸ºå“ªä½ç©å®¶åº”ç”¨æ­¤æ‰£åˆ†?</p>
            <div class="modal-buttons penalty-modal-buttons">
                <button onclick="applyCustomPenaltyToPlayer('qiqi')" class="confirm-btn">ä¸ƒä¸ƒ</button>
                <button onclick="applyCustomPenaltyToPlayer('yiyi')" class="confirm-btn">ä¸€ä¸€</button>
                <button onclick="closeCustomPenaltyModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="custom-reward-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>è‡ªå®šä¹‰å¥–åŠ±åˆ†</h3>
            <input type="number" id="custom-reward-points" placeholder="å¥–åŠ±æ•°å€¼ (å¦‚: 2 è¡¨ç¤ºå¥–åŠ±2åˆ†)" class="modal-input">
            <input type="text" id="custom-reward-desc" placeholder="å¥–åŠ±åŸå› /å¤‡æ³¨" class="modal-input" maxlength="100">
            <p style="font-size:0.9em; color:#666; margin-bottom:15px;">ä¸ºå“ªä½ç©å®¶åº”ç”¨æ­¤å¥–åŠ±?</p>
            <div class="modal-buttons">
                <button onclick="applyCustomRewardToPlayer('qiqi')" class="confirm-btn" style="background: linear-gradient(45deg, #27ae60, #229954);">æˆäºˆä¸ƒä¸ƒ</button>
                <button onclick="applyCustomRewardToPlayer('yiyi')" class="confirm-btn" style="background: linear-gradient(45deg, #27ae60, #229954);">æˆäºˆä¸€ä¸€</button>
                <button onclick="closeCustomRewardModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="define-custom-card-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>å®šä¹‰è‡ªå®šä¹‰å¡ç‰‡</h3>
            <input type="text" id="custom-card-name" placeholder="å¡ç‰‡åç§° (å¦‚: ç‰¹æ®Šå¤–å–å¡)" class="modal-input" maxlength="50">
            <input type="number" id="custom-card-points" placeholder="æ¶ˆè€—ç§¯åˆ† (å¦‚: 4)" class="modal-input">
            <select id="custom-card-type" class="modal-input">
                <option value="E">E - æ¶ˆè´¹ç±»</option>
                <option value="T">T - äº¤æ˜“ç±»</option>
                <option value="H">H - å¼€å¿ƒç±»</option>
            </select>
            <textarea id="custom-card-desc" placeholder="å¡ç‰‡æè¿° (e.g., å…·ä½“æ•ˆæœå’Œä½¿ç”¨æ¡ä»¶)" class="modal-input" rows="3" maxlength="150"></textarea>
            <div class="modal-buttons">
                <button onclick="defineAndListCustomCard()" class="confirm-btn">åˆ›å»ºå¹¶ä¸Šæ¶</button>
                <button onclick="closeDefineCustomCardModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="define-IOU-card-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>å®šä¹‰æ¬ æ¡å¡ç‰‡</h3>
            <input type="number" id="iou-card-points" placeholder="æ¬ æ¡é¢å€¼ (å³è´­ä¹°ç§¯åˆ†ï¼Œå¦‚: 10)" class="modal-input" min="1">
            <input type="number" id="iou-card-interest" placeholder="åˆ©æ¯ç™¾åˆ†æ¯” (å¦‚: 10 è¡¨ç¤º10%)" class="modal-input" min="0" max="100" value="10">
            <div class="modal-buttons">
                <button onclick="defineAndListIOUCard()" class="confirm-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">åˆ›å»ºæ¬ æ¡</button>
                <button onclick="closeDefineIOUCardModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="special-reward-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="special-reward-modal-title">æˆäºˆç‰¹æ®Šå¥–åŠ±</h3>
            <p id="special-reward-modal-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button onclick="applySpecialReward('qiqi')" class="confirm-btn">æˆäºˆä¸ƒä¸ƒ</button>
                <button onclick="applySpecialReward('yiyi')" class="confirm-btn">æˆäºˆä¸€ä¸€</button>
                <button onclick="closeSpecialRewardModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="consume-card-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="consume-card-confirm-title">ç¡®è®¤ä½¿ç”¨å¡ç‰‡</h3>
            <p id="consume-card-confirm-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-consume-btn" class="confirm-btn">ç¡®è®¤</button>
                <button onclick="closeConsumeCardConfirmModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="iou-return-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="iou-return-modal-title">å½’è¿˜æ¬ æ¡</h3>
            <p id="iou-return-modal-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-iou-return-btn" class="confirm-btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">ç¡®è®¤å½’è¿˜å¹¶æ‰£é™¤å¯¹æ–¹</button>
                <button onclick="closeIOUReturnModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="confirm-add-total-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="confirm-add-total-title">ç¡®è®¤æ“ä½œ</h3>
            <p id="confirm-add-total-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-add-total-btn" class="confirm-btn">ç¡®å®š</button>
                <button onclick="closeConfirmAddTotalModal()" class="cancel-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <div id="connection-status" class="connection-status connecting">ğŸ”„ è¿æ¥ä¸­...</div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è®©ç”Ÿæ´»æ›´æœ‰è¶£ï¼Œè®©ä¹ æƒ¯æ›´æŒä¹…</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('daily')">ğŸ“… å°æ—¥å¸¸</button>
            <button class="nav-tab" onclick="showPage('cards')">ğŸ« å°å¡ç‰‡</button>
            <button class="nav-tab" onclick="showPage('penalty')">âš–ï¸ å°å¥–æƒ©</button>
            <button class="nav-tab" onclick="showPage('bank')">ğŸ¦ å°é“¶è¡Œ</button>
            <button class="nav-tab" onclick="showPage('history')">ğŸ“œ ç§¯åˆ†å†å²</button>
        </div>

        <div class="content">
            <div id="daily" class="page active">
                <h2>ğŸ”† æ¯æ—¥åŸºæœ¬ä»»åŠ¡</h2>
                <div class="stats-overview">
                    <h3>ğŸŒŸ åŸºæœ¬ä»»åŠ¡</h3>
                    <div class="stats-grid">
                        <div class="stat-item"> <div class="stat-number">30-60min</div> <div class="stat-label">æ—¥å¸¸é”»ç‚¼</div> </div>
                        <div class="stat-item"> <div class="stat-number">30-60min</div> <div class="stat-label">æ—¥å¸¸å­¦ä¹ </div> </div>
                        <div class="stat-item"> <div class="stat-number">23:00</div> <div class="stat-label">å°±å¯æ—¶é—´</div> </div>
                    </div>
                </div>
                <div class="daily-schedule">
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 10px;">
                        <h4>ğŸ’« æ¯æ—¥ä»»åŠ¡ï¼š</h4>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li><strong>å·¥ä½œæ—¥è®¡åˆ’è¯•è¡Œç‰ˆ</strong><br>
                                1. é¥­åæ•£æ­¥20åˆ†é’Ÿï¼ˆ1ç§¯åˆ†ï¼Œç¿»å€+0ï¼Œä¸Šé™1ï¼‰<br>
                                2. å­¦ä¹ æå‡30åˆ†é’Ÿï¼ˆ1ç§¯åˆ†ï¼Œç¿»å€+1ï¼Œä¸Šé™2ï¼‰<br>
                                3. æ­£å¼é”»ç‚¼30åˆ†é’Ÿï¼ˆ1ç§¯åˆ†ï¼Œç¿»å€+2ï¼Œä¸Šé™3ï¼‰<br>
                                4. ç¦æ­¢æ¸¸æˆ</li>
                                <br>
                            <li><strong>ä¼‘æ¯æ—¥è®¡åˆ’è¯•è¡Œç‰ˆ</strong><br>
                                1. é”»ç‚¼1å°æ—¶<br>
                                2. å­¦ä¹ 3å°æ—¶<br>
                                3. åˆä¼‘1å°æ—¶<br>
                                4. å¨±ä¹ç¦æ­¢ï¼š12:30å‰å’Œ22:00å<br>
                                5. å­¦ä¹ ç¦æ­¢ï¼š06:00å‰ç¦æ­¢å­¦ä¹ <br>
                                6. å®Œæˆä»»åŠ¡åæ‰å¯éšæ„å®‰æ’æ—¶é—´</li><br>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="cards" class="page">
                <h2>ğŸ« ç§¯åˆ†å…‘æ¢ä¸ä»“åº“</h2>
                
                <div class="trade-system">
                    <h3>ğŸ’° ç§¯åˆ†äº¤æ˜“ç³»ç»Ÿ</h3>
                    <div class="trade-form">
                        <div class="trade-input-group">
                            <label for="trade-from">è½¬è´¦æ–¹</label>
                            <select id="trade-from" class="trade-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="qiqi">ä¸ƒä¸ƒ</option>
                                <option value="yiyi">ä¸€ä¸€</option>
                            </select>
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-to">æ¥æ”¶æ–¹</label>
                            <select id="trade-to" class="trade-select">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="qiqi">ä¸ƒä¸ƒ</option>
                                <option value="yiyi">ä¸€ä¸€</option>
                            </select>
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-amount">äº¤æ˜“ç§¯åˆ†</label>
                            <input type="number" id="trade-amount" class="trade-input" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" min="1" max="999">
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-memo">å¤‡æ³¨è¯´æ˜</label>
                            <textarea id="trade-memo" class="trade-textarea" placeholder="äº¤æ˜“åŸå› æˆ–å¤‡æ³¨"></textarea>
                        </div>
                        <div class="trade-input-group">
                            <button onclick="executePointsTrade()" class="trade-btn">ğŸ’¸ æ‰§è¡Œäº¤æ˜“</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="openDefineCustomCardModal()" style="background: linear-gradient(45deg, #27ae60, #229954); font-size: 1.1em; padding: 12px 25px;">â­ è‡ªå®šä¹‰å¡ç‰‡</button>
                    <button class="btn" onclick="openDefineIOUCardModal()" style="background: linear-gradient(45deg, #f39c12, #e67e22); font-size: 1.1em; padding: 12px 25px;">ğŸ“ å®šä¹‰æ¬ æ¡å¡ç‰‡</button>
                </div>

                <div class="weekly-rewards-section">
                    <h3>ğŸŒŸ æ¯å‘¨ç‰¹æ®Šå¥–åŠ±å¡</h3>
                    <div class="card-item info-card" data-points="3" data-type="special-reward" data-name="å®Œç¾å‘¨å¥–åŠ±å¡" id="predef_card_perfectweek" onclick="openSpecialRewardModal('å®Œç¾å‘¨å¥–åŠ±å¡', 3)"><div class="card-title">ğŸ† å®Œç¾å‘¨å¥–åŠ±å¡</div><div class="card-desc">å½“å‘¨è¡¨ç°ä¼˜å¼‚ï¼Œå¯è·å¾—3ç‚¹é¢å¤–å¥–åŠ±ç§¯åˆ†ã€‚</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_perfectweek', 'predefined')">âŒ</button></div>
                    <div class="card-item info-card" data-points="3" data-type="special-reward" data-name="å’Œå¹³å‘¨å¥–åŠ±å¡" id="predef_card_peaceweek" onclick="openSpecialRewardModal('å’Œå¹³å‘¨å¥–åŠ±å¡', 3)"><div class="card-title">ğŸ¤ å’Œå¹³å‘¨å¥–åŠ±å¡</div><div class="card-desc">å½“å‘¨ç›¸å¤„å’Œè°ï¼Œå¯è·å¾—3ç‚¹é¢å¤–å¥–åŠ±ç§¯åˆ†ã€‚</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_peaceweek', 'predefined')">âŒ</button></div>
                    <p style="text-align: center; font-size: 0.9em; color: #7f8c8d; margin-top: 15px;">(ç‚¹å‡»å¡ç‰‡é€‰æ‹©æˆäºˆå¯¹è±¡)</p>
                </div>

                <div class="warehouse-section">
                    <h3>ğŸ“¦ å¡ç‰‡ä»“åº“</h3>
                    <div class="warehouse-grid">
                        <div class="warehouse-owner-column"> <h4>ä¸ƒä¸ƒçš„ä»“åº“</h4> <div id="qiqi-warehouse-cards"> <p class="no-cards-text">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ~</p> </div> </div>
                        <div class="warehouse-owner-column"> <h4>ä¸€ä¸€çš„ä»“åº“</h4> <div id="yiyi-warehouse-cards"> <p class="no-cards-text">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ~</p> </div> </div>
                    </div>
                </div>

<div id="temporary-cards-section" class="points-section custom-cards-section" style="display: block;"> 
                    <h3 style="text-align:center; margin-top:0px; margin-bottom:20px; color: #2c3e50;">â­ è‡ªå®šä¹‰å¡ç‰‡</h3>
                    <div id="temp-cards-grid" class="points-grid">
                        <p id="no-temp-cards-text" class="no-cards-text" style="grid-column: 1 / -1;">å°šæœªå®šä¹‰è‡ªå®šä¹‰å¡ç‰‡ã€‚</p>
                    </div>
                </div>
                
                <h3 style="text-align:center; margin-top:40px; margin-bottom:20px; color: #2c3e50;">ğŸ›’ å¯è´­ä¹°å¡ç‰‡</h3>
                <div id="main-cards-grid" class="points-grid">
                    <div class="points-section points-1">
                        <h3>ğŸ’š 1ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(1)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/å¿«é€’å¤–å–å¡" id="predef_card_kuaidi" onclick="openBuyerModal(1, 'E', 'E/å¿«é€’å¤–å–å¡')"><div class="card-title">E/å¿«é€’å¤–å–å¡</div><div class="card-desc">è´Ÿè´£å…¨å¤©çš„å¿«é€’å’Œå¤–å–å–è´§</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_kuaidi', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/é›¶é£ŸæŠ•å–‚å¡" id="predef_card_lingshi" onclick="openBuyerModal(1, 'E', 'E/é›¶é£ŸæŠ•å–‚å¡')"><div class="card-title">E/é›¶é£ŸæŠ•å–‚å¡</div><div class="card-desc">å…‘æ¢æŒ‡å®šé›¶é£Ÿ/å¥¶èŒ¶ä¸€ä»½ï¼Œäº²æ‰‹å–‚é£Ÿ</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_lingshi', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/ç®€å•è´­ç‰©å¡" id="predef_card_gouwu" onclick="openBuyerModal(1, 'E', 'E/ç®€å•è´­ç‰©å¡')"><div class="card-title">E/ç®€å•è´­ç‰©å¡</div><div class="card-desc">ä¸€å¤©çš„ç®€å•ä»£ä¹°</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_gouwu', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="1" data-type="T" data-name="T/å®¶åŠ¡æ‰§è¡Œå¡" id="predef_card_jiawu" onclick="openBuyerModal(1, 'T', 'T/å®¶åŠ¡æ‰§è¡Œå¡')"><div class="card-title">T/å®¶åŠ¡æ‰§è¡Œå¡</div><div class="card-desc">æŒ‡å®šä»»æ„å®¶åŠ¡ï¼ˆæ•´ç†è¡£æŸœ/æ‰“æ‰«æˆ¿é—´/æ´—æ™’è¡£æœ/æ”¶æ‹¾æ¡Œå­/æ´—ç¢—ï¼‰</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_jiawu', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="1" data-type="T" data-name="T/ç®€å•æŒ‰æ‘©å¡" id="predef_card_anmo" onclick="openBuyerModal(1, 'T', 'T/ç®€å•æŒ‰æ‘©å¡')"><div class="card-title">T/ç®€å•æŒ‰æ‘©å¡</div><div class="card-desc">äº«å—3åˆ†é’Ÿè‚©é¢ˆæŒ‰æ‘©</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_anmo', 'predefined')">âŒ</button></div>
                    </div>
                    <div class="points-section points-2">
                        <h3>ğŸ§¡ 2ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(2)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/é£Ÿç‰©é€‰æ‹©å¡" id="predef_card_shiwu" onclick="openBuyerModal(2, 'E', 'E/é£Ÿç‰©é€‰æ‹©å¡')"><div class="card-title">E/é£Ÿç‰©é€‰æ‹©å¡</div><div class="card-desc">ç»™å¯¹æ–¹æä¾›ä¸‰ç§ä»¥ä¸Šçš„å¤–å–æˆ–è€…èœå“çš„é€‰æ‹©</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shiwu', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/å½±è§†é€‰æ‹©å¡" id="predef_card_yingshi" onclick="openBuyerModal(2, 'E', 'E/å½±è§†é€‰æ‹©å¡')"><div class="card-title">E/å½±è§†é€‰æ‹©å¡</div><div class="card-desc">æœ¬å¤©çœ‹å‰§æ—¶é—´å®Œå…¨ç”±ä½ å†³å®š</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_yingshi', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/é€ å‹é€‰æ‹©å¡" id="predef_card_zaoxing" onclick="openBuyerModal(2, 'E', 'E/é€ å‹é€‰æ‹©å¡')"><div class="card-title">E/é€ å‹é€‰æ‹©å¡</div><div class="card-desc">å¯¹æ–¹å¸®ä½ æŒ‘é€‰ä»Šå¤©çš„ç©¿æ­</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_zaoxing', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="2" data-type="T" data-name="T/ä¸“å±è¡¨æ¼”å¡" id="predef_card_biaoyan" onclick="openBuyerModal(2, 'T', 'T/ä¸“å±è¡¨æ¼”å¡')"><div class="card-title">T/ä¸“å±è¡¨æ¼”å¡</div><div class="card-desc">å¯¹æ–¹ä¸ºä½ è¡¨æ¼”æŒ‡å®šçš„æ­Œæ›²/è®²æ•…äº‹</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_biaoyan', 'predefined')">âŒ</button></div>
                    </div>
                    <div class="points-section points-3">
                        <h3>â¤ï¸ 3ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(3)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="3" data-type="E" data-name="E/ç¡è§‰å»¶è¿Ÿå¡" id="predef_card_shuijiao" onclick="openBuyerModal(3, 'E', 'E/ç¡è§‰å»¶è¿Ÿå¡')"><div class="card-title">E/ç¡è§‰å»¶è¿Ÿå¡</div><div class="card-desc">å¯ä»¥å»¶é•¿ç¡çœ æ—¶é—´10åˆ†é’Ÿï¼ˆå¯å åŠ ä½¿ç”¨ï¼Œä½†ä¸èƒ½è¶…è¿‡åŠå°æ—¶ï¼‰</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shuijiao', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="3" data-type="E" data-name="E/æ‹¥æŠ±å……ç”µå¡" id="predef_card_yongbao" onclick="openBuyerModal(3, 'E', 'E/æ‹¥æŠ±å……ç”µå¡')"><div class="card-title">E/æ‹¥æŠ±å……ç”µå¡</div><div class="card-desc">å…‘æ¢3åˆ†é’Ÿè¶…çº§å¤§æ‹¥æŠ±</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_yongbao', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/è§†é¢‘å½•åˆ¶å¡" id="predef_card_shipin" onclick="openBuyerModal(3, 'T', 'T/è§†é¢‘å½•åˆ¶å¡')"><div class="card-title">T/è§†é¢‘å½•åˆ¶å¡</div><div class="card-desc">ç»è¿‡å¯¹æ–¹å…è®¸å¯å½•åˆ¶7-10åˆ†é’Ÿçš„è§†é¢‘</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shipin', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/è·‘è…¿ä»£è´­å¡" id="predef_card_paotui" onclick="openBuyerModal(3, 'T', 'T/è·‘è…¿ä»£è´­å¡')"><div class="card-title">T/è·‘è…¿ä»£è´­å¡</div><div class="card-desc">å…‘æ¢ä¸€æ¬¡ä»£ä¹°æ—©é¤/æ—¥ç”¨å“æœåŠ¡ï¼ˆåŠå¾„3å…¬é‡Œå†…ï¼‰</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_paotui', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/æ‹ç…§é€‰æ‹©å¡" id="predef_card_paizhao" onclick="openBuyerModal(3, 'T', 'T/æ‹ç…§é€‰æ‹©å¡')"><div class="card-title">T/æ‹ç…§é€‰æ‹©å¡</div><div class="card-desc">ä¸“å±æ‘„å½±å¸ˆ10å¼ </div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_paizhao', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/å­¦ä¹ é™ªä¼´å¡" id="predef_card_xuexi" onclick="openBuyerModal(3, 'T', 'T/å­¦ä¹ é™ªä¼´å¡')"><div class="card-title">T/å­¦ä¹ é™ªä¼´å¡</div><div class="card-desc">å¯¹æ–¹å®‰é™é™ªä¼´ä½ å­¦ä¹ å·¥ä½œ1å°æ—¶</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_xuexi', 'predefined')">âŒ</button></div>
                    </div>
                    <div class="points-section points-5">
                        <h3>ğŸ’œ 5ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(5)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="5" data-type="E" data-name="E/æ‰‹æœºæ—¶é•¿å¡" id="predef_card_shouji" onclick="openBuyerModal(5, 'E', 'E/æ‰‹æœºæ—¶é•¿å¡')"><div class="card-title">E/æ‰‹æœºæ—¶é•¿å¡</div><div class="card-desc">å…‘æ¢30åˆ†é’Ÿæ— æ‰“æ‰°ç©æ‰‹æœºæ—¶é—´</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shouji', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="5" data-type="E" data-name="E/æ¸¸æˆé™ªç©å¡" id="predef_card_youxi" onclick="openBuyerModal(5, 'E', 'E/æ¸¸æˆé™ªç©å¡')"><div class="card-title">E/æ¸¸æˆé™ªç©å¡</div><div class="card-desc">å¯¹æ–¹é™ªä½ ç©å–œæ¬¢çš„æ¸¸æˆ2å°æ—¶</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_youxi', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="5" data-type="T" data-name="T/é£Ÿç‰©æ–™ç†å¡" id="predef_card_liaoli" onclick="openBuyerModal(5, 'T', 'T/é£Ÿç‰©æ–™ç†å¡')"><div class="card-title">T/é£Ÿç‰©æ–™ç†å¡</div><div class="card-desc">å¯¹æ–¹ä¸ºä½ å®Œæˆä¸€é“æŒ‡å®šèœï¼Œå¯¹æ–¹é™ªä½ åƒæ‰ä¸€ç¢—èœ</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_liaoli', 'predefined')">âŒ</button></div>
                    </div>
                    <div class="points-section points-10">
                        <h3>ğŸ–¤ 10ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(10)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/å®¶åŠ¡è±å…å¡" id="predef_card_huomian" onclick="openBuyerModal(10, 'T', 'T/å®¶åŠ¡è±å…å¡')"><div class="card-title">T/å®¶åŠ¡è±å…å¡</div><div class="card-desc">å…é™¤å½“æ—¥æŒ‡å®šå®¶åŠ¡åŠ³åŠ¨</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_huomian', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/åº†ç¥é€‰æ‹©å¡" id="predef_card_qingzhu" onclick="openBuyerModal(10, 'T', 'T/åº†ç¥é€‰æ‹©å¡')"><div class="card-title">T/åº†ç¥é€‰æ‹©å¡</div><div class="card-desc">çºªå¿µæ—¥å½“å¤©æŒå¡äººæ‹¥æœ‰æ´»åŠ¨å†³å®šæƒ</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_qingzhu', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/ä¸‡èƒ½åŠæ—¥å¡" id="predef_card_bannri" onclick="openBuyerModal(10, 'T', 'T/ä¸‡èƒ½åŠæ—¥å¡')"><div class="card-title">T/ä¸‡èƒ½åŠæ—¥å¡</div><div class="card-desc">å¯åœ¨å‘¨æœ«æˆ–èŠ‚å‡æ—¥ç©ºé—²æ—¶é™ªä¼´ï¼ˆå…¨å¿ƒå…¨æ„ï¼‰</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_bannri', 'predefined')">âŒ</button></div>
                    </div>
                    <div class="points-section points-20">
                        <h3>ğŸ”¥ 20ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(20)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="20" data-type="E" data-name="E/ä¸‡èƒ½å’Œå¥½å¡" id="predef_card_hehao" onclick="openBuyerModal(20, 'E', 'E/ä¸‡èƒ½å’Œå¥½å¡')"><div class="card-title">E/ä¸‡èƒ½å’Œå¥½å¡</div><div class="card-desc">åŒæ–¹éœ€è¦åœ¨15åˆ†é’Ÿå†…åœæ­¢äº‰è®ºï¼Œå€¾è¯‰ä»¥åŠæ²Ÿé€š</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_hehao', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="20" data-type="T" data-name="T/ä¸‡èƒ½åŒ…æ—¥å¡" id="predef_card_baori" onclick="openBuyerModal(20, 'T', 'T/ä¸‡èƒ½åŒ…æ—¥å¡')"><div class="card-title">T/ä¸‡èƒ½åŒ…æ—¥å¡</div><div class="card-desc">å¯åœ¨å‘¨æœ«æˆ–èŠ‚å‡æ—¥ç©ºé—²æ—¶é™ªä¼´ï¼ˆæ»¡è¶³å¯¹æ–¹ä¸€åˆ‡è¦æ±‚ï¼‰å åŠ æ—¶æ¯å¤©åŠ 10åˆ†ï¼Œå¯¹æ–¹è·å¾—ä¸‰åˆ†ä¹‹ä¸€</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_baori', 'predefined')">âŒ</button></div>
                        <div class="card-item" data-points="20" data-type="H" data-name="H/å‘¨æœ«æŒæ§å¡" id="predef_card_zhangkong" onclick="openBuyerModal(20, 'H', 'H/å‘¨æœ«æŒæ§å¡')"><div class="card-title">H/å‘¨æœ«æŒæ§å¡</div><div class="card-desc">ä¸€äººååˆ†è§£é™¤å½“å¤©çš„æ‰€æœ‰é™åˆ¶ï¼ˆæ­¤å¤–å½“å¤©æ‰€æœ‰æ—¥å¸¸ä¸åœ¨åŠ åˆ†ï¼‰</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_zhangkong', 'predefined')">âŒ</button></div>
                    </div>


                    <div class="points-section points-20">
                        <h3>ğŸŒŸ 999ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(999)">âŠ• æ·»åŠ </button></h3>
                        <div class="card-item" data-points="999" data-type="T" data-name="T/åŸåœ°ç»“å©šå¡" id="predef_card_jiehun" onclick="openBuyerModal(999, 'T', 'T/åŸåœ°ç»“å©šå¡')"><div class="card-title">T/åŸåœ°ç»“å©šå¡</div><div class="card-desc">å½“å¤©å¸¦ä¸Šèº«ä»½è¯å»æ°‘æ”¿å±€é¢†ç»“å©šè¯</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_jiehun', 'predefined')">âŒ</button></div>
                    </div>



                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(45deg, #74b9ff, #0984e3); color: white; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <h3 style="margin-bottom: 15px;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                        <div style="display: inline-block; text-align: left; font-size: 1.05em; line-height: 1.8; margin: 0 auto;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li><strong>ç§¯åˆ†äº¤æ˜“ï¼š</strong>å¯ç›´æ¥åœ¨ç©å®¶é—´è½¬ç§»ç§¯åˆ†ï¼Œæ”¯æŒå¤‡æ³¨è¯´æ˜ï¼Œäº¤æ˜“è®°å½•ä¼šè®¡å…¥æ€»åˆ†ä½“ç³»ã€‚</li>
                                <li><strong>E = æ¶ˆè´¹ç±»å¡ç‰‡ï¼š</strong>è´­ä¹°åè¿›å…¥ä»“åº“ï¼Œä½¿ç”¨åä»ä»“åº“ç§»é™¤ã€‚ç§¯åˆ†ç”±è´­ä¹°æ–¹æ‰¿æ‹…ã€‚</li>
                                <li><strong>T = äº¤æ˜“ç±»å¡ç‰‡ï¼š</strong>è´­ä¹°åè¿›å…¥ä»“åº“ã€‚ä½¿ç”¨åå¡ç‰‡ä»ä»“åº“ç§»é™¤ï¼Œå¡ç‰‡åŸç§¯åˆ†å€¼å°†åŠ å…¥å¯¹æ–¹çš„â€œäº¤æ˜“â€ç§¯åˆ†ä¸­ã€‚è´­ä¹°æ–¹æ‰¿æ‹…è´­ä¹°æˆæœ¬ã€‚</li>
                                <li><strong>H = å¼€å¿ƒç±»å¡ç‰‡ï¼šï¼š</strong>ç›´æ¥æ¶ˆè€—ï¼ŒåŒæ–¹å…±åŒæ‰¿æ‹…ç§¯åˆ†ï¼Œä¸è¿›å…¥ä»“åº“ã€‚</li>
                                <li><strong>IOU = æ¬ æ¡å¡ç‰‡ï¼š</strong>è´­ä¹°åè¿›å…¥ä»“åº“ï¼Œè´­ä¹°è€…æ‰£é™¤ç§¯åˆ†ï¼Œå¦ä¸€æ–¹ç©å®¶ç«‹å³è·å¾—ç›¸åŒç§¯åˆ†ã€‚ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨è€…è·å¾—ï¼ˆé¢å€¼+åˆ©æ¯ï¼‰ç§¯åˆ†ï¼Œå¦ä¸€æ–¹ç©å®¶æ‰£é™¤ï¼ˆé¢å€¼+åˆ©æ¯ï¼‰ç§¯åˆ†ã€‚</li>
                                 <li><strong>ç‰¹æ®Šå¥–åŠ±å¡ï¼š</strong>ç›´æ¥æˆäºˆå¯¹åº”ç©å®¶å¥–åŠ±ç§¯åˆ†ï¼Œä¸è¿›å…¥ä»“åº“ã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="penalty" class="page">
                <h2>âš–ï¸ å¥–æƒ©åˆ¶åº¦</h2>
                <div class="penalty-section">
                    <div class="penalty-card penalty-left">
                        <h3 style="color: #e74c3c; text-align: center; margin-bottom: 20px;">âŒ æ‰£åˆ†è§„åˆ™</h3>
                        <div class="penalty-list">
                            <div class="penalty-item" data-penalty-value="-1" data-penalty-desc="ä¸è€çƒ¦"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>ä¸è€çƒ¦</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, 'ä¸è€çƒ¦')">åº”ç”¨</button></div></div>
                            <div class="penalty-item" data-penalty-value="-2" data-penalty-desc="åé—®å¥"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>åé—®å¥</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, 'åé—®å¥')">åº”ç”¨</button></div></div>
                            <div class="penalty-item" data-penalty-value="-2" data-penalty-desc="è¯´è„è¯"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>è¯´è„è¯</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, 'è¯´è„è¯')">åº”ç”¨</button></div></div>
                            <div class="penalty-item" data-penalty-value="-3" data-penalty-desc="å†·æš´åŠ›"><div class="penalty-item-info"><span class="penalty-score">-3</span><span>å†·æš´åŠ›</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-3, 'å†·æš´åŠ›')">åº”ç”¨</button></div></div>
                            <div class="penalty-item"><div class="penalty-item-info"><span class="penalty-score" style="background-color: #f39c12;">è‡ªå®š</span><span>å…¶ä»–è‡ªå®šä¹‰æ‰£åˆ†</span></div><div class="penalty-action-buttons"><button onclick="openCustomPenaltyModal()" class="custom-penalty-btn">è®¾ç½®</button></div></div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 20px;"> <h4 style="color: #c62828; margin-bottom: 10px;">âš ï¸ æ‰£åˆ†è¯´æ˜</h4> <ul style="color: #666; margin-left: 20px;"><li>æ‰£åˆ†ä¼šç«‹å³ä»å½“å‰ç§¯åˆ†ä¸­æ‰£é™¤ (ä½“ç°ä¸ºå‘¨è®°å½•ä¸­çš„è´Ÿå€¼)</li><li>å¦‚ç§¯åˆ†ä¸è¶³ï¼Œå°†äº§ç”Ÿè´Ÿå€º</li><li>è¿ç»­è¿è§„è¡Œä¸ºå°†æœ‰é¢å¤–æƒ©ç½š</li><li>è‡ªå®šä¹‰æ‰£åˆ†éœ€åŒæ–¹åŒæ„å¹¶è®°å½•åŸå› </li></ul></div>
                    </div>
                    <div class="penalty-card penalty-right">
                        <h3 style="color: #27ae60; text-align: center; margin-bottom: 20px;">âœ… å€Ÿåˆ†ã€ç”³è¯‰ä¸å¥–åŠ±</h3>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;"><h4 style="color: #2e7d32; margin-bottom: 15px;">ğŸ¤ ç‰¹æ®Šæƒ…å†µå¤„ç†</h4><div style="margin: 10px 0; color: #424242;"><strong>å€Ÿåˆ†è§„åˆ™ï¼š</strong><br>ç‰¹æ®Šæƒ…å†µä¸‹å¯ä»¥"å€Ÿ"ç»™å¯¹æ–¹ç§¯åˆ†ï¼Œéœ€è¦è®°å½•å¹¶çº¦å®šè¿˜åˆ†æ—¶é—´</div></div>
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;"><h4 style="color: #f57c00; margin-bottom: 15px;">âš–ï¸ ç”³è¯‰æœºåˆ¶</h4><div style="margin: 10px 0; color: #424242;"><strong>ç¬¬ä¸‰æ–¹ä»²è£ï¼š</strong><br>å¯¹ä¸å…¬å¹³æ‰£åˆ†å¯ç”³è¯·ç¬¬ä¸‰æ–¹ä»²è£ï¼ˆå§å§ï¼‰ï¼Œç¡®ä¿å…¬å¹³å…¬æ­£</div></div>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-top: 20px;"><h4 style="color: #2e7d32; margin-bottom: 15px;">ğŸ è‡ªå®šä¹‰å¥–åŠ±</h4><div class="penalty-item"><div class="penalty-item-info"><span class="penalty-score" style="background-color: #27ae60;">è‡ªå®š</span><span>è‡ªå®šä¹‰å¥–åŠ±åˆ†</span></div><div class="penalty-action-buttons"><button onclick="openCustomRewardModal()" class="btn" style="background: #27ae60; color: white;">è®¾ç½®å¥–åŠ±</button></div></div><ul style="color: #666; margin-left: 20px; font-size: 0.9em; margin-top:10px;"><li>ä¸ºç©å®¶è®¾ç½®è‡ªå®šä¹‰çš„å¥–åŠ±ç§¯åˆ†å’ŒåŸå› ã€‚</li><li>å¥–åŠ±å°†ç´¯åŠ åˆ°å½“æ—¥çš„â€œå¥–â€åˆ†ä¸­ã€‚</li></ul></div>
                    </div>
                </div>
            </div>

            <div id="bank" class="page">
                <h2>ğŸ¦ ç§¯åˆ†é“¶è¡Œ</h2>
                <div class="total-scores">
                    <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</h3>
                    <div class="score-boards">
                        <div class="score-board"><div class="player-name">ä¸ƒä¸ƒ</div><input type="number" class="total-score-input" id="qiqi-total" value="0" placeholder="è¾“å…¥ç§¯åˆ†"><button onclick="openConfirmAddTotalModal('qiqi')" style="margin-top: 12px; padding: 8px 20px; font-size: 0.95em; background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='1)'">ğŸ“¥ åŠ å…¥æœ¬å‘¨æ€»åˆ†</button></div>
                        <div class="score-board"><div class="player-name">ä¸€ä¸€</div><input type="number" class="total-score-input" id="yiyi-total" value="0" placeholder="è¾“å…¥ç§¯åˆ†"><button onclick="openConfirmAddTotalModal('yiyi')" style="margin-top: 12px; padding: 8px 20px; font-size: 0.95em; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='1)'">ğŸ“¥ åŠ å…¥æœ¬å‘¨æ€»åˆ†</button></div>
                    </div>
                    <div class="control-buttons"> <button class="btn btn-danger" onclick="resetAllData()">é‡ç½®æ‰€æœ‰æ•°æ®</button> </div>
                </div>
                <div class="bank-section">
                    <div class="week-card">
                        <div class="week-title">ä¸ƒä¸ƒ</div>
                        <div class="week-table-container"><table class="week-table"><thead><tr><th>æ—¥æœŸ</th><th>å­¦</th><th>ç¡</th><th>ç»ƒ</th><th>å¥–</th><th>ç½š</th><th>è´­å¡</th><th>äº¤æ˜“</th></tr></thead><tbody>
                            <tr><td><strong>å‘¨ä¸€</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨äºŒ</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨ä¸‰</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨å››</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨äº”</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨å…­</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨æ—¥</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                        </tbody></table></div>
                        <div class="week-summary" id="qiqi-summary"><strong>æœ¬å‘¨ç§¯åˆ†ï¼š0åˆ† âœ¨</strong> <br> (åŸºç¡€: 0 ğŸ“š, å¥–åŠ±: 0 ğŸ, ç½šåˆ†: 0 ğŸ’”, è´­å¡: 0 ğŸ’³, äº¤æ˜“: 0 ğŸ”„)</div>
                        <button class="btn btn-secondary" onclick="resetWeekData('qiqi')">æ¸…é›¶æœ¬å‘¨æ•°æ®</button>
                    </div>
                    <div class="week-card">
                        <div class="week-title">ä¸€ä¸€</div>
                        <div class="week-table-container"><table class="week-table"><thead><tr><th>æ—¥æœŸ</th><th>å­¦</th><th>ç¡</th><th>ç»ƒ</th><th>å¥–</th><th>ç½š</th><th>è´­å¡</th><th>äº¤æ˜“</th></tr></thead><tbody>
                            <tr><td><strong>å‘¨ä¸€</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨äºŒ</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨ä¸‰</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨å››</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨äº”</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨å…­</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>å‘¨æ—¥</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                        </tbody></table></div>
                        <div class="week-summary" id="yiyi-summary"><strong>æœ¬å‘¨ç§¯åˆ†ï¼š0åˆ† âœ¨</strong> <br> (åŸºç¡€: 0 ğŸ“š, å¥–åŠ±: 0 ğŸ, ç½šåˆ†: 0 ğŸ’”, è´­å¡: 0 ğŸ’³, äº¤æ˜“: 0 ğŸ”„)</div>
                        <button class="btn btn-secondary" onclick="resetWeekData('yiyi')">æ¸…é›¶æœ¬å‘¨æ•°æ®</button>
                    </div>
                </div>
                <div style="margin-top: 30px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">ğŸ“‹ ç§¯åˆ†è®¡ç®—è¯´æ˜</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px;"><h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ“Š ç§¯åˆ†è®¡ç®—è§„åˆ™</h4><ul style="color: #555; margin-left: 20px;"><li><strong>åŸºç¡€ä»»åŠ¡ï¼š</strong>å„ä¸ªé¡¹ç›®å¯ç‚¹å‡»åˆ‡æ¢-2, 0, 1åˆ†</li><li><strong>å¥–åŠ±ç§¯åˆ†ï¼š</strong>é€šè¿‡ç‰¹æ®Šå¥–åŠ±å¡æˆ–è‡ªå®šä¹‰å¥–åŠ±è·å¾—</li><li><strong>ç½šåˆ†ï¼š</strong>é€šè¿‡æ‰£åˆ†è§„åˆ™æˆ–è‡ªå®šä¹‰æ‰£åˆ†äº§ç”Ÿ (è‡ªåŠ¨è®°å½•)</li><li><strong>è´­å¡ï¼š</strong>å¡ç‰‡è´­ä¹°æˆæœ¬ (è‡ªåŠ¨è®°å½•)</li><li><strong>äº¤æ˜“ï¼š</strong>å¯¹æ–¹ä½¿ç”¨Tå¡æ—¶ï¼Œå·±æ–¹è·å¾—çš„ç§¯åˆ† (è‡ªåŠ¨è®°å½•)</li><li><strong>æ€»åˆ† = åŸºç¡€ + å¥–åŠ± + ç½šåˆ† - è´­å¡ + äº¤æ˜“</strong> (ç½šåˆ†ä¸ºè´Ÿå€¼)</li></ul></div>
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;"><h4 style="color: #7b1fa2; margin-bottom: 10px;">ğŸ® æ“ä½œè¯´æ˜</h4><ul style="color: #555; margin-left: 20px;"><li>ç‚¹å‡»åŸºç¡€ä»»åŠ¡å•å…ƒæ ¼åˆ‡æ¢æ•°å€¼</li><li>å¥–åŠ±é€šè¿‡"å°å¡ç‰‡"é¡µé¢çš„ç‰¹æ®Šå¡æˆ–"å°å¥–æƒ©"é¡µé¢çš„è‡ªå®šä¹‰å¥–åŠ±æ“ä½œ</li><li>ç½šåˆ†é€šè¿‡"å°å¥–æƒ©"é¡µé¢æ“ä½œè‡ªåŠ¨æ›´æ–°</li><li>è´­å¡ç§¯åˆ†æ ¹æ®å¡ç‰‡è´­ä¹°è‡ªåŠ¨æ›´æ–°</li><li>äº¤æ˜“ç§¯åˆ†æ ¹æ®å¯¹æ–¹ä½¿ç”¨Tå¡è‡ªåŠ¨æ›´æ–°</li><li>ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æœ¬å‘¨å„é¡¹ç§¯åˆ†åŠæ€»åˆ†</li></ul></div>
                    </div>
                </div>
            </div>
            
            <div id="history" class="page">
                <h2>ğŸ“œ ç§¯åˆ†å†å²è®°å½•</h2>
                <div class="table-container"> <table id="score-history-table"><thead><tr><th>çº³å…¥æ—¥æœŸ</th><th>ç©å®¶</th><th class="num-center">åŸºç¡€åˆ†è¯¦æƒ…</th><th class="num-center">å¥–åŠ±åˆ†</th><th>å¥–åŠ±åˆ†è¯¦æƒ…</th><th>ç½šåˆ†è¯¦æƒ…</th><th>è´­å¡è¯¦æƒ…</th><th class="num-center">äº¤æ˜“åˆ†</th><th>äº¤æ˜“æ˜ç»†</th><th class="total-highlight num-center">æœ¬å‘¨æ€»è®¡</th></tr></thead><tbody></tbody></table></div>
                <div class="control-buttons"> <button class="btn btn-danger" onclick="clearScoreHistory()">æ¸…ç©ºå†å²è®°å½•</button> </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDG4YvEFwtk_-aD8J2OYIgvn61sOXqIAVw",
            authDomain: "score-bank.firebaseapp.com",
            databaseURL: "https://score-bank-default-rtdb.firebaseio.com/", 
            projectId: "score-bank",
            storageBucket: "score-bank.firebasestorage.app",
            messagingSenderId: "700926783701",
            appId: "1:700926783701:web:fa11b4e0150d8aae92b25c",
            measurementId: "G-4SEHTPPH7C"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const connectedRef = database.ref('.info/connected');
        const statusElement = document.getElementById('connection-status');

        const EDIT_PASSWORD = "240310"; // Your desired edit password
        let editPasswordVerifiedTimestamp = null;
        const EDIT_AUTH_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        const EDIT_AUTH_STORAGE_KEY = 'scorebank_edit_auth_time';

        let scoreHistoryLog = [];
        let warehousesData = { qiqi: [], yiyi: [] }; 
        // ç»Ÿä¸€ä¸º customDefinedCardsï¼ŒåŒ…å«ä»¥å‰çš„ä¸´æ—¶å¡ç‰‡å’Œå¸¸ç”¨å¡ç‰‡
        let customDefinedCards = {}; // Stores user-defined custom cards { cardId: {details} } 
        let iouCardsData = {}; // Stores user-defined IOU cards { cardId: {details} }
        let hiddenPredefinedCardIds = []; // Stores IDs of predefined cards to hide

        const initialDayData = () => ({
            book: 0, sleep: 0, exercise: 0,
            reward: 0, penalty: 0, consume: 0, trade: 0, // trade is for T-card income
            purchaseLog: [], penaltyLog: [], rewardLog: [], tradeLog: [], 
            tradeFromLog: [], // Log for points transferred FROM this player
            tradeToLog: []    // Log for points transferred TO this player
        });

        let weekData = {
            qiqi: { mon: initialDayData(), tue: initialDayData(), wed: initialDayData(), thu: initialDayData(), fri: initialDayData(), sat: initialDayData(), sun: initialDayData() },
            yiyi: { mon: initialDayData(), tue: initialDayData(), wed: initialDayData(), thu: initialDayData(), fri: initialDayData(), sat: initialDayData(), sun: initialDayData() }
        };
        
        const dayChineseMap = { mon: 'å‘¨ä¸€', tue: 'å‘¨äºŒ', wed: 'å‘¨ä¸‰', thu: 'å‘¨å››', fri: 'å‘¨äº”', sat: 'å‘¨å…­', sun: 'å‘¨æ—¥' };
        const taskChineseMap = { book: 'ä¹¦', sleep: 'ç¡', exercise: 'ç»ƒ' };

        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                statusElement.textContent = 'âœ… å·²è¿æ¥'; statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'âŒ è¿æ¥æ–­å¼€'; statusElement.className = 'connection-status disconnected';
            }
        });

        // Function to check if edit permission is currently valid
        function hasValidEditPermission() {
            const storedAuthTime = localStorage.getItem(EDIT_AUTH_STORAGE_KEY);
            if (storedAuthTime) {
                editPasswordVerifiedTimestamp = parseInt(storedAuthTime);
                if ((Date.now() - editPasswordVerifiedTimestamp) < EDIT_AUTH_DURATION) {
                    return true;
                } else {
                    // Stored permission has expired
                    localStorage.removeItem(EDIT_AUTH_STORAGE_KEY);
                    editPasswordVerifiedTimestamp = null;
                    return false;
                }
            }
            return false;
        }

        // Function to request edit permission via modal
        function requestEditPermission(onSuccessCallback, onCancelCallback) {
            if (hasValidEditPermission()) {
                if (onSuccessCallback) onSuccessCallback();
                return;
            }
            const editPasswordModal = document.getElementById('edit-password-modal-overlay');
            editPasswordModal.style.display = 'flex';
            const passInput = document.getElementById('edit-password-input');
            passInput.value = ''; // Clear previous input
            passInput.focus();
            const editErrorDiv = document.getElementById('edit-login-error');
            if (editErrorDiv) editErrorDiv.style.display = 'none'; // Hide error initially

            // Store callbacks to be executed after successful authentication or cancellation
            window.currentEditSuccessCallback = onSuccessCallback;
            window.currentEditCancelCallback = onCancelCallback;
        }

        // Handles submission of the edit password modal
        function handleEditPasswordSubmit() {
            const inputPassword = document.getElementById('edit-password-input').value;
            const errorDiv = document.getElementById('edit-login-error');

            if (inputPassword === EDIT_PASSWORD) {
                editPasswordVerifiedTimestamp = Date.now();
                localStorage.setItem(EDIT_AUTH_STORAGE_KEY, editPasswordVerifiedTimestamp.toString()); // Store timestamp
                document.getElementById('edit-password-modal-overlay').style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';

                // Execute the stored success callback
                if (window.currentEditSuccessCallback) {
                    window.currentEditSuccessCallback();
                    window.currentEditSuccessCallback = null; // Clear the callback
                }
            } else {
                if (errorDiv) errorDiv.style.display = 'block';
                document.getElementById('edit-password-input').value = ''; // Clear input on error
                document.getElementById('edit-password-input').focus();
                setTimeout(() => { // Hide error after 3 seconds
                    if (errorDiv) errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Handles cancellation of the edit password modal
        function cancelEditPassword() {
            document.getElementById('edit-password-modal-overlay').style.display = 'none';
            // Execute the stored cancel callback if it exists
            if (window.currentEditCancelCallback) {
                window.currentEditCancelCallback();
                window.currentEditCancelCallback = null; // Clear the callback
            }
        }
        
        // Original checkPassword function is no longer used for initial access
        function checkPassword() { console.log("Initial password check is deprecated."); }


        document.addEventListener('keydown', (event) => {
            const editPasswordModal = document.getElementById('edit-password-modal-overlay');
            if (event.key === 'Enter' && editPasswordModal && editPasswordModal.style.display !== 'none') {
                handleEditPasswordSubmit();
            }
        });
        
        // All functions that modify data should call requestEditPermission
        function saveToFirebase(showStatus = true) { requestEditPermission(() => _saveToFirebaseInternal(showStatus)); }
        function _saveToFirebaseInternal(showStatus = true) {
            if (showStatus) { statusElement.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...'; statusElement.className = 'connection-status connecting'; }
            const updates = {
                '/weekData': weekData,
                '/totalScores': { qiqi: document.getElementById('qiqi-total').value, yiyi: document.getElementById('yiyi-total').value },
                '/warehousesData': warehousesData,
                '/customDefinedCards': customDefinedCards, 
                '/hiddenPredefinedCardIds': hiddenPredefinedCardIds,
                '/iouCardsData': iouCardsData
            };
            database.ref().update(updates).then(() => {
                console.log('âœ… ä¸»æ•°æ®ã€ä»“åº“ã€è‡ªå®šä¹‰å¡ç‰‡ã€éšè—çŠ¶æ€åŠæ¬ æ¡å¡ç‰‡ä¿å­˜æˆåŠŸ'); 
                if (showStatus) { setTimeout(() => { statusElement.textContent = 'âœ… å·²è¿æ¥'; statusElement.className = 'connection-status connected'; }, 1000); }
            }).catch((error) => {
                console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                if (showStatus) { statusElement.textContent = 'âŒ ä¿å­˜å¤±è´¥'; statusElement.className = 'connection-status disconnected';}
            });
        }
        
        function saveScoreHistoryToFirebase() { requestEditPermission(_saveScoreHistoryToFirebaseInternal); }
        function _saveScoreHistoryToFirebaseInternal() {
            database.ref('/scoreHistory').set(scoreHistoryLog)
                .then(() => console.log('âœ… ç§¯åˆ†å†å²ä¿å­˜æˆåŠŸ'))
                .catch((error) => console.error('âŒ ç§¯åˆ†å†å²ä¿å­˜å¤±è´¥:', error));
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const pageElement = document.getElementById(pageId);
            if(pageElement) pageElement.classList.add('active');
            const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.getAttribute('onclick') === `showPage('${pageId}')`);
            if (clickedTab) clickedTab.classList.add('active');
        }

        let currentCardToBuy = { points: 0, type: '', name: '', isCustom: false, id: null }; 
        let currentSpecialReward = { name: '', points: 0 };

        function openSpecialRewardModal(cardName, points) {
            requestEditPermission(() => {
                currentSpecialReward = { name: cardName, points: points };
                document.getElementById('special-reward-modal-title').textContent = `æˆäºˆ "${cardName}"`;
                document.getElementById('special-reward-modal-desc').textContent = `é€‰æ‹©ç©å®¶ä»¥æˆäºˆ ${points} ç‚¹ç‰¹æ®Šå¥–åŠ±ç§¯åˆ†ã€‚`;
                document.getElementById('special-reward-modal-overlay').style.display = 'flex';
            });
        }
        function closeSpecialRewardModal() { document.getElementById('special-reward-modal-overlay').style.display = 'none'; currentSpecialReward = { name: '', points: 0 };}
        function applySpecialReward(player) { requestEditPermission(() => _applySpecialRewardInternal(player)); }
        function _applySpecialRewardInternal(player) {
            if (!currentSpecialReward.name) { alert('æ“ä½œæ— æ•ˆï¼'); return; }
            const { name: cardName, points: rewardPoints } = currentSpecialReward;
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].reward = (parseInt(weekData[player][currentDayKey].reward) || 0) + rewardPoints;
            if (!weekData[player][currentDayKey].rewardLog) weekData[player][currentDayKey].rewardLog = [];
            weekData[player][currentDayKey].rewardLog.push({ desc: cardName, pointsAdded: rewardPoints, type: 'special_card' });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å›  "${cardName}" è·å¾—äº† ${rewardPoints} ç‚¹ç‰¹æ®Šå¥–åŠ±ç§¯åˆ†ï¼`);
            closeSpecialRewardModal();
        }

        // Modified openBuyerModal to use isCustom instead of isTemporary/isPermanent
        function openBuyerModal(points, type, cardNameFromArg, isCustom = false, cardId = null) {
            requestEditPermission(() => {
                const cardName = cardNameFromArg || (event && event.target.closest('.card-item') ? event.target.closest('.card-item').dataset.name : null);
                const cardPoints = points !== undefined ? points : (event && event.target.closest('.card-item') ? parseInt(event.target.closest('.card-item').dataset.points) : 0);
                const cardType = type || (event && event.target.closest('.card-item') ? event.target.closest('.card-item').dataset.type : null);
                if (!cardName || cardType === null || isNaN(cardPoints)) {
                    const cardElement = event ? event.target.closest('.card-item') : null;
                    if (cardElement && cardElement.dataset.type === 'special-reward') { openSpecialRewardModal(cardElement.dataset.name, parseInt(cardElement.dataset.points)); return; }
                    console.error("Could not determine card details for buyer modal."); return;
                }
                currentCardToBuy = { points: cardPoints, type: cardType, name: cardName, isCustom: isCustom, id: cardId };
                if (currentCardToBuy.type === 'H') { _handleHCardPurchaseInternal(currentCardToBuy.points, currentCardToBuy.name); return; } // Directly call internal for H cards after permission
                document.getElementById('buyer-modal-card-name').textContent = ` "${currentCardToBuy.name}" (${currentCardToBuy.points}åˆ†/ä¸ª)`;
                document.getElementById('buy-card-quantity').value = 1;
                document.getElementById('buyer-modal-overlay').style.display = 'flex';
            });
        }
        function closeBuyerModal() { document.getElementById('buyer-modal-overlay').style.display = 'none'; currentCardToBuy = { points: 0, type: '', name: '', isCustom: false, id: null };} 
        
        function renderWarehouses() {
            ['qiqi', 'yiyi'].forEach(player => {
                const warehouseDiv = document.getElementById(`${player}-warehouse-cards`); warehouseDiv.innerHTML = ''; 
                if (warehousesData[player] && warehousesData[player].length > 0) {
                    warehousesData[player].forEach(card => {
                        const cardEl = document.createElement('div'); cardEl.className = 'warehouse-card-item';
                        // æ ¹æ®å¡ç‰‡ç±»å‹é€‰æ‹©ä¸åŒçš„ä½¿ç”¨å‡½æ•°
                        if (card.type === 'IOU') {
                            cardEl.innerHTML = `<div class="warehouse-card-info"><span class="name">${card.name} (é¢å€¼:${card.pointsValue}åˆ†, åˆ©æ¯:${card.interestRate}%)</span><span class="qty">æ•°é‡: ${card.quantity}</span></div><button class="use-card-btn" onclick="openIOUReturnModal('${player}', '${card.name}')">ä½¿ç”¨</button>`;
                        } else {
                            cardEl.innerHTML = `<div class="warehouse-card-info"><span class="name">${card.name} (åŸ${card.pointsValue}åˆ†)</span><span class="qty">æ•°é‡: ${card.quantity}</span></div><button class="use-card-btn" onclick="openConsumeCardConfirmModal('${player}', '${card.name}')">ä½¿ç”¨</button>`;
                        }
                        warehouseDiv.appendChild(cardEl);
                    });
                } else { warehouseDiv.innerHTML = '<p class="no-cards-text">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ~</p>'; }
            });
        }

        let cardToConsumeDetails = null;
        function openConsumeCardConfirmModal(player, cardName) {
            requestEditPermission(() => {
                const card = warehousesData[player].find(c => c.name === cardName); if (!card) return;
                cardToConsumeDetails = { player, cardName, cardType: card.type, cardPoints: card.pointsValue };
                document.getElementById('consume-card-confirm-title').textContent = `ç¡®è®¤ä½¿ç”¨ "${cardName}"?`;
                let desc = `ç±»å‹: ${card.type}. åŸä»·å€¼: ${card.pointsValue}åˆ†.`;
                if (card.type === 'T') { desc += ` ${player === 'qiqi' ? 'ä¸€ä¸€' : 'ä¸ƒä¸ƒ'} å°†è·å¾— ${card.pointsValue} äº¤æ˜“ç§¯åˆ†ã€‚`; }
                document.getElementById('consume-card-confirm-desc').textContent = desc;
                document.getElementById('confirm-consume-btn').onclick = () => processCardConsumption();
                document.getElementById('consume-card-confirm-modal').style.display = 'flex';
            });
        }
        function closeConsumeCardConfirmModal() { document.getElementById('consume-card-confirm-modal').style.display = 'none'; cardToConsumeDetails = null; }
        function processCardConsumption() { requestEditPermission(_processCardConsumptionInternal); }
        function _processCardConsumptionInternal() {
            if (!cardToConsumeDetails) return;
            const { player, cardName, cardType, cardPoints } = cardToConsumeDetails;
            const playerWarehouse = warehousesData[player]; const cardIndex = playerWarehouse.findIndex(c => c.name === cardName);
            if (cardIndex === -1) { closeConsumeCardConfirmModal(); return; }

            // IOU å¡ç‰‡ç°åœ¨é€šè¿‡ openIOUReturnModal å’Œ processIOUReturn å¤„ç†ï¼Œè¿™é‡Œä¸å†å¤„ç†
            if (cardType === 'IOU') { return; }

            let message = `${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} ä½¿ç”¨äº† "${cardName}".`;
            if (cardType === 'T') {
                const otherPlayer = player === 'qiqi' ? 'yiyi' : 'qiqi'; const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
                weekData[otherPlayer][currentDayKey].trade = (parseInt(weekData[otherPlayer][currentDayKey].trade) || 0) + cardPoints;
                if (!weekData[otherPlayer][currentDayKey].tradeLog) weekData[otherPlayer][currentDayKey].tradeLog = [];
                weekData[otherPlayer][currentDayKey].tradeLog.push({ desc: `æ¥è‡ª${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'}ä½¿ç”¨çš„äº¤æ˜“å¡ "${cardName}"`, pointsAdded: cardPoints, type: 'T_card_income' });
                updateWeekSummary(otherPlayer); message += ` ${otherPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å› æ­¤è·å¾—äº† ${cardPoints} äº¤æ˜“ç§¯åˆ†ï¼`;
            } else if (cardType === 'E') { message += ` å¡ç‰‡å·²æ¶ˆè€—ã€‚`; }
            alert(message);
            if (playerWarehouse[cardIndex].quantity > 1) { playerWarehouse[cardIndex].quantity--; } else { playerWarehouse.splice(cardIndex, 1); }
            renderWarehouses(); _saveToFirebaseInternal(); closeConsumeCardConfirmModal();
        }

        function selectBuyer(buyerPlayer) { requestEditPermission(() => _selectBuyerInternal(buyerPlayer)); }
        function _selectBuyerInternal(buyerPlayer) {
            if (!currentCardToBuy.name) { alert('æ“ä½œæ— æ•ˆï¼'); return; }
            const quantityInput = document.getElementById('buy-card-quantity'); const quantity = parseInt(quantityInput.value);
            if (isNaN(quantity) || quantity < 1) { alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´­ä¹°æ•°é‡ (è‡³å°‘ä¸º1)ã€‚"); quantityInput.focus(); return; }
            const { points: singleCardCost, type: cardType, name: cardName, isCustom, id: cardId } = currentCardToBuy; 
            const totalCardCost = singleCardCost * quantity;
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[buyerPlayer][currentDayKey].consume = (parseInt(weekData[buyerPlayer][currentDayKey].consume) || 0) + totalCardCost;
            if (!weekData[buyerPlayer][currentDayKey].purchaseLog) weekData[buyerPlayer][currentDayKey].purchaseLog = [];
            weekData[buyerPlayer][currentDayKey].purchaseLog.push({ name: cardName, cost: totalCardCost, quantity: quantity, type: cardType });

            // Special handling for IOU card purchase logic
            if (cardType === 'IOU') {
                const otherPlayer = buyerPlayer === 'qiqi' ? 'yiyi' : 'qiqi';
                const iouCardInfo = iouCardsData[cardId]; 
                if (!iouCardInfo) { alert("æ¬ æ¡ä¿¡æ¯ä¸¢å¤±ï¼Œæ— æ³•å®Œæˆè´­ä¹°ã€‚"); return; }
                const interestRate = iouCardInfo.interestRate;

                // Other player receives points immediately
                weekData[otherPlayer][currentDayKey].reward = (parseInt(weekData[otherPlayer][currentDayKey].reward) || 0) + totalCardCost;
                if (!weekData[otherPlayer][currentDayKey].rewardLog) weekData[otherPlayer][currentDayKey].rewardLog = [];
                weekData[otherPlayer][currentDayKey].rewardLog.push({ desc: `æ¥è‡ª${buyerPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'}è´­ä¹°çš„æ¬ æ¡ "${cardName}"`, pointsAdded: totalCardCost, type: 'iou_purchase_income' });

                const warehouse = warehousesData[buyerPlayer];
                // Ensure to save interestRate for IOU cards in warehouse
                const existingCard = warehouse.find(c => c.name === cardName && c.type === 'IOU' && c.pointsValue === singleCardCost && c.interestRate === interestRate);
                if (existingCard) { existingCard.quantity += quantity; } else { warehouse.push({ name: cardName, pointsValue: singleCardCost, type: cardType, quantity: quantity, interestRate: interestRate }); }

                updateWeekSummary(otherPlayer); // Update other player's summary
                alert(`${buyerPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} è´­ä¹°äº† ${quantity} ä¸ª "${cardName}"ï¼Œæ€»å…±èŠ±è´¹ ${totalCardCost} ç§¯åˆ†ï¼${otherPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} ç«‹å³è·å¾—äº† ${totalCardCost} ç§¯åˆ†ã€‚`);

            } else if (cardType === 'E' || cardType === 'T') {
                const warehouse = warehousesData[buyerPlayer]; const existingCard = warehouse.find(c => c.name === cardName);
                if (existingCard) { existingCard.quantity += quantity; } else { warehouse.push({ name: cardName, pointsValue: singleCardCost, type: cardType, quantity: quantity }); }
                alert(`${buyerPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} è´­ä¹°äº† ${quantity} ä¸ª "${cardName}"ï¼Œæ€»å…±èŠ±è´¹ ${totalCardCost} ç§¯åˆ†ï¼`);
            }

            updateWeekSummary(buyerPlayer); // Update buyer's summary
            renderWarehouses(); // Refresh warehouse display
            _saveToFirebaseInternal();
            closeBuyerModal();
        }

        function _handleHCardPurchaseInternal(cardCost, cardName) {
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            const pointsPerPlayer = Math.ceil(cardCost / 2);
            ['qiqi', 'yiyi'].forEach(player => {
                weekData[player][currentDayKey].consume = (parseInt(weekData[player][currentDayKey].consume) || 0) + pointsPerPlayer;
                if (!weekData[player][currentDayKey].purchaseLog) weekData[player][currentDayKey].purchaseLog = [];
                weekData[player][currentDayKey].purchaseLog.push({ name: cardName, cost: pointsPerPlayer, type: 'H', quantity: 1 });
                updateWeekSummary(player);
            });
            _saveToFirebaseInternal(); alert(`Hç±»å¡ç‰‡ "${cardName}" å·²è´­ä¹°ï¼ä¸ƒä¸ƒå’Œä¸€ä¸€å„æ‰¿æ‹…äº† ${pointsPerPlayer} ç§¯åˆ†ã€‚`);
        }

        let currentPenaltyValue = 0; let currentPenaltyDesc = '';
        function openPenaltyModal(value, desc) {
            requestEditPermission(() => {
                currentPenaltyValue = value; currentPenaltyDesc = desc;
                document.getElementById('penalty-modal-title').textContent = `å¯¹è°æ‰£ ${Math.abs(value)} åˆ† (${desc})?`;
                document.getElementById('penalty-modal-overlay').style.display = 'flex';
            });
        }
        function closePenaltyModal() { document.getElementById('penalty-modal-overlay').style.display = 'none'; currentPenaltyValue = 0; currentPenaltyDesc = ''; }
        
        function openCustomPenaltyModal() {
            requestEditPermission(() => {
                document.getElementById('custom-penalty-points').value = ''; document.getElementById('custom-penalty-desc').value = '';
                document.getElementById('custom-penalty-modal-overlay').style.display = 'flex'; document.getElementById('custom-penalty-points').focus();
            });
        }
        function closeCustomPenaltyModal() { document.getElementById('custom-penalty-modal-overlay').style.display = 'none'; }
        function applyCustomPenaltyToPlayer(player) { requestEditPermission(() => _applyCustomPenaltyToPlayerInternal(player));}
        function _applyCustomPenaltyToPlayerInternal(player) {
            const pointsInput = document.getElementById('custom-penalty-points'); const descInput = document.getElementById('custom-penalty-desc');
            let points = parseInt(pointsInput.value); const desc = descInput.value.trim();
            if (isNaN(points) || points === 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰£åˆ†æ•°å€¼ (ä¸èƒ½ä¸º0)ã€‚'); pointsInput.focus(); return; }
            if (!desc) { alert('è¯·è¾“å…¥æ‰£åˆ†åŸå› /å¤‡æ³¨ã€‚'); descInput.focus(); return; }
            if (points > 0) points = -points; 
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].penalty = (parseInt(weekData[player][currentDayKey].penalty) || 0) + points;
            if (!weekData[player][currentDayKey].penaltyLog) weekData[player][currentDayKey].penaltyLog = [];
            weekData[player][currentDayKey].penaltyLog.push({ desc: desc, pointsDeducted: points });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å›  "${desc}" è¢«è‡ªå®šä¹‰æ‰£é™¤äº† ${Math.abs(points)} ç§¯åˆ†ï¼`);
            closeCustomPenaltyModal();
        }

        let currentCustomReward = { points: 0, desc: '' };
        function openCustomRewardModal() {
            requestEditPermission(() => {
                document.getElementById('custom-reward-points').value = ''; document.getElementById('custom-reward-desc').value = '';
                document.getElementById('custom-reward-modal-overlay').style.display = 'flex'; document.getElementById('custom-reward-points').focus();
            });
        }
        function closeCustomRewardModal() { document.getElementById('custom-reward-modal-overlay').style.display = 'none'; currentCustomReward = { points: 0, desc: '' };}
        function applyCustomRewardToPlayer(player) { requestEditPermission(() => _applyCustomRewardToPlayerInternal(player)); }
        function _applyCustomRewardToPlayerInternal(player) {
            const pointsInput = document.getElementById('custom-reward-points'); const descInput = document.getElementById('custom-reward-desc');
            let points = parseInt(pointsInput.value); const desc = descInput.value.trim();
            if (isNaN(points) || points <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°å¥–åŠ±æ•°å€¼ã€‚'); pointsInput.focus(); return; }
            if (!desc) { alert('è¯·è¾“å…¥å¥–åŠ±åŸå› /å¤‡æ³¨ã€‚'); descInput.focus(); return; }
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].reward = (parseInt(weekData[player][currentDayKey].reward) || 0) + points;
            if (!weekData[player][currentDayKey].rewardLog) weekData[player][currentDayKey].rewardLog = [];
            weekData[player][currentDayKey].rewardLog.push({ desc: desc, pointsAdded: points, type: 'custom' });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å›  "${desc}" è·å¾—äº† ${points} ç‚¹è‡ªå®šä¹‰å¥–åŠ±ç§¯åˆ†ï¼`);
            closeCustomRewardModal();
        }

        function applyPenaltyToPlayer(player) { requestEditPermission(() => _applyPenaltyToPlayerInternal(player)); }
        function _applyPenaltyToPlayerInternal(player) { 
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            const penaltyAmount = currentPenaltyValue < 0 ? currentPenaltyValue : -currentPenaltyValue;
            weekData[player][currentDayKey].penalty = (parseInt(weekData[player][currentDayKey].penalty) || 0) + penaltyAmount;
            if (!weekData[player][currentDayKey].penaltyLog) weekData[player][currentDayKey].penaltyLog = [];
            weekData[player][currentDayKey].penaltyLog.push({desc: currentPenaltyDesc, pointsDeducted: penaltyAmount});
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å›  "${currentPenaltyDesc}" è¢«æ‰£é™¤äº† ${Math.abs(penaltyAmount)} ç§¯åˆ†ï¼`);
            closePenaltyModal();
        }

        function toggleBasicTask(element, player, day, task) { requestEditPermission(() => _toggleBasicTaskInternal(element, player, day, task)); }
        function _toggleBasicTaskInternal(element, player, day, task) {
            const values = [-2, 0, 1]; let currentValue = parseInt(element.textContent);
            let currentIndex = values.indexOf(currentValue); let newIndex = (currentIndex + 1) % values.length; let newValue = values[newIndex];
            element.textContent = newValue; element.className = element.className.replace(/cell-(negative|zero|positive)/g, '').trim();
            if (newValue === -2) element.classList.add('cell-negative');
            else if (newValue === 0) element.classList.add('cell-zero');
            else if (newValue === 1) element.classList.add('cell-positive');
            weekData[player][day][task] = newValue; updateWeekSummary(player); _saveToFirebaseInternal();
        }

        function calculateWeekScore(player) {
            let basicScore = 0, rewardScore = 0, penaltyScore = 0, consumeScore = 0, tradeScore = 0;
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            days.forEach(day => {
                const dayData = weekData[player][day];
                basicScore += (parseInt(dayData.book) || 0) + (parseInt(dayData.sleep) || 0) + (parseInt(dayData.exercise) || 0);
                rewardScore += (parseInt(dayData.reward) || 0); 
                penaltyScore += (parseInt(dayData.penalty) || 0); 
                consumeScore += (parseInt(dayData.consume) || 0); 
                tradeScore += (parseInt(dayData.trade) || 0); 
                // Directly add/subtract from tradeScore based on tradeFromLog and tradeToLog
                dayData.tradeFromLog.forEach(log => tradeScore -= log.amount); /* */ // Points flowing FROM this player
                dayData.tradeToLog.forEach(log => tradeScore += log.amount); /* */ // Points flowing TO this player
            });
            // Total score calculation now correctly reflects direct trade influences via tradeScore
            return { basic: basicScore, reward: rewardScore, penalty: penaltyScore, consume: consumeScore, trade: tradeScore, total: basicScore + rewardScore + penaltyScore - consumeScore + tradeScore }; /* */
        }

        function updateWeekSummary(player) {
            const scores = calculateWeekScore(player); const summaryElement = document.getElementById(`${player}-summary`);
            if (summaryElement) { summaryElement.innerHTML = `<strong>æœ¬å‘¨ç§¯åˆ†ï¼š${scores.total}åˆ† âœ¨</strong> <br> (åŸºç¡€: 0 ğŸ“š, å¥–åŠ±: 0 ğŸ, ç½šåˆ†: 0 ğŸ’”, è´­å¡: 0 ğŸ’³, äº¤æ˜“: 0 ğŸ”„)`;
                /* Update the week summary with accurate trade score */
                summaryElement.innerHTML = `<strong>æœ¬å‘¨ç§¯åˆ†ï¼š${scores.total}åˆ† âœ¨</strong> <br> (åŸºç¡€: ${scores.basic} ğŸ“š, å¥–åŠ±: ${scores.reward} ğŸ, ç½šåˆ†: ${scores.penalty} ğŸ’”, è´­å¡: ${scores.consume} ğŸ’³, äº¤æ˜“: ${scores.trade} ğŸ”„)`;
            }
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const playerTableBody = document.querySelector(`#${player}-summary`).closest('.week-card').querySelector('tbody');
            if (!playerTableBody) return;
            days.forEach((day, index) => {
                const dayRow = playerTableBody.querySelector(`tr:nth-child(${index + 1})`); if (!dayRow) return;
                const dayData = weekData[player][day];
                const rewardCell = dayRow.querySelector('td:nth-child(5)'); 
                if (rewardCell) { rewardCell.textContent = dayData.reward || 0; rewardCell.className = 'reward-cell'; const rewardValue = parseInt(dayData.reward) || 0; rewardCell.classList.add(`reward-${Math.min(3, Math.max(0, rewardValue))}`); }
                const penaltyInput = dayRow.querySelector('td:nth-child(6) input'); if (penaltyInput) penaltyInput.value = dayData.penalty || 0;
                const consumeInput = dayRow.querySelector('td:nth-child(7) input'); if (consumeInput) consumeInput.value = dayData.consume || 0;
                const tradeInput = dayRow.querySelector('td:nth-child(8) input'); if (tradeInput) tradeInput.value = dayData.trade || 0;
            });
        }
        
        function formatHistoryTimestamp(timestamp) { const date = new Date(timestamp); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }

        function renderScoreHistoryTable() {
            const tableBody = document.getElementById('score-history-table')?.querySelector('tbody'); if (!tableBody) return;
            tableBody.innerHTML = ''; 
            [...scoreHistoryLog].reverse().forEach(entry => {
                const row = tableBody.insertRow(); row.insertCell().textContent = formatHistoryTimestamp(entry.timestamp);
                const playerCell = row.insertCell(); playerCell.textContent = entry.player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'; playerCell.classList.add(entry.player === 'qiqi' ? 'player-qiqi' : 'player-yiyi', 'num-center');
                const basicScoreCell = row.insertCell(); basicScoreCell.classList.add('basic-score-details'); 
                if (entry.basicScoreDetails && entry.basicScoreDetails.length > 0) { const ul = document.createElement('ul'); entry.basicScoreDetails.forEach(detail => { const li = document.createElement('li'); li.textContent = `${dayChineseMap[detail.day] || detail.day} ${taskChineseMap[detail.task] || detail.task}: ${detail.score > 0 ? '+' : ''}${detail.score}åˆ†`; ul.appendChild(li); }); basicScoreCell.appendChild(ul); const totalBasicText = document.createElement('p'); totalBasicText.textContent = `(æ€»åŸºç¡€: ${entry.scores.basic}åˆ†)`; totalBasicText.style.textAlign = "center"; totalBasicText.style.fontWeight = "bold"; totalBasicText.style.marginTop = "5px"; basicScoreCell.appendChild(totalBasicText); } else { basicScoreCell.textContent = `${entry.scores.basic}åˆ† (æ— è¯¦æƒ…)`; basicScoreCell.classList.add('no-details');}
                const rewardCellTotal = row.insertCell(); rewardCellTotal.textContent = entry.scores.reward; rewardCellTotal.classList.add('num-center');
                const rewardDetailCell = row.insertCell(); rewardDetailCell.classList.add('basic-score-details');
                // Only show reward details that are NOT trade-in
                const filteredRewardDetails = entry.rewardDetails ? entry.rewardDetails.filter(d => d.type !== 'trade_in') : []; /* */
                if (filteredRewardDetails.length > 0) { const ul = document.createElement('ul'); filteredRewardDetails.forEach(detail => { const li = document.createElement('li'); li.textContent = `${detail.day ? (dayChineseMap[detail.day] || detail.day) + ' - ' : ''}${detail.desc}: +${detail.pointsAdded}åˆ†`; ul.appendChild(li); }); rewardDetailCell.appendChild(ul); } else if (entry.scores.reward > 0) { rewardDetailCell.textContent = `${entry.scores.reward}åˆ† (æ— éäº¤æ˜“å¥–åŠ±è¯¦æƒ…)`; } else { rewardDetailCell.textContent = 'æ— '; rewardDetailCell.classList.add('no-details');}
                
                // Penalty Details
                const penaltyCell = row.insertCell();
                // Only show penalty details that are NOT trade-out or IOU return deduction
                const filteredPenaltyDetails = entry.penaltyDetails ? entry.penaltyDetails.filter(p => p.type !== 'iou_return_deduction' && p.type !== 'trade_out') : []; /* */
                if (filteredPenaltyDetails.length > 0) {
                    const ul = document.createElement('ul');
                    filteredPenaltyDetails.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = `${p.desc}: ${p.pointsDeducted}åˆ†`;
                        ul.appendChild(li);
                    });
                    penaltyCell.appendChild(ul);
                } else {
                    penaltyCell.textContent = entry.scores.penalty !== 0 ? `${entry.scores.penalty}åˆ† (æ— éäº¤æ˜“ç½šåˆ†è¯¦æƒ…)` : 'æ— ';
                    if(entry.scores.penalty === 0) penaltyCell.classList.add('no-details');
                }

                // Consume Details
                const consumeCell = row.insertCell();
                if (entry.consumedItemsDetail && entry.consumedItemsDetail.length > 0) {
                    const ul = document.createElement('ul');
                    entry.consumedItemsDetail.forEach(item => {
                        const li = document.createElement('li');
                        let descText = `${item.name}${item.quantity > 1 ? ' x'+item.quantity : ''}`;
                        if (item.type === 'IOU') {
                            descText = `è´­ä¹°æ¬ æ¡ "${item.name}"`;
                        }
                        li.textContent = `${descText}: ${item.cost}åˆ†`;
                        ul.appendChild(li);
                    });
                    consumeCell.appendChild(ul);
                } else {
                    consumeCell.textContent = entry.scores.consume !== 0 ? `${entry.scores.consume}åˆ† (æ— è¯¦æƒ…)` : 'æ— ';
                    if(entry.scores.consume === 0) consumeCell.classList.add('no-details');
                }

                // Trade (T-card income) Details
                const tradeCell = row.insertCell();
                // Filter out trade_in and iou_return_gain from tradeDetails here as they will be in Transaction Details
                const filteredTradeDetails = entry.tradeDetails ? entry.tradeDetails.filter(t => t.type !== 'iou_purchase_income' && t.type !== 'iou_return_gain') : []; /* */
                if (filteredTradeDetails.length > 0) {
                    const ul = document.createElement('ul');
                    filteredTradeDetails.forEach(t => {
                        const li = document.createElement('li');
                        li.textContent = `${t.desc}: +${t.pointsAdded}åˆ†`;
                        ul.appendChild(li);
                    });
                    tradeCell.appendChild(ul);
                } else {
                    tradeCell.textContent = entry.scores.trade !== undefined ? entry.scores.trade : 'N/A';
                    if(entry.scores.trade === 0) tradeCell.classList.add('no-details');
                }
                tradeCell.classList.add('num-center'); // Ensure center alignment

                // NEW: Transaction Details (Transfer In/Out)
                const transactionDetailCell = row.insertCell();
                let hasTransactions = false;
                const transactionUl = document.createElement('ul');
                // Display direct trade-out
                if (entry.tradeFromLog && entry.tradeFromLog.length > 0) {
                    hasTransactions = true;
                    entry.tradeFromLog.forEach(log => {
                        const li = document.createElement('li');
                        li.textContent = `è½¬å‡ºç»™${log.toPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} (-${log.amount}åˆ†): ${log.memo}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display direct trade-in
                if (entry.tradeToLog && entry.tradeToLog.length > 0) {
                    hasTransactions = true;
                    entry.tradeToLog.forEach(log => {
                        const li = document.createElement('li');
                        li.textContent = `ä»${log.fromPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'}è½¬å…¥ (+${log.amount}åˆ†): ${log.memo}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display IOU purchase income (as it's a direct point transfer from one player to another)
                if (entry.tradeDetails) { // Re-checking original tradeDetails for IOU purchase income
                    entry.tradeDetails.filter(t => t.type === 'iou_purchase_income').forEach(t => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `æ¬ æ¡è´­å…¥æ”¶å…¥ (+${t.pointsAdded}åˆ†): ${t.desc}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display IOU return gain/deduction (as it's a direct point transfer)
                if (entry.tradeDetails) {
                    entry.tradeDetails.filter(t => t.type === 'iou_return_gain').forEach(t => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `æ¬ æ¡å½’è¿˜æ”¶å…¥ (+${t.pointsAdded}åˆ†): ${t.desc}`;
                        transactionUl.appendChild(li);
                    });
                }
                if (entry.penaltyDetails) {
                     entry.penaltyDetails.filter(p => p.type === 'iou_return_deduction').forEach(p => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `æ¬ æ¡å½’è¿˜æ‰£é™¤ (${p.pointsDeducted}åˆ†): ${p.desc}`;
                        transactionUl.appendChild(li);
                    });
                }


                if (hasTransactions) {
                    transactionDetailCell.appendChild(transactionUl);
                } else {
                    transactionDetailCell.textContent = 'æ— ';
                    transactionDetailCell.classList.add('no-details');
                }

                const totalCell = row.insertCell(); 
                totalCell.textContent = entry.scores.total; 
                totalCell.classList.add('total-highlight', 'num-center');
            });
        }

        // NEW: Function to open the confirmation modal for adding week total
        let playerToAddToTotal = null; // Store which player's data is being processed
        function openConfirmAddTotalModal(player) {
            requestEditPermission(() => {
                playerToAddToTotal = player;
                const scores = calculateWeekScore(player);
                const playerName = player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€';
                document.getElementById('confirm-add-total-title').textContent = `ç¡®è®¤æ“ä½œ`;
                document.getElementById('confirm-add-total-desc').innerHTML = `ç¡®å®šè¦å°† ${playerName} æœ¬å‘¨çš„ç§¯åˆ†æ€»è®¡ **${scores.total}åˆ†** åŠ å…¥æ€»åˆ†å¹¶æ¸…ç©ºæœ¬å‘¨æ•°æ®å—ï¼Ÿ`;
                document.getElementById('confirm-add-total-btn').onclick = () => {
                    addWeekTotalToTotal(playerToAddToTotal);
                    closeConfirmAddTotalModal();
                };
                document.getElementById('confirm-add-total-modal-overlay').style.display = 'flex';
            });
        }

        // NEW: Function to close the confirmation modal
        function closeConfirmAddTotalModal() {
            document.getElementById('confirm-add-total-modal-overlay').style.display = 'none';
            playerToAddToTotal = null;
        }

        function addWeekTotalToTotal(player) { requestEditPermission(() => _addWeekTotalToTotalInternal(player)); }
        function _addWeekTotalToTotalInternal(player) {
            const scores = calculateWeekScore(player); const sum = scores.total;
            const totalInput = document.getElementById(player + '-total'); let currentTotal = parseInt(totalInput.value) || 0;
            totalInput.value = currentTotal + sum;

            const consumedItemsDetail = []; 
            const penaltyDetails = []; 
            const basicScoreDetailsLog = []; 
            const rewardDetailsLog = []; 
            const tradeDetailsLog = []; // T-card income / IOU purchase income / IOU return gain
            const tradeFromLog = []; // Collect tradeFromLog
            const tradeToLog = [];    // Collect tradeToLog

            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            days.forEach(day => {
                if (weekData[player][day].purchaseLog) { weekData[player][day].purchaseLog.forEach(log => consumedItemsDetail.push(log));}
                if (weekData[player][day].penaltyLog) { weekData[player][day].penaltyLog.forEach(log => penaltyDetails.push(log));}
                if (weekData[player][day].rewardLog) { weekData[player][day].rewardLog.forEach(log => rewardDetailsLog.push({...log, day: day }));}
                if (weekData[player][day].tradeLog) { weekData[player][day].tradeLog.forEach(log => tradeDetailsLog.push({...log, day: day }));} 
                if (weekData[player][day].tradeFromLog) { weekData[player][day].tradeFromLog.forEach(log => tradeFromLog.push({...log, day: day }));} 
                if (weekData[player][day].tradeToLog) { weekData[player][day].tradeToLog.forEach(log => tradeToLog.push({...log, day: day }));}       

                ['book', 'sleep', 'exercise'].forEach(task => { const taskScore = parseInt(weekData[player][day][task]) || 0; if (taskScore !== 0) { basicScoreDetailsLog.push({ day: day, task: task, score: taskScore }); }});
            });
            
            const historyEntry = { 
                timestamp: Date.now(), 
                player: player, 
                scores: scores, 
                consumedItemsDetail: consumedItemsDetail, 
                penaltyDetails: penaltyDetails, 
                basicScoreDetails: basicScoreDetailsLog, 
                rewardDetails: rewardDetailsLog, 
                tradeDetails: tradeDetailsLog,
                tradeFromLog: tradeFromLog, 
                tradeToLog: tradeToLog         
            };
            scoreHistoryLog.unshift(historyEntry); renderScoreHistoryTable(); _saveScoreHistoryToFirebaseInternal(); 
            
            // Clear the current week's data after adding to total
            resetWeekData(player); 
            _saveToFirebaseInternal(); 

            alert(`å·²å°†æœ¬å‘¨æ€»åˆ†ï¼ˆ${sum}ï¼‰åŠ å…¥ ${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} æ€»ç§¯åˆ†ï¼æœ¬å‘¨æ•°æ®å·²æ¸…é›¶ï¼Œå†å²è®°å½•å·²æ›´æ–°ã€‚`);
        }
        
        function clearScoreHistory() { requestEditPermission(() => { if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç§¯åˆ†å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) { scoreHistoryLog = []; renderScoreHistoryTable(); database.ref('/scoreHistory').remove().then(() => alert('ç§¯åˆ†å†å²è®°å½•å·²æ¸…ç©ºï¼')).catch(error => alert('æ¸…ç©ºç§¯åˆ†å†å²è®°å½•å¤±è´¥: ' + error.message)); }});}

        function resetAllData() { requestEditPermission(() => { if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å— (åŒ…æ‹¬å‘¨è®°å½•, æ€»ç§¯åˆ†, ä»“åº“, è‡ªå®šä¹‰å¡ç‰‡å’Œç§¯åˆ†å†å²)ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) { 
            Object.keys(weekData).forEach(p => { Object.keys(weekData[p]).forEach(day => { weekData[p][day] = initialDayData(); }); });
            document.getElementById('qiqi-total').value = 0; document.getElementById('yiyi-total').value = 0;
            document.querySelectorAll('.clickable-cell[onclick*="toggleBasicTask"]').forEach(cell => { cell.textContent = '0'; cell.className = cell.className.replace(/cell-(negative|zero|positive)/g, '').trim() + ' cell-zero'; });
            document.querySelectorAll('.reward-cell').forEach(cell => { cell.textContent = '0'; cell.className = 'reward-cell reward-0'; });
            document.querySelectorAll('.small-input[readonly]').forEach(input => input.value = 0); 
            updateWeekSummary('qiqi'); updateWeekSummary('yiyi');
            warehousesData = { qiqi: [], yiyi: [] }; renderWarehouses();
            customDefinedCards = {}; 
            iouCardsData = {};
            hiddenPredefinedCardIds = []; 
            renderAllCards();
            database.ref('/customDefinedCards').remove(); 
            database.ref('/hiddenPredefinedCardIds').remove(); 
            database.ref('/iouCardsData').remove(); 
            scoreHistoryLog = []; renderScoreHistoryTable(); database.ref('/scoreHistory').remove(); 
            _saveToFirebaseInternal(); alert('æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼');
        }}); }

        function resetWeekData(player) { requestEditPermission(() => { 
            Object.keys(weekData[player]).forEach(day => { weekData[player][day] = initialDayData(); });
            const playerTable = document.querySelector(`#${player}-summary`).closest('.week-card').querySelector('.week-table');
            if (playerTable) {
                playerTable.querySelectorAll('.clickable-cell[onclick*="toggleBasicTask"]').forEach(cell => { cell.textContent = '0'; cell.className = cell.className.replace(/cell-(negative|zero|positive)/g, '').trim() + ' cell-zero'; });
                playerTable.querySelectorAll('.reward-cell').forEach(cell => { cell.textContent = '0'; cell.className = 'reward-cell reward-0'; });
                playerTable.querySelectorAll('td input[readonly]').forEach(input => input.value = 0);
            }
            updateWeekSummary(player); _saveToFirebaseInternal(); 
        });}

        function loadDataFromFirebase() {
            statusElement.textContent = 'ğŸ“¥ åŠ è½½æ•°æ®...'; statusElement.className = 'connection-status connecting';
            let loadedCount = 0; const totalToLoad = 6; 
            
            const allLoaded = () => {
                loadedCount++;
                if (loadedCount >= totalToLoad) {
                     setTimeout(() => {
                        statusElement.textContent = 'âœ… æ•°æ®å·²åŠ è½½'; statusElement.className = 'connection-status connected';
                        updateWeekSummary('qiqi'); updateWeekSummary('yiyi');
                        renderWarehouses(); renderScoreHistoryTable(); renderAllCards();
                    }, 500);
                }
            };

            database.ref('weekData').once('value').then((snapshot) => { if (snapshot.exists()) { const ld = snapshot.val(); Object.keys(ld).forEach(p=>{Object.keys(ld[p]).forEach(d=>{weekData[p][d]={...initialDayData(),...ld[p][d]}; weekData[p][d].purchaseLog = ld[p][d].purchaseLog || []; weekData[p][d].penaltyLog = ld[p][d].penaltyLog || []; weekData[p][d].rewardLog = ld[p][d].rewardLog || []; weekData[p][d].tradeLog = ld[p][d].tradeLog || []; weekData[p][d].tradeFromLog = ld[p][d].tradeFromLog || []; weekData[p][d].tradeToLog = ld[p][d].tradeToLog || []; });}); Object.entries(weekData).forEach(([p,days])=>{ const ptb=document.querySelector(`#${p}-summary`)?.closest('.week-card')?.querySelector('tbody'); if(!ptb)return; Object.entries(days).forEach(([day,sc])=>{ const di=['mon','tue','wed','thu','fri','sat','sun'].indexOf(day); if(di===-1)return; const tr=ptb.querySelector(`tr:nth-child(${di+1})`); if(!tr)return; Object.entries(sc).forEach(([k,v])=>{ if(['book','sleep','exercise'].includes(k)){const ci=['book','sleep','exercise'].indexOf(k)+2;const c=tr.querySelector(`td:nth-child(${ci})`);if(c){c.textContent=v; c.className=c.className.replace(/cell-(n|z|p).*/g,'').trim(); if(v===-2)c.classList.add('cell-negative'); else if(v===0)c.classList.add('cell-zero'); else if(v===1)c.classList.add('cell-positive');}} else if(k==='reward'){const c=tr.querySelector('td:nth-child(5)');if(c){c.textContent=v; c.className='reward-cell'; const rv=parseInt(v)||0; c.classList.add(`reward-${Math.min(3,Math.max(0,rv))}`);}} else if(k==='penalty'){const i=tr.querySelector('td:nth-child(6) input');if(i)i.value=v;} else if(k==='consume'){const i=tr.querySelector('td:nth-child(7) input');if(i)i.value=v;} else if(k==='trade'){const i=tr.querySelector('td:nth-child(8) input');if(i)i.value=v;}});});}); } allLoaded(); }).catch(err => { console.error("Error loading weekData: ", err); allLoaded(); });
            database.ref('totalScores').once('value').then((snapshot) => { if (snapshot.exists()) { const s = snapshot.val(); if (s.qiqi !== undefined) document.getElementById('qiqi-total').value = s.qiqi; if (s.yiyi !== undefined) document.getElementById('yiyi-total').value = s.yiyi;} allLoaded(); }).catch(err => { console.error("Error loading totalScores: ", err); allLoaded(); });
            database.ref('scoreHistory').once('value').then((snapshot) => { let lh = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; lh.forEach(e => { if (e.basicScoreDetails && !Array.isArray(e.basicScoreDetails)) e.basicScoreDetails = []; if (e.rewardDetails && !Array.isArray(e.rewardDetails)) e.rewardDetails = []; if (e.scores && e.scores.trade === undefined) e.scores.trade = 0; if (e.tradeDetails && !Array.isArray(e.tradeDetails)) e.tradeDetails = []; if (e.tradeFromLog && !Array.isArray(e.tradeFromLog)) e.tradeFromLog = []; if (e.tradeToLog && !Array.isArray(e.tradeToLog)) e.tradeToLog = []; }); scoreHistoryLog = lh; allLoaded(); }).catch(err => { console.error("Error loading scoreHistory: ", err); allLoaded(); });
            database.ref('warehousesData').once('value').then((snapshot) => { if (snapshot.exists()) { warehousesData = snapshot.val(); if (!Array.isArray(warehousesData.qiqi)) warehousesData.qiqi = []; if (!Array.isArray(warehousesData.yiyi)) warehousesData.yiyi = []; } else { warehousesData = { qiqi: [], yiyi: [] }; } allLoaded(); }).catch(err => { console.error("Error loading warehousesData: ", err); allLoaded(); });
            database.ref('customDefinedCards').once('value').then((snapshot) => { customDefinedCards = snapshot.exists() ? snapshot.val() : {}; allLoaded(); }).catch(err => { console.error("Error loading customDefinedCards: ", err); allLoaded(); }); 
            database.ref('hiddenPredefinedCardIds').once('value').then((snapshot) => { hiddenPredefinedCardIds = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; allLoaded(); }).catch(err => { console.error("Error loading hiddenPredefinedCardIds: ", err); allLoaded(); });
            database.ref('iouCardsData').once('value').then((snapshot) => { iouCardsData = snapshot.exists() ? snapshot.val() : {}; allLoaded(); }).catch(err => { console.error("Error loading iouCardsData: ", err); allLoaded(); });
        }

        function setupRealTimeSync() {
            database.ref('weekData').on('value', (snapshot) => { if(!snapshot.exists()) return; const nd = snapshot.val(); if(JSON.stringify(nd)!==JSON.stringify(weekData)){ Object.keys(nd).forEach(p=>{Object.keys(nd[p]).forEach(d=>{weekData[p][d]={...initialDayData(),...nd[p][d]};weekData[p][d].purchaseLog=nd[p][d].purchaseLog||[];weekData[p][d].penaltyLog=nd[p][d].penaltyLog||[];weekData[p][d].rewardLog=nd[p][d].rewardLog||[]; weekData[p][d].tradeLog=nd[p][d].tradeLog||[]; weekData[p][d].tradeFromLog=nd[p][d].tradeFromLog||[]; weekData[p][d].tradeToLog=nd[p][d].tradeToLog||[];});}); Object.entries(weekData).forEach(([p,days])=>{const ptb=document.querySelector(`#${p}-summary`)?.closest('.week-card')?.querySelector('tbody');if(!ptb)return;Object.entries(days).forEach(([day,sc])=>{const di=['mon','tue','wed','thu','fri','sat','sun'].indexOf(day);if(di===-1)return;const tr=ptb.querySelector(`tr:nth-child(${di+1})`);if(!tr)return;Object.entries(sc).forEach(([k,v])=>{if(['book','sleep','exercise'].includes(k)){const ci=['book','sleep','exercise'].indexOf(k)+2;const c=tr.querySelector(`td:nth-child(${ci})`);if(c&&c.textContent!=v){c.textContent=v;c.className=c.className.replace(/cell-(n|z|p).*/g,'').trim();if(v===-2)c.classList.add('cell-negative');else if(v===0)c.classList.add('cell-zero');else if(v===1)c.classList.add('cell-positive');}}else if(k==='reward'){const c=tr.querySelector('td:nth-child(5)');if(c&&c.textContent!=v){c.textContent=v;c.className='reward-cell';const rv=parseInt(v)||0;c.classList.add(`reward-${Math.min(3,Math.max(0,rv))}`);}}else if(k==='penalty'){const i=tr.querySelector('td:nth-child(6) input');if(i&&i.value!=v)i.value=v;}else if(k==='consume'){const i=tr.querySelector('td:nth-child(7) input');if(i&&i.value!=v)i.value=v;}else if(k==='trade'){const i=tr.querySelector('td:nth-child(8) input');if(i&&i.value!=v)i.value=v;}});});updateWeekSummary(p);});}});
            database.ref('totalScores').on('value', (snapshot) => { if(!snapshot.exists()) return; const s = snapshot.val(); const qi = document.getElementById('qiqi-total'); const yi = document.getElementById('yiyi-total'); if (s.qiqi !== undefined && qi.value != s.qiqi) qi.value = s.qiqi; if (s.yiyi !== undefined && yi.value != s.yiyi) yi.value = s.yiyi; });
            database.ref('scoreHistory').on('value', (snapshot) => { let nh = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; nh.forEach(e => { if (e.basicScoreDetails && !Array.isArray(e.basicScoreDetails)) e.basicScoreDetails = []; if (e.rewardDetails && !Array.isArray(e.rewardDetails)) e.rewardDetails = []; if (e.scores && e.scores.trade === undefined) e.scores.trade = 0; if (e.tradeDetails && !Array.isArray(e.tradeDetails)) e.tradeDetails = []; if (e.tradeFromLog && !Array.isArray(e.tradeFromLog)) e.tradeFromLog = []; if (e.tradeToLog && !Array.isArray(e.tradeToLog)) e.tradeToLog = []; }); if (JSON.stringify(nh) !== JSON.stringify(scoreHistoryLog)) { scoreHistoryLog = nh; renderScoreHistoryTable(); }});
            database.ref('warehousesData').on('value', (snapshot) => { let nw = {qiqi: [], yiyi: []}; if (snapshot.exists()) { nw = snapshot.val(); if (!Array.isArray(nw.qiqi)) nw.qiqi = []; if (!Array.isArray(nw.yiyi)) nw.yiyi = [];} if (JSON.stringify(nw) !== JSON.stringify(warehousesData)) { warehousesData = nw; renderWarehouses(); }});
            database.ref('customDefinedCards').on('value', (snapshot) => { let nc = snapshot.exists() ? snapshot.val() : {}; if (JSON.stringify(nc) !== JSON.stringify(customDefinedCards)) { customDefinedCards = nc; renderAllCards(); }}); 
            database.ref('hiddenPredefinedCardIds').on('value', (snapshot) => { let nhp = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; if (JSON.stringify(nhp) !== JSON.stringify(hiddenPredefinedCardIds)) { hiddenPredefinedCardIds = nhp; renderAllCards(); }});
            database.ref('iouCardsData').on('value', (snapshot) => { let niou = snapshot.exists() ? snapshot.val() : {}; if (JSON.stringify(niou) !== JSON.stringify(iouCardsData)) { iouCardsData = niou; renderAllCards(); }});
        }

        // Renamed and consolidated functions for defining cards
        function openDefineCustomCardModal(defaultPoints = null) {
            requestEditPermission(() => {
                document.getElementById('custom-card-name').value = ''; 
                const pointsInput = document.getElementById('custom-card-points');
                pointsInput.value = defaultPoints !== null ? defaultPoints : '';
                document.getElementById('custom-card-type').value = 'E'; 
                document.getElementById('custom-card-desc').value = '';
                document.getElementById('define-custom-card-modal-overlay').style.display = 'flex'; 
                document.getElementById('custom-card-name').focus();
            });
        }
        function closeDefineCustomCardModal() { document.getElementById('define-custom-card-modal-overlay').style.display = 'none'; }
        function defineAndListCustomCard() { requestEditPermission(_defineAndListCustomCardInternal); }
        function _defineAndListCustomCardInternal() {
            const name = document.getElementById('custom-card-name').value.trim(); 
            const points = parseInt(document.getElementById('custom-card-points').value);
            const type = document.getElementById('custom-card-type').value; 
            const desc = document.getElementById('custom-card-desc').value.trim();
            if (!name) { alert('è¯·è¾“å…¥å¡ç‰‡åç§°ã€‚'); return; } if (isNaN(points) || points <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ¶ˆè€—ã€‚'); return; }
            if (!type) { alert('è¯·é€‰æ‹©å¡ç‰‡ç±»å‹ã€‚'); return; } 
            // Hç±»å‹å¡ç‰‡ä¸éœ€è¦æè¿°
            if (type !== 'H' && !desc) { alert('è¯·è¾“å…¥å¡ç‰‡æè¿°ã€‚'); return; } 

            const nameConflict = Object.values(customDefinedCards).some(card => card.name === name) ||
                                 Object.values(iouCardsData).some(card => card.name === name) ||
                                 Array.from(document.querySelectorAll('#main-cards-grid .card-item[data-name]')).some(el => el.dataset.name === name && !hiddenPredefinedCardIds.includes(el.id));
            if (nameConflict) { alert('å·²å­˜åœ¨åŒåå¡ç‰‡ (åŒ…æ‹¬é¢„è®¾ã€è‡ªå®šä¹‰æˆ–æ¬ æ¡å¡ç‰‡)ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°ã€‚'); return; } 
            
            const cardId = 'custom_' + Date.now();
            customDefinedCards[cardId] = { id: cardId, name: name, points: points, type: type, desc: desc, isCustom: true }; 
            renderAllCards(); _saveToFirebaseInternal(); closeDefineCustomCardModal(); alert(`è‡ªå®šä¹‰å¡ç‰‡ "${name}" å·²åˆ›å»ºå¹¶ä¸Šæ¶ï¼`);
        }

        // IOU Card Definition Functions
        function openDefineIOUCardModal() {
            requestEditPermission(() => {
                document.getElementById('iou-card-points').value = '';
                document.getElementById('iou-card-interest').value = '10'; // Default 10% interest
                document.getElementById('define-IOU-card-modal-overlay').style.display = 'flex';
                document.getElementById('iou-card-points').focus();
            });
        }

        function closeDefineIOUCardModal() {
            document.getElementById('define-IOU-card-modal-overlay').style.display = 'none';
        }

        function defineAndListIOUCard() { requestEditPermission(_defineAndListIOUCardInternal); }
        function _defineAndListIOUCardInternal() {
            const points = parseInt(document.getElementById('iou-card-points').value);
            const interest = parseInt(document.getElementById('iou-card-interest').value);
            const cardName = `æ¬ æ¡ (é¢å€¼${points}, åˆ©æ¯${interest}%)`;

            if (isNaN(points) || points <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¬ æ¡é¢å€¼ (å¤§äº0)ã€‚'); return; }
            if (isNaN(interest) || interest < 0 || interest > 100) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ©æ¯ç™¾åˆ†æ¯” (0-100)ã€‚'); return; }
            
            // Check for name conflict (though name includes points and interest, it's good practice)
            const nameConflict = Object.values(customDefinedCards).some(card => card.name === cardName) ||
                                 Object.values(iouCardsData).some(card => card.name === cardName) ||
                                 Array.from(document.querySelectorAll('#main-cards-grid .card-item[data-name]')).some(el => el.dataset.name === cardName && !hiddenPredefinedCardIds.includes(el.id));
            if (nameConflict) { alert('å·²å­˜åœ¨ç›¸åŒé¢å€¼å’Œåˆ©æ¯çš„æ¬ æ¡ï¼Œè¯·è°ƒæ•´åé‡æ–°å®šä¹‰ã€‚'); return; }

            const cardId = 'iou_' + Date.now();
            iouCardsData[cardId] = {
                id: cardId,
                name: cardName,
                points: points, // Purchase price
                type: 'IOU',
                desc: `æ­¤æ¬ æ¡é¢å€¼${points}ç§¯åˆ†ï¼Œä½¿ç”¨æ—¶éœ€å½’è¿˜${interest}%åˆ©æ¯ã€‚`,
                interestRate: interest // Interest percentage
            };
            renderAllCards();
            _saveToFirebaseInternal();
            closeDefineIOUCardModal();
            alert(`æ¬ æ¡å¡ç‰‡ "${cardName}" å·²åˆ›å»ºå¹¶ä¸Šæ¶ï¼`);
        }

        // IOU Card Return Functions
        let currentIOUCardToReturn = null;
        function openIOUReturnModal(player, cardName) {
            requestEditPermission(() => {
                const card = warehousesData[player].find(c => c.name === cardName && c.type === 'IOU');
                if (!card) return;

                const returnAmount = card.pointsValue + Math.round(card.pointsValue * (card.interestRate / 100));
                document.getElementById('iou-return-modal-title').textContent = `å½’è¿˜æ¬ æ¡ "${cardName}"`;
                document.getElementById('iou-return-modal-desc').textContent = `ç¡®è®¤åï¼Œ${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å°†è·å¾— ${returnAmount} ç§¯åˆ†ï¼Œ${player === 'qiqi' ? 'ä¸€ä¸€' : 'ä¸ƒä¸ƒ'} å°†æ‰£é™¤ ${returnAmount} ç§¯åˆ†ã€‚`;
                document.getElementById('confirm-iou-return-btn').onclick = () => processIOUReturn(player, card);
                document.getElementById('iou-return-modal-overlay').style.display = 'flex';
            });
        }

        function closeIOUReturnModal() {
            document.getElementById('iou-return-modal-overlay').style.display = 'none';
            currentIOUCardToReturn = null;
        }

        function processIOUReturn(player, card) { requestEditPermission(() => _processIOUReturnInternal(player, card)); }
        function _processIOUReturnInternal(player, card) {
            if (!card || card.type !== 'IOU') { alert('æ— æ•ˆçš„æ¬ æ¡å¡ç‰‡ä¿¡æ¯ã€‚'); closeIOUReturnModal(); return; }

            const returnAmount = card.pointsValue + Math.round(card.pointsValue * (card.interestRate / 100));
            const otherPlayer = player === 'qiqi' ? 'yiyi' : 'qiqi';
            const today = new Date();
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const currentDayKey = dayNames[today.getDay()];

            // User gets points (è®¡å…¥trade)
            weekData[player][currentDayKey].trade = (parseInt(weekData[player][currentDayKey].trade) || 0) + returnAmount; /* */
            // Other player loses points (ä»tradeä¸­æ‰£é™¤)
            weekData[otherPlayer][currentDayKey].trade = (parseInt(weekData[otherPlayer][currentDayKey].trade) || 0) - returnAmount; /* */

            // Record to history logs (ä½¿ç”¨tradeToLogå’ŒtradeFromLog)
            if (!weekData[player][currentDayKey].tradeToLog) weekData[player][currentDayKey].tradeToLog = [];
            weekData[player][currentDayKey].tradeToLog.push({ desc: `ä½¿ç”¨æ¬ æ¡ "${card.name}" å½’è¿˜`, amount: returnAmount, fromPlayer: otherPlayer, type: 'iou_return_gain' }); /* */

            if (!weekData[otherPlayer][currentDayKey].tradeFromLog) weekData[otherPlayer][currentDayKey].tradeFromLog = [];
            weekData[otherPlayer][currentDayKey].tradeFromLog.push({ desc: `å› å¯¹æ–¹ä½¿ç”¨æ¬ æ¡ "${card.name}" è¢«æ‰£é™¤ (å«åˆ©æ¯)`, amount: returnAmount, toPlayer: player, type: 'iou_return_deduction' }); /* */


            // Remove card from warehouse
            const playerWarehouse = warehousesData[player];
            const cardIndex = playerWarehouse.findIndex(c => c.name === card.name && c.type === 'IOU');
            if (cardIndex !== -1) {
                if (playerWarehouse[cardIndex].quantity > 1) {
                    playerWarehouse[cardIndex].quantity--;
                } else {
                    playerWarehouse.splice(cardIndex, 1);
                }
            }

            updateWeekSummary(player);
            updateWeekSummary(otherPlayer);
            renderWarehouses();
            _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å·²å½’è¿˜æ¬ æ¡ "${card.name}"ï¼Œè·å¾— ${returnAmount} ç§¯åˆ†ï¼${otherPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} æ‰£é™¤ ${returnAmount} ç§¯åˆ†ã€‚`);
            closeIOUReturnModal();
        }

        function getCardColorClass(points) {
            if (points === 1) return 'points-1'; if (points === 2) return 'points-2'; if (points >= 3 && points <= 4) return 'points-3';
            if (points >= 5 && points <= 9) return 'points-5'; if (points >= 10 && points <= 19) return 'points-10'; if (points >= 20) return 'points-20';
            return 'points-1'; // Default
        }
        
        function renderAllCards() {
            // 1. Render Predefined Cards (handle hidden state)
            document.querySelectorAll('#main-cards-grid .card-item[id^="predef_"]').forEach(cardEl => {
                if (hiddenPredefinedCardIds.includes(cardEl.id)) {
                    cardEl.style.display = 'none';
                } else {
                    cardEl.style.display = ''; 
                }
            });
            
            // 2. Clear existing dynamically added custom cards from main grid before re-rendering
            // Also clear the custom cards grid within the .custom-cards-section
            document.querySelectorAll('#main-cards-grid .card-item[data-custom="true"]').forEach(el => el.remove());
            const customCardsGrid = document.getElementById('temp-cards-grid'); 
            customCardsGrid.innerHTML = ''; 
            const noCustomItemsText = document.getElementById('no-temp-cards-text'); 
            if (noCustomItemsText) customCardsGrid.appendChild(noCustomItemsText); 

            // 3. Render Custom Cards (formerly temporary and permanent) into their dedicated section AND main sections
            const customCardsArray = Object.values(customDefinedCards);
            const customSectionWrapper = document.getElementById('temporary-cards-section'); 
            
            if (customCardsArray.length > 0) {
                customSectionWrapper.style.display = 'block'; 
                if(noCustomItemsText) noCustomItemsText.style.display = 'none'; 
                
                customCardsArray.forEach(card => {
                    const cardPoints = parseInt(card.points);
                    const colorClass = getCardColorClass(cardPoints);
                    
                    // Add to Custom Cards Section (the box at the top)
                    const customCardElInCustomSection = document.createElement('div'); 
                    customCardElInCustomSection.className = `card-item ${colorClass}`; 
                    customCardElInCustomSection.onclick = (event) => { /* Added event parameter */
                        event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                        openBuyerModal(card.points, card.type, card.name, true, card.id); 
                    };
                    customCardElInCustomSection.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'custom')">âŒ</button>`; /* Added event.stopPropagation() here */
                    
                    customCardsGrid.appendChild(customCardElInCustomSection); 

                    // Also add to Main Cards Grid if it's not an H type (H cards are direct use, not for purchase)
                    if (card.type !== 'H') { 
                        let targetSection = document.querySelector(`#main-cards-grid .points-section.${colorClass}`); 
                        if (!targetSection) { 
                            // Create section if it doesn't exist for this point value
                            targetSection = document.createElement('div'); 
                            targetSection.className = `points-section ${colorClass}`; 
                            const h3 = document.createElement('h3'); 
                            h3.innerHTML = `è‡ªå®šä¹‰ ${cardPoints}ç§¯åˆ† <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(${cardPoints})">âŠ• æ·»åŠ </button>`; 
                            targetSection.appendChild(h3); 
                            document.getElementById('main-cards-grid').appendChild(targetSection); 
                        }
                        const cardElInMainGrid = document.createElement('div'); 
                        cardElInMainGrid.className = 'card-item'; 
                        cardElInMainGrid.dataset.points = card.points; cardElInMainGrid.dataset.type = card.type; cardElInMainGrid.dataset.name = card.name; 
                        cardElInMainGrid.dataset.id = card.id; cardElInMainGrid.dataset.custom = "true"; 
                        cardElInMainGrid.onclick = (event) => { /* Added event parameter */
                            event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                            openBuyerModal(card.points, card.type, card.name, true, card.id); 
                        };
                        cardElInMainGrid.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'custom')">âŒ</button>`; /* Added event.stopPropagation() here */
                        targetSection.appendChild(cardElInMainGrid); 
                    }
                });
            } else {
                if(noCustomItemsText) noCustomItemsText.style.display = 'block'; 
            }

            // 4. Clear existing dynamically added IOU cards from main grid
            document.querySelectorAll('#main-cards-grid .points-section.points-iou').forEach(el => el.remove()); 

            // 5. Render IOU Cards into a new section in main-cards-grid
            const mainCardsGrid = document.getElementById('main-cards-grid'); 
            if (Object.keys(iouCardsData).length > 0) { 
                const iouSection = document.createElement('div'); 
                iouSection.className = 'points-section points-iou'; 
                iouSection.innerHTML = `<h3>ğŸ“ æ¬ æ¡å¡ç‰‡ <button class="add-card-to-section-btn" onclick="openDefineIOUCardModal()">âŠ• æ·»åŠ </button></h3>`;
                
                Object.values(iouCardsData).forEach(card => { 
                    const cardEl = document.createElement('div'); 
                    cardEl.className = 'card-item'; 
                    cardEl.dataset.points = card.points; 
                    cardEl.dataset.type = card.type; 
                    cardEl.dataset.name = card.name; 
                    cardEl.dataset.id = card.id; 
                    cardEl.dataset.iou = "true"; 
                    cardEl.onclick = (event) => { /* Added event parameter */
                        event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                        openBuyerModal(card.points, card.type, card.name, false, card.id); 
                    };
                    cardEl.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'iou')">âŒ</button>`; /* Added event.stopPropagation() here */
                    iouSection.appendChild(cardEl); 
                });
                mainCardsGrid.appendChild(iouSection); 
            }
        }


        function handleDeleteCard(identifier, cardTypeString) {
            requestEditPermission(() => {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿ\nç±»å‹: ${cardTypeString}\nID/åç§°: ${identifier}`)) return;

                if (cardTypeString === 'predefined') {
                    if (!hiddenPredefinedCardIds.includes(identifier)) {
                        hiddenPredefinedCardIds.push(identifier);
                    }
                } else if (cardTypeString === 'custom') { 
                    delete customDefinedCards[identifier];
                } else if (cardTypeString === 'iou') {
                    delete iouCardsData[identifier];
                }
                renderAllCards(); 
                _saveToFirebaseInternal(); 
                alert('å¡ç‰‡å·²åˆ é™¤/éšè—ã€‚');
            });
        }

        // NEW: Function for direct points trade
        function executePointsTrade() {
            requestEditPermission(() => _executePointsTradeInternal());
        }

        function _executePointsTradeInternal() {
            const fromPlayer = document.getElementById('trade-from').value;
            const toPlayer = document.getElementById('trade-to').value;
            const amount = parseInt(document.getElementById('trade-amount').value);
            const memo = document.getElementById('trade-memo').value.trim();

            if (!fromPlayer || !toPlayer) {
                alert('è¯·é€‰æ‹©è½¬è´¦æ–¹å’Œæ¥æ”¶æ–¹ï¼');
                return;
            }

            if (fromPlayer === toPlayer) {
                alert('è½¬è´¦æ–¹å’Œæ¥æ”¶æ–¹ä¸èƒ½æ˜¯åŒä¸€äººï¼');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡ï¼');
                return;
            }

            if (!memo) {
                alert('è¯·å¡«å†™äº¤æ˜“å¤‡æ³¨ï¼');
                return;
            }

            const today = new Date();
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const currentDayKey = dayNames[today.getDay()];

            // === ä¿®æ”¹ç‚¹1ï¼šè½¬å‡ºæ–¹ç§¯åˆ†ç›´æ¥ä» trade åˆ—æ‰£é™¤ ===
            weekData[fromPlayer][currentDayKey].trade = (parseInt(weekData[fromPlayer][currentDayKey].trade) || 0) - amount; 
            // è®°å½•è½¬è´¦æ–¹è½¬å‡ºæ˜ç»†
            if (!weekData[fromPlayer][currentDayKey].tradeFromLog) weekData[fromPlayer][currentDayKey].tradeFromLog = [];
            weekData[fromPlayer][currentDayKey].tradeFromLog.push({ amount: amount, toPlayer: toPlayer, memo: memo, type: 'direct_trade_out' }); 

            // === ä¿®æ”¹ç‚¹2ï¼šæ¥æ”¶æ–¹ç§¯åˆ†ç›´æ¥å¢åŠ åˆ° trade åˆ— ===
            weekData[toPlayer][currentDayKey].trade = (parseInt(weekData[toPlayer][currentDayKey].trade) || 0) + amount; 
            // è®°å½•æ¥æ”¶æ–¹è½¬å…¥æ˜ç»†
            if (!weekData[toPlayer][currentDayKey].tradeToLog) weekData[toPlayer][currentDayKey].tradeToLog = [];
            weekData[toPlayer][currentDayKey].tradeToLog.push({ amount: amount, fromPlayer: fromPlayer, memo: memo, type: 'direct_trade_in' }); 

            updateWeekSummary(fromPlayer);
            updateWeekSummary(toPlayer);
            _saveToFirebaseInternal();

            alert(`äº¤æ˜“æˆåŠŸï¼\n${fromPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} å‘ ${toPlayer === 'qiqi' ? 'ä¸ƒä¸ƒ' : 'ä¸€ä¸€'} è½¬è´¦ ${amount} ç§¯åˆ†\nå¤‡æ³¨ï¼š${memo}`);

            // æ¸…ç©ºè¡¨å•
            document.getElementById('trade-from').value = '';
            document.getElementById('trade-to').value = '';
            document.getElementById('trade-amount').value = '';
            document.getElementById('trade-memo').value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // No initial login needed, so hide the login overlay
            document.getElementById('login-overlay').style.display = 'none'; 
            document.querySelector('.content').classList.remove('locked'); // Ensure content is unlocked

            // Add event listeners that require edit permission
            ['qiqi-total', 'yiyi-total'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    saveToFirebase(); // This will trigger requestEditPermission
                });
            });
            
            loadDataFromFirebase(); 
            setupRealTimeSync();

            document.querySelectorAll('.total-score-input').forEach(input => {
                input.addEventListener('blur', function() {
                    let value = parseInt(this.value) || 0; if (value < 0) value = 0; if (value > 9999999) value = 9999999;
                    if (this.value !== value.toString()) { this.value = value; saveToFirebase(false); } else { this.value = value; }
                });
            });
            const initialActiveTab = document.querySelector('.nav-tab.active');
            if (initialActiveTab) { const pageIdMatch = initialActiveTab.getAttribute('onclick').match(/showPage\('([^']*)'\)/); if (pageIdMatch && pageIdMatch[1]) showPage(pageIdMatch[1]); else showPage('daily'); } else { showPage('daily'); }
            // renderAllCards is called within allLoaded() after Firebase data is fetched

            // NEW: åŠ¨æ€æ›´æ–°æ¥æ”¶æ–¹é€‰é¡¹çš„ç›‘å¬å™¨
            document.getElementById('trade-from').addEventListener('change', function() {
                const toSelect = document.getElementById('trade-to');
                const fromValue = this.value;
                
                toSelect.innerHTML = '<option value="">è¯·é€‰æ‹©</option>'; // Clearæ¥æ”¶æ–¹é€‰é¡¹
                
                if (fromValue === 'qiqi') {
                    toSelect.innerHTML += '<option value="yiyi">ä¸€ä¸€</option>';
                } else if (fromValue === 'yiyi') {
                    toSelect.innerHTML += '<option value="qiqi">ä¸ƒä¸ƒ</option>';
                } else {
                    // If 'from' is empty, show both options for 'to'
                    toSelect.innerHTML += '<option value="qiqi">ä¸ƒä¸ƒ</option><option value="yiyi">ä¸€ä¸€</option>';
                }
            });
        });

    </script>
</body>
</html>
