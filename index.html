<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2); }
            to { text-shadow: 2px 2px 4px rgba(255,255,255,0.4), 0 0 20px rgba(0,0,0,0.3); }
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: white;
            padding: 15px 25px;
            margin: 5px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            min-height: 600px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page h2 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        /* Login/Edit Password Modal Styles */
        .login-overlay { /* Used for original login (now hidden by default) and edit password */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .login-box { /* Shared style for login/edit password containers */
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .login-box h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-input { /* Shared style for password inputs */
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        #permanent-card-desc {
            resize: vertical;
        }

        .login-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .login-btn { /* Shared style for login/edit password confirm buttons */
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .login-error { /* Shared style for password error messages */
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #ffebee;
            border-radius: 8px;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected { background: #27ae60; }
        .connection-status.disconnected { background: #e74c3c; }
        .connection-status.connecting { background: #f39c12; }

        .daily-schedule { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .daily-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .daily-table th, .daily-table td { padding: 12px; text-align: center; border: 2px solid #e9ecef; }
        .daily-table th { background: linear-gradient(45deg, #3498db, #2980b9); color: white; font-weight: bold; }
        .daily-table tr:nth-child(even) { background-color: #f8f9fa; }
        .daily-table tr:hover { background-color: #e3f2fd; transform: scale(1.01); transition: all 0.3s ease; }

        .points-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin: 30px 0; }
        .points-section, .weekly-rewards-section, .warehouse-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-top: 5px solid; margin-bottom: 30px; }
        .points-1 { border-top-color: #2ecc71; } .points-2 { border-top-color: #f39c12; } .points-3 { border-top-color: #e74c3c; } .points-5 { border-top-color: #9b59b6; } .points-10 { border-top-color: #34495e; } .points-20 { border-top-color: #e67e22; }
        .points-iou { border-top-color: #f39c12; } /* Added for IOU cards */
        .weekly-rewards-section { border-top-color: #1abc9c; }
        .warehouse-section { border-top-color: #3498db; }
        /* Custom Card section style */
        .custom-cards-section {
            background: white; /* Match other sections */
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 5px solid #9b59b6; /* Purple border for custom cards */
            margin-bottom: 30px;
        }
        .points-section h3, .weekly-rewards-section h3, .warehouse-section h3 { /* Removed custom-cards-section h3 from here */
            text-align: center; margin-bottom: 20px; font-size: 1.8em; color: #2c3e50;
        }

        /* NEW: Styles for centering and bolding the custom cards section heading */
        .custom-cards-section h3 {
            text-align: center; /* 确保文字内容居中 */
            font-weight: bold; /* 加粗文字 */
            /* 覆盖 flex 布局，让内容块级居中 */
            display: block; 
            width: 100%; /* 确保占据父元素全部宽度以便text-align生效 */
            position: relative; /* 为内部的绝对定位按钮提供参考 */
            margin-top: 0px; /* 确保不被之前的样式影响到 */
            margin-bottom: 20px; /* 保持与其他H3的间距 */
            font-size: 1.8em; /* 保持与其他H3的字体大小一致 */
            color: #2c3e50; /* 保持与其他H3的颜色一致 */
        }

        /* 为了不影响旁边的“⊕ 添加”按钮，我们需要为按钮单独设置定位 */
        .custom-cards-section h3 .add-card-to-section-btn {
            position: absolute; /* 绝对定位 */
            right: 0px; /* 根据需要调整距离右侧的距离，这里设置为0，让按钮贴着右侧 */
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%); /* 精确垂直居中 */
        }
        /* End NEW styles */
        
        .card-item { background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 10px; border-left: 4px solid #3498db; transition: all 0.3s ease; cursor: pointer; position: relative; /* For delete button */ }
        .card-item.info-card { border-left-color: #1abc9c; }
        .card-item:hover:not(.info-card) { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-item.info-card[data-type="special-reward"]:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-title { font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 1.1em; }
        .card-desc { color: #7f8c8d; font-size: 0.95em; line-height: 1.5; }

        /* Delete Button on Cards */
        .card-item .delete-card-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 13px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 1; /* Ensure it's above card content */
        }
        .card-item .delete-card-btn:hover { opacity: 1; background: #c0392b; transform: scale(1.1); }

        /* Style for the "Add Card to Section" button */
        /* Removed flex properties from here as they are now handled by .custom-cards-section h3 */
        .add-card-to-section-btn {
            background-color: #5dade2; /* Light blue */
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 0.8em;
            /* margin-left: 10px; */ /* Let flexbox handle spacing */
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .add-card-to-section-btn:hover {
            background-color: #2e86c1; /* Darker blue */
        }


        .warehouse-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .warehouse-owner-column h4 { text-align: center; font-size: 1.3em; color: #34495e; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #bdc3c7; }
        .warehouse-card-item { background: #ecf0f1; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #2980b9; }
        .warehouse-card-info .name { font-weight: bold; font-size: 1em; }
        .warehouse-card-info .qty { font-size: 0.9em; color: #7f8c8d; }
        .warehouse-card-item .use-card-btn { background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s; }
        .warehouse-card-item .use-card-btn:hover { background: #229954; }
        .no-cards-text { text-align: center; color: #95a5a6; padding: 20px; }

        .penalty-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0; }
        .penalty-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .penalty-left { border-top: 5px solid #e74c3c; } .penalty-right { border-top: 5px solid #27ae60; }
        .penalty-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .penalty-table th, .penalty-table td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .penalty-table th { background: #f8f9fa; font-weight: bold; color: #2c3e50; }
        .penalty-score { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; text-align: center; min-width: 40px; display: inline-block; }
        .penalty-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .penalty-item:last-child { border-bottom: none; }
        .penalty-item-info { display: flex; align-items: center; gap: 10px; }
        .penalty-action-buttons button { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 5px; transition: background-color 0.3s; }
        .penalty-action-buttons button:hover { background: #c0392b; }
        .penalty-action-buttons button.custom-penalty-btn { background: #f39c12; }
        .penalty-action-buttons button.custom-penalty-btn:hover { background: #e67e22; }

        .bank-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin: 30px 0; }
        .week-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-top: 5px solid #3498db; }
        .week-title { text-align: center; font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 10px; }
        .week-table { width: 100%; border-collapse: collapse; }
        .week-table th, .week-table td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        .week-table th { background: #f8f9fa; font-weight: bold; font-size: 0.9em; }
        .stats-overview { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-item { background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 20px; border-radius: 10px; transition: transform 0.3s ease; }
        .stat-item:hover { transform: scale(1.05); }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .clickable-cell { cursor: pointer; transition: all 0.3s ease; user-select: none; }
        .clickable-cell:hover { background-color: #e3f2fd !important; transform: scale(1.05); }
        .cell-negative { background-color: #ffebee !important; color: #c62828; }
        .cell-zero { background-color: #ffffff !important; color: #333; }
        .cell-positive { background-color: #e8f5e8 !important; color: #2e7d32; }
        .reward-0 { background-color: #f0f0f0 !important; } .reward-1 { background-color: #e3f2fd !important; } .reward-2 { background-color: #ede7f6 !important; } .reward-3 { background-color: #fff3e0 !important; }
        .reward-cell {}
        .small-input { width: 50px; padding: 3px; border: 1px solid #ddd; border-radius: 3px; text-align: center; background: #fff; font-size: 0.85em; }
        .small-input[readonly] { background-color: #f8f9fa; color: #555; border: 1px solid #eee; }
        .week-summary { text-align: center; margin-top: 15px; padding: 15px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border-radius: 10px; font-size: 1.1em; font-weight: bold; line-height: 1.8; }
        .total-scores { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .score-boards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .score-board { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .player-name { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
        .total-score-input { font-size: 2.5em; font-weight: bold; margin: 10px 0; background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; text-align: center; border-radius: 8px; padding: 10px; width: 100%; }
        .total-score-input::placeholder { color: rgba(255,255,255,0.7); }
        .control-buttons { text-align: center; margin-top: 20px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 5px; font-size: 1em; transition: all 0.3s ease; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-danger { background: #e74c3c; } .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #7f8c8d; } .btn-secondary:hover { background: #6c7a7d; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; max-width: 450px; width: 90%; animation: slideIn 0.3s ease-out; }
        .modal-content h3 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8em; }
        .modal-buttons button { color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 8px 5px; transition: all 0.3s ease; min-width: 100px; }
        .modal-buttons button:hover { transform: translateY(-2px); }
        .modal-buttons button.confirm-btn { background: linear-gradient(45deg, #3498db, #2980b9); }
        .modal-buttons button.confirm-btn:hover { box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); }
        .modal-buttons button.cancel-btn { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }
        .modal-buttons button.cancel-btn:hover { box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3); }
        .penalty-modal-buttons button.confirm-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .penalty-modal-buttons button.confirm-btn:hover { box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); }
        .week-card .btn-secondary { display: block; margin: 15px auto 0; }
        
        #history .table-container { max-height: 600px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; }
        #score-history-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9em; }
        #score-history-table th, #score-history-table td { padding: 10px 12px; text-align: left; border: 1px solid #e0e0e0; vertical-align: top; }
        #score-history-table th { background: linear-gradient(45deg, #3498db, #2980b9); color: white; font-weight: bold; text-align: center; }
        #score-history-table tr:nth-child(even) { background-color: #f8f9fa; }
        #score-history-table tr:hover { background-color: #e9f5ff; }
        #score-history-table td.player-qiqi { color: #9b59b6; font-weight: bold; }
        #score-history-table td.player-yiyi { color: #3498db; font-weight: bold; }
        #score-history-table td.total-highlight { font-weight: bold; color: #27ae60; text-align: center; }
        #score-history-table td.num-center { text-align: center; }
        #score-history-table ul { margin: 0; padding-left: 15px; font-size: 0.9em; }
        #score-history-table ul li { margin-bottom: 3px; }
        #score-history-table .no-details { color: #999; font-style: italic; text-align: center; }
        #score-history-table .basic-score-details ul { padding-left: 10px; font-size: 0.85em; list-style-type: disc; }
        #score-history-table .basic-score-details li { margin-bottom: 2px; }

        /* 积分交易系统样式 */
        .trade-system {
            background: linear-gradient(45deg, #a8e6cf 0%, #88d8a3 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .trade-system h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .trade-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .trade-input-group {
            display: flex;
            flex-direction: column;
        }

        .trade-input-group label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .trade-input, .trade-select, .trade-textarea {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255,255,255,0.95);
            color: #333;
            transition: all 0.3s ease;
        }

        .trade-input:focus, .trade-select:focus, .trade-textarea:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }

        .trade-textarea {
            resize: vertical;
            min-height: 40px;
        }

        .trade-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-height: 46px;
        }

        .trade-btn:hover {
            background: white;
            color: #88d8a3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }


        @media (max-width: 768px) {
            .container { padding: 5px; } .header h1 { font-size: 1.8em; } .header p { font-size: 1em; }
            .content { padding: 15px; margin: 10px 5px; } .penalty-section { grid-template-columns: 1fr; gap: 20px; }
            .nav-tabs { flex-direction: row; flex-wrap: wrap; padding: 5px;} .nav-tab { padding: 10px 15px; font-size: 0.9em; margin: 2px;}
            .score-boards { grid-template-columns: 1fr; gap: 15px;} .week-table { font-size: 0.75em;}
            .week-table th, .week-table td { padding: 3px 2px; font-size: 0.75em;}
            .small-input {width: 30px; font-size: 0.7em; padding: 1px;}
            .week-table-container, #history .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch;}
            .clickable-cell { min-width: 30px;} .connection-status { top: 10px; right: 10px; padding: 8px 12px; font-size: 0.8em;}
            #score-history-table { font-size: 0.8em;} #score-history-table th, #score-history-table td { padding: 6px 4px;}
            .warehouse-grid { grid-template-columns: 1fr; }
            .trade-form { grid-template-columns: 1fr; gap: 10px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5em;} .nav-tab { padding: 8px 10px; font-size: 0.75em;}
            .content { padding: 10px;} .week-table th, .week-table td { padding: 2px 1px; font-size: 0.65em;}
            .small-input { width: 25px; font-size: 0.6em; padding: 1px;}
            .total-score-input { font-size: 1.8em;} .stat-number { font-size: 1.3em;} .stat-label { font-size: 0.8em;}
            #score-history-table { font-size: 0.7em;} #score-history-table th, #score-history-table td { padding: 4px 2px;}
            #score-history-table ul { padding-left: 10px; font-size: 0.85em; }
            #score-history-table .basic-score-details ul { font-size: 0.8em; }
            .clickable-cell { min-width: 25px;}
        }
    </style>
</head>
<body>
    <div id="login-overlay" class="login-overlay" style="display: none;">
        <div class="login-box">
            <h2>🔐 积分系统登录</h2>
            <p style="margin-bottom: 20px; color: #666;">请输入密码访问系统</p>
            <input type="password" id="password-input" placeholder="输入访问密码" class="login-input">
            <button onclick="checkPassword()" class="login-btn">登录</button>
            <div id="login-error" class="login-error" style="display: none;">密码错误，请重新输入</div>
        </div>
    </div>

    <div id="edit-password-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="login-box">
            <h2>🔒 编辑权限验证</h2>
            <p style="margin-bottom: 20px; color: #666;">请输入编辑密码以修改数据</p>
            <input type="password" id="edit-password-input" placeholder="输入编辑密码" class="login-input">
            <div id="edit-login-error" class="login-error" style="display: none;">密码错误，请重新输入</div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button onclick="handleEditPasswordSubmit()" class="login-btn" style="width:auto; padding: 12px 25px; margin: 5px;">确认</button>
                <button onclick="cancelEditPassword()" class="cancel-btn" style="width:auto; padding: 12px 25px; margin: 5px;">取消</button>
            </div>
        </div>
    </div>

    <div id="buyer-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>选择购买者 <span id="buyer-modal-card-name" style="color: #3498db; font-weight:bold;"></span></h3>
            <div style="margin: 15px 0;">
                <label for="buy-card-quantity" style="display: block; margin-bottom: 8px; color: #555;">购买数量:</label>
                <input type="number" id="buy-card-quantity" value="1" min="1" max="10" class="modal-input">
            </div>
            <div class="modal-buttons">
                <button onclick="selectBuyer('qiqi')" class="confirm-btn">七七</button>
                <button onclick="selectBuyer('yiyi')" class="confirm-btn">一一</button>
                <button onclick="closeBuyerModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="penalty-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="penalty-modal-title">选择扣分对象</h3>
            <div class="modal-buttons penalty-modal-buttons">
                <button onclick="applyPenaltyToPlayer('qiqi')" class="confirm-btn">七七</button>
                <button onclick="applyPenaltyToPlayer('yiyi')" class="confirm-btn">一一</button>
                <button onclick="closePenaltyModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>
    
    <div id="custom-penalty-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>自定义扣分</h3>
            <input type="number" id="custom-penalty-points" placeholder="扣分数值 (如: 2 表示扣2分)" class="modal-input">
            <input type="text" id="custom-penalty-desc" placeholder="扣分原因/备注" class="modal-input" maxlength="100">
            <p style="font-size:0.9em; color:#666; margin-bottom:15px;">为哪位玩家应用此扣分?</p>
            <div class="modal-buttons penalty-modal-buttons">
                <button onclick="applyCustomPenaltyToPlayer('qiqi')" class="confirm-btn">七七</button>
                <button onclick="applyCustomPenaltyToPlayer('yiyi')" class="confirm-btn">一一</button>
                <button onclick="closeCustomPenaltyModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="custom-reward-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>自定义奖励分</h3>
            <input type="number" id="custom-reward-points" placeholder="奖励数值 (如: 2 表示奖励2分)" class="modal-input">
            <input type="text" id="custom-reward-desc" placeholder="奖励原因/备注" class="modal-input" maxlength="100">
            <p style="font-size:0.9em; color:#666; margin-bottom:15px;">为哪位玩家应用此奖励?</p>
            <div class="modal-buttons">
                <button onclick="applyCustomRewardToPlayer('qiqi')" class="confirm-btn" style="background: linear-gradient(45deg, #27ae60, #229954);">授予七七</button>
                <button onclick="applyCustomRewardToPlayer('yiyi')" class="confirm-btn" style="background: linear-gradient(45deg, #27ae60, #229954);">授予一一</button>
                <button onclick="closeCustomRewardModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="define-custom-card-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>定义自定义卡片</h3>
            <input type="text" id="custom-card-name" placeholder="卡片名称 (如: 特殊外卖卡)" class="modal-input" maxlength="50">
            <input type="number" id="custom-card-points" placeholder="消耗积分 (如: 4)" class="modal-input">
            <select id="custom-card-type" class="modal-input">
                <option value="E">E - 消费类</option>
                <option value="T">T - 交易类</option>
                <option value="H">H - 开心类</option>
            </select>
            <textarea id="custom-card-desc" placeholder="卡片描述 (e.g., 具体效果和使用条件)" class="modal-input" rows="3" maxlength="150"></textarea>
            <div class="modal-buttons">
                <button onclick="defineAndListCustomCard()" class="confirm-btn">创建并上架</button>
                <button onclick="closeDefineCustomCardModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="define-IOU-card-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>定义欠条卡片</h3>
            <input type="number" id="iou-card-points" placeholder="欠条面值 (即购买积分，如: 10)" class="modal-input" min="1">
            <input type="number" id="iou-card-interest" placeholder="利息百分比 (如: 10 表示10%)" class="modal-input" min="0" max="100" value="10">
            <div class="modal-buttons">
                <button onclick="defineAndListIOUCard()" class="confirm-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">创建欠条</button>
                <button onclick="closeDefineIOUCardModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="special-reward-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="special-reward-modal-title">授予特殊奖励</h3>
            <p id="special-reward-modal-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button onclick="applySpecialReward('qiqi')" class="confirm-btn">授予七七</button>
                <button onclick="applySpecialReward('yiyi')" class="confirm-btn">授予一一</button>
                <button onclick="closeSpecialRewardModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>
    <div id="consume-card-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="consume-card-confirm-title">确认使用卡片</h3>
            <p id="consume-card-confirm-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-consume-btn" class="confirm-btn">确认</button>
                <button onclick="closeConsumeCardConfirmModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="iou-return-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="iou-return-modal-title">归还欠条</h3>
            <p id="iou-return-modal-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-iou-return-btn" class="confirm-btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">确认归还并扣除对方</button>
                <button onclick="closeIOUReturnModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>

    <div id="confirm-add-total-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="confirm-add-total-title">确认操作</h3>
            <p id="confirm-add-total-desc" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button id="confirm-add-total-btn" class="confirm-btn">确定</button>
                <button onclick="closeConfirmAddTotalModal()" class="cancel-btn">取消</button>
            </div>
        </div>
    </div>


    <div id="connection-status" class="connection-status connecting">🔄 连接中...</div>

    <div class="container">
        <div class="header">
            <h1>🎯 积分管理系统</h1>
            <p>让生活更有趣，让习惯更持久</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('daily')">📅 小日常</button>
            <button class="nav-tab" onclick="showPage('cards')">🎫 小卡片</button>
            <button class="nav-tab" onclick="showPage('penalty')">⚖️ 小奖惩</button>
            <button class="nav-tab" onclick="showPage('bank')">🏦 小银行</button>
            <button class="nav-tab" onclick="showPage('history')">📜 积分历史</button>
        </div>

        <div class="content">
            <div id="daily" class="page active">
                <h2>🔆 每日基本任务</h2>
                <div class="stats-overview">
                    <h3>🌟 基本任务</h3>
                    <div class="stats-grid">
                        <div class="stat-item"> <div class="stat-number">30-60min</div> <div class="stat-label">日常锻炼</div> </div>
                        <div class="stat-item"> <div class="stat-number">30-60min</div> <div class="stat-label">日常学习</div> </div>
                        <div class="stat-item"> <div class="stat-number">23:00</div> <div class="stat-label">就寝时间</div> </div>
                    </div>
                </div>
                <div class="daily-schedule">
                    <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 10px;">
                        <h4>💫 每日任务：</h4>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li><strong>工作日计划试行版</strong><br>
                                1. 饭后散步20分钟（1积分，翻倍+0，上限1）<br>
                                2. 学习提升30分钟（1积分，翻倍+1，上限2）<br>
                                3. 正式锻炼30分钟（1积分，翻倍+2，上限3）<br>
                                4. 禁止游戏</li>
                                <br>
                            <li><strong>休息日计划试行版</strong><br>
                                1. 锻炼1小时<br>
                                2. 学习3小时<br>
                                3. 午休1小时<br>
                                4. 娱乐禁止：12:30前和22:00后<br>
                                5. 学习禁止：06:00前禁止学习<br>
                                6. 完成任务后才可随意安排时间</li><br>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="cards" class="page">
                <h2>🎫 积分兑换与仓库</h2>
                
                <div class="trade-system">
                    <h3>💰 积分交易系统</h3>
                    <div class="trade-form">
                        <div class="trade-input-group">
                            <label for="trade-from">转账方</label>
                            <select id="trade-from" class="trade-select">
                                <option value="">请选择</option>
                                <option value="qiqi">七七</option>
                                <option value="yiyi">一一</option>
                            </select>
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-to">接收方</label>
                            <select id="trade-to" class="trade-select">
                                <option value="">请选择</option>
                                <option value="qiqi">七七</option>
                                <option value="yiyi">一一</option>
                            </select>
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-amount">交易积分</label>
                            <input type="number" id="trade-amount" class="trade-input" placeholder="输入积分数量" min="1" max="999">
                        </div>
                        <div class="trade-input-group">
                            <label for="trade-memo">备注说明</label>
                            <textarea id="trade-memo" class="trade-textarea" placeholder="交易原因或备注"></textarea>
                        </div>
                        <div class="trade-input-group">
                            <button onclick="executePointsTrade()" class="trade-btn">💸 执行交易</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="openDefineCustomCardModal()" style="background: linear-gradient(45deg, #27ae60, #229954); font-size: 1.1em; padding: 12px 25px;">⭐ 自定义卡片</button>
                    <button class="btn" onclick="openDefineIOUCardModal()" style="background: linear-gradient(45deg, #f39c12, #e67e22); font-size: 1.1em; padding: 12px 25px;">📝 定义欠条卡片</button>
                </div>

                <div class="weekly-rewards-section">
                    <h3>🌟 每周特殊奖励卡</h3>
                    <div class="card-item info-card" data-points="3" data-type="special-reward" data-name="完美周奖励卡" id="predef_card_perfectweek" onclick="openSpecialRewardModal('完美周奖励卡', 3)"><div class="card-title">🏆 完美周奖励卡</div><div class="card-desc">当周表现优异，可获得3点额外奖励积分。</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_perfectweek', 'predefined')">❌</button></div>
                    <div class="card-item info-card" data-points="3" data-type="special-reward" data-name="和平周奖励卡" id="predef_card_peaceweek" onclick="openSpecialRewardModal('和平周奖励卡', 3)"><div class="card-title">🤝 和平周奖励卡</div><div class="card-desc">当周相处和谐，可获得3点额外奖励积分。</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_peaceweek', 'predefined')">❌</button></div>
                    <p style="text-align: center; font-size: 0.9em; color: #7f8c8d; margin-top: 15px;">(点击卡片选择授予对象)</p>
                </div>

                <div class="warehouse-section">
                    <h3>📦 卡片仓库</h3>
                    <div class="warehouse-grid">
                        <div class="warehouse-owner-column"> <h4>七七的仓库</h4> <div id="qiqi-warehouse-cards"> <p class="no-cards-text">仓库空空如也~</p> </div> </div>
                        <div class="warehouse-owner-column"> <h4>一一的仓库</h4> <div id="yiyi-warehouse-cards"> <p class="no-cards-text">仓库空空如也~</p> </div> </div>
                    </div>
                </div>

<div id="temporary-cards-section" class="points-section custom-cards-section" style="display: block;"> 
                    <h3 style="text-align:center; margin-top:0px; margin-bottom:20px; color: #2c3e50;">⭐ 自定义卡片</h3>
                    <div id="temp-cards-grid" class="points-grid">
                        <p id="no-temp-cards-text" class="no-cards-text" style="grid-column: 1 / -1;">尚未定义自定义卡片。</p>
                    </div>
                </div>
                
                <h3 style="text-align:center; margin-top:40px; margin-bottom:20px; color: #2c3e50;">🛒 可购买卡片</h3>
                <div id="main-cards-grid" class="points-grid">
                    <div class="points-section points-1">
                        <h3>💚 1积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(1)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/快递外卖卡" id="predef_card_kuaidi" onclick="openBuyerModal(1, 'E', 'E/快递外卖卡')"><div class="card-title">E/快递外卖卡</div><div class="card-desc">负责全天的快递和外卖取货</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_kuaidi', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/零食投喂卡" id="predef_card_lingshi" onclick="openBuyerModal(1, 'E', 'E/零食投喂卡')"><div class="card-title">E/零食投喂卡</div><div class="card-desc">兑换指定零食/奶茶一份，亲手喂食</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_lingshi', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="1" data-type="E" data-name="E/简单购物卡" id="predef_card_gouwu" onclick="openBuyerModal(1, 'E', 'E/简单购物卡')"><div class="card-title">E/简单购物卡</div><div class="card-desc">一天的简单代买</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_gouwu', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="1" data-type="T" data-name="T/家务执行卡" id="predef_card_jiawu" onclick="openBuyerModal(1, 'T', 'T/家务执行卡')"><div class="card-title">T/家务执行卡</div><div class="card-desc">指定任意家务（整理衣柜/打扫房间/洗晒衣服/收拾桌子/洗碗）</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_jiawu', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="1" data-type="T" data-name="T/简单按摩卡" id="predef_card_anmo" onclick="openBuyerModal(1, 'T', 'T/简单按摩卡')"><div class="card-title">T/简单按摩卡</div><div class="card-desc">享受3分钟肩颈按摩</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_anmo', 'predefined')">❌</button></div>
                    </div>
                    <div class="points-section points-2">
                        <h3>🧡 2积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(2)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/食物选择卡" id="predef_card_shiwu" onclick="openBuyerModal(2, 'E', 'E/食物选择卡')"><div class="card-title">E/食物选择卡</div><div class="card-desc">给对方提供三种以上的外卖或者菜品的选择</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shiwu', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/影视选择卡" id="predef_card_yingshi" onclick="openBuyerModal(2, 'E', 'E/影视选择卡')"><div class="card-title">E/影视选择卡</div><div class="card-desc">本天看剧时间完全由你决定</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_yingshi', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="2" data-type="E" data-name="E/造型选择卡" id="predef_card_zaoxing" onclick="openBuyerModal(2, 'E', 'E/造型选择卡')"><div class="card-title">E/造型选择卡</div><div class="card-desc">对方帮你挑选今天的穿搭</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_zaoxing', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="2" data-type="T" data-name="T/专属表演卡" id="predef_card_biaoyan" onclick="openBuyerModal(2, 'T', 'T/专属表演卡')"><div class="card-title">T/专属表演卡</div><div class="card-desc">对方为你表演指定的歌曲/讲故事</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_biaoyan', 'predefined')">❌</button></div>
                    </div>
                    <div class="points-section points-3">
                        <h3>❤️ 3积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(3)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="3" data-type="E" data-name="E/睡觉延迟卡" id="predef_card_shuijiao" onclick="openBuyerModal(3, 'E', 'E/睡觉延迟卡')"><div class="card-title">E/睡觉延迟卡</div><div class="card-desc">可以延长睡眠时间10分钟（可叠加使用，但不能超过半小时）</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shuijiao', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="3" data-type="E" data-name="E/拥抱充电卡" id="predef_card_yongbao" onclick="openBuyerModal(3, 'E', 'E/拥抱充电卡')"><div class="card-title">E/拥抱充电卡</div><div class="card-desc">兑换3分钟超级大拥抱</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_yongbao', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/视频录制卡" id="predef_card_shipin" onclick="openBuyerModal(3, 'T', 'T/视频录制卡')"><div class="card-title">T/视频录制卡</div><div class="card-desc">经过对方允许可录制7-10分钟的视频</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shipin', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/跑腿代购卡" id="predef_card_paotui" onclick="openBuyerModal(3, 'T', 'T/跑腿代购卡')"><div class="card-title">T/跑腿代购卡</div><div class="card-desc">兑换一次代买早餐/日用品服务（半径3公里内）</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_paotui', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/拍照选择卡" id="predef_card_paizhao" onclick="openBuyerModal(3, 'T', 'T/拍照选择卡')"><div class="card-title">T/拍照选择卡</div><div class="card-desc">专属摄影师10张</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_paizhao', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="3" data-type="T" data-name="T/学习陪伴卡" id="predef_card_xuexi" onclick="openBuyerModal(3, 'T', 'T/学习陪伴卡')"><div class="card-title">T/学习陪伴卡</div><div class="card-desc">对方安静陪伴你学习工作1小时</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_xuexi', 'predefined')">❌</button></div>
                    </div>
                    <div class="points-section points-5">
                        <h3>💜 5积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(5)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="5" data-type="E" data-name="E/手机时长卡" id="predef_card_shouji" onclick="openBuyerModal(5, 'E', 'E/手机时长卡')"><div class="card-title">E/手机时长卡</div><div class="card-desc">兑换30分钟无打扰玩手机时间</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_shouji', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="5" data-type="E" data-name="E/游戏陪玩卡" id="predef_card_youxi" onclick="openBuyerModal(5, 'E', 'E/游戏陪玩卡')"><div class="card-title">E/游戏陪玩卡</div><div class="card-desc">对方陪你玩喜欢的游戏2小时</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_youxi', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="5" data-type="T" data-name="T/食物料理卡" id="predef_card_liaoli" onclick="openBuyerModal(5, 'T', 'T/食物料理卡')"><div class="card-title">T/食物料理卡</div><div class="card-desc">对方为你完成一道指定菜，对方陪你吃掉一碗菜</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_liaoli', 'predefined')">❌</button></div>
                    </div>
                    <div class="points-section points-10">
                        <h3>🖤 10积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(10)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/家务豁免卡" id="predef_card_huomian" onclick="openBuyerModal(10, 'T', 'T/家务豁免卡')"><div class="card-title">T/家务豁免卡</div><div class="card-desc">免除当日指定家务劳动</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_huomian', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/庆祝选择卡" id="predef_card_qingzhu" onclick="openBuyerModal(10, 'T', 'T/庆祝选择卡')"><div class="card-title">T/庆祝选择卡</div><div class="card-desc">纪念日当天持卡人拥有活动决定权</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_qingzhu', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="10" data-type="T" data-name="T/万能半日卡" id="predef_card_bannri" onclick="openBuyerModal(10, 'T', 'T/万能半日卡')"><div class="card-title">T/万能半日卡</div><div class="card-desc">可在周末或节假日空闲时陪伴（全心全意）</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_bannri', 'predefined')">❌</button></div>
                    </div>
                    <div class="points-section points-20">
                        <h3>🔥 20积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(20)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="20" data-type="E" data-name="E/万能和好卡" id="predef_card_hehao" onclick="openBuyerModal(20, 'E', 'E/万能和好卡')"><div class="card-title">E/万能和好卡</div><div class="card-desc">双方需要在15分钟内停止争论，倾诉以及沟通</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_hehao', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="20" data-type="T" data-name="T/万能包日卡" id="predef_card_baori" onclick="openBuyerModal(20, 'T', 'T/万能包日卡')"><div class="card-title">T/万能包日卡</div><div class="card-desc">可在周末或节假日空闲时陪伴（满足对方一切要求）叠加时每天加10分，对方获得三分之一</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_baori', 'predefined')">❌</button></div>
                        <div class="card-item" data-points="20" data-type="H" data-name="H/周末掌控卡" id="predef_card_zhangkong" onclick="openBuyerModal(20, 'H', 'H/周末掌控卡')"><div class="card-title">H/周末掌控卡</div><div class="card-desc">一人十分解除当天的所有限制（此外当天所有日常不在加分）</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_zhangkong', 'predefined')">❌</button></div>
                    </div>


                    <div class="points-section points-20">
                        <h3>🌟 999积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(999)">⊕ 添加</button></h3>
                        <div class="card-item" data-points="999" data-type="T" data-name="T/原地结婚卡" id="predef_card_jiehun" onclick="openBuyerModal(999, 'T', 'T/原地结婚卡')"><div class="card-title">T/原地结婚卡</div><div class="card-desc">当天带上身份证去民政局领结婚证</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('predef_card_jiehun', 'predefined')">❌</button></div>
                    </div>



                    <div style="margin-top: 30px; padding: 25px; background: linear-gradient(45deg, #74b9ff, #0984e3); color: white; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <h3 style="margin-bottom: 15px;">💡 使用说明</h3>
                        <div style="display: inline-block; text-align: left; font-size: 1.05em; line-height: 1.8; margin: 0 auto;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li><strong>积分交易：</strong>可直接在玩家间转移积分，支持备注说明，交易记录会计入总分体系。</li>
                                <li><strong>E = 消费类卡片：</strong>购买后进入仓库，使用后从仓库移除。积分由购买方承担。</li>
                                <li><strong>T = 交易类卡片：</strong>购买后进入仓库。使用后卡片从仓库移除，卡片原积分值将加入对方的“交易”积分中。购买方承担购买成本。</li>
                                <li><strong>H = 开心类卡片：：</strong>直接消耗，双方共同承担积分，不进入仓库。</li>
                                <li><strong>IOU = 欠条卡片：</strong>购买后进入仓库，购买者扣除积分，另一方玩家立即获得相同积分。使用时，使用者获得（面值+利息）积分，另一方玩家扣除（面值+利息）积分。</li>
                                 <li><strong>特殊奖励卡：</strong>直接授予对应玩家奖励积分，不进入仓库。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="penalty" class="page">
                <h2>⚖️ 奖惩制度</h2>
                <div class="penalty-section">
                    <div class="penalty-card penalty-left">
                        <h3 style="color: #e74c3c; text-align: center; margin-bottom: 20px;">❌ 扣分规则</h3>
                        <div class="penalty-list">
                            <div class="penalty-item" data-penalty-value="-1" data-penalty-desc="不耐烦"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>不耐烦</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, '不耐烦')">应用</button></div></div>
                            <div class="penalty-item" data-penalty-value="-2" data-penalty-desc="反问句"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>反问句</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, '反问句')">应用</button></div></div>
                            <div class="penalty-item" data-penalty-value="-2" data-penalty-desc="说脏话"><div class="penalty-item-info"><span class="penalty-score">-1</span><span>说脏话</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-1, '说脏话')">应用</button></div></div>
                            <div class="penalty-item" data-penalty-value="-3" data-penalty-desc="冷暴力"><div class="penalty-item-info"><span class="penalty-score">-3</span><span>冷暴力</span></div><div class="penalty-action-buttons"><button onclick="openPenaltyModal(-3, '冷暴力')">应用</button></div></div>
                            <div class="penalty-item"><div class="penalty-item-info"><span class="penalty-score" style="background-color: #f39c12;">自定</span><span>其他自定义扣分</span></div><div class="penalty-action-buttons"><button onclick="openCustomPenaltyModal()" class="custom-penalty-btn">设置</button></div></div>
                        </div>
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 20px;"> <h4 style="color: #c62828; margin-bottom: 10px;">⚠️ 扣分说明</h4> <ul style="color: #666; margin-left: 20px;"><li>扣分会立即从当前积分中扣除 (体现为周记录中的负值)</li><li>如积分不足，将产生负债</li><li>连续违规行为将有额外惩罚</li><li>自定义扣分需双方同意并记录原因</li></ul></div>
                    </div>
                    <div class="penalty-card penalty-right">
                        <h3 style="color: #27ae60; text-align: center; margin-bottom: 20px;">✅ 借分、申诉与奖励</h3>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;"><h4 style="color: #2e7d32; margin-bottom: 15px;">🤝 特殊情况处理</h4><div style="margin: 10px 0; color: #424242;"><strong>借分规则：</strong><br>特殊情况下可以"借"给对方积分，需要记录并约定还分时间</div></div>
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;"><h4 style="color: #f57c00; margin-bottom: 15px;">⚖️ 申诉机制</h4><div style="margin: 10px 0; color: #424242;"><strong>第三方仲裁：</strong><br>对不公平扣分可申请第三方仲裁（姐姐），确保公平公正</div></div>
                        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-top: 20px;"><h4 style="color: #2e7d32; margin-bottom: 15px;">🎁 自定义奖励</h4><div class="penalty-item"><div class="penalty-item-info"><span class="penalty-score" style="background-color: #27ae60;">自定</span><span>自定义奖励分</span></div><div class="penalty-action-buttons"><button onclick="openCustomRewardModal()" class="btn" style="background: #27ae60; color: white;">设置奖励</button></div></div><ul style="color: #666; margin-left: 20px; font-size: 0.9em; margin-top:10px;"><li>为玩家设置自定义的奖励积分和原因。</li><li>奖励将累加到当日的“奖”分中。</li></ul></div>
                    </div>
                </div>
            </div>

            <div id="bank" class="page">
                <h2>🏦 积分银行</h2>
                <div class="total-scores">
                    <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">🏆 积分排行榜</h3>
                    <div class="score-boards">
                        <div class="score-board"><div class="player-name">七七</div><input type="number" class="total-score-input" id="qiqi-total" value="0" placeholder="输入积分"><button onclick="openConfirmAddTotalModal('qiqi')" style="margin-top: 12px; padding: 8px 20px; font-size: 0.95em; background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='1)'">📥 加入本周总分</button></div>
                        <div class="score-board"><div class="player-name">一一</div><input type="number" class="total-score-input" id="yiyi-total" value="0" placeholder="输入积分"><button onclick="openConfirmAddTotalModal('yiyi')" style="margin-top: 12px; padding: 8px 20px; font-size: 0.95em; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.1); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='1)'">📥 加入本周总分</button></div>
                    </div>
                    <div class="control-buttons"> <button class="btn btn-danger" onclick="resetAllData()">重置所有数据</button> </div>
                </div>
                <div class="bank-section">
                    <div class="week-card">
                        <div class="week-title">七七</div>
                        <div class="week-table-container"><table class="week-table"><thead><tr><th>日期</th><th>学</th><th>睡</th><th>练</th><th>奖</th><th>罚</th><th>购卡</th><th>交易</th></tr></thead><tbody>
                            <tr><td><strong>周一</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'mon', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周二</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'tue', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周三</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'wed', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周四</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'thu', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周五</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'fri', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周六</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sat', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周日</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'qiqi', 'sun', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                        </tbody></table></div>
                        <div class="week-summary" id="qiqi-summary"><strong>本周积分：0分 ✨</strong> <br> (基础: 0 📚, 奖励: 0 🎁, 罚分: 0 💔, 购卡: 0 💳, 交易: 0 🔄)</div>
                        <button class="btn btn-secondary" onclick="resetWeekData('qiqi')">清零本周数据</button>
                    </div>
                    <div class="week-card">
                        <div class="week-title">一一</div>
                        <div class="week-table-container"><table class="week-table"><thead><tr><th>日期</th><th>学</th><th>睡</th><th>练</th><th>奖</th><th>罚</th><th>购卡</th><th>交易</th></tr></thead><tbody>
                            <tr><td><strong>周一</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'mon', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周二</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'tue', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周三</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'wed', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周四</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'thu', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周五</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'fri', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周六</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sat', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                            <tr><td><strong>周日</strong></td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'book')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'sleep')">0</td><td class="clickable-cell cell-zero" onclick="toggleBasicTask(this, 'yiyi', 'sun', 'exercise')">0</td><td class="reward-0 reward-cell">0</td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td><td><input type="number" class="small-input" value="0" readonly></td></tr>
                        </tbody></table></div>
                        <div class="week-summary" id="yiyi-summary"><strong>本周积分：0分 ✨</strong> <br> (基础: 0 📚, 奖励: 0 🎁, 罚分: 0 💔, 购卡: 0 💳, 交易: 0 🔄)</div>
                        <button class="btn btn-secondary" onclick="resetWeekData('yiyi')">清零本周数据</button>
                    </div>
                </div>
                <div style="margin-top: 30px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                    <h3 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">📋 积分计算说明</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px;"><h4 style="color: #1976d2; margin-bottom: 10px;">📊 积分计算规则</h4><ul style="color: #555; margin-left: 20px;"><li><strong>基础任务：</strong>各个项目可点击切换-2, 0, 1分</li><li><strong>奖励积分：</strong>通过特殊奖励卡或自定义奖励获得</li><li><strong>罚分：</strong>通过扣分规则或自定义扣分产生 (自动记录)</li><li><strong>购卡：</strong>卡片购买成本 (自动记录)</li><li><strong>交易：</strong>对方使用T卡时，己方获得的积分 (自动记录)</li><li><strong>总分 = 基础 + 奖励 + 罚分 - 购卡 + 交易</strong> (罚分为负值)</li></ul></div>
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px;"><h4 style="color: #7b1fa2; margin-bottom: 10px;">🎮 操作说明</h4><ul style="color: #555; margin-left: 20px;"><li>点击基础任务单元格切换数值</li><li>奖励通过"小卡片"页面的特殊卡或"小奖惩"页面的自定义奖励操作</li><li>罚分通过"小奖惩"页面操作自动更新</li><li>购卡积分根据卡片购买自动更新</li><li>交易积分根据对方使用T卡自动更新</li><li>系统自动计算本周各项积分及总分</li></ul></div>
                    </div>
                </div>
            </div>
            
            <div id="history" class="page">
                <h2>📜 积分历史记录</h2>
                <div class="table-container"> <table id="score-history-table"><thead><tr><th>纳入日期</th><th>玩家</th><th class="num-center">基础分详情</th><th class="num-center">奖励分</th><th>奖励分详情</th><th>罚分详情</th><th>购卡详情</th><th class="num-center">交易分</th><th>交易明细</th><th class="total-highlight num-center">本周总计</th></tr></thead><tbody></tbody></table></div>
                <div class="control-buttons"> <button class="btn btn-danger" onclick="clearScoreHistory()">清空历史记录</button> </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDG4YvEFwtk_-aD8J2OYIgvn61sOXqIAVw",
            authDomain: "score-bank.firebaseapp.com",
            databaseURL: "https://score-bank-default-rtdb.firebaseio.com/", 
            projectId: "score-bank",
            storageBucket: "score-bank.firebasestorage.app",
            messagingSenderId: "700926783701",
            appId: "1:700926783701:web:fa11b4e0150d8aae92b25c",
            measurementId: "G-4SEHTPPH7C"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const connectedRef = database.ref('.info/connected');
        const statusElement = document.getElementById('connection-status');

        const EDIT_PASSWORD = "240310"; // Your desired edit password
        let editPasswordVerifiedTimestamp = null;
        const EDIT_AUTH_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        const EDIT_AUTH_STORAGE_KEY = 'scorebank_edit_auth_time';

        let scoreHistoryLog = [];
        let warehousesData = { qiqi: [], yiyi: [] }; 
        // 统一为 customDefinedCards，包含以前的临时卡片和常用卡片
        let customDefinedCards = {}; // Stores user-defined custom cards { cardId: {details} } 
        let iouCardsData = {}; // Stores user-defined IOU cards { cardId: {details} }
        let hiddenPredefinedCardIds = []; // Stores IDs of predefined cards to hide

        const initialDayData = () => ({
            book: 0, sleep: 0, exercise: 0,
            reward: 0, penalty: 0, consume: 0, trade: 0, // trade is for T-card income
            purchaseLog: [], penaltyLog: [], rewardLog: [], tradeLog: [], 
            tradeFromLog: [], // Log for points transferred FROM this player
            tradeToLog: []    // Log for points transferred TO this player
        });

        let weekData = {
            qiqi: { mon: initialDayData(), tue: initialDayData(), wed: initialDayData(), thu: initialDayData(), fri: initialDayData(), sat: initialDayData(), sun: initialDayData() },
            yiyi: { mon: initialDayData(), tue: initialDayData(), wed: initialDayData(), thu: initialDayData(), fri: initialDayData(), sat: initialDayData(), sun: initialDayData() }
        };
        
        const dayChineseMap = { mon: '周一', tue: '周二', wed: '周三', thu: '周四', fri: '周五', sat: '周六', sun: '周日' };
        const taskChineseMap = { book: '书', sleep: '睡', exercise: '练' };

        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                statusElement.textContent = '✅ 已连接'; statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '❌ 连接断开'; statusElement.className = 'connection-status disconnected';
            }
        });

        // Function to check if edit permission is currently valid
        function hasValidEditPermission() {
            const storedAuthTime = localStorage.getItem(EDIT_AUTH_STORAGE_KEY);
            if (storedAuthTime) {
                editPasswordVerifiedTimestamp = parseInt(storedAuthTime);
                if ((Date.now() - editPasswordVerifiedTimestamp) < EDIT_AUTH_DURATION) {
                    return true;
                } else {
                    // Stored permission has expired
                    localStorage.removeItem(EDIT_AUTH_STORAGE_KEY);
                    editPasswordVerifiedTimestamp = null;
                    return false;
                }
            }
            return false;
        }

        // Function to request edit permission via modal
        function requestEditPermission(onSuccessCallback, onCancelCallback) {
            if (hasValidEditPermission()) {
                if (onSuccessCallback) onSuccessCallback();
                return;
            }
            const editPasswordModal = document.getElementById('edit-password-modal-overlay');
            editPasswordModal.style.display = 'flex';
            const passInput = document.getElementById('edit-password-input');
            passInput.value = ''; // Clear previous input
            passInput.focus();
            const editErrorDiv = document.getElementById('edit-login-error');
            if (editErrorDiv) editErrorDiv.style.display = 'none'; // Hide error initially

            // Store callbacks to be executed after successful authentication or cancellation
            window.currentEditSuccessCallback = onSuccessCallback;
            window.currentEditCancelCallback = onCancelCallback;
        }

        // Handles submission of the edit password modal
        function handleEditPasswordSubmit() {
            const inputPassword = document.getElementById('edit-password-input').value;
            const errorDiv = document.getElementById('edit-login-error');

            if (inputPassword === EDIT_PASSWORD) {
                editPasswordVerifiedTimestamp = Date.now();
                localStorage.setItem(EDIT_AUTH_STORAGE_KEY, editPasswordVerifiedTimestamp.toString()); // Store timestamp
                document.getElementById('edit-password-modal-overlay').style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'none';

                // Execute the stored success callback
                if (window.currentEditSuccessCallback) {
                    window.currentEditSuccessCallback();
                    window.currentEditSuccessCallback = null; // Clear the callback
                }
            } else {
                if (errorDiv) errorDiv.style.display = 'block';
                document.getElementById('edit-password-input').value = ''; // Clear input on error
                document.getElementById('edit-password-input').focus();
                setTimeout(() => { // Hide error after 3 seconds
                    if (errorDiv) errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Handles cancellation of the edit password modal
        function cancelEditPassword() {
            document.getElementById('edit-password-modal-overlay').style.display = 'none';
            // Execute the stored cancel callback if it exists
            if (window.currentEditCancelCallback) {
                window.currentEditCancelCallback();
                window.currentEditCancelCallback = null; // Clear the callback
            }
        }
        
        // Original checkPassword function is no longer used for initial access
        function checkPassword() { console.log("Initial password check is deprecated."); }


        document.addEventListener('keydown', (event) => {
            const editPasswordModal = document.getElementById('edit-password-modal-overlay');
            if (event.key === 'Enter' && editPasswordModal && editPasswordModal.style.display !== 'none') {
                handleEditPasswordSubmit();
            }
        });
        
        // All functions that modify data should call requestEditPermission
        function saveToFirebase(showStatus = true) { requestEditPermission(() => _saveToFirebaseInternal(showStatus)); }
        function _saveToFirebaseInternal(showStatus = true) {
            if (showStatus) { statusElement.textContent = '💾 保存中...'; statusElement.className = 'connection-status connecting'; }
            const updates = {
                '/weekData': weekData,
                '/totalScores': { qiqi: document.getElementById('qiqi-total').value, yiyi: document.getElementById('yiyi-total').value },
                '/warehousesData': warehousesData,
                '/customDefinedCards': customDefinedCards, 
                '/hiddenPredefinedCardIds': hiddenPredefinedCardIds,
                '/iouCardsData': iouCardsData
            };
            database.ref().update(updates).then(() => {
                console.log('✅ 主数据、仓库、自定义卡片、隐藏状态及欠条卡片保存成功'); 
                if (showStatus) { setTimeout(() => { statusElement.textContent = '✅ 已连接'; statusElement.className = 'connection-status connected'; }, 1000); }
            }).catch((error) => {
                console.error('❌ 保存失败:', error);
                if (showStatus) { statusElement.textContent = '❌ 保存失败'; statusElement.className = 'connection-status disconnected';}
            });
        }
        
        function saveScoreHistoryToFirebase() { requestEditPermission(_saveScoreHistoryToFirebaseInternal); }
        function _saveScoreHistoryToFirebaseInternal() {
            database.ref('/scoreHistory').set(scoreHistoryLog)
                .then(() => console.log('✅ 积分历史保存成功'))
                .catch((error) => console.error('❌ 积分历史保存失败:', error));
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const pageElement = document.getElementById(pageId);
            if(pageElement) pageElement.classList.add('active');
            const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.getAttribute('onclick') === `showPage('${pageId}')`);
            if (clickedTab) clickedTab.classList.add('active');
        }

        let currentCardToBuy = { points: 0, type: '', name: '', isCustom: false, id: null }; 
        let currentSpecialReward = { name: '', points: 0 };

        function openSpecialRewardModal(cardName, points) {
            requestEditPermission(() => {
                currentSpecialReward = { name: cardName, points: points };
                document.getElementById('special-reward-modal-title').textContent = `授予 "${cardName}"`;
                document.getElementById('special-reward-modal-desc').textContent = `选择玩家以授予 ${points} 点特殊奖励积分。`;
                document.getElementById('special-reward-modal-overlay').style.display = 'flex';
            });
        }
        function closeSpecialRewardModal() { document.getElementById('special-reward-modal-overlay').style.display = 'none'; currentSpecialReward = { name: '', points: 0 };}
        function applySpecialReward(player) { requestEditPermission(() => _applySpecialRewardInternal(player)); }
        function _applySpecialRewardInternal(player) {
            if (!currentSpecialReward.name) { alert('操作无效！'); return; }
            const { name: cardName, points: rewardPoints } = currentSpecialReward;
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].reward = (parseInt(weekData[player][currentDayKey].reward) || 0) + rewardPoints;
            if (!weekData[player][currentDayKey].rewardLog) weekData[player][currentDayKey].rewardLog = [];
            weekData[player][currentDayKey].rewardLog.push({ desc: cardName, pointsAdded: rewardPoints, type: 'special_card' });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? '七七' : '一一'} 因 "${cardName}" 获得了 ${rewardPoints} 点特殊奖励积分！`);
            closeSpecialRewardModal();
        }

        // Modified openBuyerModal to use isCustom instead of isTemporary/isPermanent
        function openBuyerModal(points, type, cardNameFromArg, isCustom = false, cardId = null) {
            requestEditPermission(() => {
                const cardName = cardNameFromArg || (event && event.target.closest('.card-item') ? event.target.closest('.card-item').dataset.name : null);
                const cardPoints = points !== undefined ? points : (event && event.target.closest('.card-item') ? parseInt(event.target.closest('.card-item').dataset.points) : 0);
                const cardType = type || (event && event.target.closest('.card-item') ? event.target.closest('.card-item').dataset.type : null);
                if (!cardName || cardType === null || isNaN(cardPoints)) {
                    const cardElement = event ? event.target.closest('.card-item') : null;
                    if (cardElement && cardElement.dataset.type === 'special-reward') { openSpecialRewardModal(cardElement.dataset.name, parseInt(cardElement.dataset.points)); return; }
                    console.error("Could not determine card details for buyer modal."); return;
                }
                currentCardToBuy = { points: cardPoints, type: cardType, name: cardName, isCustom: isCustom, id: cardId };
                if (currentCardToBuy.type === 'H') { _handleHCardPurchaseInternal(currentCardToBuy.points, currentCardToBuy.name); return; } // Directly call internal for H cards after permission
                document.getElementById('buyer-modal-card-name').textContent = ` "${currentCardToBuy.name}" (${currentCardToBuy.points}分/个)`;
                document.getElementById('buy-card-quantity').value = 1;
                document.getElementById('buyer-modal-overlay').style.display = 'flex';
            });
        }
        function closeBuyerModal() { document.getElementById('buyer-modal-overlay').style.display = 'none'; currentCardToBuy = { points: 0, type: '', name: '', isCustom: false, id: null };} 
        
        function renderWarehouses() {
            ['qiqi', 'yiyi'].forEach(player => {
                const warehouseDiv = document.getElementById(`${player}-warehouse-cards`); warehouseDiv.innerHTML = ''; 
                if (warehousesData[player] && warehousesData[player].length > 0) {
                    warehousesData[player].forEach(card => {
                        const cardEl = document.createElement('div'); cardEl.className = 'warehouse-card-item';
                        // 根据卡片类型选择不同的使用函数
                        if (card.type === 'IOU') {
                            cardEl.innerHTML = `<div class="warehouse-card-info"><span class="name">${card.name} (面值:${card.pointsValue}分, 利息:${card.interestRate}%)</span><span class="qty">数量: ${card.quantity}</span></div><button class="use-card-btn" onclick="openIOUReturnModal('${player}', '${card.name}')">使用</button>`;
                        } else {
                            cardEl.innerHTML = `<div class="warehouse-card-info"><span class="name">${card.name} (原${card.pointsValue}分)</span><span class="qty">数量: ${card.quantity}</span></div><button class="use-card-btn" onclick="openConsumeCardConfirmModal('${player}', '${card.name}')">使用</button>`;
                        }
                        warehouseDiv.appendChild(cardEl);
                    });
                } else { warehouseDiv.innerHTML = '<p class="no-cards-text">仓库空空如也~</p>'; }
            });
        }

        let cardToConsumeDetails = null;
        function openConsumeCardConfirmModal(player, cardName) {
            requestEditPermission(() => {
                const card = warehousesData[player].find(c => c.name === cardName); if (!card) return;
                cardToConsumeDetails = { player, cardName, cardType: card.type, cardPoints: card.pointsValue };
                document.getElementById('consume-card-confirm-title').textContent = `确认使用 "${cardName}"?`;
                let desc = `类型: ${card.type}. 原价值: ${card.pointsValue}分.`;
                if (card.type === 'T') { desc += ` ${player === 'qiqi' ? '一一' : '七七'} 将获得 ${card.pointsValue} 交易积分。`; }
                document.getElementById('consume-card-confirm-desc').textContent = desc;
                document.getElementById('confirm-consume-btn').onclick = () => processCardConsumption();
                document.getElementById('consume-card-confirm-modal').style.display = 'flex';
            });
        }
        function closeConsumeCardConfirmModal() { document.getElementById('consume-card-confirm-modal').style.display = 'none'; cardToConsumeDetails = null; }
        function processCardConsumption() { requestEditPermission(_processCardConsumptionInternal); }
        function _processCardConsumptionInternal() {
            if (!cardToConsumeDetails) return;
            const { player, cardName, cardType, cardPoints } = cardToConsumeDetails;
            const playerWarehouse = warehousesData[player]; const cardIndex = playerWarehouse.findIndex(c => c.name === cardName);
            if (cardIndex === -1) { closeConsumeCardConfirmModal(); return; }

            // IOU 卡片现在通过 openIOUReturnModal 和 processIOUReturn 处理，这里不再处理
            if (cardType === 'IOU') { return; }

            let message = `${player === 'qiqi' ? '七七' : '一一'} 使用了 "${cardName}".`;
            if (cardType === 'T') {
                const otherPlayer = player === 'qiqi' ? 'yiyi' : 'qiqi'; const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
                weekData[otherPlayer][currentDayKey].trade = (parseInt(weekData[otherPlayer][currentDayKey].trade) || 0) + cardPoints;
                if (!weekData[otherPlayer][currentDayKey].tradeLog) weekData[otherPlayer][currentDayKey].tradeLog = [];
                weekData[otherPlayer][currentDayKey].tradeLog.push({ desc: `来自${player === 'qiqi' ? '七七' : '一一'}使用的交易卡 "${cardName}"`, pointsAdded: cardPoints, type: 'T_card_income' });
                updateWeekSummary(otherPlayer); message += ` ${otherPlayer === 'qiqi' ? '七七' : '一一'} 因此获得了 ${cardPoints} 交易积分！`;
            } else if (cardType === 'E') { message += ` 卡片已消耗。`; }
            alert(message);
            if (playerWarehouse[cardIndex].quantity > 1) { playerWarehouse[cardIndex].quantity--; } else { playerWarehouse.splice(cardIndex, 1); }
            renderWarehouses(); _saveToFirebaseInternal(); closeConsumeCardConfirmModal();
        }

        function selectBuyer(buyerPlayer) { requestEditPermission(() => _selectBuyerInternal(buyerPlayer)); }
        function _selectBuyerInternal(buyerPlayer) {
            if (!currentCardToBuy.name) { alert('操作无效！'); return; }
            const quantityInput = document.getElementById('buy-card-quantity'); const quantity = parseInt(quantityInput.value);
            if (isNaN(quantity) || quantity < 1) { alert("请输入有效的购买数量 (至少为1)。"); quantityInput.focus(); return; }
            const { points: singleCardCost, type: cardType, name: cardName, isCustom, id: cardId } = currentCardToBuy; 
            const totalCardCost = singleCardCost * quantity;
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[buyerPlayer][currentDayKey].consume = (parseInt(weekData[buyerPlayer][currentDayKey].consume) || 0) + totalCardCost;
            if (!weekData[buyerPlayer][currentDayKey].purchaseLog) weekData[buyerPlayer][currentDayKey].purchaseLog = [];
            weekData[buyerPlayer][currentDayKey].purchaseLog.push({ name: cardName, cost: totalCardCost, quantity: quantity, type: cardType });

            // Special handling for IOU card purchase logic
            if (cardType === 'IOU') {
                const otherPlayer = buyerPlayer === 'qiqi' ? 'yiyi' : 'qiqi';
                const iouCardInfo = iouCardsData[cardId]; 
                if (!iouCardInfo) { alert("欠条信息丢失，无法完成购买。"); return; }
                const interestRate = iouCardInfo.interestRate;

                // Other player receives points immediately
                weekData[otherPlayer][currentDayKey].reward = (parseInt(weekData[otherPlayer][currentDayKey].reward) || 0) + totalCardCost;
                if (!weekData[otherPlayer][currentDayKey].rewardLog) weekData[otherPlayer][currentDayKey].rewardLog = [];
                weekData[otherPlayer][currentDayKey].rewardLog.push({ desc: `来自${buyerPlayer === 'qiqi' ? '七七' : '一一'}购买的欠条 "${cardName}"`, pointsAdded: totalCardCost, type: 'iou_purchase_income' });

                const warehouse = warehousesData[buyerPlayer];
                // Ensure to save interestRate for IOU cards in warehouse
                const existingCard = warehouse.find(c => c.name === cardName && c.type === 'IOU' && c.pointsValue === singleCardCost && c.interestRate === interestRate);
                if (existingCard) { existingCard.quantity += quantity; } else { warehouse.push({ name: cardName, pointsValue: singleCardCost, type: cardType, quantity: quantity, interestRate: interestRate }); }

                updateWeekSummary(otherPlayer); // Update other player's summary
                alert(`${buyerPlayer === 'qiqi' ? '七七' : '一一'} 购买了 ${quantity} 个 "${cardName}"，总共花费 ${totalCardCost} 积分！${otherPlayer === 'qiqi' ? '七七' : '一一'} 立即获得了 ${totalCardCost} 积分。`);

            } else if (cardType === 'E' || cardType === 'T') {
                const warehouse = warehousesData[buyerPlayer]; const existingCard = warehouse.find(c => c.name === cardName);
                if (existingCard) { existingCard.quantity += quantity; } else { warehouse.push({ name: cardName, pointsValue: singleCardCost, type: cardType, quantity: quantity }); }
                alert(`${buyerPlayer === 'qiqi' ? '七七' : '一一'} 购买了 ${quantity} 个 "${cardName}"，总共花费 ${totalCardCost} 积分！`);
            }

            updateWeekSummary(buyerPlayer); // Update buyer's summary
            renderWarehouses(); // Refresh warehouse display
            _saveToFirebaseInternal();
            closeBuyerModal();
        }

        function _handleHCardPurchaseInternal(cardCost, cardName) {
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            const pointsPerPlayer = Math.ceil(cardCost / 2);
            ['qiqi', 'yiyi'].forEach(player => {
                weekData[player][currentDayKey].consume = (parseInt(weekData[player][currentDayKey].consume) || 0) + pointsPerPlayer;
                if (!weekData[player][currentDayKey].purchaseLog) weekData[player][currentDayKey].purchaseLog = [];
                weekData[player][currentDayKey].purchaseLog.push({ name: cardName, cost: pointsPerPlayer, type: 'H', quantity: 1 });
                updateWeekSummary(player);
            });
            _saveToFirebaseInternal(); alert(`H类卡片 "${cardName}" 已购买！七七和一一各承担了 ${pointsPerPlayer} 积分。`);
        }

        let currentPenaltyValue = 0; let currentPenaltyDesc = '';
        function openPenaltyModal(value, desc) {
            requestEditPermission(() => {
                currentPenaltyValue = value; currentPenaltyDesc = desc;
                document.getElementById('penalty-modal-title').textContent = `对谁扣 ${Math.abs(value)} 分 (${desc})?`;
                document.getElementById('penalty-modal-overlay').style.display = 'flex';
            });
        }
        function closePenaltyModal() { document.getElementById('penalty-modal-overlay').style.display = 'none'; currentPenaltyValue = 0; currentPenaltyDesc = ''; }
        
        function openCustomPenaltyModal() {
            requestEditPermission(() => {
                document.getElementById('custom-penalty-points').value = ''; document.getElementById('custom-penalty-desc').value = '';
                document.getElementById('custom-penalty-modal-overlay').style.display = 'flex'; document.getElementById('custom-penalty-points').focus();
            });
        }
        function closeCustomPenaltyModal() { document.getElementById('custom-penalty-modal-overlay').style.display = 'none'; }
        function applyCustomPenaltyToPlayer(player) { requestEditPermission(() => _applyCustomPenaltyToPlayerInternal(player));}
        function _applyCustomPenaltyToPlayerInternal(player) {
            const pointsInput = document.getElementById('custom-penalty-points'); const descInput = document.getElementById('custom-penalty-desc');
            let points = parseInt(pointsInput.value); const desc = descInput.value.trim();
            if (isNaN(points) || points === 0) { alert('请输入有效的扣分数值 (不能为0)。'); pointsInput.focus(); return; }
            if (!desc) { alert('请输入扣分原因/备注。'); descInput.focus(); return; }
            if (points > 0) points = -points; 
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].penalty = (parseInt(weekData[player][currentDayKey].penalty) || 0) + points;
            if (!weekData[player][currentDayKey].penaltyLog) weekData[player][currentDayKey].penaltyLog = [];
            weekData[player][currentDayKey].penaltyLog.push({ desc: desc, pointsDeducted: points });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? '七七' : '一一'} 因 "${desc}" 被自定义扣除了 ${Math.abs(points)} 积分！`);
            closeCustomPenaltyModal();
        }

        let currentCustomReward = { points: 0, desc: '' };
        function openCustomRewardModal() {
            requestEditPermission(() => {
                document.getElementById('custom-reward-points').value = ''; document.getElementById('custom-reward-desc').value = '';
                document.getElementById('custom-reward-modal-overlay').style.display = 'flex'; document.getElementById('custom-reward-points').focus();
            });
        }
        function closeCustomRewardModal() { document.getElementById('custom-reward-modal-overlay').style.display = 'none'; currentCustomReward = { points: 0, desc: '' };}
        function applyCustomRewardToPlayer(player) { requestEditPermission(() => _applyCustomRewardToPlayerInternal(player)); }
        function _applyCustomRewardToPlayerInternal(player) {
            const pointsInput = document.getElementById('custom-reward-points'); const descInput = document.getElementById('custom-reward-desc');
            let points = parseInt(pointsInput.value); const desc = descInput.value.trim();
            if (isNaN(points) || points <= 0) { alert('请输入有效的正数奖励数值。'); pointsInput.focus(); return; }
            if (!desc) { alert('请输入奖励原因/备注。'); descInput.focus(); return; }
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            weekData[player][currentDayKey].reward = (parseInt(weekData[player][currentDayKey].reward) || 0) + points;
            if (!weekData[player][currentDayKey].rewardLog) weekData[player][currentDayKey].rewardLog = [];
            weekData[player][currentDayKey].rewardLog.push({ desc: desc, pointsAdded: points, type: 'custom' });
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? '七七' : '一一'} 因 "${desc}" 获得了 ${points} 点自定义奖励积分！`);
            closeCustomRewardModal();
        }

        function applyPenaltyToPlayer(player) { requestEditPermission(() => _applyPenaltyToPlayerInternal(player)); }
        function _applyPenaltyToPlayerInternal(player) { 
            const today = new Date(); const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat']; const currentDayKey = dayNames[today.getDay()];
            const penaltyAmount = currentPenaltyValue < 0 ? currentPenaltyValue : -currentPenaltyValue;
            weekData[player][currentDayKey].penalty = (parseInt(weekData[player][currentDayKey].penalty) || 0) + penaltyAmount;
            if (!weekData[player][currentDayKey].penaltyLog) weekData[player][currentDayKey].penaltyLog = [];
            weekData[player][currentDayKey].penaltyLog.push({desc: currentPenaltyDesc, pointsDeducted: penaltyAmount});
            updateWeekSummary(player); _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? '七七' : '一一'} 因 "${currentPenaltyDesc}" 被扣除了 ${Math.abs(penaltyAmount)} 积分！`);
            closePenaltyModal();
        }

        function toggleBasicTask(element, player, day, task) { requestEditPermission(() => _toggleBasicTaskInternal(element, player, day, task)); }
        function _toggleBasicTaskInternal(element, player, day, task) {
            const values = [-2, 0, 1]; let currentValue = parseInt(element.textContent);
            let currentIndex = values.indexOf(currentValue); let newIndex = (currentIndex + 1) % values.length; let newValue = values[newIndex];
            element.textContent = newValue; element.className = element.className.replace(/cell-(negative|zero|positive)/g, '').trim();
            if (newValue === -2) element.classList.add('cell-negative');
            else if (newValue === 0) element.classList.add('cell-zero');
            else if (newValue === 1) element.classList.add('cell-positive');
            weekData[player][day][task] = newValue; updateWeekSummary(player); _saveToFirebaseInternal();
        }

        function calculateWeekScore(player) {
            let basicScore = 0, rewardScore = 0, penaltyScore = 0, consumeScore = 0, tradeScore = 0;
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            days.forEach(day => {
                const dayData = weekData[player][day];
                basicScore += (parseInt(dayData.book) || 0) + (parseInt(dayData.sleep) || 0) + (parseInt(dayData.exercise) || 0);
                rewardScore += (parseInt(dayData.reward) || 0); 
                penaltyScore += (parseInt(dayData.penalty) || 0); 
                consumeScore += (parseInt(dayData.consume) || 0); 
                tradeScore += (parseInt(dayData.trade) || 0); 
                // Directly add/subtract from tradeScore based on tradeFromLog and tradeToLog
                dayData.tradeFromLog.forEach(log => tradeScore -= log.amount); /* */ // Points flowing FROM this player
                dayData.tradeToLog.forEach(log => tradeScore += log.amount); /* */ // Points flowing TO this player
            });
            // Total score calculation now correctly reflects direct trade influences via tradeScore
            return { basic: basicScore, reward: rewardScore, penalty: penaltyScore, consume: consumeScore, trade: tradeScore, total: basicScore + rewardScore + penaltyScore - consumeScore + tradeScore }; /* */
        }

        function updateWeekSummary(player) {
            const scores = calculateWeekScore(player); const summaryElement = document.getElementById(`${player}-summary`);
            if (summaryElement) { summaryElement.innerHTML = `<strong>本周积分：${scores.total}分 ✨</strong> <br> (基础: 0 📚, 奖励: 0 🎁, 罚分: 0 💔, 购卡: 0 💳, 交易: 0 🔄)`;
                /* Update the week summary with accurate trade score */
                summaryElement.innerHTML = `<strong>本周积分：${scores.total}分 ✨</strong> <br> (基础: ${scores.basic} 📚, 奖励: ${scores.reward} 🎁, 罚分: ${scores.penalty} 💔, 购卡: ${scores.consume} 💳, 交易: ${scores.trade} 🔄)`;
            }
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const playerTableBody = document.querySelector(`#${player}-summary`).closest('.week-card').querySelector('tbody');
            if (!playerTableBody) return;
            days.forEach((day, index) => {
                const dayRow = playerTableBody.querySelector(`tr:nth-child(${index + 1})`); if (!dayRow) return;
                const dayData = weekData[player][day];
                const rewardCell = dayRow.querySelector('td:nth-child(5)'); 
                if (rewardCell) { rewardCell.textContent = dayData.reward || 0; rewardCell.className = 'reward-cell'; const rewardValue = parseInt(dayData.reward) || 0; rewardCell.classList.add(`reward-${Math.min(3, Math.max(0, rewardValue))}`); }
                const penaltyInput = dayRow.querySelector('td:nth-child(6) input'); if (penaltyInput) penaltyInput.value = dayData.penalty || 0;
                const consumeInput = dayRow.querySelector('td:nth-child(7) input'); if (consumeInput) consumeInput.value = dayData.consume || 0;
                const tradeInput = dayRow.querySelector('td:nth-child(8) input'); if (tradeInput) tradeInput.value = dayData.trade || 0;
            });
        }
        
        function formatHistoryTimestamp(timestamp) { const date = new Date(timestamp); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; }

        function renderScoreHistoryTable() {
            const tableBody = document.getElementById('score-history-table')?.querySelector('tbody'); if (!tableBody) return;
            tableBody.innerHTML = ''; 
            [...scoreHistoryLog].reverse().forEach(entry => {
                const row = tableBody.insertRow(); row.insertCell().textContent = formatHistoryTimestamp(entry.timestamp);
                const playerCell = row.insertCell(); playerCell.textContent = entry.player === 'qiqi' ? '七七' : '一一'; playerCell.classList.add(entry.player === 'qiqi' ? 'player-qiqi' : 'player-yiyi', 'num-center');
                const basicScoreCell = row.insertCell(); basicScoreCell.classList.add('basic-score-details'); 
                if (entry.basicScoreDetails && entry.basicScoreDetails.length > 0) { const ul = document.createElement('ul'); entry.basicScoreDetails.forEach(detail => { const li = document.createElement('li'); li.textContent = `${dayChineseMap[detail.day] || detail.day} ${taskChineseMap[detail.task] || detail.task}: ${detail.score > 0 ? '+' : ''}${detail.score}分`; ul.appendChild(li); }); basicScoreCell.appendChild(ul); const totalBasicText = document.createElement('p'); totalBasicText.textContent = `(总基础: ${entry.scores.basic}分)`; totalBasicText.style.textAlign = "center"; totalBasicText.style.fontWeight = "bold"; totalBasicText.style.marginTop = "5px"; basicScoreCell.appendChild(totalBasicText); } else { basicScoreCell.textContent = `${entry.scores.basic}分 (无详情)`; basicScoreCell.classList.add('no-details');}
                const rewardCellTotal = row.insertCell(); rewardCellTotal.textContent = entry.scores.reward; rewardCellTotal.classList.add('num-center');
                const rewardDetailCell = row.insertCell(); rewardDetailCell.classList.add('basic-score-details');
                // Only show reward details that are NOT trade-in
                const filteredRewardDetails = entry.rewardDetails ? entry.rewardDetails.filter(d => d.type !== 'trade_in') : []; /* */
                if (filteredRewardDetails.length > 0) { const ul = document.createElement('ul'); filteredRewardDetails.forEach(detail => { const li = document.createElement('li'); li.textContent = `${detail.day ? (dayChineseMap[detail.day] || detail.day) + ' - ' : ''}${detail.desc}: +${detail.pointsAdded}分`; ul.appendChild(li); }); rewardDetailCell.appendChild(ul); } else if (entry.scores.reward > 0) { rewardDetailCell.textContent = `${entry.scores.reward}分 (无非交易奖励详情)`; } else { rewardDetailCell.textContent = '无'; rewardDetailCell.classList.add('no-details');}
                
                // Penalty Details
                const penaltyCell = row.insertCell();
                // Only show penalty details that are NOT trade-out or IOU return deduction
                const filteredPenaltyDetails = entry.penaltyDetails ? entry.penaltyDetails.filter(p => p.type !== 'iou_return_deduction' && p.type !== 'trade_out') : []; /* */
                if (filteredPenaltyDetails.length > 0) {
                    const ul = document.createElement('ul');
                    filteredPenaltyDetails.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = `${p.desc}: ${p.pointsDeducted}分`;
                        ul.appendChild(li);
                    });
                    penaltyCell.appendChild(ul);
                } else {
                    penaltyCell.textContent = entry.scores.penalty !== 0 ? `${entry.scores.penalty}分 (无非交易罚分详情)` : '无';
                    if(entry.scores.penalty === 0) penaltyCell.classList.add('no-details');
                }

                // Consume Details
                const consumeCell = row.insertCell();
                if (entry.consumedItemsDetail && entry.consumedItemsDetail.length > 0) {
                    const ul = document.createElement('ul');
                    entry.consumedItemsDetail.forEach(item => {
                        const li = document.createElement('li');
                        let descText = `${item.name}${item.quantity > 1 ? ' x'+item.quantity : ''}`;
                        if (item.type === 'IOU') {
                            descText = `购买欠条 "${item.name}"`;
                        }
                        li.textContent = `${descText}: ${item.cost}分`;
                        ul.appendChild(li);
                    });
                    consumeCell.appendChild(ul);
                } else {
                    consumeCell.textContent = entry.scores.consume !== 0 ? `${entry.scores.consume}分 (无详情)` : '无';
                    if(entry.scores.consume === 0) consumeCell.classList.add('no-details');
                }

                // Trade (T-card income) Details
                const tradeCell = row.insertCell();
                // Filter out trade_in and iou_return_gain from tradeDetails here as they will be in Transaction Details
                const filteredTradeDetails = entry.tradeDetails ? entry.tradeDetails.filter(t => t.type !== 'iou_purchase_income' && t.type !== 'iou_return_gain') : []; /* */
                if (filteredTradeDetails.length > 0) {
                    const ul = document.createElement('ul');
                    filteredTradeDetails.forEach(t => {
                        const li = document.createElement('li');
                        li.textContent = `${t.desc}: +${t.pointsAdded}分`;
                        ul.appendChild(li);
                    });
                    tradeCell.appendChild(ul);
                } else {
                    tradeCell.textContent = entry.scores.trade !== undefined ? entry.scores.trade : 'N/A';
                    if(entry.scores.trade === 0) tradeCell.classList.add('no-details');
                }
                tradeCell.classList.add('num-center'); // Ensure center alignment

                // NEW: Transaction Details (Transfer In/Out)
                const transactionDetailCell = row.insertCell();
                let hasTransactions = false;
                const transactionUl = document.createElement('ul');
                // Display direct trade-out
                if (entry.tradeFromLog && entry.tradeFromLog.length > 0) {
                    hasTransactions = true;
                    entry.tradeFromLog.forEach(log => {
                        const li = document.createElement('li');
                        li.textContent = `转出给${log.toPlayer === 'qiqi' ? '七七' : '一一'} (-${log.amount}分): ${log.memo}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display direct trade-in
                if (entry.tradeToLog && entry.tradeToLog.length > 0) {
                    hasTransactions = true;
                    entry.tradeToLog.forEach(log => {
                        const li = document.createElement('li');
                        li.textContent = `从${log.fromPlayer === 'qiqi' ? '七七' : '一一'}转入 (+${log.amount}分): ${log.memo}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display IOU purchase income (as it's a direct point transfer from one player to another)
                if (entry.tradeDetails) { // Re-checking original tradeDetails for IOU purchase income
                    entry.tradeDetails.filter(t => t.type === 'iou_purchase_income').forEach(t => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `欠条购入收入 (+${t.pointsAdded}分): ${t.desc}`;
                        transactionUl.appendChild(li);
                    });
                }
                // Display IOU return gain/deduction (as it's a direct point transfer)
                if (entry.tradeDetails) {
                    entry.tradeDetails.filter(t => t.type === 'iou_return_gain').forEach(t => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `欠条归还收入 (+${t.pointsAdded}分): ${t.desc}`;
                        transactionUl.appendChild(li);
                    });
                }
                if (entry.penaltyDetails) {
                     entry.penaltyDetails.filter(p => p.type === 'iou_return_deduction').forEach(p => {
                        hasTransactions = true;
                        const li = document.createElement('li');
                        li.textContent = `欠条归还扣除 (${p.pointsDeducted}分): ${p.desc}`;
                        transactionUl.appendChild(li);
                    });
                }


                if (hasTransactions) {
                    transactionDetailCell.appendChild(transactionUl);
                } else {
                    transactionDetailCell.textContent = '无';
                    transactionDetailCell.classList.add('no-details');
                }

                const totalCell = row.insertCell(); 
                totalCell.textContent = entry.scores.total; 
                totalCell.classList.add('total-highlight', 'num-center');
            });
        }

        // NEW: Function to open the confirmation modal for adding week total
        let playerToAddToTotal = null; // Store which player's data is being processed
        function openConfirmAddTotalModal(player) {
            requestEditPermission(() => {
                playerToAddToTotal = player;
                const scores = calculateWeekScore(player);
                const playerName = player === 'qiqi' ? '七七' : '一一';
                document.getElementById('confirm-add-total-title').textContent = `确认操作`;
                document.getElementById('confirm-add-total-desc').innerHTML = `确定要将 ${playerName} 本周的积分总计 **${scores.total}分** 加入总分并清空本周数据吗？`;
                document.getElementById('confirm-add-total-btn').onclick = () => {
                    addWeekTotalToTotal(playerToAddToTotal);
                    closeConfirmAddTotalModal();
                };
                document.getElementById('confirm-add-total-modal-overlay').style.display = 'flex';
            });
        }

        // NEW: Function to close the confirmation modal
        function closeConfirmAddTotalModal() {
            document.getElementById('confirm-add-total-modal-overlay').style.display = 'none';
            playerToAddToTotal = null;
        }

        function addWeekTotalToTotal(player) { requestEditPermission(() => _addWeekTotalToTotalInternal(player)); }
        function _addWeekTotalToTotalInternal(player) {
            const scores = calculateWeekScore(player); const sum = scores.total;
            const totalInput = document.getElementById(player + '-total'); let currentTotal = parseInt(totalInput.value) || 0;
            totalInput.value = currentTotal + sum;

            const consumedItemsDetail = []; 
            const penaltyDetails = []; 
            const basicScoreDetailsLog = []; 
            const rewardDetailsLog = []; 
            const tradeDetailsLog = []; // T-card income / IOU purchase income / IOU return gain
            const tradeFromLog = []; // Collect tradeFromLog
            const tradeToLog = [];    // Collect tradeToLog

            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            days.forEach(day => {
                if (weekData[player][day].purchaseLog) { weekData[player][day].purchaseLog.forEach(log => consumedItemsDetail.push(log));}
                if (weekData[player][day].penaltyLog) { weekData[player][day].penaltyLog.forEach(log => penaltyDetails.push(log));}
                if (weekData[player][day].rewardLog) { weekData[player][day].rewardLog.forEach(log => rewardDetailsLog.push({...log, day: day }));}
                if (weekData[player][day].tradeLog) { weekData[player][day].tradeLog.forEach(log => tradeDetailsLog.push({...log, day: day }));} 
                if (weekData[player][day].tradeFromLog) { weekData[player][day].tradeFromLog.forEach(log => tradeFromLog.push({...log, day: day }));} 
                if (weekData[player][day].tradeToLog) { weekData[player][day].tradeToLog.forEach(log => tradeToLog.push({...log, day: day }));}       

                ['book', 'sleep', 'exercise'].forEach(task => { const taskScore = parseInt(weekData[player][day][task]) || 0; if (taskScore !== 0) { basicScoreDetailsLog.push({ day: day, task: task, score: taskScore }); }});
            });
            
            const historyEntry = { 
                timestamp: Date.now(), 
                player: player, 
                scores: scores, 
                consumedItemsDetail: consumedItemsDetail, 
                penaltyDetails: penaltyDetails, 
                basicScoreDetails: basicScoreDetailsLog, 
                rewardDetails: rewardDetailsLog, 
                tradeDetails: tradeDetailsLog,
                tradeFromLog: tradeFromLog, 
                tradeToLog: tradeToLog         
            };
            scoreHistoryLog.unshift(historyEntry); renderScoreHistoryTable(); _saveScoreHistoryToFirebaseInternal(); 
            
            // Clear the current week's data after adding to total
            resetWeekData(player); 
            _saveToFirebaseInternal(); 

            alert(`已将本周总分（${sum}）加入 ${player === 'qiqi' ? '七七' : '一一'} 总积分！本周数据已清零，历史记录已更新。`);
        }
        
        function clearScoreHistory() { requestEditPermission(() => { if (confirm('确定要清空所有积分历史记录吗？此操作无法撤销！')) { scoreHistoryLog = []; renderScoreHistoryTable(); database.ref('/scoreHistory').remove().then(() => alert('积分历史记录已清空！')).catch(error => alert('清空积分历史记录失败: ' + error.message)); }});}

        function resetAllData() { requestEditPermission(() => { if (confirm('确定要重置所有数据吗 (包括周记录, 总积分, 仓库, 自定义卡片和积分历史)？此操作无法撤销！')) { 
            Object.keys(weekData).forEach(p => { Object.keys(weekData[p]).forEach(day => { weekData[p][day] = initialDayData(); }); });
            document.getElementById('qiqi-total').value = 0; document.getElementById('yiyi-total').value = 0;
            document.querySelectorAll('.clickable-cell[onclick*="toggleBasicTask"]').forEach(cell => { cell.textContent = '0'; cell.className = cell.className.replace(/cell-(negative|zero|positive)/g, '').trim() + ' cell-zero'; });
            document.querySelectorAll('.reward-cell').forEach(cell => { cell.textContent = '0'; cell.className = 'reward-cell reward-0'; });
            document.querySelectorAll('.small-input[readonly]').forEach(input => input.value = 0); 
            updateWeekSummary('qiqi'); updateWeekSummary('yiyi');
            warehousesData = { qiqi: [], yiyi: [] }; renderWarehouses();
            customDefinedCards = {}; 
            iouCardsData = {};
            hiddenPredefinedCardIds = []; 
            renderAllCards();
            database.ref('/customDefinedCards').remove(); 
            database.ref('/hiddenPredefinedCardIds').remove(); 
            database.ref('/iouCardsData').remove(); 
            scoreHistoryLog = []; renderScoreHistoryTable(); database.ref('/scoreHistory').remove(); 
            _saveToFirebaseInternal(); alert('所有数据已重置！');
        }}); }

        function resetWeekData(player) { requestEditPermission(() => { 
            Object.keys(weekData[player]).forEach(day => { weekData[player][day] = initialDayData(); });
            const playerTable = document.querySelector(`#${player}-summary`).closest('.week-card').querySelector('.week-table');
            if (playerTable) {
                playerTable.querySelectorAll('.clickable-cell[onclick*="toggleBasicTask"]').forEach(cell => { cell.textContent = '0'; cell.className = cell.className.replace(/cell-(negative|zero|positive)/g, '').trim() + ' cell-zero'; });
                playerTable.querySelectorAll('.reward-cell').forEach(cell => { cell.textContent = '0'; cell.className = 'reward-cell reward-0'; });
                playerTable.querySelectorAll('td input[readonly]').forEach(input => input.value = 0);
            }
            updateWeekSummary(player); _saveToFirebaseInternal(); 
        });}

        function loadDataFromFirebase() {
            statusElement.textContent = '📥 加载数据...'; statusElement.className = 'connection-status connecting';
            let loadedCount = 0; const totalToLoad = 6; 
            
            const allLoaded = () => {
                loadedCount++;
                if (loadedCount >= totalToLoad) {
                     setTimeout(() => {
                        statusElement.textContent = '✅ 数据已加载'; statusElement.className = 'connection-status connected';
                        updateWeekSummary('qiqi'); updateWeekSummary('yiyi');
                        renderWarehouses(); renderScoreHistoryTable(); renderAllCards();
                    }, 500);
                }
            };

            database.ref('weekData').once('value').then((snapshot) => { if (snapshot.exists()) { const ld = snapshot.val(); Object.keys(ld).forEach(p=>{Object.keys(ld[p]).forEach(d=>{weekData[p][d]={...initialDayData(),...ld[p][d]}; weekData[p][d].purchaseLog = ld[p][d].purchaseLog || []; weekData[p][d].penaltyLog = ld[p][d].penaltyLog || []; weekData[p][d].rewardLog = ld[p][d].rewardLog || []; weekData[p][d].tradeLog = ld[p][d].tradeLog || []; weekData[p][d].tradeFromLog = ld[p][d].tradeFromLog || []; weekData[p][d].tradeToLog = ld[p][d].tradeToLog || []; });}); Object.entries(weekData).forEach(([p,days])=>{ const ptb=document.querySelector(`#${p}-summary`)?.closest('.week-card')?.querySelector('tbody'); if(!ptb)return; Object.entries(days).forEach(([day,sc])=>{ const di=['mon','tue','wed','thu','fri','sat','sun'].indexOf(day); if(di===-1)return; const tr=ptb.querySelector(`tr:nth-child(${di+1})`); if(!tr)return; Object.entries(sc).forEach(([k,v])=>{ if(['book','sleep','exercise'].includes(k)){const ci=['book','sleep','exercise'].indexOf(k)+2;const c=tr.querySelector(`td:nth-child(${ci})`);if(c){c.textContent=v; c.className=c.className.replace(/cell-(n|z|p).*/g,'').trim(); if(v===-2)c.classList.add('cell-negative'); else if(v===0)c.classList.add('cell-zero'); else if(v===1)c.classList.add('cell-positive');}} else if(k==='reward'){const c=tr.querySelector('td:nth-child(5)');if(c){c.textContent=v; c.className='reward-cell'; const rv=parseInt(v)||0; c.classList.add(`reward-${Math.min(3,Math.max(0,rv))}`);}} else if(k==='penalty'){const i=tr.querySelector('td:nth-child(6) input');if(i)i.value=v;} else if(k==='consume'){const i=tr.querySelector('td:nth-child(7) input');if(i)i.value=v;} else if(k==='trade'){const i=tr.querySelector('td:nth-child(8) input');if(i)i.value=v;}});});}); } allLoaded(); }).catch(err => { console.error("Error loading weekData: ", err); allLoaded(); });
            database.ref('totalScores').once('value').then((snapshot) => { if (snapshot.exists()) { const s = snapshot.val(); if (s.qiqi !== undefined) document.getElementById('qiqi-total').value = s.qiqi; if (s.yiyi !== undefined) document.getElementById('yiyi-total').value = s.yiyi;} allLoaded(); }).catch(err => { console.error("Error loading totalScores: ", err); allLoaded(); });
            database.ref('scoreHistory').once('value').then((snapshot) => { let lh = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; lh.forEach(e => { if (e.basicScoreDetails && !Array.isArray(e.basicScoreDetails)) e.basicScoreDetails = []; if (e.rewardDetails && !Array.isArray(e.rewardDetails)) e.rewardDetails = []; if (e.scores && e.scores.trade === undefined) e.scores.trade = 0; if (e.tradeDetails && !Array.isArray(e.tradeDetails)) e.tradeDetails = []; if (e.tradeFromLog && !Array.isArray(e.tradeFromLog)) e.tradeFromLog = []; if (e.tradeToLog && !Array.isArray(e.tradeToLog)) e.tradeToLog = []; }); scoreHistoryLog = lh; allLoaded(); }).catch(err => { console.error("Error loading scoreHistory: ", err); allLoaded(); });
            database.ref('warehousesData').once('value').then((snapshot) => { if (snapshot.exists()) { warehousesData = snapshot.val(); if (!Array.isArray(warehousesData.qiqi)) warehousesData.qiqi = []; if (!Array.isArray(warehousesData.yiyi)) warehousesData.yiyi = []; } else { warehousesData = { qiqi: [], yiyi: [] }; } allLoaded(); }).catch(err => { console.error("Error loading warehousesData: ", err); allLoaded(); });
            database.ref('customDefinedCards').once('value').then((snapshot) => { customDefinedCards = snapshot.exists() ? snapshot.val() : {}; allLoaded(); }).catch(err => { console.error("Error loading customDefinedCards: ", err); allLoaded(); }); 
            database.ref('hiddenPredefinedCardIds').once('value').then((snapshot) => { hiddenPredefinedCardIds = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; allLoaded(); }).catch(err => { console.error("Error loading hiddenPredefinedCardIds: ", err); allLoaded(); });
            database.ref('iouCardsData').once('value').then((snapshot) => { iouCardsData = snapshot.exists() ? snapshot.val() : {}; allLoaded(); }).catch(err => { console.error("Error loading iouCardsData: ", err); allLoaded(); });
        }

        function setupRealTimeSync() {
            database.ref('weekData').on('value', (snapshot) => { if(!snapshot.exists()) return; const nd = snapshot.val(); if(JSON.stringify(nd)!==JSON.stringify(weekData)){ Object.keys(nd).forEach(p=>{Object.keys(nd[p]).forEach(d=>{weekData[p][d]={...initialDayData(),...nd[p][d]};weekData[p][d].purchaseLog=nd[p][d].purchaseLog||[];weekData[p][d].penaltyLog=nd[p][d].penaltyLog||[];weekData[p][d].rewardLog=nd[p][d].rewardLog||[]; weekData[p][d].tradeLog=nd[p][d].tradeLog||[]; weekData[p][d].tradeFromLog=nd[p][d].tradeFromLog||[]; weekData[p][d].tradeToLog=nd[p][d].tradeToLog||[];});}); Object.entries(weekData).forEach(([p,days])=>{const ptb=document.querySelector(`#${p}-summary`)?.closest('.week-card')?.querySelector('tbody');if(!ptb)return;Object.entries(days).forEach(([day,sc])=>{const di=['mon','tue','wed','thu','fri','sat','sun'].indexOf(day);if(di===-1)return;const tr=ptb.querySelector(`tr:nth-child(${di+1})`);if(!tr)return;Object.entries(sc).forEach(([k,v])=>{if(['book','sleep','exercise'].includes(k)){const ci=['book','sleep','exercise'].indexOf(k)+2;const c=tr.querySelector(`td:nth-child(${ci})`);if(c&&c.textContent!=v){c.textContent=v;c.className=c.className.replace(/cell-(n|z|p).*/g,'').trim();if(v===-2)c.classList.add('cell-negative');else if(v===0)c.classList.add('cell-zero');else if(v===1)c.classList.add('cell-positive');}}else if(k==='reward'){const c=tr.querySelector('td:nth-child(5)');if(c&&c.textContent!=v){c.textContent=v;c.className='reward-cell';const rv=parseInt(v)||0;c.classList.add(`reward-${Math.min(3,Math.max(0,rv))}`);}}else if(k==='penalty'){const i=tr.querySelector('td:nth-child(6) input');if(i&&i.value!=v)i.value=v;}else if(k==='consume'){const i=tr.querySelector('td:nth-child(7) input');if(i&&i.value!=v)i.value=v;}else if(k==='trade'){const i=tr.querySelector('td:nth-child(8) input');if(i&&i.value!=v)i.value=v;}});});updateWeekSummary(p);});}});
            database.ref('totalScores').on('value', (snapshot) => { if(!snapshot.exists()) return; const s = snapshot.val(); const qi = document.getElementById('qiqi-total'); const yi = document.getElementById('yiyi-total'); if (s.qiqi !== undefined && qi.value != s.qiqi) qi.value = s.qiqi; if (s.yiyi !== undefined && yi.value != s.yiyi) yi.value = s.yiyi; });
            database.ref('scoreHistory').on('value', (snapshot) => { let nh = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; nh.forEach(e => { if (e.basicScoreDetails && !Array.isArray(e.basicScoreDetails)) e.basicScoreDetails = []; if (e.rewardDetails && !Array.isArray(e.rewardDetails)) e.rewardDetails = []; if (e.scores && e.scores.trade === undefined) e.scores.trade = 0; if (e.tradeDetails && !Array.isArray(e.tradeDetails)) e.tradeDetails = []; if (e.tradeFromLog && !Array.isArray(e.tradeFromLog)) e.tradeFromLog = []; if (e.tradeToLog && !Array.isArray(e.tradeToLog)) e.tradeToLog = []; }); if (JSON.stringify(nh) !== JSON.stringify(scoreHistoryLog)) { scoreHistoryLog = nh; renderScoreHistoryTable(); }});
            database.ref('warehousesData').on('value', (snapshot) => { let nw = {qiqi: [], yiyi: []}; if (snapshot.exists()) { nw = snapshot.val(); if (!Array.isArray(nw.qiqi)) nw.qiqi = []; if (!Array.isArray(nw.yiyi)) nw.yiyi = [];} if (JSON.stringify(nw) !== JSON.stringify(warehousesData)) { warehousesData = nw; renderWarehouses(); }});
            database.ref('customDefinedCards').on('value', (snapshot) => { let nc = snapshot.exists() ? snapshot.val() : {}; if (JSON.stringify(nc) !== JSON.stringify(customDefinedCards)) { customDefinedCards = nc; renderAllCards(); }}); 
            database.ref('hiddenPredefinedCardIds').on('value', (snapshot) => { let nhp = (snapshot.exists() && Array.isArray(snapshot.val())) ? snapshot.val() : []; if (JSON.stringify(nhp) !== JSON.stringify(hiddenPredefinedCardIds)) { hiddenPredefinedCardIds = nhp; renderAllCards(); }});
            database.ref('iouCardsData').on('value', (snapshot) => { let niou = snapshot.exists() ? snapshot.val() : {}; if (JSON.stringify(niou) !== JSON.stringify(iouCardsData)) { iouCardsData = niou; renderAllCards(); }});
        }

        // Renamed and consolidated functions for defining cards
        function openDefineCustomCardModal(defaultPoints = null) {
            requestEditPermission(() => {
                document.getElementById('custom-card-name').value = ''; 
                const pointsInput = document.getElementById('custom-card-points');
                pointsInput.value = defaultPoints !== null ? defaultPoints : '';
                document.getElementById('custom-card-type').value = 'E'; 
                document.getElementById('custom-card-desc').value = '';
                document.getElementById('define-custom-card-modal-overlay').style.display = 'flex'; 
                document.getElementById('custom-card-name').focus();
            });
        }
        function closeDefineCustomCardModal() { document.getElementById('define-custom-card-modal-overlay').style.display = 'none'; }
        function defineAndListCustomCard() { requestEditPermission(_defineAndListCustomCardInternal); }
        function _defineAndListCustomCardInternal() {
            const name = document.getElementById('custom-card-name').value.trim(); 
            const points = parseInt(document.getElementById('custom-card-points').value);
            const type = document.getElementById('custom-card-type').value; 
            const desc = document.getElementById('custom-card-desc').value.trim();
            if (!name) { alert('请输入卡片名称。'); return; } if (isNaN(points) || points <= 0) { alert('请输入有效的积分消耗。'); return; }
            if (!type) { alert('请选择卡片类型。'); return; } 
            // H类型卡片不需要描述
            if (type !== 'H' && !desc) { alert('请输入卡片描述。'); return; } 

            const nameConflict = Object.values(customDefinedCards).some(card => card.name === name) ||
                                 Object.values(iouCardsData).some(card => card.name === name) ||
                                 Array.from(document.querySelectorAll('#main-cards-grid .card-item[data-name]')).some(el => el.dataset.name === name && !hiddenPredefinedCardIds.includes(el.id));
            if (nameConflict) { alert('已存在同名卡片 (包括预设、自定义或欠条卡片)，请使用其他名称。'); return; } 
            
            const cardId = 'custom_' + Date.now();
            customDefinedCards[cardId] = { id: cardId, name: name, points: points, type: type, desc: desc, isCustom: true }; 
            renderAllCards(); _saveToFirebaseInternal(); closeDefineCustomCardModal(); alert(`自定义卡片 "${name}" 已创建并上架！`);
        }

        // IOU Card Definition Functions
        function openDefineIOUCardModal() {
            requestEditPermission(() => {
                document.getElementById('iou-card-points').value = '';
                document.getElementById('iou-card-interest').value = '10'; // Default 10% interest
                document.getElementById('define-IOU-card-modal-overlay').style.display = 'flex';
                document.getElementById('iou-card-points').focus();
            });
        }

        function closeDefineIOUCardModal() {
            document.getElementById('define-IOU-card-modal-overlay').style.display = 'none';
        }

        function defineAndListIOUCard() { requestEditPermission(_defineAndListIOUCardInternal); }
        function _defineAndListIOUCardInternal() {
            const points = parseInt(document.getElementById('iou-card-points').value);
            const interest = parseInt(document.getElementById('iou-card-interest').value);
            const cardName = `欠条 (面值${points}, 利息${interest}%)`;

            if (isNaN(points) || points <= 0) { alert('请输入有效的欠条面值 (大于0)。'); return; }
            if (isNaN(interest) || interest < 0 || interest > 100) { alert('请输入有效的利息百分比 (0-100)。'); return; }
            
            // Check for name conflict (though name includes points and interest, it's good practice)
            const nameConflict = Object.values(customDefinedCards).some(card => card.name === cardName) ||
                                 Object.values(iouCardsData).some(card => card.name === cardName) ||
                                 Array.from(document.querySelectorAll('#main-cards-grid .card-item[data-name]')).some(el => el.dataset.name === cardName && !hiddenPredefinedCardIds.includes(el.id));
            if (nameConflict) { alert('已存在相同面值和利息的欠条，请调整后重新定义。'); return; }

            const cardId = 'iou_' + Date.now();
            iouCardsData[cardId] = {
                id: cardId,
                name: cardName,
                points: points, // Purchase price
                type: 'IOU',
                desc: `此欠条面值${points}积分，使用时需归还${interest}%利息。`,
                interestRate: interest // Interest percentage
            };
            renderAllCards();
            _saveToFirebaseInternal();
            closeDefineIOUCardModal();
            alert(`欠条卡片 "${cardName}" 已创建并上架！`);
        }

        // IOU Card Return Functions
        let currentIOUCardToReturn = null;
        function openIOUReturnModal(player, cardName) {
            requestEditPermission(() => {
                const card = warehousesData[player].find(c => c.name === cardName && c.type === 'IOU');
                if (!card) return;

                const returnAmount = card.pointsValue + Math.round(card.pointsValue * (card.interestRate / 100));
                document.getElementById('iou-return-modal-title').textContent = `归还欠条 "${cardName}"`;
                document.getElementById('iou-return-modal-desc').textContent = `确认后，${player === 'qiqi' ? '七七' : '一一'} 将获得 ${returnAmount} 积分，${player === 'qiqi' ? '一一' : '七七'} 将扣除 ${returnAmount} 积分。`;
                document.getElementById('confirm-iou-return-btn').onclick = () => processIOUReturn(player, card);
                document.getElementById('iou-return-modal-overlay').style.display = 'flex';
            });
        }

        function closeIOUReturnModal() {
            document.getElementById('iou-return-modal-overlay').style.display = 'none';
            currentIOUCardToReturn = null;
        }

        function processIOUReturn(player, card) { requestEditPermission(() => _processIOUReturnInternal(player, card)); }
        function _processIOUReturnInternal(player, card) {
            if (!card || card.type !== 'IOU') { alert('无效的欠条卡片信息。'); closeIOUReturnModal(); return; }

            const returnAmount = card.pointsValue + Math.round(card.pointsValue * (card.interestRate / 100));
            const otherPlayer = player === 'qiqi' ? 'yiyi' : 'qiqi';
            const today = new Date();
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const currentDayKey = dayNames[today.getDay()];

            // User gets points (计入trade)
            weekData[player][currentDayKey].trade = (parseInt(weekData[player][currentDayKey].trade) || 0) + returnAmount; /* */
            // Other player loses points (从trade中扣除)
            weekData[otherPlayer][currentDayKey].trade = (parseInt(weekData[otherPlayer][currentDayKey].trade) || 0) - returnAmount; /* */

            // Record to history logs (使用tradeToLog和tradeFromLog)
            if (!weekData[player][currentDayKey].tradeToLog) weekData[player][currentDayKey].tradeToLog = [];
            weekData[player][currentDayKey].tradeToLog.push({ desc: `使用欠条 "${card.name}" 归还`, amount: returnAmount, fromPlayer: otherPlayer, type: 'iou_return_gain' }); /* */

            if (!weekData[otherPlayer][currentDayKey].tradeFromLog) weekData[otherPlayer][currentDayKey].tradeFromLog = [];
            weekData[otherPlayer][currentDayKey].tradeFromLog.push({ desc: `因对方使用欠条 "${card.name}" 被扣除 (含利息)`, amount: returnAmount, toPlayer: player, type: 'iou_return_deduction' }); /* */


            // Remove card from warehouse
            const playerWarehouse = warehousesData[player];
            const cardIndex = playerWarehouse.findIndex(c => c.name === card.name && c.type === 'IOU');
            if (cardIndex !== -1) {
                if (playerWarehouse[cardIndex].quantity > 1) {
                    playerWarehouse[cardIndex].quantity--;
                } else {
                    playerWarehouse.splice(cardIndex, 1);
                }
            }

            updateWeekSummary(player);
            updateWeekSummary(otherPlayer);
            renderWarehouses();
            _saveToFirebaseInternal();
            alert(`${player === 'qiqi' ? '七七' : '一一'} 已归还欠条 "${card.name}"，获得 ${returnAmount} 积分！${otherPlayer === 'qiqi' ? '七七' : '一一'} 扣除 ${returnAmount} 积分。`);
            closeIOUReturnModal();
        }

        function getCardColorClass(points) {
            if (points === 1) return 'points-1'; if (points === 2) return 'points-2'; if (points >= 3 && points <= 4) return 'points-3';
            if (points >= 5 && points <= 9) return 'points-5'; if (points >= 10 && points <= 19) return 'points-10'; if (points >= 20) return 'points-20';
            return 'points-1'; // Default
        }
        
        function renderAllCards() {
            // 1. Render Predefined Cards (handle hidden state)
            document.querySelectorAll('#main-cards-grid .card-item[id^="predef_"]').forEach(cardEl => {
                if (hiddenPredefinedCardIds.includes(cardEl.id)) {
                    cardEl.style.display = 'none';
                } else {
                    cardEl.style.display = ''; 
                }
            });
            
            // 2. Clear existing dynamically added custom cards from main grid before re-rendering
            // Also clear the custom cards grid within the .custom-cards-section
            document.querySelectorAll('#main-cards-grid .card-item[data-custom="true"]').forEach(el => el.remove());
            const customCardsGrid = document.getElementById('temp-cards-grid'); 
            customCardsGrid.innerHTML = ''; 
            const noCustomItemsText = document.getElementById('no-temp-cards-text'); 
            if (noCustomItemsText) customCardsGrid.appendChild(noCustomItemsText); 

            // 3. Render Custom Cards (formerly temporary and permanent) into their dedicated section AND main sections
            const customCardsArray = Object.values(customDefinedCards);
            const customSectionWrapper = document.getElementById('temporary-cards-section'); 
            
            if (customCardsArray.length > 0) {
                customSectionWrapper.style.display = 'block'; 
                if(noCustomItemsText) noCustomItemsText.style.display = 'none'; 
                
                customCardsArray.forEach(card => {
                    const cardPoints = parseInt(card.points);
                    const colorClass = getCardColorClass(cardPoints);
                    
                    // Add to Custom Cards Section (the box at the top)
                    const customCardElInCustomSection = document.createElement('div'); 
                    customCardElInCustomSection.className = `card-item ${colorClass}`; 
                    customCardElInCustomSection.onclick = (event) => { /* Added event parameter */
                        event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                        openBuyerModal(card.points, card.type, card.name, true, card.id); 
                    };
                    customCardElInCustomSection.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'custom')">❌</button>`; /* Added event.stopPropagation() here */
                    
                    customCardsGrid.appendChild(customCardElInCustomSection); 

                    // Also add to Main Cards Grid if it's not an H type (H cards are direct use, not for purchase)
                    if (card.type !== 'H') { 
                        let targetSection = document.querySelector(`#main-cards-grid .points-section.${colorClass}`); 
                        if (!targetSection) { 
                            // Create section if it doesn't exist for this point value
                            targetSection = document.createElement('div'); 
                            targetSection.className = `points-section ${colorClass}`; 
                            const h3 = document.createElement('h3'); 
                            h3.innerHTML = `自定义 ${cardPoints}积分 <button class="add-card-to-section-btn" onclick="openDefineCustomCardModal(${cardPoints})">⊕ 添加</button>`; 
                            targetSection.appendChild(h3); 
                            document.getElementById('main-cards-grid').appendChild(targetSection); 
                        }
                        const cardElInMainGrid = document.createElement('div'); 
                        cardElInMainGrid.className = 'card-item'; 
                        cardElInMainGrid.dataset.points = card.points; cardElInMainGrid.dataset.type = card.type; cardElInMainGrid.dataset.name = card.name; 
                        cardElInMainGrid.dataset.id = card.id; cardElInMainGrid.dataset.custom = "true"; 
                        cardElInMainGrid.onclick = (event) => { /* Added event parameter */
                            event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                            openBuyerModal(card.points, card.type, card.name, true, card.id); 
                        };
                        cardElInMainGrid.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'custom')">❌</button>`; /* Added event.stopPropagation() here */
                        targetSection.appendChild(cardElInMainGrid); 
                    }
                });
            } else {
                if(noCustomItemsText) noCustomItemsText.style.display = 'block'; 
            }

            // 4. Clear existing dynamically added IOU cards from main grid
            document.querySelectorAll('#main-cards-grid .points-section.points-iou').forEach(el => el.remove()); 

            // 5. Render IOU Cards into a new section in main-cards-grid
            const mainCardsGrid = document.getElementById('main-cards-grid'); 
            if (Object.keys(iouCardsData).length > 0) { 
                const iouSection = document.createElement('div'); 
                iouSection.className = 'points-section points-iou'; 
                iouSection.innerHTML = `<h3>📝 欠条卡片 <button class="add-card-to-section-btn" onclick="openDefineIOUCardModal()">⊕ 添加</button></h3>`;
                
                Object.values(iouCardsData).forEach(card => { 
                    const cardEl = document.createElement('div'); 
                    cardEl.className = 'card-item'; 
                    cardEl.dataset.points = card.points; 
                    cardEl.dataset.type = card.type; 
                    cardEl.dataset.name = card.name; 
                    cardEl.dataset.id = card.id; 
                    cardEl.dataset.iou = "true"; 
                    cardEl.onclick = (event) => { /* Added event parameter */
                        event.stopPropagation(); /* Stop propagation to prevent card purchase modal */
                        openBuyerModal(card.points, card.type, card.name, false, card.id); 
                    };
                    cardEl.innerHTML = `<div class="card-title">${card.name}</div><div class="card-desc">${card.desc}</div><button class="delete-card-btn" onclick="event.stopPropagation(); handleDeleteCard('${card.id}', 'iou')">❌</button>`; /* Added event.stopPropagation() here */
                    iouSection.appendChild(cardEl); 
                });
                mainCardsGrid.appendChild(iouSection); 
            }
        }


        function handleDeleteCard(identifier, cardTypeString) {
            requestEditPermission(() => {
                if (!confirm(`确定要删除这个卡片吗？\n类型: ${cardTypeString}\nID/名称: ${identifier}`)) return;

                if (cardTypeString === 'predefined') {
                    if (!hiddenPredefinedCardIds.includes(identifier)) {
                        hiddenPredefinedCardIds.push(identifier);
                    }
                } else if (cardTypeString === 'custom') { 
                    delete customDefinedCards[identifier];
                } else if (cardTypeString === 'iou') {
                    delete iouCardsData[identifier];
                }
                renderAllCards(); 
                _saveToFirebaseInternal(); 
                alert('卡片已删除/隐藏。');
            });
        }

        // NEW: Function for direct points trade
        function executePointsTrade() {
            requestEditPermission(() => _executePointsTradeInternal());
        }

        function _executePointsTradeInternal() {
            const fromPlayer = document.getElementById('trade-from').value;
            const toPlayer = document.getElementById('trade-to').value;
            const amount = parseInt(document.getElementById('trade-amount').value);
            const memo = document.getElementById('trade-memo').value.trim();

            if (!fromPlayer || !toPlayer) {
                alert('请选择转账方和接收方！');
                return;
            }

            if (fromPlayer === toPlayer) {
                alert('转账方和接收方不能是同一人！');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效的积分数量！');
                return;
            }

            if (!memo) {
                alert('请填写交易备注！');
                return;
            }

            const today = new Date();
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const currentDayKey = dayNames[today.getDay()];

            // === 修改点1：转出方积分直接从 trade 列扣除 ===
            weekData[fromPlayer][currentDayKey].trade = (parseInt(weekData[fromPlayer][currentDayKey].trade) || 0) - amount; 
            // 记录转账方转出明细
            if (!weekData[fromPlayer][currentDayKey].tradeFromLog) weekData[fromPlayer][currentDayKey].tradeFromLog = [];
            weekData[fromPlayer][currentDayKey].tradeFromLog.push({ amount: amount, toPlayer: toPlayer, memo: memo, type: 'direct_trade_out' }); 

            // === 修改点2：接收方积分直接增加到 trade 列 ===
            weekData[toPlayer][currentDayKey].trade = (parseInt(weekData[toPlayer][currentDayKey].trade) || 0) + amount; 
            // 记录接收方转入明细
            if (!weekData[toPlayer][currentDayKey].tradeToLog) weekData[toPlayer][currentDayKey].tradeToLog = [];
            weekData[toPlayer][currentDayKey].tradeToLog.push({ amount: amount, fromPlayer: fromPlayer, memo: memo, type: 'direct_trade_in' }); 

            updateWeekSummary(fromPlayer);
            updateWeekSummary(toPlayer);
            _saveToFirebaseInternal();

            alert(`交易成功！\n${fromPlayer === 'qiqi' ? '七七' : '一一'} 向 ${toPlayer === 'qiqi' ? '七七' : '一一'} 转账 ${amount} 积分\n备注：${memo}`);

            // 清空表单
            document.getElementById('trade-from').value = '';
            document.getElementById('trade-to').value = '';
            document.getElementById('trade-amount').value = '';
            document.getElementById('trade-memo').value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // No initial login needed, so hide the login overlay
            document.getElementById('login-overlay').style.display = 'none'; 
            document.querySelector('.content').classList.remove('locked'); // Ensure content is unlocked

            // Add event listeners that require edit permission
            ['qiqi-total', 'yiyi-total'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    saveToFirebase(); // This will trigger requestEditPermission
                });
            });
            
            loadDataFromFirebase(); 
            setupRealTimeSync();

            document.querySelectorAll('.total-score-input').forEach(input => {
                input.addEventListener('blur', function() {
                    let value = parseInt(this.value) || 0; if (value < 0) value = 0; if (value > 9999999) value = 9999999;
                    if (this.value !== value.toString()) { this.value = value; saveToFirebase(false); } else { this.value = value; }
                });
            });
            const initialActiveTab = document.querySelector('.nav-tab.active');
            if (initialActiveTab) { const pageIdMatch = initialActiveTab.getAttribute('onclick').match(/showPage\('([^']*)'\)/); if (pageIdMatch && pageIdMatch[1]) showPage(pageIdMatch[1]); else showPage('daily'); } else { showPage('daily'); }
            // renderAllCards is called within allLoaded() after Firebase data is fetched

            // NEW: 动态更新接收方选项的监听器
            document.getElementById('trade-from').addEventListener('change', function() {
                const toSelect = document.getElementById('trade-to');
                const fromValue = this.value;
                
                toSelect.innerHTML = '<option value="">请选择</option>'; // Clear接收方选项
                
                if (fromValue === 'qiqi') {
                    toSelect.innerHTML += '<option value="yiyi">一一</option>';
                } else if (fromValue === 'yiyi') {
                    toSelect.innerHTML += '<option value="qiqi">七七</option>';
                } else {
                    // If 'from' is empty, show both options for 'to'
                    toSelect.innerHTML += '<option value="qiqi">七七</option><option value="yiyi">一一</option>';
                }
            });
        });

    </script>
</body>
</html>
