<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>积分管理系统 V2.0</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="积分管理系统">
    <meta name="description" content="完成任务，获得悬赏！积分管理系统帮助您轻松管理个人积分奖励。">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-navbutton-color" content="#667eea">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icon-152x152.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="./icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="./icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="./icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icon-512x512.png">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/x-icon" href="./ghostwriter.ico">
    <link rel="shortcut icon" type="image/x-icon" href="./ghostwriter.ico">
    
    <!-- Windows Tiles -->
    <meta name="msapplication-TileImage" content="./icon-144x144.png">
    <meta name="msapplication-config" content="./browserconfig.xml">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCI2ksv8LV88v7wKIj9-2a-QfUl1vbD8JA",
            authDomain: "points-reward-system.firebaseapp.com",
            databaseURL: "https://points-reward-system-default-rtdb.firebaseio.com",
            projectId: "points-reward-system",
            storageBucket: "points-reward-system.firebasestorage.app",
            messagingSenderId: "655875805786",
            appId: "1:655875805786:web:c69c29e0dc2d32b50d7e63",
            measurementId: "G-QXGLX0KW5E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // 将Firebase功能暴露到全局
        window.firebaseDb = {
            database,
            ref,
            set,
            get,
            onValue,
            push
        };
        
        // 初始化完成后触发事件
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* 防止移动端点击高亮 */
            -webkit-tap-highlight-color: transparent;
            /* 防止移动端选择文本 */
            -webkit-touch-callout: none;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.2); }
            to { text-shadow: 2px 2px 4px rgba(255,255,255,0.4), 0 0 20px rgba(0,0,0,0.3); }
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 8px;
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            flex-wrap: wrap;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: white;
            padding: 12px 20px;
            margin: 4px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }


        .nav-tab:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.35);
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .content {
            background: rgba(255,255,255,0.98);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.15),
                0 12px 25px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.9);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.4);
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2, #ff6b6b, #4ecdc4, #667eea);
            background-size: 400% 100%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page h2 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        /* 悬赏功能样式 */
        .bounty-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #ff6b6b;
        }

        .bounty-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .bounty-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .bounty-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin: 0;
        }

        .create-bounty-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .create-bounty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .bounty-category {
            margin-bottom: 25px;
        }

        .bounty-list {
            display: grid;
            gap: 15px;
        }

        .bounty-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .bounty-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .bounty-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-open { background: #ffe4e1; color: #d63384; }
        .status-taken { background: #fff3cd; color: #856404; }
        .status-done { background: #d1ecf1; color: #0c5460; }
        .status-expired { background: #f8d7da; color: #721c24; }
        .status-settled { background: #d4edda; color: #155724; }

        /* 系统任务特殊样式 */
        .bounty-item.system-task {
            border-left: 5px solid #4caf50;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }

        .system-task-badge {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            display: inline-block;
            margin-left: 8px;
        }

        .bounty-title-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .bounty-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #666;
        }

        .bounty-desc {
            color: #555;
            margin: 10px 0;
        }

        .bounty-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .bounty-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn-assign { background: #ffc107; color: #212529; }
        .btn-complete { background: #28a745; color: white; }
        .btn-settle { background: #007bff; color: white; }
        
        /* 完成方式按钮样式 */
        .completion-buttons {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .btn-normal {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-double {
            background: #ffc107;
            color: #212529;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-super {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }
        
        .btn-normal:hover { background: #218838; transform: translateY(-1px); }
        .btn-double:hover { background: #e0a800; transform: translateY(-1px); }
        .btn-super:hover { background: #c82333; transform: translateY(-1px); }
        
        .btn-clear {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-clear:hover { 
            background: #5a6268; 
            transform: translateY(-1px); 
        }

        .bounty-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-delete { 
            background: #dc3545; 
            color: white; 
            font-size: 0.8em;
            padding: 6px 12px;
        }

        .bounty-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .delete-bounty-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .delete-bounty-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .bounty-item {
            position: relative;
        }

        /* 积分交易样式 */
        .trade-section {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }

        .trade-form {
            display: grid;
            grid-template-columns: 1fr 1fr 80px 100px;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .trade-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .trade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        /* 模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease;
            position: relative;
            cursor: default;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 0 0;
            padding: 15px 25px 10px 25px;
            position: relative;
            cursor: move;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .modal-header h3 {
            color: white;
            margin: 0;
            text-align: center;
            font-size: 1.1em;
        }
        
        .modal-drag-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            margin: 0 auto 10px auto;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .modal-drag-handle:hover {
            background: rgba(255,255,255,0.6);
            width: 50px;
        }
        
        .modal-drag-handle::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -5px;
            right: -5px;
            bottom: -8px;
            background: transparent;
        }
        
        .modal-box > .form-group:first-child,
        .modal-box > div:not(.modal-header):first-child {
            padding: 40px 40px 0 40px;
        }
        
        .modal-box .form-group {
            padding: 0 40px;
        }
        
        .modal-box .modal-actions {
            padding: 20px 40px 40px 40px;
        }
        
        .modal-box #task-manage-list {
            padding: 20px 40px 0 40px;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        


        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .modal-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }


        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 15px rgba(108, 117, 125, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }


        .btn-secondary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(108, 117, 125, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* 统计表格样式 */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .stats-table th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .stats-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .stats-table tr:hover {
            background: #e3f2fd;
        }

        /* 连接状态指示器 */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .connection-status:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-syncing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .sync-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sync-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .sync-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .sync-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .sync-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
        }

        .sync-info p {
            color: #555;
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            /* 基础布局优化 */
            .container { 
                padding: 8px; 
                max-width: 100%;
            }
            
            .page {
                padding: 15px 10px;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 { 
                font-size: 1.8em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .content { 
                padding: 15px;
                border-radius: 15px;
            }

            /* 导航栏优化 */
            .nav-tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 8px;
                margin-bottom: 20px;
            }
            
            .nav-tab {
                padding: 12px 8px;
                font-size: 0.85em;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* 表单优化 */
            .trade-form { 
                grid-template-columns: 1fr; 
                gap: 12px; 
            }
            
            .penalty-section {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 20px 0;
            }
            
            .penalty-group, .reward-group {
                padding: 20px;
            }

            /* 悬赏信息优化 */
            .bounty-info {
                grid-template-columns: 1fr;
                gap: 8px;
                font-size: 0.9em;
            }
            
            .bounty-item {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .bounty-actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .bounty-btn {
                width: 100%;
                padding: 10px;
            }

            /* 移动端状态指示器优化 - 简化为圆形图标 */
            .connection-status {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2em;
                z-index: 1001;
                border: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            
            .connection-status .status-text {
                display: none;
            }
            
            #auth-status {
                top: 60px !important;
                right: 10px;
                left: auto;
                width: 40px;
                height: 40px;
            }
            
            /* 添加点击效果 */
            .connection-status:active {
                transform: scale(0.95);
            }

            /* 统计表格优化 */
            .stats-table {
                font-size: 0.85em;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .stats-table th,
            .stats-table td {
                padding: 8px 4px;
                min-width: 60px;
            }

            /* 模态框优化 */
            .modal-box {
                margin: 8px;
                width: calc(100% - 16px);
                max-width: none;
                min-height: auto;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            }
            
            .modal-box .form-group {
                padding: 0 25px;
            }
            
            .modal-box > .form-group:first-child,
            .modal-box > div:not(.modal-header):first-child {
                padding: 25px 25px 0 25px;
            }
            
            .modal-box .modal-actions {
                padding: 20px 25px 25px 25px;
            }
            
            .modal-box #task-manage-list {
                padding: 20px 25px 0 25px;
            }
            
            .modal-input {
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            .modal-header {
                padding: 12px 20px 8px 20px;
            }
            
            .modal-drag-handle {
                width: 35px;
                height: 3px;
                margin-bottom: 8px;
            }
            
            .modal-header h3 {
                font-size: 1em;
            }
            
            /* 密码模态框移动端优化 */
            #password-modal .modal-box {
                max-width: calc(100% - 32px);
                margin: 16px;
            }
            
            #password-modal .form-group {
                padding: 0 25px;
            }
            
            #password-modal .form-group:first-of-type {
                padding: 25px 25px 0 25px;
            }
            
            #password-modal .modal-actions {
                padding: 20px 25px 25px 25px;
            }
            
            #admin-password {
                font-size: 16px; /* 防止iOS缩放 */
            }
            
            /* 用户选择模态框移动端优化 */
            #user-select-modal .modal-box {
                max-width: calc(100% - 32px);
                margin: 16px;
            }
            
            #user-select-modal .form-group {
                padding: 0 25px;
            }
            
            #user-select-modal .form-group:first-of-type {
                padding: 25px 25px 0 25px;
            }
            
            #user-select-modal .modal-actions {
                padding: 20px 25px 25px 25px;
            }
            
            .user-select-option {
                font-size: 0.95em !important;
                padding: 12px 18px !important;
                min-height: 44px; /* Apple推荐的最小触摸目标 */
            }
            
            #user-select-options {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            /* 批量导入模态框移动端优化 */
            #batch-import-modal .modal-box {
                max-width: calc(100% - 32px);
                margin: 16px;
            }
            
            #batch-import-modal .form-group {
                padding: 0 25px;
            }
            
            #batch-import-modal .form-group:first-of-type {
                padding: 25px 25px 0 25px;
            }
            
            #batch-import-modal .modal-actions {
                padding: 20px 25px 25px 25px;
            }
            
            #batch-import-text {
                font-size: 14px !important;
                min-height: 120px;
            }
            
            #batch-preview {
                font-size: 0.8em !important;
                max-height: 200px !important;
            }
            

            /* 同步信息面板优化 */
            .sync-info {
                padding: 15px;
                margin: 15px 0;
            }
            
            .sync-info h4 {
                font-size: 1.1em;
            }
            
            .sync-info p {
                font-size: 0.85em;
                margin: 5px 0;
            }

            /* 积分管理按钮优化 */
            .modal-btn {
                padding: 12px;
                font-size: 0.9em;
            }

            /* 页面标题优化 */
            .page h2 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }

            /* 每日任务系统样式 - PC兼容性优化 */
            .user-task-section {
                background: #ffffff !important;
                border: 1px solid #e0e0e0 !important;
                border-radius: 8px !important;
                padding: 25px !important;
                margin-bottom: 25px !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            .user-task-header {
                display: block !important;
                width: 100% !important;
                margin-bottom: 20px !important;
                overflow: hidden !important;
                zoom: 1; /* IE兼容 */
            }
            
            .user-task-header::after {
                content: "";
                display: table;
                clear: both;
            }
            
            .user-task-header h3 {
                float: left !important;
                margin: 0 !important;
                font-size: 1.3em !important;
                color: #333 !important;
                line-height: 40px !important;
            }
            
            .task-header-controls {
                float: right !important;
                margin: 0 !important;
            }
            
            .task-header-controls button {
                display: inline-block;
                margin-left: 10px;
                padding: 8px 16px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: #f8f9fa;
                color: #495057;
                cursor: pointer;
                font-size: 0.9em;
                vertical-align: top;
                text-decoration: none;
            }
            
            .task-header-controls .btn-primary {
                background: #007bff;
                border-color: #007bff;
                color: white;
            }
            
            .task-header-controls .btn-primary:hover {
                background: #0056b3;
                border-color: #0056b3;
            }
            
            .task-header-controls .btn-secondary:hover {
                background: #e2e6ea;
                border-color: #dae0e5;
            }
            
            .task-grid {
                clear: both;
                width: 100%;
                display: grid;
                gap: 15px;
            }
            
            .task-item {
                display: block;
                background: white;
                border: none;
                border-left: 4px solid #3498db;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 15px;
                box-sizing: border-box;
                position: relative;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            }
            
            .task-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            }
            
            .task-item.completed {
                background: #f0f9f0;
                border-left-color: #28a745;
            }
            
            .task-title {
                font-size: 1.2em;
                font-weight: bold;
                margin: 0 0 8px 0;
                color: #2c3e50;
                line-height: 1.4;
                padding-right: 100px; /* 为积分标签留空间 */
            }
            
            .task-description {
                color: #555;
                margin: 10px 0;
                line-height: 1.5;
                font-size: 0.95em;
            }
            
            .task-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
            
            .task-actions button {
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s ease;
            }
            
            .task-actions button:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            }
            
            /* 任务按钮专用样式 */
            .task-actions .btn-success {
                background: #28a745;
                color: white;
            }
            
            .task-actions .btn-primary {
                background: #007bff;
                color: white;
            }
            
            .task-actions .btn-danger {
                background: #dc3545;
                color: white;
            }
            
            .task-actions .btn-secondary {
                background: #6c757d;
                color: white;
            }
            
            .task-reward {
                position: absolute;
                top: 20px;
                right: 20px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 6px 12px;
                border-radius: 15px;
                font-size: 0.85em;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .task-completed .task-title {
                text-decoration: line-through;
                color: #6c757d;
            }
            
            .task-completed .task-reward {
                background: #d4edda;
                border-color: #c3e6cb;
                color: #155724;
            }
            
            .no-tasks {
                text-align: center;
                color: #6c757d;
                padding: 40px 20px;
                font-style: italic;
                background: #f8f9fa;
                border: 1px dashed #dee2e6;
                border-radius: 4px;
            }
            
            .daily-info {
                background: #fff3cd;
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            }
            
            .daily-info h4 {
                color: #856404;
                margin-bottom: 10px;
            }
            
            .daily-info ul {
                color: #555;
                padding-left: 20px;
                line-height: 1.6;
            }
            
            /* 任务管理模态框样式 */
            .task-manage-item {
                background: white;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 15px;
                border-left: 4px solid #3498db;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 15px;
            }
            
            .task-manage-info {
                flex: 1;
            }
            
            .task-manage-actions {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }
            
            .task-details {
                color: #666;
                font-size: 0.9em;
                margin-top: 5px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 0.75em;
                border-radius: 4px;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .btn-success {
                background: #27ae60;
                color: white;
            }
            
            .btn-success:hover {
                background: #229954;
            }
            
            .btn-danger {
                background: #e74c3c;
                color: white;
            }
            
            .btn-danger:hover {
                background: #c0392b;
            }

            /* 历史记录优化 */
            #history-list > div {
                padding: 12px 0;
            }
            
            /* 悬赏创建按钮优化 */
            .create-bounty-btn {
                width: 100%;
                margin-top: 10px;
                padding: 12px 20px;
            }
            
            .bounty-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .bounty-header-buttons {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .bounty-header-buttons .create-bounty-btn {
                width: 100%;
                margin: 0 !important;
                font-size: 0.9em;
                padding: 12px 20px;
            }
            
            .bounty-title {
                text-align: center;
                margin-bottom: 0;
            }
            
            /* 移动端每日任务优化 */
            .task-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .user-task-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .task-header-controls {
                justify-content: center;
            }
            
            .task-header-controls button {
                flex: 1;
                max-width: 120px;
            }
            
            .task-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .task-actions button {
                flex: 1;
                min-width: 60px;
            }
            
            .task-manage-item {
                flex-direction: column;
                gap: 10px;
            }
            
            .task-manage-actions {
                justify-content: center;
                width: 100%;
            }
            
            .task-manage-actions button {
                flex: 1;
                max-width: 80px;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .page {
                padding: 12px 8px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-tabs {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .nav-tab {
                padding: 10px;
                font-size: 0.8em;
            }
            
            .content {
                padding: 10px;
            }
            
            .page h2 {
                font-size: 1.4em;
            }
            
            .modal-box {
                margin: 8px;
                width: calc(100% - 16px);
                max-height: calc(100vh - 60px);
            }
            
            .modal-box .form-group {
                padding: 0 20px;
            }
            
            .modal-box > .form-group:first-child,
            .modal-box > div:not(.modal-header):first-child {
                padding: 20px 20px 0 20px;
            }
            
            .modal-box .modal-actions {
                padding: 15px 20px 20px 20px;
            }
            
            .modal-box #task-manage-list {
                padding: 15px 20px 0 20px;
            }
            
            .modal-header {
                padding: 10px 15px 6px 15px;
            }
            
            .modal-drag-handle {
                width: 30px;
                height: 3px;
                margin-bottom: 6px;
            }
            
            .modal-header h3 {
                font-size: 0.9em;
            }
            
            /* 密码模态框超小屏幕优化 */
            #password-modal .modal-box {
                max-width: calc(100% - 16px);
                margin: 8px;
            }
            
            #password-modal .form-group {
                padding: 0 20px;
            }
            
            #password-modal .form-group:first-of-type {
                padding: 20px 20px 0 20px;
            }
            
            #password-modal .modal-actions {
                padding: 15px 20px 20px 20px;
            }
            
            /* 用户选择模态框超小屏幕优化 */
            #user-select-modal .modal-box {
                max-width: calc(100% - 16px);
                margin: 8px;
            }
            
            #user-select-modal .form-group {
                padding: 0 20px;
            }
            
            #user-select-modal .form-group:first-of-type {
                padding: 20px 20px 0 20px;
            }
            
            #user-select-modal .modal-actions {
                padding: 15px 20px 20px 20px;
            }
            
            .user-select-option {
                font-size: 0.9em !important;
                padding: 10px 15px !important;
            }
            
            /* 批量导入模态框超小屏幕优化 */
            #batch-import-modal .modal-box {
                max-width: calc(100% - 16px);
                margin: 8px;
            }
            
            #batch-import-modal .form-group {
                padding: 0 20px;
            }
            
            #batch-import-modal .form-group:first-of-type {
                padding: 20px 20px 0 20px;
            }
            
            #batch-import-modal .modal-actions {
                padding: 15px 20px 20px 20px;
            }
            
            #batch-import-text {
                font-size: 13px !important;
                min-height: 100px;
            }
            
            #batch-preview {
                font-size: 0.75em !important;
                max-height: 150px !important;
            }
            
            
            .connection-status {
                width: 35px;
                height: 35px;
                font-size: 1em;
            }
            
            #auth-status {
                top: 55px !important;
                width: 35px;
                height: 35px;
            }
            
            /* 超小屏幕每日任务优化 */
            .user-task-section {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .task-item {
                padding: 12px;
            }
            
            .task-title {
                font-size: 0.9em;
            }
            
            .task-reward {
                font-size: 0.8em;
            }
            
            .task-actions button {
                padding: 4px 6px;
                font-size: 0.7em;
            }
            
            .task-header-controls button {
                padding: 6px 10px;
                font-size: 0.75em;
            }
        }

        /* Edge浏览器兼容性修复 */
        @supports (-ms-ime-align: auto) {
            .nav-tabs {
                background: rgba(255,255,255,0.3);
            }
            
            .content {
                background: rgba(255,255,255,0.99);
                backdrop-filter: none;
            }
            
            .modal-overlay {
                backdrop-filter: none;
                background: rgba(0,0,0,0.5);
            }
            
            .task-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .task-item {
                display: block;
                width: auto;
                margin: 0;
            }
        }

        /* Internet Explorer 兼容性修复 */
        @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
            .task-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .task-item {
                display: block;
                width: auto;
                margin: 0;
            }
            
            .user-task-header {
                display: block;
            }
            
            .task-header-controls {
                text-align: right;
                margin-top: 10px;
            }
        }

        /* 移动端触摸优化 */
        @media (max-width: 768px) {
            /* 增加按钮触摸目标大小 */
            button, .nav-tab, .bounty-btn, .modal-btn {
                min-height: 44px; /* Apple推荐的最小触摸目标 */
                min-width: 44px;
            }
            
            /* 优化输入框在移动端的体验 */
            input, select, textarea {
                -webkit-appearance: none;
                border-radius: 8px;
                font-size: 16px; /* 防止iOS Safari缩放 */
            }
            
            /* 优化长按菜单 */
            .bounty-item, .stats-table, .editable-content {
                -webkit-touch-callout: default;
            }
            
            /* 滚动优化 */
            .content, .modal-box, .bounty-list {
                -webkit-overflow-scrolling: touch;
            }
            
            /* 表格水平滚动优化 */
            .stats-table {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* 表单元素间距优化 */
            .form-group {
                margin-bottom: 16px;
            }
            
            /* 状态指示器在移动端的安全区域适配 */
            .connection-status {
                top: max(10px, env(safe-area-inset-top));
            }
            
            #auth-status {
                top: max(50px, calc(env(safe-area-inset-top) + 40px)) !important;
            }
        }

        /* iPhone X 及以上设备的安全区域适配 */
        @supports (padding: max(0px)) {
            @media (max-width: 768px) {
                .container {
                    padding-left: max(8px, env(safe-area-inset-left));
                    padding-right: max(8px, env(safe-area-inset-right));
                    padding-bottom: max(8px, env(safe-area-inset-bottom));
                }
                
                .modal-box {
                    margin-left: max(10px, env(safe-area-inset-left));
                    margin-right: max(10px, env(safe-area-inset-right));
                    margin-bottom: max(10px, env(safe-area-inset-bottom));
                }
            }
        }

        /* 每日任务样式保持原有设计 */
        .editable-content {
            border: 1px solid #ccc;
            padding: 10px 20px;
            min-height: 80px;
            outline: none;
            border-radius: 8px;
            margin-top: 10px;
            background-color: #fcfcfc;
            line-height: 1.6;
            font-size: 1.05em;
            transition: border-color 0.3s ease;
            text-align: left !important;
            color: #333;
        }

        .editable-content:focus {
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.2);
        }

        .daily-task-controls {
            text-align: right;
            margin-top: 15px;
        }

        .daily-task-controls button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .daily-task-controls button:hover {
            background: #218838;
        }

        /* 奖惩样式保持原有设计 */
        .penalty-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        .penalty-group {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #e74c3c;
        }

        .reward-group {
            background: #f0f8f0;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #27ae60;
        }

        /* 强制每日任务样式重置 - 最高优先级 */
        #daily .user-task-section {
            background: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 25px !important;
            margin-bottom: 25px !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        #daily .user-task-header {
            display: block !important;
            width: 100% !important;
            margin-bottom: 20px !important;
            overflow: hidden !important;
        }
        
        #daily .user-task-header::after {
            content: "";
            display: table;
            clear: both;
        }
        
        #daily .user-task-header h3 {
            float: left !important;
            margin: 0 !important;
            font-size: 1.3em !important;
            color: #333 !important;
            line-height: 40px !important;
        }
        
        #daily .task-header-controls {
            float: right !important;
            margin: 0 !important;
        }
        
        #daily .task-header-controls button {
            display: inline-block !important;
            margin-left: 10px !important;
            padding: 8px 16px !important;
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            background: #f8f9fa !important;
            color: #495057 !important;
            cursor: pointer !important;
            font-size: 0.9em !important;
            vertical-align: top !important;
        }
        
        #daily .task-header-controls .btn-primary {
            background: #007bff !important;
            border-color: #007bff !important;
            color: white !important;
        }
        
        #daily .task-grid {
            clear: both !important;
            width: 100% !important;
            display: grid !important;
            gap: 15px !important;
        }
        
        #daily .no-tasks {
            text-align: center !important;
            color: #6c757d !important;
            padding: 40px 20px !important;
        }
        
        /* 强制每日任务项样式 - 美化卡片设计 */
        #daily .task-item {
            display: block !important;
            background: white !important;
            border: none !important;
            border-left: 4px solid #3498db !important;
            border-radius: 10px !important;
            padding: 20px !important;
            margin-bottom: 15px !important;
            box-sizing: border-box !important;
            position: relative !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            transition: all 0.3s ease !important;
            width: auto !important;
            margin: 0 !important;
        }
        
        #daily .task-item:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15) !important;
        }
        
        #daily .task-item.completed {
            background: #f0f9f0 !important;
            border-left-color: #28a745 !important;
        }
        
        #daily .task-title {
            font-size: 1.2em !important;
            font-weight: bold !important;
            margin: 0 0 8px 0 !important;
            color: #2c3e50 !important;
            line-height: 1.4 !important;
            padding-right: 100px !important;
        }
        
        #daily .task-description {
            color: #555 !important;
            margin: 10px 0 !important;
            line-height: 1.5 !important;
            font-size: 0.95em !important;
        }
        
        #daily .task-actions {
            display: flex !important;
            gap: 10px !important;
            margin-top: 15px !important;
        }
        
        #daily .task-actions button {
            padding: 8px 16px !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 0.9em !important;
            transition: all 0.2s ease !important;
        }
        
        #daily .task-actions button:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2) !important;
        }
        
        #daily .task-actions .btn-success {
            background: #28a745 !important;
            color: white !important;
        }
        
        #daily .task-actions .btn-primary {
            background: #007bff !important;
            color: white !important;
        }
        
        #daily .task-actions .btn-danger {
            background: #dc3545 !important;
            color: white !important;
        }
        
        #daily .task-actions .btn-secondary {
            background: #6c757d !important;
            color: white !important;
        }
        
        #daily .task-reward {
            position: absolute !important;
            top: 20px !important;
            right: 20px !important;
            background: #fff3cd !important;
            border: 1px solid #ffeaa7 !important;
            color: #856404 !important;
            padding: 6px 12px !important;
            border-radius: 15px !important;
            font-size: 0.85em !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        #daily .task-completed .task-title {
            text-decoration: line-through !important;
            color: #6c757d !important;
        }
        
        #daily .task-completed .task-reward {
            background: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }

        /* 积分展示卡片样式 - 星星主题 - 左右布局 */
        .score-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .user-score-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.15);
        }

        .qiqi-section .user-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid rgba(33, 150, 243, 0.2);
        }

        .qiqi-section .user-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .yiyi-section .user-header {
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .yiyi-section .user-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #f57f17;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .score-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .score-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        .score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            opacity: 0.08;
            border-radius: 16px;
        }

        .score-card.total-score {
            border-image: linear-gradient(135deg, #ffd700, #ffb347) 1;
        }

        .score-card.weekly-score {
            border-image: linear-gradient(135deg, #ff69b4, #ffd700) 1;
        }

        .score-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
        }

        .qiqi-section .score-header {
            border-bottom: 2px solid rgba(33, 150, 243, 0.2);
        }

        .yiyi-section .score-header {
            border-bottom: 2px solid rgba(255, 193, 7, 0.3);
        }

        .qiqi-section .score-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .yiyi-section .score-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #f57f17;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .score-content {
            text-align: center;
            margin-bottom: 15px;
        }

        .qiqi-section .score-value {
            font-size: 2.8em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .yiyi-section .score-value {
            font-size: 2.8em;
            font-weight: bold;
            color: #f57f17;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .star-display {
            padding: 12px;
            border-radius: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qiqi-section .star-display {
            background: rgba(33, 150, 243, 0.05);
            border: 1px solid rgba(33, 150, 243, 0.1);
        }

        .yiyi-section .star-display {
            background: rgba(255, 193, 7, 0.05);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .score-stars {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 3px;
            line-height: 1;
        }

        /* 星星等级样式 */
        .star-small {
            font-size: 1.2em;
            color: #ffd700;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }

        .star-half {
            font-size: 1.2em;
            background: linear-gradient(90deg, #ffd700 50%, #ccc 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }

        .star-big {
            font-size: 1.8em;
            color: #ff6b35;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
            animation: bigStarGlow 2s infinite alternate;
        }

        .star-rainbow {
            font-size: 2.2em;
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
            animation: rainbowStarGlow 2s infinite alternate;
        }

        .weekly-reset-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 237, 78, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .weekly-reset-info small {
            color: #666;
            font-size: 0.95em;
            font-weight: 500;
        }

        /* 星星积分池样式 */
        .star-bonus-pool {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(255, 193, 7, 0.2);
            box-shadow: 0 6px 25px rgba(255, 152, 0, 0.15);
        }

        .star-bonus-pool h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #e65100;
            font-size: 1.3em;
            font-weight: bold;
        }

        .bonus-description {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .bonus-description p {
            margin: 0 0 8px 0;
            color: #bf360c;
            font-weight: 600;
        }

        .bonus-description ul {
            margin: 0;
            padding-left: 20px;
            color: #d84315;
        }

        .bonus-description li {
            margin: 4px 0;
            font-size: 0.9em;
        }

        .bonus-dashboard {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
        }

        .user-bonus-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .user-bonus-card {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .qiqi-bonus {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid rgba(33, 150, 243, 0.2);
        }

        .yiyi-bonus {
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .user-bonus-card h5 {
            margin: 0 0 8px 0;
            font-size: 1em;
            font-weight: bold;
        }

        .qiqi-bonus h5 {
            color: #1976d2;
        }

        .yiyi-bonus h5 {
            color: #f57f17;
        }

        .star-count {
            font-size: 0.85em;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .monthly-bonus {
            font-size: 0.9em;
            font-weight: 600;
        }

        .qiqi-bonus .monthly-bonus {
            color: #1976d2;
        }

        .yiyi-bonus .monthly-bonus {
            color: #f57f17;
        }

        .next-bonus-date {
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 193, 7, 0.2);
        }

        .next-bonus-date small {
            color: #bf360c;
            font-size: 0.85em;
            font-weight: 500;
        }

        /* 新的每日任务系统样式 */
        .task-pool-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(40, 167, 69, 0.2);
        }

        .task-pool-preview {
            margin-top: 15px;
        }

        .pool-count-info {
            margin-bottom: 15px;
        }

        .pool-count-badge {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .pool-tasks-preview {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .empty-pool {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 10px;
        }

        .preview-task-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .preview-task-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.9em;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
        }

        .preview-task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #28a745;
        }

        .preview-task-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .preview-task-count {
            font-size: 0.8em;
            color: #6c757d;
            text-align: right;
        }

        .preview-task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-task-expand {
            color: #007bff;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            transition: color 0.2s ease;
            user-select: none;
        }

        .preview-task-expand:hover {
            color: #0056b3;
        }

        .preview-task-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 100px;
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h3 {
            color: #155724;
            margin: 0;
        }

        .task-pool-info {
            text-align: center;
            color: #28a745;
            font-weight: 500;
        }

        .daily-task-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .daily-task-section.qiqi-section {
            border-left: 4px solid #2196f3;
        }

        .daily-task-section.yiyi-section {
            border-left: 4px solid #ffc107;
        }

        .daily-progress {
            margin: 15px 0;
            text-align: center;
        }

        .daily-progress h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* 完成3个任务时的特殊进度条效果 */
        .progress-fill.completed {
            background: linear-gradient(90deg, #ffd700, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7);
            background-size: 300% 300%;
            animation: rainbowShine 2s ease-in-out infinite;
        }

        @keyframes rainbowShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* 奖励按钮动画 */
        .reward-claim-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f, #4d9de0, #e15759, #ff9ff3);
            background-size: 300% 300%;
            animation: rewardGlow 1.5s ease-in-out infinite;
            border: none;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transform: scale(1);
            transition: transform 0.2s ease;
        }

        .reward-claim-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        @keyframes rewardGlow {
            0%, 100% { 
                background-position: 0% 50%; 
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            50% { 
                background-position: 100% 50%; 
                box-shadow: 0 4px 20px rgba(255, 215, 61, 0.6);
            }
        }

        /* 庆祝文字效果 */
        .celebration-text {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f);
            background-size: 200% 200%;
            animation: celebrationShine 1s ease-in-out infinite;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        @keyframes celebrationShine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* 庆祝动画关键帧 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px currentColor; }
            to { text-shadow: 0 0 30px currentColor, 0 0 40px currentColor; }
        }

        @keyframes rainbowText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes confettiFall {
            0% { 
                transform: translateY(-10px) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(360deg); 
                opacity: 0; 
            }
        }

        @keyframes coinFall {
            0% { 
                transform: translateY(0) rotate(0deg) scale(1); 
                opacity: 1; 
            }
            50% { 
                transform: translateY(50vh) rotate(180deg) scale(1.2); 
                opacity: 0.8; 
            }
            100% { 
                transform: translateY(100vh) rotate(360deg) scale(0.8); 
                opacity: 0; 
            }
        }

        @keyframes rewardTextFloat {
            0% { 
                transform: translateX(-50%) translateY(0) scale(0.5); 
                opacity: 0; 
            }
            20% { 
                transform: translateX(-50%) translateY(-20px) scale(1.2); 
                opacity: 1; 
            }
            80% { 
                transform: translateX(-50%) translateY(-40px) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translateX(-50%) translateY(-60px) scale(0.8); 
                opacity: 0; 
            }
        }

        .daily-tasks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .task-slot {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .task-slot:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .task-slot.selected {
            background: #e7f3ff;
            border-color: #007bff;
            border-style: solid;
        }

        .task-slot.completed {
            background: #d4edda;
            border-color: #28a745;
            border-style: solid;
        }

        .slot-content {
            font-weight: 500;
            color: #6c757d;
        }

        .task-slot.selected .slot-content {
            color: #007bff;
        }

        .task-slot.completed .slot-content {
            color: #28a745;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .task-multiplier {
            font-size: 0.9em;
            margin: 5px 0;
        }

        .task-actions {
            margin-top: 10px;
        }

        .multiplier-btn {
            padding: 4px 8px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
        }

        .multiplier-btn.normal {
            background: #28a745;
            color: white;
        }

        .multiplier-btn.double {
            background: #ffc107;
            color: #212529;
        }

        .multiplier-btn.triple {
            background: #dc3545;
            color: white;
        }

        .multiplier-btn.abandon {
            background: #6c757d;
            color: white;
            font-size: 0.85em;
        }

        .multiplier-btn.abandon:hover {
            background: #5a6268;
        }

        .multiplier-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 任务池管理样式 */
        .task-pool-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .task-pool-list h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .pool-task-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 120px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .pool-task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #28a745, #20c997);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pool-task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.15);
            border-color: #28a745;
        }

        .pool-task-item:hover::before {
            opacity: 1;
        }

        .pool-task-content {
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .pool-task-name {
            font-weight: 700;
            font-size: 1.15em;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .pool-task-description {
            font-size: 0.95em;
            color: #6c757d;
            line-height: 1.5;
            margin-bottom: 0;
        }

        .pool-task-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: auto;
        }

        .pool-task-actions .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .pool-task-actions .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            background: linear-gradient(135deg, #c82333, #a71e2a);
        }

        .pool-task-actions .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .pool-task-actions .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            background: linear-gradient(135deg, #0056b3, #003d82);
        }

        /* 任务特殊属性样式 */
        .task-attributes {
            margin: 6px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .task-attribute {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .task-attribute.exclusive-qiqi {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            box-shadow: 0 1px 3px rgba(255, 107, 107, 0.4);
        }

        .task-attribute.exclusive-yiyi {
            background: linear-gradient(135deg, #4834d4, #341f97);
            box-shadow: 0 1px 3px rgba(72, 52, 212, 0.4);
        }

        .task-attribute.double-value {
            background: linear-gradient(135deg, #ffa502, #ff6348);
            box-shadow: 0 1px 3px rgba(255, 165, 2, 0.4);
        }

        .task-attribute.streak-bonus {
            background: linear-gradient(135deg, #ff3838, #c44569);
            box-shadow: 0 1px 3px rgba(255, 56, 56, 0.4);
        }

        .task-attribute.weekly-limit {
            background: linear-gradient(135deg, #00d2d3, #006ba6);
            box-shadow: 0 1px 3px rgba(0, 210, 211, 0.4);
        }

        .task-attribute.base-points {
            background: linear-gradient(135deg, #9c88ff, #8c7ae6);
            box-shadow: 0 1px 3px rgba(156, 136, 255, 0.4);
        }

        /* 特殊属性选择卡片样式 */
        .special-attribute-card {
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .special-attribute-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .special-attribute-card.checked {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .double-value-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ffb74d;
        }

        .double-value-card.checked {
            background: linear-gradient(135deg, #ffcc02 0%, #ff9800 100%);
            border: 2px solid #f57600;
        }

        .streak-bonus-card {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f06292;
        }

        .streak-bonus-card.checked {
            background: linear-gradient(135deg, #ff5722 0%, #d32f2f 100%);
            border: 2px solid #c62828;
        }

        .streak-bonus-card.checked .card-text,
        .double-value-card.checked .card-text {
            color: white !important;
        }

        .task-pool-list {
            margin: 30px 0;
            max-height: 500px;
            overflow-y: auto;
            background: rgba(248, 249, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(40, 167, 69, 0.1);
        }

        .task-pool-list h4 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 3px solid #28a745;
            padding-bottom: 12px;
            font-size: 1.3em;
            font-weight: 700;
            background: linear-gradient(135deg, #28a745, #20c997);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .task-pool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .task-pool-modal-box {
                width: 98vw !important;
                margin: 10px;
            }
            
            .task-pool-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .pool-task-item {
                min-height: 100px;
                padding: 15px;
            }
        }

        .pool-empty-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 30px;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        /* 任务池管理模态框专用样式 */
        .task-pool-modal-box {
            max-width: 900px !important;
            width: 95vw !important;
            max-height: 85vh !important;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid rgba(40, 167, 69, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }

        .task-pool-modal-box .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
            margin: -20px -30px 25px -30px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-pool-modal-box .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-pool-modal-box .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .task-pool-modal-box .modal-header h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .task-pool-modal-box .form-group {
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        .task-pool-modal-box .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
            font-size: 1.1em;
        }

        .task-pool-modal-box .modal-input {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .task-pool-modal-box .modal-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background: #ffffff;
        }

        .task-pool-modal-box .modal-btn {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .task-pool-modal-box .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .task-pool-modal-box .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        .task-pool-modal-box .btn-secondary {
            background: #6c757d;
            border: none;
            color: white;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .task-pool-modal-box .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        .task-pool-modal-box .modal-actions {
            margin-top: 20px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        /* 任务池模态框的任务列表区域 */
        .task-pool-modal-box .task-pool-list {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin: 20px 0 0 0;
        }

        .task-pool-modal-box .task-pool-list h4 {
            flex-shrink: 0;
            margin: 0 0 15px 0;
        }

        .task-pool-modal-box #pool-tasks-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
        }

        /* 为任务池列表滚动条美化 - 使用更大的滚动条 */
        .task-pool-modal-box #pool-tasks-list::-webkit-scrollbar {
            width: 12px;
        }

        .task-pool-modal-box #pool-tasks-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            margin: 2px;
        }

        .task-pool-modal-box #pool-tasks-list::-webkit-scrollbar-thumb {
            background: rgba(40, 167, 69, 0.6);
            border-radius: 6px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .task-pool-modal-box #pool-tasks-list::-webkit-scrollbar-thumb:hover {
            background: rgba(40, 167, 69, 0.8);
            background-clip: content-box;
        }

        /* 任务池模态框内容区域滚动设置 */
        .task-pool-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 5px 0 0;
            min-height: 0;
        }

        /* 任务池模态框内容区域滚动条美化 */
        .task-pool-modal-content::-webkit-scrollbar {
            width: 12px;
        }

        .task-pool-modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            margin: 2px;
        }

        .task-pool-modal-content::-webkit-scrollbar-thumb {
            background: rgba(40, 167, 69, 0.6);
            border-radius: 6px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .task-pool-modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(40, 167, 69, 0.8);
            background-clip: content-box;
        }

        /* 每日任务选择模态框专用样式 */
        .daily-task-select-modal-box {
            max-width: 800px !important;
            width: 90vw !important;
            max-height: 80vh !important;
        }

        .daily-task-select-modal-box .available-tasks {
            margin: 25px 0;
            max-height: 500px;
            overflow-y: auto;
            background: rgba(248, 249, 250, 0.5);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
        }

        /* 超额补充任务样式 */
        .extra-tasks-section {
            transition: all 0.3s ease;
        }

        .extra-tasks-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .extra-task-item {
            transition: all 0.3s ease;
        }

        .extra-task-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .extra-task-item.completed {
            animation: completedPulse 2s ease-in-out;
        }

        @keyframes completedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* 连胜奖励准备状态样式 */
        .task-attribute.streak-bonus.streak-ready {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important;
            animation: streakReady 2s infinite;
        }

        @keyframes streakReady {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 107, 107, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 107, 107, 0.8); }
        }

        /* 超额任务选择对话框样式 */
        .extra-task-option {
            transition: all 0.3s ease !important;
        }

        .extra-task-option:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .extra-tasks-header {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .extra-task-item .task-actions button {
                font-size: 0.7em !important;
                padding: 3px 6px !important;
                margin-right: 3px !important;
            }
        }

        .daily-task-select-modal-box .available-tasks h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .daily-task-select-modal-box .available-task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .daily-task-select-modal-box .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
            margin: -20px -30px 25px -30px;
        }

        .daily-task-select-modal-box .modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .daily-task-select-modal-box .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .daily-task-select-modal-box {
                width: 95vw !important;
                margin: 10px;
            }
            
            .daily-task-select-modal-box .available-task-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }

        .available-tasks {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .available-task-item {
            padding: 18px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .available-task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .available-task-item:hover {
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }

        .available-task-item:hover::before {
            opacity: 1;
        }

        .available-task-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .available-task-item.disabled:hover {
            background: #f8f9fa;
            border-color: transparent;
        }

        .available-task-header {
            cursor: pointer;
        }

        .available-task-expand {
            color: #007bff;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            transition: color 0.2s ease;
            user-select: none;
        }

        .available-task-expand:hover {
            color: #0056b3;
        }

        .available-task-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
            animation: slideDown 0.3s ease;
        }

        .task-name-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .daily-task-expand {
            color: #007bff;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 8px;
            transition: color 0.2s ease;
            user-select: none;
        }

        .daily-task-expand:hover {
            color: #0056b3;
        }

        .daily-task-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
            animation: slideDown 0.3s ease;
        }

        .task-unavailable-reason {
            font-size: 0.8em;
            color: #dc3545;
            margin-top: 5px;
        }

        /* 星星等级说明样式 */
        .star-legend {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(108, 117, 125, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .star-legend h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.2em;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .legend-text {
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
        }

        @keyframes starTwinkle {
            0% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            100% { 
                transform: scale(1.1) rotate(5deg);
                filter: brightness(1.2);
            }
        }

        @keyframes bigStarGlow {
            0% { 
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)) brightness(1);
                transform: scale(1);
            }
            100% { 
                filter: drop-shadow(0 4px 8px rgba(255,107,53,0.6)) brightness(1.3);
                transform: scale(1.1);
            }
        }

        @keyframes rainbowStarGlow {
            0% { 
                filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5)) brightness(1);
                transform: scale(1);
            }
            100% { 
                filter: drop-shadow(0 4px 12px rgba(255,0,255,0.8)) brightness(1.3);
                transform: scale(1.1);
            }
        }

        /* 移动端积分卡片适配 */
        @media (max-width: 768px) {
            .score-dashboard {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 15px 0;
            }

            .user-score-section {
                gap: 12px;
            }

            .user-header {
                padding: 12px 15px;
                margin-bottom: 10px;
            }

            .user-title {
                font-size: 1.2em;
            }

            .score-card {
                padding: 15px;
            }

            .score-title {
                font-size: 1em;
            }

            .score-value {
                font-size: 2.2em;
            }

            .star-display {
                padding: 10px;
                min-height: 40px;
            }

            .star-small {
                font-size: 1em;
            }

            .star-half {
                font-size: 1em;
            }

            .star-big {
                font-size: 1.5em;
            }

            .star-rainbow {
                font-size: 1.8em;
            }

            .weekly-reset-info {
                margin: 15px 0;
                padding: 12px;
            }

            .star-bonus-pool {
                padding: 15px;
                margin: 15px 0;
            }

            .star-bonus-pool h4 {
                font-size: 1.1em;
            }

            .bonus-description {
                padding: 12px;
            }

            .bonus-description p {
                font-size: 0.9em;
            }

            .bonus-description li {
                font-size: 0.8em;
            }

            .bonus-dashboard {
                padding: 12px;
            }

            .user-bonus-section {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .user-bonus-card {
                padding: 10px;
            }

            .user-bonus-card h5 {
                font-size: 0.9em;
            }

            .star-count {
                font-size: 0.75em;
            }

            .monthly-bonus {
                font-size: 0.8em;
            }

            .star-legend {
                padding: 15px;
                margin: 15px 0;
            }

            .star-legend h4 {
                font-size: 1.1em;
                margin-bottom: 12px;
            }

            .legend-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .legend-item {
                padding: 6px 10px;
            }

            .legend-text {
                font-size: 0.85em;
            }

            /* 每日任务移动端适配 */
            .task-pool-section {
                padding: 15px;
            }
            
            /* 积分池系统移动端适配 */
            .points-pool-top-section {
                margin: 15px 0 !important;
                padding: 20px 15px !important;
                border-radius: 15px !important;
            }
            
            .points-pool-top-section h3 {
                font-size: 1.4em !important;
            }
            
            .points-pool-top-section p {
                font-size: 0.95em !important;
            }
            
            .points-pool-top-section > div:nth-child(2) {
                display: flex !important;
                flex-direction: column !important;
                gap: 15px !important;
                margin-bottom: 20px !important;
            }
            
            .points-pool-top-section > div:nth-child(2) > div {
                padding: 20px 15px !important;
                border-radius: 15px !important;
            }
            
            .points-pool-top-section h5 {
                font-size: 1.1em !important;
            }
            
            .points-pool-top-section button {
                padding: 10px 12px !important;
                font-size: 0.85em !important;
                border-radius: 10px !important;
            }
            
            /* 移动端复选框优化 */
            input[type="checkbox"] {
                width: 20px !important;
                height: 20px !important;
                transform: none !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                background: white !important;
                border: 2px solid #007bff !important;
                border-radius: 4px !important;
                position: relative !important;
                cursor: pointer !important;
            }
            
            input[type="checkbox"]:checked {
                background: #007bff !important;
                border-color: #007bff !important;
            }
            
            input[type="checkbox"]:checked::after {
                content: '✓' !important;
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 14px !important;
            }

            .section-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .daily-task-section {
                padding: 15px;
                margin: 15px 0;
            }

            .daily-tasks-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .task-slot {
                padding: 15px;
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- 连接状态指示器 -->
    <div id="connection-status" class="connection-status status-offline" onclick="showSyncDebugInfo()">
        🔴<span class="status-text"> 离线</span>
    </div>

    <!-- 密码状态指示器 -->
    <div id="auth-status" class="connection-status" style="top: 70px; background: #e8f4fd; color: #1976d2; border: 1px solid #bee5eb;">
        🔒<span class="status-text"> 需要密码</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>🎯 积分管理系统</h1>
            <p>完成任务，获得悬赏！！！</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('daily')">📅 小日常</button>
            <button class="nav-tab" onclick="showPage('cards')">🎫 小悬赏</button>
            <button class="nav-tab" onclick="showPage('penalty')">⚖️ 小奖惩</button>
            <button class="nav-tab" onclick="showPage('bank')">🏦 小银行</button>
            <button class="nav-tab" onclick="showPage('history')">📜 小历史</button>
        </div>

        <div class="content">
            <!-- 小日常页面 -->
            <div id="daily" class="page active">
                <h2>📅 每日任务</h2>
                
                <!-- 周目标系统 -->
                <div class="weekly-goals-section" style="margin: 25px 0; padding: 25px; background: linear-gradient(135deg, #e8f5e8 0%, #f3e5f5 100%); border-radius: 20px; border: 3px solid #4caf50; box-shadow: 0 12px 30px rgba(76, 175, 80, 0.2);">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                            <h3 style="color: #2e7d32; margin: 0; font-size: 1.7em; font-weight: bold;">🎯 每周积分目标</h3>
                            <button onclick="openWeeklyGoalSettings()" style="background: linear-gradient(45deg, #ff9800, #f57c00); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.8em; font-weight: bold; cursor: pointer; box-shadow: 0 3px 10px rgba(255, 152, 0, 0.3);">⚙️ 设置</button>
                        </div>
                        <p id="weekly-target-desc" style="color: #388e3c; margin: 0; font-size: 1.0em; font-weight: 500;">每周需获得25分，否则每少1分扣2分！</p>
                    </div>
                    
                    <!-- 用户周目标显示 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- 七七的周目标 -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f8f4ff 100%); border-radius: 15px; border: 2px solid #2196f3; box-shadow: 0 6px 20px rgba(33, 150, 243, 0.15);">
                            <h5 style="color: #1976d2; margin: 0 0 15px 0; font-size: 1.2em; text-align: center; font-weight: bold;">👦 七七</h5>
                            <div id="qiqi-weekly-progress" style="font-size: 1.0em; line-height: 1.6; text-align: center;">
                                <!-- 周进度将通过JavaScript动态更新 -->
                            </div>
                        </div>
                        
                        <!-- 一一的周目标 -->
                        <div style="padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #f0f9ff 100%); border-radius: 15px; border: 2px solid #ff9800; box-shadow: 0 6px 20px rgba(255, 152, 0, 0.15);">
                            <h5 style="color: #f57c00; margin: 0 0 15px 0; font-size: 1.2em; text-align: center; font-weight: bold;">👧 一一</h5>
                            <div id="yiyi-weekly-progress" style="font-size: 1.0em; line-height: 1.6; text-align: center;">
                                <!-- 周进度将通过JavaScript动态更新 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 任务池管理 -->
                <div class="task-pool-section">
                    <div class="section-header">
                        <h3>🎯 每日任务池</h3>
                        <button class="btn-primary" onclick="openTaskPoolModal()">+ 管理任务池</button>
                    </div>
                    <div class="task-pool-preview">
                        <div class="pool-count-info">
                            <span class="pool-count-badge">共有 <span id="task-pool-count">0</span> 个任务</span>
                        </div>
                        <div class="pool-tasks-preview" id="pool-tasks-preview">
                            <div class="empty-pool">暂无任务，点击上方按钮添加任务</div>
                        </div>
                    </div>
                </div>

                <!-- 七七的每日任务 -->
                <div class="daily-task-section qiqi-section">
                    <div class="user-header">
                        <div class="user-title">七七</div>
                        <button onclick="openDailyTaskSettings()" style="background: linear-gradient(45deg, #ff9800, #f57c00); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 0.7em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);">⚙️ 设置</button>
                    </div>
                    <div class="daily-progress">
                        <h4>今日进度: <span id="qiqi-progress">0/3</span></h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="qiqi-progress-fill" style="width: 0%"></div>
                        </div>
                        <!-- 预计积分和倒计时 -->
                        <div class="daily-stats" style="margin-top: 12px; font-size: 0.9em;">
                            <div class="expected-points" id="qiqi-expected-points" style="color: #28a745; font-weight: bold; margin-bottom: 5px;">
                                预计获得积分: +0分
                            </div>
                            <div class="daily-countdown" id="daily-countdown" style="color: #dc3545; font-weight: bold;">
                                任务截止: 23:30:00
                            </div>
                            <div class="task-reward-claim" id="qiqi-reward-claim" style="margin-top: 8px;">
                                <!-- 奖励领取按钮将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                    <div class="daily-tasks-grid" id="qiqi-daily-tasks">
                        <div class="task-slot empty" onclick="selectDailyTask('qiqi', 0)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                        <div class="task-slot empty" onclick="selectDailyTask('qiqi', 1)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                        <div class="task-slot empty" onclick="selectDailyTask('qiqi', 2)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                    </div>
                    
                    <!-- 七七的超额补充任务区 -->
                    <div class="extra-tasks-section" id="qiqi-extra-section" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 2px solid #007bff;">
                        <div class="extra-tasks-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #007bff; margin: 0; font-size: 1.1em;">✨ 超额补充任务</h4>
                            <button class="btn btn-sm" onclick="openExtraTaskSelect('qiqi')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">+ 添加任务</button>
                        </div>
                        <div class="extra-tasks-grid" id="qiqi-extra-tasks">
                            <div class="extra-task-placeholder" style="text-align: center; color: #666; font-size: 0.9em; padding: 20px;">
                                点击"+ 添加任务"从任务池选择额外任务获得积分
                            </div>
                        </div>
                        <div class="extra-tasks-stats" style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            今日额外完成: <span id="qiqi-extra-count">0</span> 个任务，额外获得: +<span id="qiqi-extra-points">0</span> 积分
                        </div>
                    </div>
                    
                    <!-- 任务承接详细信息 -->
                    <div class="task-acceptance-info" id="qiqi-task-info" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 8px;">📋 任务承接情况</div>
                        <div id="qiqi-acceptance-details" style="font-size: 0.9em; color: #666;">
                            暂无承接的悬赏任务
                        </div>
                    </div>
                </div>

                <!-- 一一的每日任务 -->
                <div class="daily-task-section yiyi-section">
                    <div class="user-header">
                        <div class="user-title">一一</div>
                    </div>
                    <div class="daily-progress">
                        <h4>今日进度: <span id="yiyi-progress">0/3</span></h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="yiyi-progress-fill" style="width: 0%"></div>
                        </div>
                        <!-- 预计积分和倒计时 -->
                        <div class="daily-stats" style="margin-top: 12px; font-size: 0.9em;">
                            <div class="expected-points" id="yiyi-expected-points" style="color: #28a745; font-weight: bold; margin-bottom: 5px;">
                                预计获得积分: +0分
                            </div>
                            <div class="daily-countdown-duplicate" style="color: #dc3545; font-weight: bold;">
                                任务截止: 23:30:00
                            </div>
                            <div class="task-reward-claim" id="yiyi-reward-claim" style="margin-top: 8px;">
                                <!-- 奖励领取按钮将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                    <div class="daily-tasks-grid" id="yiyi-daily-tasks">
                        <div class="task-slot empty" onclick="selectDailyTask('yiyi', 0)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                        <div class="task-slot empty" onclick="selectDailyTask('yiyi', 1)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                        <div class="task-slot empty" onclick="selectDailyTask('yiyi', 2)">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                    </div>
                    
                    <!-- 一一的超额补充任务区 -->
                    <div class="extra-tasks-section" id="yiyi-extra-section" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); border-radius: 10px; border: 2px solid #28a745;">
                        <div class="extra-tasks-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #28a745; margin: 0; font-size: 1.1em;">✨ 超额补充任务</h4>
                            <button class="btn btn-sm" onclick="openExtraTaskSelect('yiyi')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;">+ 添加任务</button>
                        </div>
                        <div class="extra-tasks-grid" id="yiyi-extra-tasks">
                            <div class="extra-task-placeholder" style="text-align: center; color: #666; font-size: 0.9em; padding: 20px;">
                                点击"+ 添加任务"从任务池选择额外任务获得积分
                            </div>
                        </div>
                        <div class="extra-tasks-stats" style="margin-top: 10px; font-size: 0.8em; color: #666;">
                            今日额外完成: <span id="yiyi-extra-count">0</span> 个任务，额外获得: +<span id="yiyi-extra-points">0</span> 积分
                        </div>
                    </div>
                    
                    <!-- 任务承接详细信息 -->
                    <div class="task-acceptance-info" id="yiyi-task-info" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="font-weight: bold; color: #28a745; margin-bottom: 8px;">📋 任务承接情况</div>
                        <div id="yiyi-acceptance-details" style="font-size: 0.9em; color: #666;">
                            暂无承接的悬赏任务
                        </div>
                    </div>
                </div>

                <!-- 任务统计区域 -->
                <div class="task-stats-section" style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 1px solid #dee2e6;">
                    <h4 style="color: #495057; margin-bottom: 15px; text-align: center;">📊 任务完成统计</h4>
                    
                    <!-- 七七的统计 -->
                    <div class="user-stats-section" style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #007bff;">
                        <h5 style="color: #007bff; margin-bottom: 10px;">👦 七七的任务统计</h5>
                        <div id="qiqi-task-stats" style="font-size: 0.9em; line-height: 1.4;">
                            <div id="qiqi-streak-stats" style="margin-bottom: 8px;"></div>
                            <div id="qiqi-weekly-stats"></div>
                        </div>
                    </div>
                    
                    <!-- 一一的统计 -->
                    <div class="user-stats-section" style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); border-radius: 8px; border-left: 4px solid #28a745;">
                        <h5 style="color: #28a745; margin-bottom: 10px;">👧 一一的任务统计</h5>
                        <div id="yiyi-task-stats" style="font-size: 0.9em; line-height: 1.4;">
                            <div id="yiyi-streak-stats" style="margin-bottom: 8px;"></div>
                            <div id="yiyi-weekly-stats"></div>
                        </div>
                    </div>
                </div>

                <!-- 任务奖励等级系统 -->
                <div class="task-reward-section" style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 50%, #ffcc02 100%); border-radius: 15px; border: 2px solid #ff9800; box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);">
                    <h4 style="color: #e65100; margin-bottom: 15px; text-align: center; font-size: 1.3em; text-shadow: 0 2px 4px rgba(230, 81, 0, 0.3);">🏆 任务完成奖励系统 ✨</h4>
                    <p style="text-align: center; color: #bf360c; margin-bottom: 25px; font-size: 1em; font-weight: 500;">🎯 完成3个任务可获得额外奖励，升级等级可增加奖励积分！🚀</p>
                    
                    <!-- 七七的奖励等级 -->
                    <div class="user-reward-section" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 15px; border: 2px solid #2196f3; box-shadow: 0 6px 20px rgba(33, 150, 243, 0.2);">
                        <h5 style="color: #1976d2; margin-bottom: 12px; font-size: 1.1em; display: flex; align-items: center; justify-content: center;">👦 七七的奖励等级 ⭐</h5>
                        <div id="qiqi-reward-info" style="font-size: 0.95em; line-height: 1.5; margin-bottom: 15px; text-align: center;"></div>
                        <button class="modal-btn btn-primary" id="qiqi-upgrade-btn" onclick="upgradeRewardLevel('qiqi')" style="font-size: 0.9em; padding: 8px 15px; border-radius: 10px; background: linear-gradient(45deg, #2196f3, #21cbf3); border: none; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); transition: all 0.3s ease;">🚀 升级</button>
                    </div>
                    
                    <!-- 一一的奖励等级 -->
                    <div class="user-reward-section" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); border-radius: 15px; border: 2px solid #4caf50; box-shadow: 0 6px 20px rgba(76, 175, 80, 0.2);">
                        <h5 style="color: #388e3c; margin-bottom: 12px; font-size: 1.1em; display: flex; align-items: center; justify-content: center;">👧 一一的奖励等级 ⭐</h5>
                        <div id="yiyi-reward-info" style="font-size: 0.95em; line-height: 1.5; margin-bottom: 15px; text-align: center;"></div>
                        <button class="modal-btn btn-primary" id="yiyi-upgrade-btn" onclick="upgradeRewardLevel('yiyi')" style="font-size: 0.9em; padding: 8px 15px; border-radius: 10px; background: linear-gradient(45deg, #4caf50, #8bc34a); border: none; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); transition: all 0.3s ease;">🚀 升级</button>
                    </div>
                </div>


                <!-- 系统说明 -->
                <div class="daily-info">
                    <h4>💡 每日任务说明</h4>
                    <ul>
                        <li>每天需要完成3个不同的每日任务</li>
                        <li>每个任务基础奖励1分，加倍2分，超级加倍3分</li>
                        <li>任务状态每日 6:00 AM 自动重置</li>
                        <li>可以从任务池中选择当天要完成的任务</li>
                    </ul>
                </div>
            </div>

            <!-- 小卡片页面 - 只保留积分交易系统和悬赏功能 -->
            <div id="cards" class="page">
                <h2>🎫 积分系统</h2>

                <!-- 悬赏功能 -->
                <div class="bounty-section">
                    <div class="bounty-header">
                        <h3 class="bounty-title">🎯 悬赏任务</h3>
                        <div class="bounty-header-buttons">
                            <button class="create-bounty-btn" onclick="openBountyModal()">+ 新建悬赏</button>
                            <button class="create-bounty-btn" onclick="console.log('批量导入按钮被点击'); showBatchImportModal();" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">📥 批量导入</button>
                            <button class="create-bounty-btn" onclick="clearAllBounties()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">🗑️ 清空悬赏</button>
                        </div>
                    </div>
                    
                    <!-- 正在进行的悬赏 -->
                    <div class="bounty-category">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                            🏃‍♂️ 正在进行
                        </h4>
                        <div class="bounty-list" id="active-bounty-list">
                            <p style="text-align: center; color: #666; padding: 20px;">暂无进行中的悬赏任务</p>
                        </div>
                    </div>

                    <!-- 已结算的悬赏 -->
                    <div class="bounty-category" style="margin-top: 30px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #27ae60; padding-bottom: 8px;">
                            ✅ 已结算
                        </h4>
                        <div class="bounty-list" id="settled-bounty-list">
                            <p style="text-align: center; color: #666; padding: 20px;">暂无已结算的悬赏任务</p>
                        </div>
                    </div>
                </div>

                <!-- 积分交易 -->
                <div class="trade-section">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">💰 积分交易</h3>
                    <div class="trade-form">
                        <div class="form-group">
                            <label for="trade-from">支付方</label>
                            <select id="trade-from">
                                <option value="qiqi">七七</option>
                                <option value="yiyi">一一</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="trade-to">接收方</label>
                            <select id="trade-to">
                                <option value="yiyi">一一</option>
                                <option value="qiqi">七七</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="trade-points">积分</label>
                            <input type="number" id="trade-points" min="1" placeholder="积分">
                        </div>
                        <button class="trade-btn" onclick="executeTrade()">转账</button>
                    </div>
                    
                    <div style="background: #ffffff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">💡 交易说明</h4>
                        <ul style="color: #555; padding-left: 20px;">
                            <li>支付方的"交易"列将减少对应积分</li>
                            <li>接收方的"交易"列将增加对应积分</li>
                            <li>所有交易记录会自动保存到历史记录</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 小奖惩页面 -->
            <div id="penalty" class="page">
                <h2>⚖️ 奖惩系统</h2>
                
                <div class="penalty-section">
                    <div class="penalty-group">
                        <h3 style="color: #e74c3c; margin-bottom: 20px;">⛔ 扣分管理</h3>
                        <div class="form-group">
                            <label for="penalty-player">扣分对象</label>
                            <select id="penalty-player">
                                <option value="qiqi">七七</option>
                                <option value="yiyi">一一</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="penalty-reason">扣分原因</label>
                            <input type="text" id="penalty-reason" placeholder="例：迟到、违规等">
                        </div>
                        <div class="form-group">
                            <label for="penalty-points">扣分数值</label>
                            <input type="number" id="penalty-points" min="1" placeholder="扣分">
                        </div>
                        <button class="modal-btn btn-primary" onclick="applyPenalty()" style="width: 100%; margin-top: 10px;">确认扣分</button>
                    </div>

                    <div class="reward-group">
                        <h3 style="color: #27ae60; margin-bottom: 20px;">⭐ 奖励管理</h3>
                        <div class="form-group">
                            <label for="reward-player">奖励对象</label>
                            <select id="reward-player">
                                <option value="qiqi">七七</option>
                                <option value="yiyi">一一</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reward-reason">奖励原因</label>
                            <input type="text" id="reward-reason" placeholder="例：表现优秀、完成目标等">
                        </div>
                        <div class="form-group">
                            <label for="reward-points">奖励积分</label>
                            <input type="number" id="reward-points" min="1" placeholder="奖励">
                        </div>
                        <button class="modal-btn btn-primary" onclick="applyReward()" style="width: 100%; margin-top: 10px;">确认奖励</button>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">📋 奖惩规则</h4>
                    <ul style="color: #555; padding-left: 20px;">
                        <li>所有奖惩都会自动记录到小银行的相应列</li>
                        <li>扣分记录为负值，会影响总积分计算</li>
                        <li>奖励积分直接加入奖励列</li>
                        <li>历史记录中会保留详细的奖惩信息</li>
                    </ul>
                </div>
            </div>

            <!-- 小银行页面 -->
            <div id="bank" class="page">
                <h2>🏦 积分统计</h2>
                
                <!-- 积分展示区 - 左右布局 -->
                <div class="score-dashboard">
                    <!-- 七七的积分展示（左侧） -->
                    <div class="user-score-section qiqi-section">
                        <div class="user-header">
                            <div class="user-title">七七</div>
                        </div>
                        
                        <!-- 总积分卡片 -->
                        <div class="score-card total-score">
                            <div class="score-header">
                                <div class="score-title">总积分</div>
                            </div>
                            <div class="score-content">
                                <div class="score-value" id="qiqi-total-score">0</div>
                            </div>
                            <div class="star-display">
                                <div class="score-stars" id="qiqi-total-stars"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 一一的积分展示（右侧） -->
                    <div class="user-score-section yiyi-section">
                        <div class="user-header">
                            <div class="user-title">一一</div>
                        </div>
                        
                        <!-- 总积分卡片 -->
                        <div class="score-card total-score">
                            <div class="score-header">
                                <div class="score-title">总积分</div>
                            </div>
                            <div class="score-content">
                                <div class="score-value" id="yiyi-total-score">0</div>
                            </div>
                            <div class="star-display">
                                <div class="score-stars" id="yiyi-total-stars"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 重置信息 -->
                <div class="weekly-reset-info">
                    <small>📅 每周一自动重置本周积分</small>
                </div>


                
                <!-- 自动同步状态面板 -->
                <div class="sync-info">
                    <h4>☁️ 自动数据同步</h4>
                    <p id="sync-status">正在检查连接状态...</p>
                    <p id="last-sync">上次同步：未同步</p>
                    <p style="font-size: 0.85em; color: #666;">🔄 自动同步已启用：所有数据变更将实时同步到云端</p>
                    <p style="font-size: 0.8em; color: #888; margin-top: 8px;">📱 页面打开时自动下载最新数据 | 💾 数据修改时自动上传到云端</p>
                    
                    <!-- 手动同步控制 -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                        <button class="modal-btn btn-primary" onclick="manualSyncData()" style="margin-right: 10px;">🔄 立即同步</button>
                        <button class="modal-btn btn-secondary" onclick="showSyncDebugInfo()">🔍 同步状态</button>
                        <button class="modal-btn btn-secondary" onclick="debugPointsPoolSync()" style="margin-left: 10px;">🔧 积分池调试</button>
                    </div>
                </div>
                
                <!-- 积分管理操作 -->
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 15px;">⚙️ 数据管理</h4>
                    <p style="color: #856404; margin-bottom: 15px; font-size: 0.9em;">危险操作：请谨慎使用以下功能</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="modal-btn btn-primary" onclick="clearAllPoints()" style="background: #dc3545; border-color: #dc3545; flex: 1; min-width: 150px;">
                            🗑️ 清零所有积分
                        </button>
                        <button class="modal-btn btn-primary" onclick="globalDataClear()" style="background: linear-gradient(45deg, #8b0000, #660000); border-color: #660000; flex: 1; min-width: 150px; box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);">
                            💥 全局清空所有数据
                        </button>
                    </div>
                    <p style="color: #dc3545; margin: 10px 0 0 0; font-size: 0.8em; font-weight: bold;">⚠️ 全局清空将删除所有数据（任务、积分、历史等），不可恢复！</p>
                </div>
                
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>周次</th>
                            <th>用户</th>
                            <th>奖励</th>
                            <th>惩罚</th>
                            <th>发布</th>
                            <th>获取</th>
                            <th>交易</th>
                            <th>日收</th>
                            <th>日罚</th>
                            <th>星收</th>
                            <th>总分</th>
                        </tr>
                    </thead>
                    <tbody id="bank-table-body">
                        <tr>
                            <td colspan="11" style="text-align: center; color: #666; padding: 20px;">暂无数据</td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">📊 积分计算规则</h4>
                    <ul style="color: #555; padding-left: 20px;">
                        <li><strong>奖励积分：</strong>通过奖励系统获得的正向积分</li>
                        <li><strong>罚分：</strong>通过扣分系统产生的负向积分</li>
                        <li><strong>发布：</strong>发布悬赏任务的成本支出（显示为负数）</li>
                        <li><strong>获取：</strong>完成悬赏任务的收益获得（显示为正数）</li>
                        <li><strong>交易：</strong>积分转账收支和其他交易</li>
                        <li><strong>日收入：</strong>完成每日任务获得的积分</li>
                        <li><strong>日惩罚：</strong>未完成每日任务被扭除的积分（显示为负数）</li>
                        <li><strong>星星收入：</strong>基于总积分每月可获得的星星奖励</li>
                        <li><strong>总积分在上方卡片显示 = 奖 + 罚 + 发布 + 获取 + 交易 + 日收入 + 日惩罚</strong></li>
                    </ul>
                </div>
            </div>

            <!-- 积分历史页面 -->
            <div id="history" class="page">
                <h2>📜 积分历史</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="modal-btn btn-secondary" onclick="clearHistory()" style="float: right;">清空历史</button>
                    <h3 style="color: #2c3e50;">操作记录</h3>
                </div>

                <div id="history-list" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <p style="text-align: center; color: #666; padding: 20px;">暂无历史记录</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 悬赏创建模态框 -->
    <div id="bounty-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3>🎯 创建悬赏任务</h3>
            </div>
            
            <div class="form-group">
                <label for="bounty-publisher">发布者</label>
                <select id="bounty-publisher" class="modal-input" onchange="handlePublisherChange()">
                    <option value="qiqi">七七</option>
                    <option value="yiyi">一一</option>
                    <option value="system">🤖 系统任务</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bounty-assignee">承接者（可选）</label>
                <select id="bounty-assignee" class="modal-input">
                    <option value="">待接单</option>
                    <option value="qiqi">七七</option>
                    <option value="yiyi">一一</option>
                    <option value="both" style="display: none;">🎁 同时给两人</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bounty-title">悬赏标题</label>
                <input type="text" id="bounty-title" class="modal-input" placeholder="请输入悬赏标题" maxlength="100">
            </div>

            <div class="form-group">
                <label for="bounty-description">悬赏说明（可选）</label>
                <textarea id="bounty-description" class="modal-input" placeholder="请输入悬赏详细说明" maxlength="200" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="bounty-points">悬赏积分</label>
                <input type="number" id="bounty-points" class="modal-input" placeholder="请输入悬赏积分" min="1">
            </div>

            <div class="form-group">
                <label for="bounty-time-limit">时间限制（可选）</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="bounty-time-value" class="modal-input" placeholder="不填则无时间限制" min="1" max="72" style="flex: 1;">
                    <select id="bounty-time-unit" class="modal-input" style="flex: 1;">
                        <option value="hours">小时</option>
                        <option value="days">天</option>
                    </select>
                </div>
                <small style="color: #666; font-size: 0.9em;">不填时间限制则永不过期；填写后超期自动放弃，积分归还发布者</small>
            </div>

            <!-- 系统任务提示 -->
            <div id="system-task-notice" class="form-group" style="display: none;">
                <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <div style="color: #2e7d32; font-weight: bold; margin-bottom: 8px;">🤖 系统任务说明</div>
                    <ul style="color: #2e7d32; font-size: 0.9em; margin: 0; padding-left: 20px;">
                        <li>系统任务积分来源于系统，不扣除任何用户积分</li>
                        <li>可选择"同时给两人"，完成后两人都获得全额积分</li>
                        <li>适合发布公共任务、节日活动等场景</li>
                    </ul>
                </div>
            </div>


            <div class="modal-actions">
                <button class="modal-btn btn-secondary" onclick="closeBountyModal()">取消</button>
                <button class="modal-btn btn-primary" onclick="createBounty()">创建悬赏</button>
            </div>
        </div>
    </div>

    <!-- 任务池管理模态框 -->
    <div id="task-pool-modal" class="modal-overlay" onclick="closeTaskPoolModalIfClickedOutside(event)">
        <div class="modal-box task-pool-modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3>🎯 任务池管理</h3>
                <button class="modal-close-btn" onclick="closeTaskPoolModal()">×</button>
            </div>
            
            <div class="task-pool-modal-content">
            <div class="form-group">
                <label for="pool-task-name">任务标题</label>
                <input type="text" id="pool-task-name" class="modal-input" placeholder="输入任务标题" maxlength="50">
            </div>
            
            <div class="form-group">
                <label for="pool-task-base-points">💎 基础积分</label>
                <input type="number" id="pool-task-base-points" class="modal-input" placeholder="1" value="1" min="1" max="50">
                <small style="color: #666; font-size: 0.8em; display: block; margin-top: 5px;">普通完成获得此积分，加倍完成x2，超级完成x3</small>
            </div>
            
            <div class="form-group">
                <label for="pool-task-description">详细说明</label>
                <textarea id="pool-task-description" class="modal-input" placeholder="输入任务的详细说明" maxlength="200" rows="3"></textarea>
            </div>
            
            <!-- 特殊属性设置 -->
            <div class="form-group">
                <label style="font-weight: 600; color: #2c3e50; margin-bottom: 10px; display: block;">🎆 特殊属性</label>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <!-- 专属设置 -->
                    <div>
                        <label for="pool-task-exclusive" style="font-size: 0.9em; color: #555; margin-bottom: 5px; display: block;">📍 专属设置</label>
                        <select id="pool-task-exclusive" class="modal-input" style="font-size: 0.9em;">
                            <option value="">无专属</option>
                            <option value="qiqi">七七专属</option>
                            <option value="yiyi">一一专属</option>
                        </select>
                    </div>
                    
                    <!-- 每周次数限制 -->
                    <div>
                        <label for="pool-task-weekly-limit" style="font-size: 0.9em; color: #555; margin-bottom: 5px; display: block;">🏃 每周次数限制</label>
                        <input type="number" id="pool-task-weekly-limit" class="modal-input" placeholder="不限" min="0" max="7" style="font-size: 0.9em;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 25px; align-items: center; flex-wrap: nowrap;">
                    <div style="display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                        <input type="checkbox" id="pool-task-double-value" style="transform: scale(1.1); vertical-align: middle;">
                        <label for="pool-task-double-value" style="font-size: 0.9em; color: #555; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 4px;">
                            <span>💪</span><span>以一抵二</span>
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                        <input type="checkbox" id="pool-task-streak-bonus" style="transform: scale(1.1); vertical-align: middle;" onchange="toggleStreakInputs()">
                        <label for="pool-task-streak-bonus" style="font-size: 0.9em; color: #555; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 4px;">
                            <span>🔥</span><span>连胜奖励</span>
                        </label>
                    </div>
                </div>
                
                <!-- 连胜奖励自定义设置 -->
                <div id="streak-custom-settings" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #ff5722;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="streak-days" style="font-size: 0.85em; color: #333; margin-bottom: 5px; display: block;">🗓️ 连胜天数：</label>
                            <input type="number" id="streak-days" min="2" max="30" value="7" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label for="streak-points" style="font-size: 0.85em; color: #333; margin-bottom: 5px; display: block;">💎 奖励分数：</label>
                            <input type="number" id="streak-points" min="1" max="50" value="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em;">
                        </div>
                    </div>
                    <p style="font-size: 0.8em; color: #666; margin: 10px 0 0 0;">📝 连续完成指定天数后获得一次性奖励，然后重置计数</p>
                </div>
                
                <div style="font-size: 0.8em; color: #666; margin-top: 10px; line-height: 1.4;">
                    <div>• <strong>以一抵二：</strong>一个任务算作两个任务</div>
                    <div>• <strong>连胜奖励：</strong>连续7天完成同一任务额外+3分（奖励直接进入积分池）</div>
                    <div>• <strong>次数限制：</strong>每周最多可选择的次数</div>
                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #28a745;">
                        <strong>🔥 连胜奖励说明：</strong><br>
                        第1-6天：无奖励，积累连胜<br>
                        第7天及以后：每次完成+3分奖励
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="modal-btn btn-primary" onclick="addPoolTask()" style="width: 100%;">添加到任务池</button>
            </div>

            <div class="task-pool-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">任务池 (<span id="pool-count">0</span>个任务)</h4>
                    <button onclick="clearTaskPool()" style="background: #dc3545; border: none; color: white; padding: 4px 8px; font-size: 0.75em; border-radius: 4px; cursor: pointer;">🗑️ 清空</button>
                </div>
                <div id="pool-tasks-list"></div>
            </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-secondary" onclick="debugTaskPoolSync()" style="margin-right: 10px;" title="仅在同步异常时使用">调试同步</button>
                <button class="modal-btn btn-secondary" onclick="closeTaskPoolModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 每日任务选择模态框 -->
    <div id="daily-task-select-modal" class="modal-overlay" onclick="closeDailyTaskSelectModalIfClickedOutside(event)">
        <div class="modal-box daily-task-select-modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3 id="select-modal-title">选择每日任务</h3>
                <button class="modal-close-btn" onclick="closeDailyTaskSelectModal()">×</button>
            </div>
            
            <div class="available-tasks">
                <h4>可选择的任务：</h4>
                <div id="available-tasks-list"></div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-secondary" onclick="closeDailyTaskSelectModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 任务管理模态框 -->
    <div id="task-manage-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3 id="task-manage-title">📋 管理任务</h3>
            </div>
            
            <div id="task-manage-list" style="max-height: 400px; overflow-y: auto;">
                <!-- 任务管理列表将在这里动态生成 -->
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-secondary" onclick="closeTaskManageModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 密码输入模态框 -->
    <div id="password-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3>🔒 输入管理密码</h3>
            </div>
            
            <div class="form-group" style="padding: 25px 40px 0 40px;">
                <label for="admin-password">管理密码</label>
                <input type="password" id="admin-password" class="modal-input" placeholder="请输入管理密码" autocomplete="current-password">
                <small style="color: #666; font-size: 0.9em; margin-top: 8px; display: block;">密码用于保护数据修改操作</small>
            </div>

            <div class="modal-actions" style="padding: 20px 40px 40px 40px;">
                <button class="modal-btn btn-secondary" onclick="cancelPasswordInput()">取消</button>
                <button class="modal-btn btn-primary" onclick="confirmPasswordInput()">确认</button>
            </div>
        </div>
    </div>

    <!-- 用户选择模态框 -->
    <div id="user-select-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 420px;">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3 id="user-select-title">👥 选择用户</h3>
            </div>
            
            <div class="form-group" style="padding: 25px 40px 0 40px;">
                <label id="user-select-label">请选择用户</label>
                <div id="user-select-options" style="display: grid; gap: 12px; margin-top: 15px;">
                    <!-- 选项将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="modal-actions" style="padding: 20px 40px 40px 40px;">
                <button class="modal-btn btn-secondary" onclick="cancelUserSelect()">取消</button>
            </div>
        </div>
    </div>

    <!-- 批量导入模态框 -->
    <div id="batch-import-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3>📥 批量导入任务</h3>
            </div>
            
            <div class="form-group" style="padding: 25px 40px 0 40px;">
                <label for="batch-import-text">批量导入文本</label>
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; font-size: 0.9em; color: #6c757d;">
                    <div style="font-weight: bold; margin-bottom: 8px;">📋 格式说明：</div>
                    <div style="margin-bottom: 6px;">• 使用全角逗号（，）作为分隔符</div>
                    <div style="margin-bottom: 6px;">• 格式：发布者，悬赏标题，悬赏积分</div>
                    <div style="margin-bottom: 6px;">• 发布者请填写：<code style="background:#fff;padding:2px 4px;border-radius:3px;">一一</code> 或 <code style="background:#fff;padding:2px 4px;border-radius:3px;">七七</code></div>
                    <div style="margin-bottom: 6px;">• 积分支持：阿拉伯数字(1-1000)或中文数字(一、二、三、十、二十等)</div>
                    <div style="margin-bottom: 10px;">• 支持序号：如 <code style="background:#fff;padding:2px 4px;border-radius:3px;">1. </code> 开头会自动忽略</div>
                    <div style="background: white; border-radius: 4px; padding: 8px; font-family: 'Courier New', monospace;">
                        1. 一一，看十章小说，三<br>
                        2. 七七，扔垃圾，5<br>
                        3. 七七，胡心怡游戏，十
                    </div>
                </div>
                <textarea id="batch-import-text" class="modal-input" placeholder="请粘贴或输入批量任务数据..." rows="8" style="font-family: 'Courier New', monospace; font-size: 14px;"></textarea>
            </div>

            <div class="form-group" style="padding: 0 40px;">
                <label>解析预览</label>
                <div id="batch-preview" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; font-size: 0.9em;">
                    <div style="color: #6c757d; text-align: center; padding: 20px;">请在上方输入任务数据，将自动显示解析预览</div>
                </div>
            </div>

            <div class="modal-actions" style="padding: 20px 40px 40px 40px;">
                <button class="modal-btn btn-secondary" onclick="cancelBatchImport()">取消</button>
                <button class="modal-btn btn-primary" id="batch-import-confirm" onclick="confirmBatchImport()" disabled>导入任务</button>
            </div>
        </div>
    </div>

    <!-- 确认输入模态框 -->
    <div id="confirm-input-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-drag-handle"></div>
                <h3 id="confirm-input-title">⚠️ 危险操作确认</h3>
            </div>
            
            <div class="form-group" style="padding: 25px 40px 0 40px;">
                <div id="confirm-input-message" style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 15px; margin-bottom: 15px; color: #856404;">
                    <!-- 确认消息将在这里显示 -->
                </div>
                <label for="confirm-input-text">请输入确认文本：</label>
                <input type="text" id="confirm-input-text" class="modal-input" placeholder="请输入确认文本">
                <small style="color: #dc3545; font-size: 0.9em; margin-top: 8px; display: block;">此操作无法撤销，请谨慎操作</small>
            </div>

            <div class="modal-actions" style="padding: 20px 40px 40px 40px;">
                <button class="modal-btn btn-secondary" onclick="cancelConfirmInput()">取消</button>
                <button class="modal-btn btn-primary" id="confirm-input-submit" onclick="submitConfirmInput()" style="background: #dc3545; border-color: #dc3545;">确认</button>
            </div>
        </div>
    </div>

    <!-- JavaScript代码 -->
    <script>
        // 全局变量
        let bountyData = [];
        let bankData = { qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 }, yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 } };
        
        // 调试模式开关
        let debugMode = false;
        
        // 任务完成奖励系统
        let taskRewardSystem = {
            qiqi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null },
            yiyi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null }
        };
        
        // 周目标系统 - 超简化版本
        let weeklyGoals = {
            qiqi: { 
                progress: 0,        // 本周获得积分
                weekStart: null     // 周开始时间
            },
            yiyi: { 
                progress: 0,        // 本周获得积分
                weekStart: null     // 周开始时间
            },
            target: 25,             // 每周目标积分
            lastPenaltyCheck: null  // 最后执行惩罚检查的日期
        };
        
        // 连胜奖励重置跟踪系统
        let streakResetTracker = {
            qiqi: {}, // 格式: {taskId: 'lastResetDate'}
            yiyi: {}  // 格式: {taskId: 'lastResetDate'}
        };
        
        let historyData = [];
        let bountyCounter = 1;
        let dailyTasksContent = '';
        let weeklyData = { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
        let monthlyStarBonus = { qiqi: 0, yiyi: 0, lastBonusDate: new Date().toISOString() };
        
        // 严格惩罚系统 - 记录截止时刻的任务状态
        let dailyTaskSnapshots = {}; // 格式: {"Mon Dec 30 2024": {qiqi: [...], yiyi: [...]}}
        let penaltySystemStartDate = null; // 惩罚系统开始日期
        
        // 周度积分统计系统
        const SYSTEM_START_DATE = new Date('2025-06-01'); // 系统开始日期：2025年6月1日
        let weeklyStats = {
            qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
            yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
            currentWeek: getCurrentWeekNumber(),
            weekStart: getWeekStartDate().toDateString()
        };
        
        // 新的每日任务系统数据
        let taskPool = []; // 任务池
        let dailyTasks = {
            qiqi: [null, null, null], // 每日任务槽（动态数量）
            yiyi: [null, null, null],
            progress: { qiqi: 0, yiyi: 0 }, // 今日完成进度
            extraTasks: { // 超额补充任务
                qiqi: [], // 七七的超额任务
                yiyi: []  // 一一的超额任务
            },
            clearedCompleted: { // 已清除的完成任务记录
                qiqi: [],
                yiyi: []
            },
            settings: {
                dailyTaskCount: 3, // 每日任务数量（可设置）
                extraTasksCountAsProgress: true // 超额任务是否计入进度
            }
        };
        let taskCounter = 1;
        let currentEditingTask = null;
        let currentEditingUser = null;
        let lastResetDate = null;
        
        // Firebase 同步相关变量
        let isFirebaseReady = false;
        let isOnline = false;
        let lastSyncTime = null;
        
        // 密码保护相关变量
        const ADMIN_PASSWORD = '240310'; // 这里设置你的密码
        const PASSWORD_STORAGE_KEY = 'pointSystemAuthTime';
        const PASSWORD_VALID_HOURS = 15;
        let isAuthenticated = false;
        let passwordCallback = null; // 存储密码验证成功后的回调函数
        let userSelectCallback = null; // 存储用户选择的回调函数
        let batchImportData = []; // 存储批量导入解析后的数据
        let confirmInputCallback = null; // 存储确认输入的回调函数
        let confirmInputExpectedText = ''; // 存储期望的确认文本

        // 页面切换功能
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            const clickedTab = Array.from(document.querySelectorAll('.nav-tab')).find(t => t.getAttribute('onclick') === `showPage('${pageId}')`);
            if (clickedTab) clickedTab.classList.add('active');

            // 刷新当前页面数据
            if (pageId === 'bank') refreshBankPage();
            if (pageId === 'history') refreshHistoryPage();
            if (pageId === 'cards') refreshBountyList();
            if (pageId === 'daily') {
                refreshDailyTasks();
                updateWeeklyTargetDescription(); // 更新目标描述
                updateWeeklyGoalsDisplay(); // 切换到每日任务页面时更新周目标显示
            }
            
            // 每次切换页面时检查惩罚
            processSnapshotPenalties();
        }

        // 悬赏功能
        function openBountyModal() {
            document.getElementById('bounty-modal').style.display = 'flex';
        }

        function closeBountyModal() {
            const modal = document.getElementById('bounty-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            clearBountyForm();
            // 重置模态框位置
            resetModalPosition(modalBox);
        }

        function clearBountyForm() {
            document.getElementById('bounty-publisher').value = 'qiqi';
            document.getElementById('bounty-assignee').value = '';
            document.getElementById('bounty-title').value = '';
            document.getElementById('bounty-description').value = '';
            document.getElementById('bounty-points').value = '';
            document.getElementById('bounty-time-value').value = '';
            document.getElementById('bounty-time-unit').value = 'hours';
            
            // 重置系统任务相关显示
            handlePublisherChange();
        }

        function handlePublisherChange() {
            const publisher = document.getElementById('bounty-publisher').value;
            const assigneeSelect = document.getElementById('bounty-assignee');
            const systemNotice = document.getElementById('system-task-notice');
            const bothOption = assigneeSelect.querySelector('option[value="both"]');
            
            if (publisher === 'system') {
                // 系统任务模式
                systemNotice.style.display = 'block';
                bothOption.style.display = 'block';
                
                // 更新承接者选项标签
                assigneeSelect.parentElement.querySelector('label').textContent = '奖励对象（可选）';
            } else {
                // 普通悬赏模式
                systemNotice.style.display = 'none';
                bothOption.style.display = 'none';
                
                // 重置承接者选项标签
                assigneeSelect.parentElement.querySelector('label').textContent = '承接者（可选）';
                
                // 如果当前选择了"both"，重置为空
                if (assigneeSelect.value === 'both') {
                    assigneeSelect.value = '';
                }
            }
        }

        function createBounty() {
            requireAuth(() => {
                const publisher = document.getElementById('bounty-publisher').value;
            const assignee = document.getElementById('bounty-assignee').value;
            const title = document.getElementById('bounty-title').value.trim();
            const description = document.getElementById('bounty-description').value.trim();
            const points = parseInt(document.getElementById('bounty-points').value);
            const timeValue = parseInt(document.getElementById('bounty-time-value').value);
            const timeUnit = document.getElementById('bounty-time-unit').value;

            // 验证表单
            if (!title) {
                alert('请输入悬赏标题');
                return;
            }
            if (!points || points < 1) {
                alert('请输入有效的悬赏积分（≥1）');
                return;
            }
            // 时间限制变为可选，如果填写了就验证
            if (timeValue && timeValue < 1) {
                alert('时间限制必须大于0');
                return;
            }
            // 检查是否为自接悬赏（系统任务除外）
            if (publisher !== 'system' && assignee && assignee === publisher) {
                alert('发布者不能承接自己的悬赏，请选择其他承接者或留空待接单');
                return;
            }

            // 计算到期时间（如果设置了时间限制）
            const now = new Date();
            let expireAt = null;
            let timeLimit = null;
            let displayExpireAt = null;

            if (timeValue && timeValue > 0) {
                expireAt = new Date(now);
                if (timeUnit === 'hours') {
                    expireAt.setHours(expireAt.getHours() + timeValue);
                } else {
                    expireAt.setDate(expireAt.getDate() + timeValue);
                }
                timeLimit = {
                    value: timeValue,
                    unit: timeUnit,
                    displayText: `${timeValue}${timeUnit === 'hours' ? '小时' : '天'}`
                };
                displayExpireAt = expireAt.toLocaleString();
            }

            // 创建悬赏
            const bounty = {
                id: `bounty_${bountyCounter++}`,
                publisher,
                assignee,
                title,
                description,
                points,
                timeLimit,
                status: assignee ? 'taken' : 'open',
                createdAt: now.toISOString(),
                expireAt: expireAt ? expireAt.toISOString() : null,
                startedAt: assignee ? now.toISOString() : null,
                completedAt: null,
                settledAt: null,
                displayCreatedAt: now.toLocaleString(),
                displayExpireAt
            };

            bountyData.push(bounty);

            // 处理系统任务的特殊逻辑
            if (publisher === 'system') {
                if (assignee === 'both') {
                    // 同时给两人发放积分
                    bankData.qiqi.reward += points;
                    bankData.yiyi.reward += points;
                    addWeeklyPoints('qiqi', points);
                    addWeeklyPoints('yiyi', points);
                    
                    // 更新周度跟踪
                    updateWeeklyPointTracking('qiqi', 'reward', points);
                    updateWeeklyPointTracking('yiyi', 'reward', points);
                    
                    bounty.status = 'settled';
                    bounty.completedAt = now.toISOString();
                    bounty.settledAt = now.toISOString();
                    
                    addHistory(`系统任务"${title}"完成，七七和一一各获得${points}积分`, 'system');
                    alert(`系统任务创建成功！七七和一一各获得${points}积分。`);
                } else if (assignee) {
                    // 直接给指定用户发放积分
                    bankData[assignee].reward += points;
                    addWeeklyPoints(assignee, points);
                    
                    // 更新周度跟踪
                    updateWeeklyPointTracking(assignee, 'reward', points);
                    
                    bounty.status = 'settled';
                    bounty.completedAt = now.toISOString();
                    bounty.settledAt = now.toISOString();
                    
                    const userName = assignee === 'qiqi' ? '七七' : '一一';
                    addHistory(`系统任务"${title}"完成，${userName}获得${points}积分`, 'system');
                    alert(`系统任务创建成功！${userName}获得${points}积分。`);
                } else {
                    alert('系统任务创建成功！等待用户完成。');
                }
            } else {
                // 普通悬赏：从发布者扣除积分
                if (bankData[publisher].reward < points) {
                    alert('积分不足，无法发布悬赏！');
                    bountyData.pop(); // 移除刚添加的悬赏
                    return;
                }
                bankData[publisher].reward -= points;
                bankData[publisher].publish -= points; // 记录发布成本
                
                // 更新周度跟踪
                updateWeeklyPointTracking(publisher, 'publish', -points);
                
                
                addHistory(`${publisher === 'qiqi' ? '七七' : '一一'}发布悬赏"${title}"，扣除${points}积分`, 'bounty');
                alert('悬赏创建成功！积分已扣除。');
            }

            saveData();
            refreshBountyList();
            refreshBankPage();
            closeBountyModal();
            });
        }

        function refreshBountyList() {
            const activeListElement = document.getElementById('active-bounty-list');
            const settledListElement = document.getElementById('settled-bounty-list');
            
            // 分离进行中和已结算的悬赏
            const activeBounties = bountyData.filter(bounty => bounty.status !== 'settled' && bounty.status !== 'expired');
            const settledBounties = bountyData.filter(bounty => bounty.status === 'settled' || bounty.status === 'expired');
            
            // 渲染进行中的悬赏
            if (activeBounties.length === 0) {
                activeListElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无进行中的悬赏任务</p>';
            } else {
                activeListElement.innerHTML = activeBounties.map(bounty => renderBountyItem(bounty)).join('');
            }
            
            // 渲染已结算的悬赏
            if (settledBounties.length === 0) {
                settledListElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无已结算的悬赏任务</p>';
            } else {
                settledListElement.innerHTML = settledBounties.map(bounty => renderBountyItem(bounty)).join('');
            }
            
            // 更新每日任务中的任务承接信息（如果当前在每日任务页面）
            if (document.getElementById('qiqi-acceptance-details')) {
                updateTaskAcceptanceInfo();
            }
        }

        function renderBountyItem(bounty) {
            const timeInfo = getBountyTimeInfo(bounty);
            const isSystemTask = bounty.publisher === 'system';
            
            return `
                <div class="bounty-item ${isSystemTask ? 'system-task' : ''}">
                    <button class="delete-bounty-btn" onclick="deleteBounty('${bounty.id}')" title="删除悬赏">
                        ✖
                    </button>
                    <div class="bounty-status status-${bounty.status}">
                        ${getStatusText(bounty.status)}
                    </div>
                    <div class="bounty-title-text">
                        ${bounty.title}
                        ${isSystemTask ? '<span class="system-task-badge">系统任务</span>' : ''}
                    </div>
                    <div class="bounty-info">
                        <div>发布者: ${getPlayerName(bounty.publisher)}</div>
                        <div>承接者: ${bounty.assignee ? getPlayerName(bounty.assignee) : '待接单'}</div>
                        <div>积分: ${bounty.points}${isSystemTask ? ' (系统提供)' : ''}</div>
                    </div>
                    ${bounty.description ? `<div class="bounty-desc">${bounty.description}</div>` : ''}
                    <div class="bounty-time-info" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.85em; color: #555;">
                        ${timeInfo}
                    </div>
                    <div class="bounty-actions">
                        ${getBountyActions(bounty)}
                    </div>
                </div>
            `;
        }

        function getBountyTimeInfo(bounty) {
            let timeInfo = [];
            
            if (bounty.createdAt) {
                timeInfo.push(`📅 创建时间: ${new Date(bounty.createdAt).toLocaleString()}`);
            }
            
            // 显示时间限制信息
            if (bounty.timeLimit) {
                timeInfo.push(`⏰ 时间限制: ${bounty.timeLimit.displayText}`);
            }
            
            // 显示到期时间和剩余时间
            if (bounty.expireAt) {
                const remaining = formatTimeRemaining(bounty.expireAt);
                const expireTime = new Date(bounty.expireAt).toLocaleString();
                
                if (bounty.status === 'expired') {
                    timeInfo.push(`⏰ 已于 ${expireTime} 过期`);
                } else if (remaining === '已过期') {
                    timeInfo.push(`⏰ 已过期 (${expireTime})`);
                } else {
                    timeInfo.push(`⏰ 到期时间: ${expireTime}`);
                    timeInfo.push(`⏳ 剩余时间: ${remaining}`);
                }
            }
            
            if (bounty.startedAt) {
                timeInfo.push(`🏁 开始时间: ${new Date(bounty.startedAt).toLocaleString()}`);
            }
            
            if (bounty.completedAt) {
                timeInfo.push(`✅ 完成时间: ${new Date(bounty.completedAt).toLocaleString()}`);
            }
            
            if (bounty.settledAt) {
                timeInfo.push(`💰 结算时间: ${new Date(bounty.settledAt).toLocaleString()}`);
            }
            
            // 计算持续时间
            if (bounty.startedAt && bounty.completedAt) {
                const duration = new Date(bounty.completedAt) - new Date(bounty.startedAt);
                const hours = Math.floor(duration / (1000 * 60 * 60));
                const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
                if (hours > 0) {
                    timeInfo.push(`⏱️ 执行时长: ${hours}小时${minutes}分钟`);
                } else {
                    timeInfo.push(`⏱️ 执行时长: ${minutes}分钟`);
                }
            }
            
            return timeInfo.join('<br>');
        }

        function getStatusText(status) {
            const statusMap = {
                'open': '待接单',
                'taken': '已接单',
                'done': '已完成',
                'settled': '已结算',
                'expired': '已过期'
            };
            return statusMap[status] || status;
        }

        function getPlayerName(player) {
            if (player === 'qiqi') return '七七';
            if (player === 'yiyi') return '一一';
            if (player === 'system') return '🤖 系统';
            if (player === 'both') return '🎁 七七 & 一一';
            return player;
        }

        function getBountyActions(bounty) {
            switch (bounty.status) {
                case 'open':
                    return `<button class="bounty-btn btn-assign" onclick="assignBounty('${bounty.id}')">指派/接单</button>`;
                case 'taken':
                    return `<button class="bounty-btn btn-complete" onclick="completeBounty('${bounty.id}')">完成</button>`;
                case 'done':
                    return '<span style="color: #28a745; font-weight: bold;">✅ 已完成</span>';
                case 'settled':
                    return '<span style="color: #28a745; font-weight: bold;">✅ 已结算</span>';
                default:
                    return '';
            }
        }

        function assignBounty(bountyId) {
            requireAuth(() => {
                const bounty = bountyData.find(b => b.id === bountyId);
                if (!bounty) return;

                if (bounty.publisher === 'system') {
                    // 系统任务：选择奖励对象
                    selectRewardTarget((selectedValue) => {
                        if (selectedValue === 'both') {
                            if (confirm('确认同时给七七和一一发放积分？')) {
                                bounty.assignee = 'both';
                                bounty.status = 'taken';
                                bounty.startedAt = new Date().toISOString();
                                finalizeBountyAssignment();
                            }
                        } else {
                            bounty.assignee = selectedValue === '七七' ? 'qiqi' : 'yiyi';
                            bounty.status = 'taken';
                            bounty.startedAt = new Date().toISOString();
                            finalizeBountyAssignment();
                        }
                    });
                } else {
                    // 普通悬赏：选择承接者
                    selectAssignee((selectedValue) => {
                        const assigneeKey = selectedValue === '七七' ? 'qiqi' : 'yiyi';
                        
                        if (assigneeKey === bounty.publisher) {
                            alert('发布者不能承接自己的悬赏！');
                            return;
                        }

                        bounty.assignee = assigneeKey;
                        bounty.status = 'taken';
                        bounty.startedAt = new Date().toISOString();
                        finalizeBountyAssignment();
                    });
                }

                function finalizeBountyAssignment() {
                    saveData();
                    refreshBountyList();
                }
            });
        }

        function completeBounty(bountyId) {
            requireAuth(() => {
                const bounty = bountyData.find(b => b.id === bountyId);
                if (!bounty) return;

                if (bounty.publisher === 'system') {
                    // 系统任务完成后自动结算
                    if (confirm('确认完成此系统任务？')) {
                        bounty.status = 'settled';
                        bounty.completedAt = new Date().toISOString();
                        bounty.settledAt = new Date().toISOString();
                        
                        // 给承接者发放积分
                        if (bounty.assignee === 'both') {
                            bankData.qiqi.reward += bounty.points;
                            bankData.yiyi.reward += bounty.points;
                            addWeeklyPoints('qiqi', bounty.points);
                            addWeeklyPoints('yiyi', bounty.points);
                            addHistory(`系统任务"${bounty.title}"完成，七七和一一各获得${bounty.points}积分`, 'system');
                        } else if (bounty.assignee) {
                            bankData[bounty.assignee].reward += bounty.points;
                            addWeeklyPoints(bounty.assignee, bounty.points);
                            const userName = bounty.assignee === 'qiqi' ? '七七' : '一一';
                            addHistory(`系统任务"${bounty.title}"完成，${userName}获得${bounty.points}积分`, 'system');
                        }
                        
                        saveData();
                        refreshBountyList();
                        refreshBankPage();
                        alert('系统任务完成，积分已发放！');
                    }
                } else {
                    // 普通悬赏任务 - 直接完成并结算
                    if (confirm(`确认完成并结算悬赏？\n${getPlayerName(bounty.publisher)} 将扭除 ${bounty.points} 积分（发布成本）\n${getPlayerName(bounty.assignee)} 将获得 ${bounty.points} 积分（获取收益）`)) {
                        // 执行记账 - 发布者扭除积分，承接者获得积分
                        bankData[bounty.publisher].publish -= bounty.points; // 发布成本（负数）
                        bankData[bounty.assignee].obtain += bounty.points;   // 获取收益（正数）
                        addWeeklyPoints(bounty.assignee, bounty.points);
                        

                        // 添加历史记录
                        const historyEntry = {
                            id: `history_${Date.now()}`,
                            type: '悬赏结算',
                            time: new Date().toLocaleString(),
                            description: `悬赏“${bounty.title}”完成并结算`,
                            details: {
                                publisher: bounty.publisher,
                                assignee: bounty.assignee,
                                points: bounty.points,
                                changes: [
                                    `${getPlayerName(bounty.publisher)} 发布 -${bounty.points}`,
                                    `${getPlayerName(bounty.assignee)} 获取 +${bounty.points}`
                                ]
                            }
                        };
                        historyData.unshift(historyEntry);

                        bounty.status = 'settled';
                        bounty.completedAt = new Date().toISOString();
                        bounty.settledAt = new Date().toISOString();

                        saveData();
                        refreshBountyList();
                        refreshBankPage();
                        
                        alert(`悬赏完成：${getPlayerName(bounty.publisher)} -发布 ${bounty.points} 分；${getPlayerName(bounty.assignee)} +获取 ${bounty.points} 分。`);
                    }
                }
            });
        }

        function settleBounty(bountyId) {
            requireAuth(() => {
                const bounty = bountyData.find(b => b.id === bountyId);
                if (!bounty || bounty.status === 'settled') return;

                if (confirm(`确认结算悬赏？\n${getPlayerName(bounty.publisher)} 将扣除 ${bounty.points} 积分（发布成本）\n${getPlayerName(bounty.assignee)} 将获得 ${bounty.points} 积分（获取收益）`)) {
                // 执行记账 - 发布者扭除积分，承接者获得积分
                bankData[bounty.publisher].publish -= bounty.points; // 发布成本（负数）
                bankData[bounty.assignee].obtain += bounty.points;   // 获取收益（正数）
                addWeeklyPoints(bounty.assignee, bounty.points);
                

                // 添加历史记录
                const historyEntry = {
                    id: `history_${Date.now()}`,
                    type: '悬赏结算',
                    time: new Date().toLocaleString(),
                    description: `悬赏"${bounty.title}"结算完成`,
                    details: {
                        publisher: bounty.publisher,
                        assignee: bounty.assignee,
                        points: bounty.points,
                        changes: [
                            `${getPlayerName(bounty.publisher)} 发布 -${bounty.points}`,
                            `${getPlayerName(bounty.assignee)} 获取 +${bounty.points}`
                        ]
                    }
                };
                historyData.unshift(historyEntry);

                bounty.status = 'settled';
                bounty.settledAt = new Date().toISOString();

                saveData();
                refreshBountyList();
                
                alert(`结算完成：${getPlayerName(bounty.publisher)} -发布 ${bounty.points} 分；${getPlayerName(bounty.assignee)} +获取 ${bounty.points} 分。`);
                }
            });
        }

        function deleteBounty(bountyId) {
            requireAuth(() => {
                const bounty = bountyData.find(b => b.id === bountyId);
                if (!bounty) return;

                // 构建确认信息
                let confirmMessage = `确认删除悬赏"${bounty.title}"吗？\n\n`;
                confirmMessage += `状态：${getStatusText(bounty.status)}\n`;
                confirmMessage += `发布者：${getPlayerName(bounty.publisher)}\n`;
                confirmMessage += `积分：${bounty.points}\n\n`;

                // 根据不同状态说明积分返还情况
                let refundInfo = '';
                if (bounty.status === 'settled') {
                    refundInfo = `此悬赏已结算完成，删除后只会移除记录，不会退还积分。`;
                } else {
                    refundInfo = `此悬赏尚未结算，删除后将退还发布者的悬赏积分。`;
                }

                confirmMessage += refundInfo;

                if (confirm(confirmMessage)) {
                    // 处理积分返还
                    if (bounty.status === 'settled') {
                        // 已结算的悬赏：只删除记录，不退还积分
                        const historyEntry = {
                            id: `history_${Date.now()}`,
                            type: '悬赏删除',
                            time: new Date().toLocaleString(),
                            description: `删除已结算悬赏"${bounty.title}"`,
                            details: {
                                publisher: bounty.publisher,
                                assignee: bounty.assignee,
                                points: bounty.points,
                                changes: ['已结算悬赏删除，不涉及积分变动']
                            }
                        };
                        historyData.unshift(historyEntry);
                    } else {
                        // 未结算的悬赏：退还发布者的悬赏积分
                        if (bounty.publisher !== 'system') {
                            // 普通悬赏需要退还积分
                            bankData[bounty.publisher].reward += bounty.points;
                            bankData[bounty.publisher].publish += bounty.points; // 撤销发布成本
                            
                        }
                        
                        const historyEntry = {
                            id: `history_${Date.now()}`,
                            type: '悬赏删除',
                            time: new Date().toLocaleString(),
                            description: `删除未结算悬赏"${bounty.title}"${bounty.publisher !== 'system' ? '，积分已退还' : ''}`,
                            details: {
                                publisher: bounty.publisher,
                                assignee: bounty.assignee || '无',
                                points: bounty.points,
                                changes: bounty.publisher !== 'system' ? 
                                    [`${getPlayerName(bounty.publisher)} 悬赏 +${bounty.points}（退还）`] : 
                                    ['系统任务删除，无积分变动']
                            }
                        };
                        historyData.unshift(historyEntry);
                    }

                    // 从悬赏列表中移除
                    const index = bountyData.findIndex(b => b.id === bountyId);
                    if (index > -1) {
                        bountyData.splice(index, 1);
                    }

                    saveData();
                    refreshBountyList();
                    
                    alert('悬赏已删除' + (bounty.status === 'settled' ? '！' : '，积分已退还！'));
                }
            });
        }

        // 积分交易功能
        function executeTrade() {
            requireAuth(() => {
                const from = document.getElementById('trade-from').value;
            const to = document.getElementById('trade-to').value;
            const points = parseInt(document.getElementById('trade-points').value);

            if (!points || points < 1) {
                alert('请输入有效的积分数值');
                return;
            }

            if (from === to) {
                alert('支付方和接收方不能相同');
                return;
            }

            if (confirm(`确认转账？\n${getPlayerName(from)} 支付 ${points} 积分给 ${getPlayerName(to)}`)) {
                // 执行转账
                bankData[from].trade -= points;
                bankData[to].trade += points;
                addWeeklyPoints(to, points);
                

                // 添加历史记录
                const historyEntry = {
                    id: `history_${Date.now()}`,
                    type: '积分转账',
                    time: new Date().toLocaleString(),
                    description: `${getPlayerName(from)} 向 ${getPlayerName(to)} 转账 ${points} 积分`,
                    details: {
                        from,
                        to,
                        points,
                        changes: [
                            `${getPlayerName(from)} 交易 -${points}`,
                            `${getPlayerName(to)} 交易 +${points}`
                        ]
                    }
                };
                historyData.unshift(historyEntry);

                saveData();
                document.getElementById('trade-points').value = '';
                
                alert('转账成功！');
                }
            });
        }

        // 奖惩功能
        function applyPenalty() {
            requireAuth(() => {
                const player = document.getElementById('penalty-player').value;
            const reason = document.getElementById('penalty-reason').value.trim();
            const points = parseInt(document.getElementById('penalty-points').value);

            if (!reason) {
                alert('请输入扣分原因');
                return;
            }
            if (!points || points < 1) {
                alert('请输入有效的扣分数值');
                return;
            }

            if (confirm(`确认对 ${getPlayerName(player)} 扣除 ${points} 分？\n原因：${reason}`)) {
                // 执行扣分
                bankData[player].penalty -= points;
                

                // 添加历史记录
                const historyEntry = {
                    id: `history_${Date.now()}`,
                    type: '扣分',
                    time: new Date().toLocaleString(),
                    description: `${getPlayerName(player)} 因"${reason}"被扣除 ${points} 积分`,
                    details: {
                        player,
                        reason,
                        points,
                        changes: [`${getPlayerName(player)} 罚分 -${points}`]
                    }
                };
                historyData.unshift(historyEntry);

                saveData();
                document.getElementById('penalty-reason').value = '';
                document.getElementById('penalty-points').value = '';
                
                alert('扣分成功！');
                }
            });
        }

        function applyReward() {
            requireAuth(() => {
                const player = document.getElementById('reward-player').value;
            const reason = document.getElementById('reward-reason').value.trim();
            const points = parseInt(document.getElementById('reward-points').value);

            if (!reason) {
                alert('请输入奖励原因');
                return;
            }
            if (!points || points < 1) {
                alert('请输入有效的奖励积分');
                return;
            }

            if (confirm(`确认奖励 ${getPlayerName(player)} ${points} 分？\n原因：${reason}`)) {
                // 执行奖励
                bankData[player].reward += points;
                
                // 更新周度跟踪
                updateWeeklyPointTracking(player, 'reward', points);
                addWeeklyPoints(player, points);
                

                // 添加历史记录
                const historyEntry = {
                    id: `history_${Date.now()}`,
                    type: '奖励',
                    time: new Date().toLocaleString(),
                    description: `${getPlayerName(player)} 因"${reason}"获得 ${points} 积分奖励`,
                    details: {
                        player,
                        reason,
                        points,
                        changes: [`${getPlayerName(player)} 奖励 +${points}`]
                    }
                };
                historyData.unshift(historyEntry);

                saveData();
                document.getElementById('reward-reason').value = '';
                document.getElementById('reward-points').value = '';
                
                alert('奖励成功！');
                }
            });
        }

        // 每周星星积分汇总功能
        function checkWeeklyReset() {
            const now = new Date();
            const currentWeekStart = getWeekStart(now);
            
            if (!weeklyData) {
                weeklyData = {
                    qiqi: 0,
                    yiyi: 0,
                    lastResetDate: currentWeekStart.toISOString()
                };
            }
            
            const lastResetDate = new Date(weeklyData.lastResetDate);
            
            // 检查是否需要处理周期性任务（跨周了）
            if (currentWeekStart > lastResetDate) {
                // 在重置之前，将本周获得的星星积分汇总到总积分
                if (weeklyData.qiqi > 0 || weeklyData.yiyi > 0) {
                    const qiqiStarBonus = calculateWeeklyStarBonus(weeklyData.qiqi);
                    const yiyiStarBonus = calculateWeeklyStarBonus(weeklyData.yiyi);
                    
                    if (qiqiStarBonus > 0) {
                        bankData.qiqi.reward += qiqiStarBonus;
                        updateWeeklyPointTracking('qiqi', 'starIncome', qiqiStarBonus);
                        addHistory(`🌟 七七的星星积分汇总：本周获得${weeklyData.qiqi}积分，转换为${qiqiStarBonus}星星积分奖励`, 'system');
                    }
                    
                    if (yiyiStarBonus > 0) {
                        bankData.yiyi.reward += yiyiStarBonus;
                        updateWeeklyPointTracking('yiyi', 'starIncome', yiyiStarBonus);
                        addHistory(`🌟 一一的星星积分汇总：本周获得${weeklyData.yiyi}积分，转换为${yiyiStarBonus}星星积分奖励`, 'system');
                    }
                }
                
                // 重置本周数据
                weeklyData.qiqi = 0;
                weeklyData.yiyi = 0;
                weeklyData.lastResetDate = currentWeekStart.toISOString();
                saveData();
                console.log('每周星星积分已汇总并重置');
            }
        }

        function calculateWeeklyStarBonus(weeklyPoints) {
            // 根据本周获得的积分计算星星奖励
            // 每10分本周积分可以获得1分星星奖励
            return Math.floor(weeklyPoints / 10);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = 周日, 1 = 周一
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 调整到周一
            d.setDate(diff);
            d.setHours(6, 0, 0, 0); // 设置为周一6点重置
            return d;
        }

        function addWeeklyPoints(user, points) {
            if (!weeklyData) {
                weeklyData = { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
            }
            
                        weeklyData[user] += points;
            saveData();
        }

        function calculateStarCounts(points) {
            if (points <= 0) return { rainbow: 0, big: 0, small: 0, half: 0 };
            
            let remainingPoints = points;
            
            // 彩色星星 (10000分 = 1个)
            const rainbowStars = Math.floor(remainingPoints / 10000);
            remainingPoints %= 10000;
            
            // 大星星 (1000分 = 1个)
            const bigStars = Math.floor(remainingPoints / 1000);
            remainingPoints %= 1000;
            
            // 小星星 (100分 = 1个)
            const smallStars = Math.floor(remainingPoints / 100);
            remainingPoints %= 100;
            
            // 半星 (50分 = 1个)
            const halfStars = remainingPoints >= 50 ? 1 : 0;
            
            return { rainbow: rainbowStars, big: bigStars, small: smallStars, half: halfStars };
        }

        function generateStars(points) {
            if (points <= 0) return '';
            
            let starsHTML = '';
            let remainingPoints = points;
            
            // 彩色星星 (10000分 = 1个)
            const rainbowStars = Math.floor(remainingPoints / 10000);
            for (let i = 0; i < rainbowStars; i++) {
                starsHTML += '<span class="star-rainbow">★</span>';
            }
            remainingPoints %= 10000;
            
            // 大星星 (1000分 = 1个)
            const bigStars = Math.floor(remainingPoints / 1000);
            for (let i = 0; i < bigStars; i++) {
                starsHTML += '<span class="star-big">★</span>';
            }
            remainingPoints %= 1000;
            
            // 小星星 (100分 = 1个)
            const smallStars = Math.floor(remainingPoints / 100);
            for (let i = 0; i < smallStars; i++) {
                starsHTML += '<span class="star-small">★</span>';
            }
            remainingPoints %= 100;
            
            // 半星 (50分 = 1个)
            if (remainingPoints >= 50) {
                starsHTML += '<span class="star-half">★</span>';
            }
            
            return starsHTML;
        }

        function calculateMonthlyBonus(points) {
            const stars = calculateStarCounts(points);
            return stars.small * 1 + stars.big * 10 + stars.rainbow * 100;
        }

        function calculateStarEarnings(points) {
            if (points <= 0) return '0分';
            
            const stars = calculateStarCounts(points);
            const monthlyBonus = stars.small * 1 + stars.big * 10 + stars.rainbow * 100;
            
            if (monthlyBonus > 0) {
                return `${monthlyBonus}分/月`;
            }
            return '0分';
        }

        function checkMonthlyBonus() {
            const now = new Date();
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            if (!monthlyStarBonus) {
                monthlyStarBonus = {
                    qiqi: 0,
                    yiyi: 0,
                    lastBonusDate: currentMonthStart.toISOString()
                };
            }
            
            const lastBonusDate = new Date(monthlyStarBonus.lastBonusDate);
            
            // 检查是否需要发放月度奖励（跨月了）
            if (currentMonthStart > lastBonusDate) {
                const qiqiTotal = bankData.qiqi.reward + bankData.qiqi.penalty + bankData.qiqi.publish + bankData.qiqi.obtain + bankData.qiqi.trade + bankData.qiqi.daily;
                const yiyiTotal = bankData.yiyi.reward + bankData.yiyi.penalty + bankData.yiyi.publish + bankData.yiyi.obtain + bankData.yiyi.trade + bankData.yiyi.daily;
                
                const qiqiBonus = calculateMonthlyBonus(qiqiTotal);
                const yiyiBonus = calculateMonthlyBonus(yiyiTotal);
                
                if (qiqiBonus > 0 || yiyiBonus > 0) {
                    if (qiqiBonus > 0) {
                        bankData.qiqi.reward += qiqiBonus;
                        updateWeeklyPointTracking('qiqi', 'starIncome', qiqiBonus);
                        addWeeklyPoints('qiqi', qiqiBonus);
                        monthlyStarBonus.qiqi += qiqiBonus;
                    }
                    
                    if (yiyiBonus > 0) {
                        bankData.yiyi.reward += yiyiBonus;
                        updateWeeklyPointTracking('yiyi', 'starIncome', yiyiBonus);
                        addWeeklyPoints('yiyi', yiyiBonus);
                        monthlyStarBonus.yiyi += yiyiBonus;
                    }
                    
                    monthlyStarBonus.lastBonusDate = currentMonthStart.toISOString();
                    saveData();
                    
                    const bonusMessage = [];
                    if (qiqiBonus > 0) bonusMessage.push(`七七获得${qiqiBonus}分星星奖励`);
                    if (yiyiBonus > 0) bonusMessage.push(`一一获得${yiyiBonus}分星星奖励`);
                    
                    addHistory(`🌟 月度星星奖励发放：${bonusMessage.join('，')}`, 'system');
                    console.log('月度星星奖励已发放');
                }
            }
        }

        // 任务完成奖励系统
        function getUpgradeCost(level) {
            if (level === 0) return 300;
            return 300 * Math.pow(2, level);
        }

        function getTaskCompletionReward(level) {
            return level + 1;
        }

        function canUpgradeRewardLevel(user) {
            const currentLevel = taskRewardSystem[user].level;
            const upgradeCost = getUpgradeCost(currentLevel);
            const userTotal = bankData[user].reward + bankData[user].penalty + bankData[user].publish + bankData[user].obtain + bankData[user].trade + bankData[user].dailyIncome + bankData[user].dailyPenalty;
            return userTotal >= upgradeCost;
        }

        function upgradeRewardLevel(user) {
            const currentLevel = taskRewardSystem[user].level;
            const upgradeCost = getUpgradeCost(currentLevel);
            const userTotal = bankData[user].reward + bankData[user].penalty + bankData[user].publish + bankData[user].obtain + bankData[user].trade + bankData[user].dailyIncome + bankData[user].dailyPenalty;
            const userName = user === 'qiqi' ? '七七' : '一一';
            const newLevel = currentLevel + 1;
            const newReward = getTaskCompletionReward(newLevel);
            
            if (userTotal < upgradeCost) {
                alert(`积分不足！${userName}需要${upgradeCost}积分才能升级，当前只有${userTotal}积分。`);
                return false;
            }
            
            // 简化升级流程，减少确认步骤
            if (confirm(`升级${userName}的任务奖励等级？\n消耗${upgradeCost}积分 → ${currentLevel}级升至${newLevel}级\n奖励提升：${currentLevel + 1}分 → ${newReward}分`)) {
                bankData[user].reward -= upgradeCost;
                taskRewardSystem[user].level++;
                
                addHistory(`${userName}升级任务奖励等级到${newLevel}级，消耗${upgradeCost}积分，现在完成3个任务可获得${newReward}分奖励`, 'system');
                
                saveData();
                refreshBankPage();
                refreshDailyTasks();
                alert(`🚀 ${userName}升级成功！${newLevel}级 → 奖励${newReward}分！`);
                return true;
            }
            return false;
        }

        function createCelebrationEffect(user) {
            // 创建全屏庆祝遮罩
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.5s ease-in;
            `;
            
            const userName = user === 'qiqi' ? '七七' : '一一';
            const userColor = user === 'qiqi' ? '#2196f3' : '#4caf50';
            
            celebration.innerHTML = `
                <div style="
                    text-align: center;
                    color: white;
                    animation: bounceIn 1s ease-out;
                ">
                    <div style="
                        font-size: 4em;
                        margin-bottom: 20px;
                        animation: pulse 1s ease-in-out infinite;
                    ">🎉🎊🥳</div>
                    <h2 style="
                        font-size: 2.5em;
                        margin: 20px 0;
                        color: ${userColor};
                        text-shadow: 0 0 20px ${userColor};
                        animation: glow 1s ease-in-out infinite alternate;
                    ">恭喜${userName}!</h2>
                    <p style="
                        font-size: 1.5em;
                        margin: 20px 0;
                        background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4);
                        background-size: 200% 200%;
                        animation: rainbowText 2s ease-in-out infinite;
                        -webkit-background-clip: text;
                        background-clip: text;
                        -webkit-text-fill-color: transparent;
                        font-weight: bold;
                    ">完成了3个任务!</p>
                    <div style="
                        font-size: 3em;
                        animation: bounce 2s ease-in-out infinite;
                    ">🎁✨🌟</div>
                </div>
            `;
            
            // 创建彩纸效果
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    background: ${['#ff6b6b', '#ffd93d', '#6bcf7f', '#4d9de0', '#e15759', '#ff9ff3'][Math.floor(Math.random() * 6)]};
                    left: ${Math.random() * 100}%;
                    top: -10px;
                    border-radius: 50%;
                    animation: confettiFall ${2 + Math.random() * 3}s linear infinite;
                    animation-delay: ${Math.random() * 2}s;
                `;
                celebration.appendChild(confetti);
            }
            
            document.body.appendChild(celebration);
            
            // 3秒后自动移除庆祝效果
            setTimeout(() => {
                celebration.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => {
                    if (celebration.parentNode) {
                        celebration.parentNode.removeChild(celebration);
                    }
                }, 500);
            }, 3000);
        }

        function checkTaskCompletionReward(user, actualTaskCount = 1) {
            // 累加任务进度
            taskRewardSystem[user].tasksCompleted += actualTaskCount;
            
            let totalRewardPoints = 0;
            
            // 检查是否可以获得奖励（每3个进度获得一次奖励）
            while (taskRewardSystem[user].tasksCompleted >= 3) {
                const rewardPoints = getTaskCompletionReward(taskRewardSystem[user].level);
                taskRewardSystem[user].pendingReward += rewardPoints;
                taskRewardSystem[user].tasksCompleted -= 3; // 减去已使用的进度
                totalRewardPoints += rewardPoints;
                
                const userName = user === 'qiqi' ? '七七' : '一一';
                
                // 创建庆祝特效
                createCelebrationEffect(user);
                
                console.log(`${userName}获得进度奖励: ${rewardPoints}分 (剩余进度: ${taskRewardSystem[user].tasksCompleted})`);
            }
            
            return totalRewardPoints;
        }

        function claimTaskReward(user) {
            const pendingReward = taskRewardSystem[user].pendingReward;
            const userName = user === 'qiqi' ? '七七' : '一一';
            
            if (pendingReward <= 0) {
                alert(`${userName}暂无可领取的奖励！`);
                return false;
            }
            
            // 检查是否今天已经领取过
            const today = new Date().toDateString();
            const lastClaimDate = taskRewardSystem[user].lastClaimDate;
            
            if (lastClaimDate === today) {
                alert(`${userName}今天已经领取过奖励了！明天再来吧~ 🌅`);
                return false;
            }
            
            // 奖励计入周目标进度
            addToWeeklyGoals(user, pendingReward);
            taskRewardSystem[user].lastClaimDate = today;
            
            addHistory(`${userName}领取任务完成奖励${pendingReward}分（等级${taskRewardSystem[user].level}），已存入积分池`, 'system');
            
            taskRewardSystem[user].pendingReward = 0;
            saveData();
            refreshBankPage();
            refreshDailyTasks();
            refreshWeeklyGoals();
            
            // 创建领取成功特效
            createRewardClaimEffect(user, pendingReward);
            return true;
        }

        function createRewardClaimEffect(user, rewardPoints) {
            // 创建金币掉落效果
            for (let i = 0; i < 20; i++) {
                const coin = document.createElement('div');
                coin.style.cssText = `
                    position: fixed;
                    width: 30px;
                    height: 30px;
                    background: linear-gradient(45deg, #ffd700, #ffed4a);
                    border-radius: 50%;
                    border: 2px solid #ffcc00;
                    z-index: 10000;
                    left: ${45 + Math.random() * 10}%;
                    top: 30%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2em;
                    animation: coinFall ${1 + Math.random() * 2}s ease-out forwards;
                    animation-delay: ${Math.random() * 0.5}s;
                    box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
                `;
                coin.textContent = '💰';
                
                document.body.appendChild(coin);
                
                // 移除金币
                setTimeout(() => {
                    if (coin.parentNode) {
                        coin.parentNode.removeChild(coin);
                    }
                }, 3000);
            }
            
            // 创建奖励文字飞入效果
            const rewardText = document.createElement('div');
            rewardText.style.cssText = `
                position: fixed;
                top: 40%;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10001;
                font-size: 2em;
                font-weight: bold;
                color: #ffd700;
                text-shadow: 0 0 20px #ffd700;
                animation: rewardTextFloat 2s ease-out forwards;
            `;
            rewardText.textContent = `+${rewardPoints}分! 🎉`;
            
            document.body.appendChild(rewardText);
            
            setTimeout(() => {
                if (rewardText.parentNode) {
                    rewardText.parentNode.removeChild(rewardText);
                }
            }, 2000);
        }

        // 周目标功能 - 直接加到总分，记录周进度
        function addToWeeklyGoals(user, points) {
            // 检查是否需要重置周数据
            const today = new Date();
            const weekStart = getWeekStartDate();
            
            if (!weeklyGoals[user].weekStart || new Date(weeklyGoals[user].weekStart) < weekStart) {
                weeklyGoals[user].weekStart = weekStart.toISOString();
                weeklyGoals[user].progress = 0; // 新周重置进度
            }
            
            // 直接将积分加到总分
            bankData[user].dailyIncome += points;
            addWeeklyPoints(user, points);
            
            // 记录周目标进度
            weeklyGoals[user].progress += points;
            
            // 添加历史记录
            const userName = user === 'qiqi' ? '七七' : '一一';
            addHistory(`${userName}完成任务获得${points}分`, 'reward');
            
            console.log(`✅ ${userName}获得${points}分，本周进度: ${weeklyGoals[user].progress}/${weeklyGoals.target}`);
            
            // 更新周目标显示
            updateWeeklyGoalsDisplay();
        }

        function calculatePenalty(user) {
            const progress = weeklyGoals[user].progress || 0;
            const target = weeklyGoals.target;
            if (progress < target) {
                return (target - progress) * 2; // 每少一分扣两分
            }
            return 0;
        }

        // 提现功能已简化，积分直接进入总分，无需提现操作
        function withdrawPoints(user, amount = null) {
            const userName = user === 'qiqi' ? '七七' : '一一';
            alert(`${userName}的积分已直接加入总分，无需提现操作！`);
            return false;
        }

        function autoWeeklyCheck() {
            const now = new Date();
            const isWeekEnd = now.getDay() === 0; // 周日
            const today = now.toDateString();
            
            if (isWeekEnd && weeklyGoals.lastPenaltyCheck !== today) {
                // 周日检查是否需要实施惩罚，防止重复执行
                ['qiqi', 'yiyi'].forEach(user => {
                    checkWeeklyPenalty(user);
                });
                weeklyGoals.lastPenaltyCheck = today;
                saveData(); // 保存防重复标记
            }
        }

        function checkWeeklyPenalty(user) {
            const progress = weeklyGoals[user].progress || 0;
            const target = weeklyGoals.target;
            const userName = user === 'qiqi' ? '七七' : '一一';
            
            // 计算惩罚
            const penalty = calculatePenalty(user);
            
            // 应用惩罚
            if (penalty > 0) {
                bankData[user].reward -= penalty;
                addHistory(`${userName}本周完成${progress}分，低于${target}分目标，惩罚-${penalty}分`, 'penalty');
                console.log(`⚠️ ${userName}本周进度不足，被扣${penalty}分`);
            } else {
                addHistory(`${userName}本周完成${progress}分，达成${target}分目标`, 'system');
                console.log(`✅ ${userName}本周达标，无惩罚`);
            }
            
            // 重置周进度
            weeklyGoals[user].progress = 0;
            weeklyGoals[user].weekStart = getWeekStartDate().toISOString();
            
            // 更新显示
            updateWeeklyGoalsDisplay();
        }

        function getWeekStartDate() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1); // 调整到周一
            const monday = new Date(now.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function toggleStreakInputs() {
            const checkbox = document.getElementById('pool-task-streak-bonus');
            const settings = document.getElementById('streak-custom-settings');
            
            if (checkbox.checked) {
                settings.style.display = 'block';
            } else {
                settings.style.display = 'none';
            }
        }

        function clearTaskPool() {
            if (confirm('⚠️ 确认清空任务池吗？\n\n这将删除：\n• 所有任务池中的任务\n• 用户已选择的每日任务将变为无效\n• 连胜记录将保留\n\n此操作不可恢复！')) {
                const taskCount = taskPool.length;
                
                // 清空任务池
                taskPool = [];
                
                // 清空用户的每日任务选择（因为任务池清空了，这些任务变成无效）
                dailyTasks.qiqi = [null, null, null];
                dailyTasks.yiyi = [null, null, null];
                dailyTasks.progress = { qiqi: 0, yiyi: 0 };
                
                // 清空超额任务
                dailyTasks.extraTasks = { qiqi: [], yiyi: [] };
                
                addHistory(`管理员清空任务池，删除了${taskCount}个任务，用户每日任务已重置`, 'system');
                
                saveData();
                refreshTaskPoolDisplay();
                refreshDailyTasks();
                updateTaskPoolPreview();
                
                alert(`🗑️ 任务池已清空！\n删除了${taskCount}个任务，用户每日任务已重置。`);
            }
        }

        function clearPointsPool() {
            // 添加密码保护
            const password = prompt('⚠️ 积分池清空需要管理员权限！\n\n请输入管理员密码：');
            if (!password) {
                alert('操作已取消');
                return;
            }
            
            // 验证密码（可以设置为你想要的密码）
            if (password !== '960818') {
                alert('❌ 密码错误！无法清空积分池。');
                return;
            }
            
            if (confirm('⚠️ 管理员权限已验证！\n\n确认重置周目标吗？\n\n这将重置：\n• 七七和一一的周目标进度\n• 连胜重置记录\n\n此操作不可恢复！')) {
                const qiqiProgress = weeklyGoals.qiqi.progress;
                const yiyiProgress = weeklyGoals.yiyi.progress;
                
                // 重置周目标
                weeklyGoals = {
                    qiqi: { progress: 0, weekStart: null },
                    yiyi: { progress: 0, weekStart: null },
                    target: 25,
                    lastPenaltyCheck: null
                };
                
                // 清空连胜重置记录
                streakResetTracker = {
                    qiqi: {},
                    yiyi: {}
                };
                
                addHistory(`管理员重置周目标，七七进度${qiqiProgress}分，一一进度${yiyiProgress}分`, 'system');
                
                saveData();
                refreshWeeklyGoals();
                
                alert(`🗑️ 周目标已重置！\n七七进度：${qiqiProgress}分\n一一进度：${yiyiProgress}分`);
            }
        }

        function globalDataClear() {
            if (confirm('⚠️ 确认要清除所有数据吗？\n\n这将删除：\n• 所有任务数据\n• 银行积分数据\n• 积分池数据\n• 任务奖励系统数据\n• 历史记录\n• 所有设置和配置\n\n此操作不可恢复！')) {
                // 清除所有本地存储
                localStorage.clear();
                
                // 重置所有全局变量
                bankData = { 
                    qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 }, 
                    yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 } 
                };
                weeklyData = { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
                monthlyStarBonus = { qiqi: 0, yiyi: 0, lastBonusDate: new Date().toISOString() };
                taskList = { qiqi: [], yiyi: [] };
                // taskPool = []; // 保留任务池，不清除
                taskCounter = 1;
                historyData = [];
                penaltyHistory = [];
                lastResetDate = null;
                taskSnapshots = {};
                dailyTasks = {
                    qiqi: [null, null, null],
                    yiyi: [null, null, null],
                    progress: { qiqi: 0, yiyi: 0 },
                    extraTasks: { qiqi: [], yiyi: [] },
                    clearedCompleted: { qiqi: [], yiyi: [] }
                };
                
                // 重置任务奖励系统
                taskRewardSystem = {
                    qiqi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null },
                    yiyi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null }
                };
                
                // 重置周目标（已迁移到新系统）
                // weeklyGoals 已在上面重置
                
                // 重置连胜跟踪器
                streakResetTracker = {
                    qiqi: {},
                    yiyi: {}
                };
                
                // 保存空数据并刷新所有页面
                saveData();
                refreshDailyPage();
                refreshBankPage();
                refreshHistoryPage();
                refreshWeeklyGoals();
                
                addHistory('系统重置：所有数据已清空', 'system');
                alert('🗑️ 所有数据已清空完成！');
                
                // 刷新当前页面显示
                location.reload();
            }
        }

        // 已移除：showPartialWithdrawModal - 新系统无需提现功能

        // 更新周目标显示
        function updateWeeklyGoalsDisplay() {
            try {
                console.log('🔄 开始更新周目标显示');
                
                ['qiqi', 'yiyi'].forEach(user => {
                    const progress = weeklyGoals[user].progress || 0;
                    const target = weeklyGoals.target;
                    const remaining = Math.max(0, target - progress);
                    const penalty = remaining > 0 ? remaining * 2 : 0;
                    
                    const displayEl = document.getElementById(`${user}-weekly-progress`);
                    if (displayEl) {
                        let statusColor = '';
                        let statusMsg = '';
                        let progressBar = '';
                        
                        if (progress >= target) {
                            statusColor = '#4caf50';
                            statusMsg = '🎉 已达成目标！';
                            progressBar = `<div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0;"><div style="width: 100%; height: 100%; background: #4caf50; border-radius: 4px; transition: width 0.3s ease;"></div></div>`;
                        } else {
                            statusColor = '#ff5722';
                            statusMsg = `⚠️ 还差 ${remaining}分<br>预计扣分: ${penalty}分`;
                            const percentage = Math.min(100, (progress / target) * 100);
                            progressBar = `<div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin: 10px 0;"><div style="width: ${percentage}%; height: 100%; background: #ff5722; border-radius: 4px; transition: width 0.3s ease;"></div></div>`;
                        }
                        
                        displayEl.innerHTML = `
                            <div style="font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 8px;">
                                ${progress}/${target}分
                            </div>
                            ${progressBar}
                            <div style="color: ${statusColor}; font-weight: bold; font-size: 0.9em; margin-bottom: 10px;">
                                ${statusMsg}
                            </div>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button onclick="clearWeeklyProgress('${user}')" 
                                        style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer; font-weight: bold;">
                                    🗑️ 清除
                                </button>
                                <button onclick="customWeeklyProgress('${user}')" 
                                        style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; cursor: pointer; font-weight: bold;">
                                    ⚙️ 自定义
                                </button>
                            </div>
                        `;
                    }
                });
                
                console.log('✅ 周目标显示更新完成');
            } catch (error) {
                console.error('❌ 周目标显示更新失败:', error);
            }
        }

        // 打开周目标设置
        function openWeeklyGoalSettings() {
            const currentTarget = weeklyGoals.target;
            
            let settingsText = '⚙️ 周目标设置\n\n';
            settingsText += `当前目标: ${currentTarget}分/周\n\n`;
            settingsText += `当前进度:\n`;
            settingsText += `七七: ${weeklyGoals.qiqi.progress}分\n`;
            settingsText += `一一: ${weeklyGoals.yiyi.progress}分\n\n`;
            settingsText += `请输入新的周目标分数（建议10-50分）:`;
            
            const input = prompt(settingsText, currentTarget);
            
            if (input !== null) {
                const newTarget = parseInt(input);
                
                if (isNaN(newTarget) || newTarget < 1 || newTarget > 100) {
                    alert('❌ 请输入有效的目标分数（1-100分）！');
                    return;
                }
                
                if (confirm(`确认设置周目标为 ${newTarget}分？\n\n规则：每周没达到目标，每少1分扣2分`)) {
                    weeklyGoals.target = newTarget;
                    
                    // 更新描述文字
                    updateWeeklyTargetDescription();
                    
                    // 更新显示
                    updateWeeklyGoalsDisplay();
                    
                    // 保存数据
                    saveData();
                    
                    // 添加历史记录
                    addHistory(`管理员设置周目标为 ${newTarget}分`, 'system');
                    
                    alert(`✅ 周目标已设置为 ${newTarget}分！`);
                    console.log(`✅ 周目标已更新为 ${newTarget}分`);
                }
            }
        }

        // 更新周目标描述文字
        function updateWeeklyTargetDescription() {
            const descEl = document.getElementById('weekly-target-desc');
            if (descEl) {
                descEl.textContent = `每周需获得${weeklyGoals.target}分，否则每少1分扣2分！`;
            }
        }

        // 清除用户周目标进度
        function clearWeeklyProgress(user) {
            const userName = user === 'qiqi' ? '七七' : '一一';
            const currentProgress = weeklyGoals[user].progress || 0;
            
            if (currentProgress === 0) {
                alert(`${userName}的本周进度已经是0分，无需清除！`);
                return;
            }
            
            if (confirm(`确认清除${userName}的本周进度吗？\n\n当前进度: ${currentProgress}分\n清除后将变为: 0分`)) {
                weeklyGoals[user].progress = 0;
                
                // 更新显示
                updateWeeklyGoalsDisplay();
                
                // 保存数据
                saveData();
                
                // 添加历史记录
                addHistory(`管理员清除${userName}的周目标进度（原${currentProgress}分）`, 'system');
                
                alert(`✅ ${userName}的周目标进度已清除！`);
                console.log(`🗑️ 已清除${userName}的周目标进度`);
            }
        }

        // 自定义用户周目标进度
        function customWeeklyProgress(user) {
            const userName = user === 'qiqi' ? '七七' : '一一';
            const currentProgress = weeklyGoals[user].progress || 0;
            
            let customText = `⚙️ 自定义${userName}的周目标进度\n\n`;
            customText += `当前进度: ${currentProgress}分\n`;
            customText += `目标: ${weeklyGoals.target}分\n\n`;
            customText += `请输入新的进度分数:`;
            
            const input = prompt(customText, currentProgress);
            
            if (input !== null) {
                const newProgress = parseInt(input);
                
                if (isNaN(newProgress) || newProgress < 0 || newProgress > 200) {
                    alert('❌ 请输入有效的进度分数（0-200分）！');
                    return;
                }
                
                if (confirm(`确认设置${userName}的周目标进度为 ${newProgress}分？\n\n原进度: ${currentProgress}分\n新进度: ${newProgress}分`)) {
                    const oldProgress = weeklyGoals[user].progress;
                    weeklyGoals[user].progress = newProgress;
                    
                    // 更新显示
                    updateWeeklyGoalsDisplay();
                    
                    // 保存数据
                    saveData();
                    
                    // 添加历史记录
                    addHistory(`管理员设置${userName}的周目标进度：${oldProgress}分 → ${newProgress}分`, 'system');
                    
                    alert(`✅ ${userName}的周目标进度已设置为 ${newProgress}分！`);
                    console.log(`⚙️ ${userName}的周目标进度已更新：${oldProgress}分 → ${newProgress}分`);
                }
            }
        }

        // 打开每日任务设置
        function openDailyTaskSettings() {
            const currentCount = dailyTasks.settings.dailyTaskCount;
            const extraCountsAsProgress = dailyTasks.settings.extraTasksCountAsProgress;
            
            let settingsText = '⚙️ 每日任务设置\n\n';
            settingsText += `当前设置:\n`;
            settingsText += `• 每日任务数量: ${currentCount}个\n`;
            settingsText += `• 超额任务计入进度: ${extraCountsAsProgress ? '是' : '否'}\n`;
            settingsText += `• 调试模式: ${debugMode ? '开启' : '关闭'}\n\n`;
            settingsText += `当前状态:\n`;
            settingsText += `• 七七: ${dailyTasks.qiqi.filter(t => t).length}/${currentCount} 任务\n`;
            settingsText += `• 一一: ${dailyTasks.yiyi.filter(t => t).length}/${currentCount} 任务\n\n`;
            
            const options = [
                '1. 设置每日任务数量',
                '2. 切换超额任务计入进度',
                '3. 切换调试模式',
                '4. 取消'
            ];
            
            const choice = prompt(settingsText + '请选择操作:\n' + options.join('\n'), '1');
            
            if (choice === '1') {
                setDailyTaskCount();
            } else if (choice === '2') {
                toggleExtraTaskProgress();
            } else if (choice === '3') {
                toggleDebugMode();
            }
        }

        // 设置每日任务数量
        function setDailyTaskCount() {
            const currentCount = dailyTasks.settings.dailyTaskCount;
            const input = prompt(`设置每日任务数量 (建议1-8个):\n\n当前: ${currentCount}个`, currentCount);
            
            if (input !== null) {
                const newCount = parseInt(input);
                
                if (isNaN(newCount) || newCount < 1 || newCount > 10) {
                    alert('❌ 请输入有效的任务数量（1-10个）！');
                    return;
                }
                
                if (confirm(`确认设置每日任务数量为 ${newCount}个？\n\n注意：这会重新调整任务槽位`)) {
                    // 调整任务槽数组大小
                    adjustTaskSlots(newCount);
                    
                    dailyTasks.settings.dailyTaskCount = newCount;
                    
                    // 更新显示
                    refreshDailyTasks();
                    
                    // 保存数据
                    saveData();
                    
                    // 添加历史记录
                    addHistory(`管理员设置每日任务数量为 ${newCount}个`, 'system');
                    
                    alert(`✅ 每日任务数量已设置为 ${newCount}个！`);
                }
            }
        }

        // 调整任务槽数组大小
        function adjustTaskSlots(newCount) {
            ['qiqi', 'yiyi'].forEach(user => {
                const currentTasks = dailyTasks[user];
                const currentLength = currentTasks.length;
                
                if (newCount > currentLength) {
                    // 增加槽位，用null填充
                    for (let i = currentLength; i < newCount; i++) {
                        currentTasks.push(null);
                    }
                } else if (newCount < currentLength) {
                    // 减少槽位，保留前面的任务
                    dailyTasks[user] = currentTasks.slice(0, newCount);
                }
            });
        }

        // 切换调试模式
        function toggleDebugMode() {
            const newDebugMode = !debugMode;
            
            if (confirm(`确认${newDebugMode ? '开启' : '关闭'}调试模式？\n\n调试模式功能：\n• 允许重复选择同一个任务\n• 便于测试和调试功能`)) {
                debugMode = newDebugMode;
                
                // 刷新任务选择界面（如果已打开）
                if (document.getElementById('daily-task-select-modal').style.display === 'flex') {
                    showAvailableTasks(currentEditingUser, currentEditingSlot);
                }
                
                const statusMsg = debugMode ? '开启' : '关闭';
                alert(`✅ 调试模式已${statusMsg}！\n\n${debugMode ? '现在可以重复选择同一个任务进行测试。' : '恢复正常模式，不允许重复选择任务。'}`);
            }
        }

        // 切换超额任务计入进度
        function toggleExtraTaskProgress() {
            const current = dailyTasks.settings.extraTasksCountAsProgress;
            const newValue = !current;
            
            if (confirm(`确认${newValue ? '开启' : '关闭'}超额任务计入进度？\n\n${newValue ? '开启后：超额任务完成也会增加每日进度' : '关闭后：只有主要任务计入每日进度'}`)) {
                dailyTasks.settings.extraTasksCountAsProgress = newValue;
                
                // 重新计算进度
                updateDailyProgress();
                
                // 更新显示
                refreshDailyTasks();
                
                // 保存数据
                saveData();
                
                // 添加历史记录
                addHistory(`管理员${newValue ? '开启' : '关闭'}了超额任务计入进度`, 'system');
                
                alert(`✅ 已${newValue ? '开启' : '关闭'}超额任务计入进度！`);
            }
        }

        // 更新每日进度计算
        function updateDailyProgress() {
            ['qiqi', 'yiyi'].forEach(user => {
                let progress = 0;
                
                // 计算主要任务进度
                dailyTasks[user].forEach(task => {
                    if (task && task.completed) {
                        progress += task.actualTaskCount || 1; // 以一抵二算2分，普通任务算1分
                    }
                });
                
                // 如果开启了超额任务计入进度
                if (dailyTasks.settings.extraTasksCountAsProgress && dailyTasks.extraTasks && dailyTasks.extraTasks[user]) {
                    dailyTasks.extraTasks[user].forEach(task => {
                        if (task.completed) {
                            progress += task.multiplier || 1; // 超额任务的倍数
                        }
                    });
                }
                
                dailyTasks.progress[user] = progress;
            });
        }

        // 获取完成方式文本
        function getCompletionTypeText(completionType) {
            switch(completionType) {
                case 'normal': return '普通完成';
                case 'double': return '加倍完成';
                case 'super': return '超级完成';
                default: return '';
            }
        }

        // 动态生成任务槽HTML
        function generateTaskSlots(user) {
            const taskCount = dailyTasks.settings.dailyTaskCount;
            let slotsHtml = '';
            
            for (let i = 0; i < taskCount; i++) {
                const task = dailyTasks[user][i];
                if (task) {
                    // 已选择任务的槽
                    const completedClass = task.completed ? 'completed' : '';
                    const multiplierBadge = task.actualTaskCount > 1 ? 
                        `<div class="multiplier-badge">×${task.actualTaskCount}</div>` : '';
                    
                    slotsHtml += `
                        <div class="task-slot filled ${completedClass}">
                            <div class="slot-content">
                                <div class="task-name">
                                    ${task.name}
                                    <div style="font-size: 0.8em; color: #666; margin-top: 2px;">
                                        ${task.basePoints && task.basePoints > 0 ? `基础: ${task.basePoints}分` : '无积分任务'}
                                        ${task.completed && task.completionType ? ` | ${getCompletionTypeText(task.completionType)} (${task.earnedPoints}分)` : ''}
                                    </div>
                                </div>
                                <div class="task-actions">
                                    ${task.completed ? 
                                        // 已完成任务显示编辑和清除按钮
                                        `<button onclick="editCompletedTask('${user}', ${i})" class="btn-complete">✅ 已完成</button>
                                         <button onclick="clearDailyTaskSlot('${user}', ${i})" class="btn-clear">🗑️ 清除</button>` :
                                        // 未完成任务：有积分显示完成按钮，无积分只显示清除按钮
                                        task.basePoints && task.basePoints > 0 ?
                                        `<div class="completion-buttons">
                                             <button onclick="completeDailyTask('${user}', ${i}, 'normal', 1)" class="btn-normal" title="普通完成 +${task.basePoints}分">普通</button>
                                             <button onclick="completeDailyTask('${user}', ${i}, 'double', 2)" class="btn-double" title="加倍完成 +${task.basePoints * 2}分">加倍</button>
                                             <button onclick="completeDailyTask('${user}', ${i}, 'super', 3)" class="btn-super" title="超级完成 +${task.basePoints * 3}分">超级</button>
                                         </div>
                                         <button onclick="abandonDailyTask('${user}', ${i})" class="btn-abandon">🗑️ 放弃</button>` :
                                        `<button onclick="clearDailyTaskSlot('${user}', ${i})" class="btn-clear" title="清除无积分任务">🗑️ 清除</button>`
                                    }
                                </div>
                                ${multiplierBadge}
                            </div>
                        </div>
                    `;
                } else {
                    // 空槽
                    slotsHtml += `
                        <div class="task-slot empty" onclick="selectDailyTask('${user}', ${i})">
                            <div class="slot-content">点击选择任务</div>
                        </div>
                    `;
                }
            }
            
            return slotsHtml;
        }

        // 更新进度显示
        function updateProgressDisplay(user) {
            const progress = dailyTasks.progress[user] || 0;
            const target = dailyTasks.settings.dailyTaskCount;
            
            // 更新进度文字
            const progressSpan = document.getElementById(`${user}-progress`);
            if (progressSpan) {
                progressSpan.textContent = `${progress}/${target}`;
            }
            
            // 更新进度条
            const progressFill = document.getElementById(`${user}-progress-fill`);
            if (progressFill) {
                const percentage = target > 0 ? Math.min(100, (progress / target) * 100) : 0;
                progressFill.style.width = percentage + '%';
            }
        }

        function refreshWeeklyGoals() {
            try {
                console.log('🔄 更新周目标显示');
                
                // 检查周目标数据完整性
                if (!weeklyGoals) {
                    console.error('❌ 周目标数据不存在');
                    return;
                }
                
                // 更新周目标显示
                ['qiqi', 'yiyi'].forEach(user => {
                    const progress = weeklyGoals[user]?.progress || 0;
                    const target = weeklyGoals.target || 25;
                    const remaining = Math.max(0, target - progress);
                    const projectedPenalty = remaining > 0 ? remaining * 2 : 0;
                    
                    console.log(`✅ ${user}: 周进度=${progress}/${target}, 还差=${remaining}分, 预计扣分=${projectedPenalty}`);
                    
                    // 更新周目标部分的显示
                    const goalStatusEl = document.querySelector(`#${user}-weekly-goal .weekly-goal-status`);
                    const goalProgressEl = document.querySelector(`#${user}-weekly-goal .weekly-goal-progress`);
                    
                    if (goalStatusEl) {
                        let statusMsg = '';
                        let statusColor = '';
                        
                        if (progress >= target) {
                            statusMsg = '✅ 已达成目标！';
                            statusColor = '#4caf50';
                        } else {
                            statusMsg = `⚠️ 还差 ${remaining}分，预计扣${projectedPenalty}分`;
                            statusColor = '#d32f2f';
                        }
                        
                        goalStatusEl.innerHTML = `
                            <div style="color: #1976d2;">📊 本周进度: <strong>${progress}/${target}分</strong></div>
                            <div style="color: ${statusColor}; font-weight: bold; margin-top: 5px;">${statusMsg}</div>
                        `;
                    }
                    
                    if (goalProgressEl) {
                        const percentage = Math.min(100, (progress / target) * 100);
                        goalProgressEl.style.width = percentage + '%';
                    }
                });
                
                console.log('✅ 周目标显示更新完成');
            } catch (error) {
                console.error('❌ 周目标显示更新失败:', error);
            }
        }

        function updateTaskRewardDisplay() {
            ['qiqi', 'yiyi'].forEach(user => {
                const level = taskRewardSystem[user].level;
                const tasksCompleted = taskRewardSystem[user].tasksCompleted;
                const pendingReward = taskRewardSystem[user].pendingReward;
                const currentReward = getTaskCompletionReward(level);
                const nextUpgradeCost = getUpgradeCost(level);
                const userTotal = bankData[user].reward + bankData[user].penalty + bankData[user].publish + bankData[user].obtain + bankData[user].trade + bankData[user].dailyIncome + bankData[user].dailyPenalty;
                const canUpgrade = canUpgradeRewardLevel(user);
                
                // 更新每日任务区域的奖励显示
                const rewardClaimEl = document.getElementById(`${user}-reward-claim`);
                if (rewardClaimEl) {
                    if (pendingReward > 0) {
                        rewardClaimEl.innerHTML = `
                            <button class="reward-claim-btn" onclick="claimTaskReward('${user}')" 
                                    style="font-size: 0.9em; padding: 10px 15px; width: 100%; border-radius: 20px; cursor: pointer;">
                                🎉 领取 ${pendingReward} 分奖励! 🎁
                            </button>`;
                    } else {
                        // 显示进度信息
                        const progressText = tasksCompleted > 0 ? 
                            `进度: ${tasksCompleted}/3 (还需${3 - tasksCompleted}个进度)` : 
                            '完成任务获得进度，每3个进度获得奖励';
                        rewardClaimEl.innerHTML = `
                            <div style="text-align: center; color: #6c757d; font-size: 0.8em; padding: 8px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6;">
                                📊 ${progressText}
                            </div>`;
                    }
                }
                
                // 更新详细信息区域
                const rewardInfoEl = document.getElementById(`${user}-reward-info`);
                if (rewardInfoEl) {
                    const today = new Date().toDateString();
                    const lastClaimDate = taskRewardSystem[user].lastClaimDate;
                    const hasClaimedToday = lastClaimDate === today;
                    
                    let claimButton = '';
                    if (pendingReward > 0 && !hasClaimedToday) {
                        claimButton = `<button class="reward-claim-btn" onclick="claimTaskReward('${user}')" style="margin-top: 10px; font-size: 0.9em; padding: 8px 15px; border-radius: 15px; cursor: pointer;">🎉 领取 ${pendingReward} 分奖励! 🎁</button>`;
                    } else if (hasClaimedToday) {
                        claimButton = `<div style="margin-top: 10px; text-align: center; color: #6c757d; font-size: 0.85em; padding: 8px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6;">✅ 今日已领取奖励 🌅</div>`;
                    }
                    
                    rewardInfoEl.innerHTML = `
                        <div>当前等级: ${level}级 | 完成3个任务奖励: ${currentReward}分</div>
                        <div>已完成任务: ${tasksCompleted}/3 ${pendingReward > 0 ? '| 🎁 有奖励可领取!' : ''}</div>
                        <div>升级费用: ${nextUpgradeCost}积分 | 当前积分: ${userTotal}分</div>
                        ${claimButton}
                    `;
                }
                
                // 更新升级按钮状态
                const upgradeBtn = document.getElementById(`${user}-upgrade-btn`);
                if (upgradeBtn) {
                    upgradeBtn.disabled = !canUpgrade;
                    upgradeBtn.textContent = canUpgrade ? '🚀 升级' : `需要${nextUpgradeCost}积分`;
                    upgradeBtn.style.opacity = canUpgrade ? '1' : '0.5';
                }
            });
        }

        function updateStarBonusDisplay() {
            const qiqiTotal = bankData.qiqi.reward + bankData.qiqi.penalty + bankData.qiqi.publish + bankData.qiqi.obtain + bankData.qiqi.trade + bankData.qiqi.dailyIncome + bankData.qiqi.dailyPenalty;
            const yiyiTotal = bankData.yiyi.reward + bankData.yiyi.penalty + bankData.yiyi.publish + bankData.yiyi.obtain + bankData.yiyi.trade + bankData.yiyi.dailyIncome + bankData.yiyi.dailyPenalty;
            
            const qiqiStars = calculateStarCounts(qiqiTotal);
            const yiyiStars = calculateStarCounts(yiyiTotal);
            
            const qiqiBonus = calculateMonthlyBonus(qiqiTotal);
            const yiyiBonus = calculateMonthlyBonus(yiyiTotal);
            
            // 更新七七的星星统计 - 检查元素是否存在
            const qiqiStarCountEl = document.getElementById('qiqi-star-count');
            if (qiqiStarCountEl) {
                qiqiStarCountEl.textContent = 
                    `彩色星星: ${qiqiStars.rainbow} | 大星星: ${qiqiStars.big} | 小星星: ${qiqiStars.small}`;
            }
            const qiqiMonthlyBonusEl = document.getElementById('qiqi-monthly-bonus');
            if (qiqiMonthlyBonusEl) {
                qiqiMonthlyBonusEl.textContent = `下次奖励: ${qiqiBonus}分`;
            }
                
            // 更新一一的星星统计 - 检查元素是否存在
            const yiyiStarCountEl = document.getElementById('yiyi-star-count');
            if (yiyiStarCountEl) {
                yiyiStarCountEl.textContent = 
                    `彩色星星: ${yiyiStars.rainbow} | 大星星: ${yiyiStars.big} | 小星星: ${yiyiStars.small}`;
            }
            const yiyiMonthlyBonusEl = document.getElementById('yiyi-monthly-bonus');
            if (yiyiMonthlyBonusEl) {
                yiyiMonthlyBonusEl.textContent = `下次奖励: ${yiyiBonus}分`;
            }
            
            // 更新下次发放时间 - 检查元素是否存在
            const nextBonusInfoEl = document.getElementById('next-bonus-info');
            if (nextBonusInfoEl) {
                const now = new Date();
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                nextBonusInfoEl.textContent = 
                    `下次发放时间: ${nextMonth.toLocaleDateString('zh-CN', options)}`;
            }
        }

        // 小银行页面
        function refreshBankPage() {
            checkWeeklyReset(); // 检查是否需要周度重置
            checkMonthlyBonus();
            
            // 更新周度统计数据
            updateWeeklyStats();
            
            // 更新周度积分统计表
            const tbody = document.getElementById('bank-table-body');
            const rows = [
                {
                    name: '七七',
                    data: bankData.qiqi,
                    user: 'qiqi'
                },
                {
                    name: '一一',
                    data: bankData.yiyi,
                    user: 'yiyi'
                }
            ];

            tbody.innerHTML = rows.map(row => {
                const weeklyData = weeklyStats[row.user];
                const total = (row.data.reward || 0) + (row.data.penalty || 0) + (row.data.publish || 0) + (row.data.obtain || 0) + (row.data.trade || 0) + (row.data.dailyIncome || 0) + (row.data.dailyPenalty || 0);
                const safeTotal = isNaN(total) ? 0 : total;
                const starEarnings = calculateStarEarnings(safeTotal) || '0分';
                
                return `
                    <tr>
                        <td style="font-weight: bold; text-align: center;">${weeklyStats.currentWeek}</td>
                        <td style="font-weight: bold;">${row.name}</td>
                        <td style="color: ${(weeklyData.reward || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.reward || 0}</td>
                        <td style="color: ${(weeklyData.penalty || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.penalty || 0}</td>
                        <td style="color: ${(weeklyData.publish || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.publish || 0}</td>
                        <td style="color: ${(weeklyData.obtain || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.obtain || 0}</td>
                        <td style="color: ${(weeklyData.trade || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.trade || 0}</td>
                        <td style="color: ${(weeklyData.dailyIncome || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.dailyIncome || 0}</td>
                        <td style="color: ${(weeklyData.dailyPenalty || 0) >= 0 ? '#28a745' : '#dc3545'};">${weeklyData.dailyPenalty || 0}</td>
                        <td style="text-align: center; color: #ffc107; font-weight: bold;">${starEarnings}</td>
                        <td style="color: ${safeTotal >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">${safeTotal}</td>
                    </tr>
                `;
            }).join('');

            // 更新积分展示卡片和星星积分池
            updateScoreCards();
            updateStarBonusDisplay();
            updateTaskRewardDisplay();
        }

        function updateScoreCards() {
            if (!weeklyData) {
                weeklyData = { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
            }

            // 更新总积分显示卡片
            const qiqiTotal = (bankData.qiqi.reward || 0) + (bankData.qiqi.penalty || 0) + (bankData.qiqi.publish || 0) + (bankData.qiqi.obtain || 0) + (bankData.qiqi.trade || 0) + (bankData.qiqi.dailyIncome || 0) + (bankData.qiqi.dailyPenalty || 0);
            const yiyiTotal = (bankData.yiyi.reward || 0) + (bankData.yiyi.penalty || 0) + (bankData.yiyi.publish || 0) + (bankData.yiyi.obtain || 0) + (bankData.yiyi.trade || 0) + (bankData.yiyi.dailyIncome || 0) + (bankData.yiyi.dailyPenalty || 0);
            
            const safeTotalQiqi = isNaN(qiqiTotal) ? 0 : qiqiTotal;
            const safeTotalYiyi = isNaN(yiyiTotal) ? 0 : yiyiTotal;
            
            document.getElementById('qiqi-total-score').textContent = safeTotalQiqi;
            document.getElementById('yiyi-total-score').textContent = safeTotalYiyi;
            document.getElementById('qiqi-total-stars').innerHTML = generateStars(safeTotalQiqi);
            document.getElementById('yiyi-total-stars').innerHTML = generateStars(safeTotalYiyi);
            
            // 调试信息：显示快照状态和历史记录检查
            const snapshotDates = Object.keys(dailyTaskSnapshots);
            const pendingSnapshots = snapshotDates.filter(date => !dailyTaskSnapshots[date].penaltyProcessed);
            const processedSnapshots = snapshotDates.filter(date => dailyTaskSnapshots[date].penaltyProcessed);
            
            console.log(`任务快照状态: ${pendingSnapshots.length}个待处理, ${processedSnapshots.length}个已处理`);
            if (pendingSnapshots.length > 0) {
                console.log('待处理快照:', pendingSnapshots);
            }
            
        }

        // 添加历史记录
        function addHistory(message, type = 'system', details = null) {
            const historyEntry = {
                id: Date.now(),
                type: type === 'system' ? '系统记录' : type === 'bounty' ? '悬赏记录' : '操作记录',
                message: message,
                timestamp: new Date().toISOString(),
                displayTime: new Date().toLocaleString(),
                time: new Date().toLocaleString() // 兼容连胜检查中使用的time字段
            };
            
            // 如果有详细信息，添加到记录中
            if (details) {
                historyEntry.details = details;
            }
            
            historyData.unshift(historyEntry);
            
            // 只保留最近2000条记录
            if (historyData.length > 5000) {
                historyData = historyData.slice(0, 5000);
            }
        }

        // 历史记录页面
        function refreshHistoryPage() {
            const listElement = document.getElementById('history-list');
            
            if (historyData.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无历史记录</p>';
                return;
            }

            listElement.innerHTML = historyData.map(entry => `
                <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong style="color: #2c3e50;">${entry.type}</strong>
                        <span style="color: #666; font-size: 0.9em;">${entry.displayTime || entry.time}</span>
                    </div>
                    <div style="color: #555; margin-bottom: 8px;">${entry.message || entry.description}</div>
                    ${entry.details && entry.details.changes ? `
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; font-size: 0.9em;">
                            ${entry.details.changes.map(change => `<div>• ${change}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function clearHistory() {
            requireAuth(() => {
                if (confirm('确定要清空所有历史记录吗？此操作无法撤销！')) {
                    historyData = [];
                    saveData();
                    refreshHistoryPage();
                    alert('历史记录已清空');
                }
            });
        }

        // 个人清空按钮函数
        function clearBountyHistory() {
            requireAuth(() => {
                if (confirm('确定要清空所有悬赏记录吗？此操作无法撤销！')) {
                    bountyTasks = [];
                    saveData();
                    displayBountyTasks();
                    alert('悬赏记录已清空');
                }
            });
        }

        function clearPenaltyHistory() {
            requireAuth(() => {
                if (confirm('确定要清空所有扣分记录吗？此操作无法撤销！')) {
                    historyData = historyData.filter(item => item.type !== 'penalty');
                    saveData();
                    refreshHistoryPage();
                    alert('扣分记录已清空');
                }
            });
        }

        function clearRewardHistory() {
            requireAuth(() => {
                if (confirm('确定要清空所有奖励记录吗？此操作无法撤销！')) {
                    historyData = historyData.filter(item => item.type !== 'reward');
                    saveData();
                    refreshHistoryPage();
                    alert('奖励记录已清空');
                }
            });
        }

        function clearHistoryData() {
            requireAuth(() => {
                if (confirm('确定要清空所有历史记录吗？此操作无法撤销！')) {
                    historyData = [];
                    saveData();
                    refreshHistoryPage();
                    alert('历史记录已清空');
                }
            });
        }

        function clearQiqiDailyTasks() {
            requireAuth(() => {
                if (confirm('确定要清空七七的每日任务吗？此操作无法撤销！')) {
                    dailyTasks.qiqi = [null, null, null];
                    dailyTasks.progress.qiqi = 0;
                    dailyTasks.extraTasks.qiqi = [];
                    saveData();
                    refreshDailyTasks();
                    alert('七七的每日任务已清空');
                }
            });
        }

        function clearYiyiDailyTasks() {
            requireAuth(() => {
                if (confirm('确定要清空一一的每日任务吗？此操作无法撤销！')) {
                    dailyTasks.yiyi = [null, null, null];
                    dailyTasks.progress.yiyi = 0;
                    dailyTasks.extraTasks.yiyi = [];
                    saveData();
                    refreshDailyTasks();
                    alert('一一的每日任务已清空');
                }
            });
        }

        function clearCustomStreakData() {
            requireAuth(() => {
                if (confirm('确定要清空所有自定义连胜数据吗？此操作无法撤销！\n\n将清空：\n• 所有任务的连胜记录\n• 连胜设置保持不变')) {
                    // 清空所有任务的连胜记录
                    taskPool.forEach(task => {
                        if (task.streakData) {
                            task.streakData = { qiqi: 0, yiyi: 0 };
                        }
                    });
                    
                    // 清空悬赏任务的连胜记录
                    bountyTasks.forEach(bounty => {
                        if (bounty.streakData) {
                            bounty.streakData = { qiqi: 0, yiyi: 0 };
                        }
                    });
                    
                    saveData();
                    refreshTaskPoolDisplay();
                    displayBountyTasks();
                    
                    alert('自定义连胜数据已清空');
                }
            });
        }

        // 清零所有积分功能
        function clearAllPoints() {
            requireAuth(() => {
                // 获取当前积分状态用于确认和记录
                const qiqiTotal = (bankData.qiqi.reward || 0) + (bankData.qiqi.penalty || 0) + (bankData.qiqi.publish || 0) + (bankData.qiqi.obtain || 0) + (bankData.qiqi.trade || 0) + (bankData.qiqi.dailyIncome || 0) + (bankData.qiqi.dailyPenalty || 0) + (bankData.qiqi.starIncome || 0);
                const yiyiTotal = (bankData.yiyi.reward || 0) + (bankData.yiyi.penalty || 0) + (bankData.yiyi.publish || 0) + (bankData.yiyi.obtain || 0) + (bankData.yiyi.trade || 0) + (bankData.yiyi.dailyIncome || 0) + (bankData.yiyi.dailyPenalty || 0) + (bankData.yiyi.starIncome || 0);
                const safeTotalQiqi = isNaN(qiqiTotal) ? 0 : qiqiTotal;
                const safeTotalYiyi = isNaN(yiyiTotal) ? 0 : yiyiTotal;
                
                const confirmMessage = `⚠️ 危险操作确认 ⚠️\n\n` +
                    `即将清零所有用户的积分数据：\n\n` +
                    `七七当前总积分：${safeTotalQiqi}\n` +
                    `• 奖励：${bankData.qiqi.reward || 0}\n` +
                    `• 罚分：${bankData.qiqi.penalty || 0}\n` +
                    `• 发布：${bankData.qiqi.publish || 0}\n` +
                    `• 获取：${bankData.qiqi.obtain || 0}\n` +
                    `• 交易：${bankData.qiqi.trade || 0}\n` +
                    `• 日收入：${bankData.qiqi.dailyIncome || 0}\n` +
                    `• 日惩罚：${bankData.qiqi.dailyPenalty || 0}\n\n` +
                    `一一当前总积分：${safeTotalYiyi}\n` +
                    `• 奖励：${bankData.yiyi.reward || 0}\n` +
                    `• 罚分：${bankData.yiyi.penalty || 0}\n` +
                    `• 发布：${bankData.yiyi.publish || 0}\n` +
                    `• 获取：${bankData.yiyi.obtain || 0}\n` +
                    `• 交易：${bankData.yiyi.trade || 0}\n` +
                    `• 日收入：${bankData.yiyi.dailyIncome || 0}\n` +
                    `• 日惩罚：${bankData.yiyi.dailyPenalty || 0}\n\n` +
                    `此操作将清零所有积分数据，无法撤销！\n` +
                    `确定要继续吗？`;

                if (confirm(confirmMessage)) {
                    // 保存清零前的数据用于历史记录
                    const beforeClearData = {
                        qiqi: { ...bankData.qiqi },
                        yiyi: { ...bankData.yiyi }
                    };

                    // 清零所有积分
                    bankData.qiqi = { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 };
                    bankData.yiyi = { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 };

                    // 添加历史记录
                    const historyEntry = {
                        id: `history_${Date.now()}`,
                        type: '积分清零',
                        time: new Date().toLocaleString(),
                        description: '管理员执行了积分清零操作，所有用户积分已重置为0',
                        details: {
                            beforeClear: beforeClearData,
                            changes: [
                                `七七：总分 ${safeTotalQiqi} → 0（奖:${beforeClearData.qiqi.reward || 0}→0, 罚:${beforeClearData.qiqi.penalty || 0}→0, 发布:${beforeClearData.qiqi.publish || 0}→0, 获取:${beforeClearData.qiqi.obtain || 0}→0, 交易:${beforeClearData.qiqi.trade || 0}→0, 日收入:${beforeClearData.qiqi.dailyIncome || 0}→0, 日惩罚:${beforeClearData.qiqi.dailyPenalty || 0}→0）`,
                                `一一：总分 ${safeTotalYiyi} → 0（奖:${beforeClearData.yiyi.reward || 0}→0, 罚:${beforeClearData.yiyi.penalty || 0}→0, 发布:${beforeClearData.yiyi.publish || 0}→0, 获取:${beforeClearData.yiyi.obtain || 0}→0, 交易:${beforeClearData.yiyi.trade || 0}→0, 日收入:${beforeClearData.yiyi.dailyIncome || 0}→0, 日惩罚:${beforeClearData.yiyi.dailyPenalty || 0}→0）`
                            ]
                        }
                    };
                    historyData.unshift(historyEntry);

                    // 保存数据并刷新界面
                    saveData();
                    refreshBankPage();
                    
                    alert('✅ 积分清零操作完成！\n\n所有用户的积分已重置为0，操作已记录到历史中。');
                }
            });
        }

        // 新的每日任务系统功能
        
        // 任务池管理
        function openTaskPoolModal() {
            requireAuth(() => {
                document.getElementById('task-pool-modal').style.display = 'flex';
                refreshTaskPoolDisplay();
            });
        }

        function closeTaskPoolModal() {
            document.getElementById('task-pool-modal').style.display = 'none';
            cancelEditPoolTask(); // 关闭时取消编辑状态
        }

        function closeTaskPoolModalIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                closeTaskPoolModal();
            }
        }

        // 添加ESC键关闭模态框功能
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const taskPoolModal = document.getElementById('task-pool-modal');
                const taskSelectModal = document.getElementById('daily-task-select-modal');
                
                if (taskPoolModal && taskPoolModal.style.display === 'flex') {
                    closeTaskPoolModal();
                } else if (taskSelectModal && taskSelectModal.style.display === 'flex') {
                    closeDailyTaskSelectModal();
                }
            }
        });


        function addPoolTask() {
            const taskName = document.getElementById('pool-task-name').value.trim();
            const taskDescription = document.getElementById('pool-task-description').value.trim();
            const basePoints = parseInt(document.getElementById('pool-task-base-points').value) || 1;
            const exclusive = document.getElementById('pool-task-exclusive').value;
            const weeklyLimit = parseInt(document.getElementById('pool-task-weekly-limit').value) || null;
            const doubleValue = document.getElementById('pool-task-double-value').checked;
            const streakBonus = document.getElementById('pool-task-streak-bonus').checked;
            
            // 获取自定义连胜设置
            let streakConfig = null;
            if (streakBonus) {
                const streakDays = parseInt(document.getElementById('streak-days').value) || 7;
                const streakPoints = parseInt(document.getElementById('streak-points').value) || 3;
                streakConfig = {
                    days: streakDays,
                    points: streakPoints
                };
            }
            
            if (!taskName) {
                alert('请输入任务标题');
                return;
            }

            if (taskPool.some(task => task.name === taskName)) {
                alert('任务标题已存在');
                return;
            }

            const newTask = {
                id: `pool_${Date.now()}`,
                name: taskName,
                description: taskDescription,
                basePoints: basePoints,                // 基础积分
                createdAt: new Date().toISOString(),
                // 特殊属性
                exclusive: exclusive || null,          // 专属：'qiqi', 'yiyi', 或 null
                weeklyLimit: weeklyLimit,              // 每周次数限制
                doubleValue: doubleValue,              // 以一抵二
                streakBonus: streakBonus,              // 连胜奖励开关
                streakConfig: streakConfig             // 连胜奖励配置 {days: number, points: number}
            };

            taskPool.push(newTask);
            saveData();
            refreshTaskPoolDisplay();
            refreshDailyTasks();
            
            // 清空表单
            document.getElementById('pool-task-name').value = '';
            document.getElementById('pool-task-description').value = '';
            document.getElementById('pool-task-base-points').value = '1';
            document.getElementById('pool-task-exclusive').value = '';
            document.getElementById('pool-task-weekly-limit').value = '';
            document.getElementById('pool-task-double-value').checked = false;
            document.getElementById('pool-task-streak-bonus').checked = false;
            document.getElementById('streak-days').value = '7';
            document.getElementById('streak-points').value = '3';
            document.getElementById('streak-custom-settings').style.display = 'none';
            
            alert('任务添加成功！');
        }

        function removePoolTask(taskId) {
            if (!confirm('确定要删除这个任务吗？删除后已选择该任务的用户需要重新选择。')) return;

            taskPool = taskPool.filter(task => task.id !== taskId);
            
            // 清除已选择此任务的用户
            ['qiqi', 'yiyi'].forEach(user => {
                for (let i = 0; i < 3; i++) {
                    if (dailyTasks[user][i] && dailyTasks[user][i].poolTaskId === taskId) {
                        dailyTasks[user][i] = null;
                    }
                }
            });

            saveData();
            refreshTaskPoolDisplay();
            refreshDailyTasks();
        }

        function editPoolTask(taskId) {
            requireAuth(() => {
                const task = taskPool.find(t => t.id === taskId);
                if (!task) return;

                // 填入当前任务的信息到表单中
                document.getElementById('pool-task-name').value = task.name;
                document.getElementById('pool-task-description').value = task.description || '';
                document.getElementById('pool-task-base-points').value = task.basePoints || 1;
                document.getElementById('pool-task-exclusive').value = task.exclusive || '';
                document.getElementById('pool-task-weekly-limit').value = task.weeklyLimit || '';
                document.getElementById('pool-task-double-value').checked = task.doubleValue || false;
                document.getElementById('pool-task-streak-bonus').checked = task.streakBonus || false;
                
                // 设置连胜自定义配置
                if (task.streakBonus && task.streakConfig) {
                    document.getElementById('streak-days').value = task.streakConfig.days || 7;
                    document.getElementById('streak-points').value = task.streakConfig.points || 3;
                    document.getElementById('streak-custom-settings').style.display = 'block';
                } else {
                    document.getElementById('streak-days').value = '7';
                    document.getElementById('streak-points').value = '3';
                    document.getElementById('streak-custom-settings').style.display = 'none';
                }
                
                // 修改按钮文字和事件
                const addButton = document.querySelector('.task-pool-modal-box .btn-primary');
                addButton.textContent = '更新任务';
                addButton.onclick = () => updatePoolTask(taskId);
                
                // 添加取消编辑按钮
                if (!document.getElementById('cancel-edit-btn')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.className = 'modal-btn btn-secondary';
                    cancelBtn.textContent = '取消编辑';
                    cancelBtn.style.width = '100%';
                    cancelBtn.style.marginTop = '10px';
                    cancelBtn.onclick = cancelEditPoolTask;
                    addButton.parentNode.appendChild(cancelBtn);
                }
            });
        }

        function updatePoolTask(taskId) {
            const name = document.getElementById('pool-task-name').value.trim();
            const description = document.getElementById('pool-task-description').value.trim();
            const basePoints = parseInt(document.getElementById('pool-task-base-points').value) || 1;
            const exclusive = document.getElementById('pool-task-exclusive').value;
            const weeklyLimit = parseInt(document.getElementById('pool-task-weekly-limit').value) || null;
            const doubleValue = document.getElementById('pool-task-double-value').checked;
            const streakBonus = document.getElementById('pool-task-streak-bonus').checked;
            
            // 获取自定义连胜设置
            let streakConfig = null;
            if (streakBonus) {
                const streakDays = parseInt(document.getElementById('streak-days').value) || 7;
                const streakPoints = parseInt(document.getElementById('streak-points').value) || 3;
                streakConfig = {
                    days: streakDays,
                    points: streakPoints
                };
            }

            if (!name) {
                alert('请输入任务名称');
                return;
            }

            // 查找并更新任务
            const taskIndex = taskPool.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            taskPool[taskIndex] = {
                ...taskPool[taskIndex],
                name: name,
                description: description,
                basePoints: basePoints,
                exclusive: exclusive || null,
                weeklyLimit: weeklyLimit,
                doubleValue: doubleValue,
                streakBonus: streakBonus,
                streakConfig: streakConfig,
                updatedAt: new Date().toISOString()
            };

            // 更新已选择此任务的用户的任务信息
            ['qiqi', 'yiyi'].forEach(user => {
                for (let i = 0; i < 3; i++) {
                    if (dailyTasks[user][i] && dailyTasks[user][i].poolTaskId === taskId) {
                        dailyTasks[user][i].name = name;
                        dailyTasks[user][i].description = description;
                    }
                }
            });

            saveData();
            refreshTaskPoolDisplay();
            refreshDailyTasks();
            cancelEditPoolTask();
            
            alert('任务更新成功！');
        }

        function cancelEditPoolTask() {
            // 清空表单
            document.getElementById('pool-task-name').value = '';
            document.getElementById('pool-task-description').value = '';
            document.getElementById('pool-task-base-points').value = '1';
            document.getElementById('pool-task-exclusive').value = '';
            document.getElementById('pool-task-weekly-limit').value = '';
            document.getElementById('pool-task-double-value').checked = false;
            document.getElementById('pool-task-streak-bonus').checked = false;
            
            // 恢复按钮状态
            const addButton = document.querySelector('.task-pool-modal-box .btn-primary');
            addButton.textContent = '添加到任务池';
            addButton.onclick = addPoolTask;
            
            // 移除取消按钮
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        // 调试任务池同步功能
        async function debugTaskPoolSync() {
            let debugInfo = '🔍 任务池同步调试信息\n\n';
            let parsed = null; // 在函数开始时定义
            
            // 本地任务池状态
            debugInfo += `📱 本地任务池: ${taskPool.length} 个任务\n`;
            taskPool.forEach((task, index) => {
                debugInfo += `  ${index + 1}. ${task.name}\n`;
            });
            
            // 检查本地存储
            const localData = localStorage.getItem('pointSystemV2');
            if (localData) {
                try {
                    parsed = JSON.parse(localData);
                    const localTaskPool = parsed.taskPool || [];
                    debugInfo += `\n💾 本地存储任务池: ${localTaskPool.length} 个任务\n`;
                    localTaskPool.forEach((task, index) => {
                        debugInfo += `  ${index + 1}. ${task.name}\n`;
                    });
                } catch (e) {
                    debugInfo += `\n❌ 本地存储解析失败: ${e.message}\n`;
                }
            }
            
            // 检查云端数据
            if (isFirebaseReady && isOnline) {
                debugInfo += `\n☁️ 正在检查云端数据...\n`;
                try {
                    const snapshot = await window.firebaseDb.get(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'));
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        const cloudTaskPool = cloudData.taskPool || [];
                        debugInfo += `☁️ 云端任务池: ${cloudTaskPool.length} 个任务\n`;
                        cloudTaskPool.forEach((task, index) => {
                            debugInfo += `  ${index + 1}. ${task.name}\n`;
                        });
                        
                        const localTime = new Date(parsed ? parsed.lastUpdated || 0 : 0);
                        const cloudTime = new Date(cloudData.lastUpdated || 0);
                        debugInfo += `\n🕰️ 时间戳对比:\n`;
                        debugInfo += `  本地: ${localTime.toLocaleString()}\n`;
                        debugInfo += `  云端: ${cloudTime.toLocaleString()}\n`;
                        debugInfo += `  云端较新: ${cloudTime > localTime ? '是' : '否'}\n`;
                    } else {
                        debugInfo += `❌ 云端没有数据\n`;
                    }
                } catch (e) {
                    debugInfo += `❌ 云端数据获取失败: ${e.message}\n`;
                }
            } else {
                debugInfo += `\n❌ Firebase状态: 不可用 (Ready: ${isFirebaseReady}, Online: ${isOnline})\n`;
            }
            
            // 强制下载云端数据
            debugInfo += `\n🔄 正在强制下载云端数据...\n`;
            try {
                await forceDownloadFromFirebase();
                debugInfo += `✅ 强制下载完成\n`;
                
                // 更新后的状态
                debugInfo += `\n🔄 下载后的任务池: ${taskPool.length} 个任务\n`;
                taskPool.forEach((task, index) => {
                    debugInfo += `  ${index + 1}. ${task.name}\n`;
                });
            } catch (e) {
                debugInfo += `❌ 强制下载失败: ${e.message}\n`;
            }
            
            alert(debugInfo);
        }

        // 强制下载云端数据（忽略时间戳检查）
        async function forceDownloadFromFirebase() {
            if (!isFirebaseReady || !isOnline) {
                throw new Error('网络或Firebase不可用');
            }

            try {
                const snapshot = await window.firebaseDb.get(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'));
                
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    
                    // 直接使用云端数据，不检查时间戳
                    bountyData = cloudData.bountyData || [];
                    bankData = cloudData.bankData || { qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 }, yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 } };
                    
                    // 兼容性处理
                    if (bankData.qiqi.daily !== undefined && bankData.qiqi.dailyIncome === undefined) {
                        bankData.qiqi.dailyIncome = Math.max(0, bankData.qiqi.daily);
                        bankData.qiqi.dailyPenalty = Math.min(0, bankData.qiqi.daily);
                        delete bankData.qiqi.daily;
                    }
                    if (bankData.yiyi.daily !== undefined && bankData.yiyi.dailyIncome === undefined) {
                        bankData.yiyi.dailyIncome = Math.max(0, bankData.yiyi.daily);
                        bankData.yiyi.dailyPenalty = Math.min(0, bankData.yiyi.daily);
                        delete bankData.yiyi.daily;
                    }
                    if (bankData.qiqi.bounty !== undefined && bankData.qiqi.publish === undefined) {
                        bankData.qiqi.publish = Math.min(0, bankData.qiqi.bounty);
                        bankData.qiqi.obtain = Math.max(0, bankData.qiqi.bounty);
                        delete bankData.qiqi.bounty;
                    }
                    if (bankData.yiyi.bounty !== undefined && bankData.yiyi.publish === undefined) {
                        bankData.yiyi.publish = Math.min(0, bankData.yiyi.bounty);
                        bankData.yiyi.obtain = Math.max(0, bankData.yiyi.bounty);
                        delete bankData.yiyi.bounty;
                    }
                    
                    // 确保字段存在
                    if (!bankData.qiqi.publish) bankData.qiqi.publish = 0;
                    if (!bankData.qiqi.obtain) bankData.qiqi.obtain = 0;
                    if (!bankData.yiyi.publish) bankData.yiyi.publish = 0;
                    if (!bankData.yiyi.obtain) bankData.yiyi.obtain = 0;
                    if (!bankData.qiqi.dailyIncome) bankData.qiqi.dailyIncome = 0;
                    if (!bankData.qiqi.dailyPenalty) bankData.qiqi.dailyPenalty = 0;
                    if (!bankData.yiyi.dailyIncome) bankData.yiyi.dailyIncome = 0;
                    if (!bankData.yiyi.dailyPenalty) bankData.yiyi.dailyPenalty = 0;
                    
                    historyData = cloudData.historyData || [];
                    bountyCounter = cloudData.bountyCounter || 1;
                    dailyTasksContent = cloudData.dailyTasksContent || '';
                    
                    // 重点：恢复任务池数据
                    taskPool = cloudData.taskPool || [];
                    taskCounter = cloudData.taskCounter || 1;
                    
                    // 恢复任务奖励系统数据
                    taskRewardSystem = cloudData.taskRewardSystem || {
                        qiqi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null },
                        yiyi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null }
                    };
                    
                    // 恢复周目标数据 - 永远取最高进度
                    if (cloudData.weeklyGoals) {
                        const cloudGoals = cloudData.weeklyGoals;
                        const localGoals = weeklyGoals;
                        
                        // 智能合并 - 按周进度取最优状态
                        const localTotal = {
                            qiqi: localGoals.qiqi?.progress || 0,
                            yiyi: localGoals.yiyi?.progress || 0
                        };
                        const cloudTotal = {
                            qiqi: cloudGoals.qiqi?.progress || 0,
                            yiyi: cloudGoals.yiyi?.progress || 0
                        };
                        
                        weeklyGoals = {
                            qiqi: {
                                progress: Math.max(localTotal.qiqi, cloudTotal.qiqi),
                                weekStart: localGoals.qiqi?.weekStart || cloudGoals.qiqi?.weekStart
                            },
                            yiyi: {
                                progress: Math.max(localTotal.yiyi, cloudTotal.yiyi),
                                weekStart: localGoals.yiyi?.weekStart || cloudGoals.yiyi?.weekStart
                            },
                            target: cloudGoals.target || localGoals.target || 25,
                            lastPenaltyCheck: cloudGoals.lastPenaltyCheck || localGoals.lastPenaltyCheck
                        };
                        console.log('🔄 自动智能合并完成：永远取最高分');
                    }
                    
                    // 恢复每日任务数据
                    if (cloudData.dailyTasks && Array.isArray(cloudData.dailyTasks.qiqi) && Array.isArray(cloudData.dailyTasks.yiyi)) {
                        dailyTasks = {
                            qiqi: cloudData.dailyTasks.qiqi || [null, null, null],
                            yiyi: cloudData.dailyTasks.yiyi || [null, null, null],
                            progress: cloudData.dailyTasks.progress || { qiqi: 0, yiyi: 0 }
                        };
                    } else {
                        dailyTasks = {
                            qiqi: [null, null, null],
                            yiyi: [null, null, null],
                            progress: { qiqi: 0, yiyi: 0 },
                            extraTasks: { qiqi: [], yiyi: [] },
                            clearedCompleted: { qiqi: [], yiyi: [] }
                        };
                    }
                    
                    lastResetDate = cloudData.lastResetDate || null;
                    weeklyData = cloudData.weeklyData || { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
                    monthlyStarBonus = cloudData.monthlyStarBonus || { qiqi: 0, yiyi: 0, lastBonusDate: new Date().toISOString() };
                    
                    // 加载任务快照数据
                    dailyTaskSnapshots = cloudData.dailyTaskSnapshots || {};
                    penaltySystemStartDate = cloudData.penaltySystemStartDate || null;
                    
                    
                    // 检查是否需要每日重置
                    checkDailyReset();
                    
                    // 保存到本地
                    localStorage.setItem('pointSystemV2', JSON.stringify({
                        bountyData,
                        bankData,
                        historyData,
                        bountyCounter,
                        dailyTasksContent,
                        dailyTasks,
                        taskPool,
                        taskCounter,
                        lastResetDate,
                        weeklyData,
                        monthlyStarBonus,
                        dailyTaskSnapshots,
                        penaltySystemStartDate,
                        taskRewardSystem,
                        weeklyGoals,
                        lastUpdated: cloudData.lastUpdated
                    }));
                    
                    // 刷新所有界面
                    refreshBankPage();
                    refreshHistoryPage();
                    refreshBountyList();
                    refreshDailyTasks();
                    updateTaskPoolPreview();
                    refreshTaskPoolDisplay();
                    
                    console.log('强制下载云端数据成功，任务池:', taskPool.length, '个任务');
                } else {
                    throw new Error('云端没有数据');
                }
            } catch (error) {
                console.error('强制下载失败:', error);
                throw error;
            }
        }

        function refreshTaskPoolDisplay() {
            const poolList = document.getElementById('pool-tasks-list');
            const poolCount = document.getElementById('pool-count');
            const taskPoolCount = document.getElementById('task-pool-count');
            
            poolCount.textContent = taskPool.length;
            taskPoolCount.textContent = taskPool.length;

            // 更新管理模态框中的任务列表
            if (taskPool.length === 0) {
                poolList.innerHTML = '<div class="pool-empty-message">暂无任务，请在上方添加新任务</div>';
            } else {
                poolList.innerHTML = `
                    <div class="task-pool-grid">
                        ${taskPool.map(task => `
                            <div class="pool-task-item">
                                <div class="pool-task-content">
                                    <div class="pool-task-name">${task.name}</div>
                                    ${getTaskSpecialAttributes(task)}
                                    ${task.description ? `<div class="pool-task-description">${task.description}</div>` : ''}
                                </div>
                                <div class="pool-task-actions">
                                    <button class="modal-btn btn-primary" onclick="editPoolTask('${task.id}')" style="font-size: 0.8em; padding: 6px 12px; margin-right: 8px;">编辑</button>
                                    <button class="modal-btn btn-danger" onclick="removePoolTask('${task.id}')" style="font-size: 0.8em; padding: 6px 12px;">删除</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // 更新主页面上的任务池预览
            updateTaskPoolPreview();
        }

        // 生成任务特殊属性的HTML显示
        function getTaskSpecialAttributes(task, user = null) {
            const attributes = [];
            
            // 基础积分
            if (task.basePoints) {
                attributes.push(`<span class="task-attribute base-points">💎 基础${task.basePoints}分</span>`);
            }
            
            // 专属属性
            if (task.exclusive === 'qiqi') {
                attributes.push('<span class="task-attribute exclusive-qiqi">🎯 七七专属</span>');
            } else if (task.exclusive === 'yiyi') {
                attributes.push('<span class="task-attribute exclusive-yiyi">🎯 一一专属</span>');
            }
            
            // 以一抵二
            if (task.doubleValue) {
                attributes.push('<span class="task-attribute double-value">💪 以一抵二</span>');
            }
            
            // 连胜奖励
            if (task.streakBonus) {
                const config = task.streakConfig || { days: 7, points: 3 };
                let streakText = `🔥 连胜奖励(${config.days}天+${config.points}分)`;
                
                // 如果提供了用户信息，显示当前连胜天数
                if (user && task.id) {
                    const streakDays = getTaskStreakDays(user, task.id);
                    if (streakDays > 0) {
                        streakText = `🔥 连胜第${streakDays + 1}天/${config.days}天`;
                        if (streakDays >= config.days - 1) {
                            streakText += ' (奖励就绪!)';
                        }
                    }
                }
                
                attributes.push(`<span class="task-attribute streak-bonus">${streakText}</span>`);
            }
            
            // 每周次数限制
            if (task.weeklyLimit && task.weeklyLimit > 0) {
                attributes.push(`<span class="task-attribute weekly-limit">🏃 限${task.weeklyLimit}次/周</span>`);
            }
            
            if (attributes.length === 0) {
                return '';
            }
            
            return `<div class="task-attributes">${attributes.join(' ')}</div>`;
        }

        function updateTaskPoolPreview() {
            const previewContainer = document.getElementById('pool-tasks-preview');
            
            if (taskPool.length === 0) {
                previewContainer.innerHTML = '<div class="empty-pool">暂无任务，点击上方按钮添加任务</div>';
            } else {
                previewContainer.innerHTML = `
                    <div class="preview-task-list">
                        ${taskPool.map((task, index) => `
                            <div class="preview-task-item" onclick="toggleTaskDetails('preview-${task.id}')">
                                <div class="preview-task-header">
                                    <div class="preview-task-title">${task.name}</div>
                                    <div class="preview-task-count">#${index + 1}</div>
                                    ${task.description ? '<div class="preview-task-expand">▼</div>' : ''}
                                </div>
                                ${getTaskSpecialAttributes(task)}
                                ${task.description ? `
                                    <div class="preview-task-details" id="preview-${task.id}" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.85em; color: #666; line-height: 1.4;">
                                        ${task.description}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // 切换任务详细信息显示
        function toggleTaskDetails(detailsId) {
            const detailsElement = document.getElementById(detailsId);
            if (!detailsElement) return;
            
            const isVisible = detailsElement.style.display !== 'none';
            const parentItem = detailsElement.closest('.preview-task-item, .available-task-item, .task-slot');
            const expandIcon = parentItem.querySelector('.preview-task-expand, .available-task-expand, .daily-task-expand');
            
            if (isVisible) {
                detailsElement.style.display = 'none';
                if (expandIcon) expandIcon.textContent = '▼';
            } else {
                detailsElement.style.display = 'block';
                if (expandIcon) expandIcon.textContent = '▲';
            }
        }

        // 每日任务选择
        let currentEditingSlot = null;
        
        function selectDailyTask(user, slotIndex) {
            requireAuth(() => {
                currentEditingUser = user;
                currentEditingSlot = slotIndex;
                document.getElementById('select-modal-title').textContent = `为${user === 'qiqi' ? '七七' : '一一'}选择任务 (位置${slotIndex + 1})`;
                showAvailableTasks(user, slotIndex);
                document.getElementById('daily-task-select-modal').style.display = 'flex';
            });
        }

        function closeDailyTaskSelectModal() {
            document.getElementById('daily-task-select-modal').style.display = 'none';
        }

        function closeDailyTaskSelectModalIfClickedOutside(event) {
            if (event.target === event.currentTarget) {
                closeDailyTaskSelectModal();
            }
        }

        function showAvailableTasks(user, slotIndex) {
            const availableList = document.getElementById('available-tasks-list');
            
            if (taskPool.length === 0) {
                availableList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">任务池为空，请先添加任务</div>';
                return;
            }

            // 获取当前用户已选择的任务
            const selectedTasks = dailyTasks[user].filter(task => task !== null).map(task => task.poolTaskId);
            // 获取当前周的任务使用次数统计
            const weeklyTaskUsage = getWeeklyTaskUsage(user);

            availableList.innerHTML = `
                <div class="available-task-grid">
                    ${taskPool.map(poolTask => {
                const isSelected = selectedTasks.includes(poolTask.id);
                const isCurrentSlot = dailyTasks[user][slotIndex] && dailyTasks[user][slotIndex].poolTaskId === poolTask.id;
                
                let className = 'available-task-item';
                let clickHandler = `selectTaskFromPool('${poolTask.id}', '${poolTask.name}')`;
                let statusText = '';
                let canSelect = true;

                // 检查专属属性
                if (poolTask.exclusive && poolTask.exclusive !== user) {
                    className += ' disabled';
                    clickHandler = '';
                    statusText = `<div class="task-unavailable-reason">${poolTask.exclusive === 'qiqi' ? '七七' : '一一'}专属任务</div>`;
                    canSelect = false;
                }
                // 检查每周次数限制
                else if (poolTask.weeklyLimit && weeklyTaskUsage[poolTask.id] >= poolTask.weeklyLimit && !isCurrentSlot) {
                    className += ' disabled';
                    clickHandler = '';
                    statusText = `<div class="task-unavailable-reason">本周已达使用上限 (${weeklyTaskUsage[poolTask.id]}/${poolTask.weeklyLimit})</div>`;
                    canSelect = false;
                }
                // 检查是否已在其他位置选择（调试模式下允许重复选择）
                else if (isSelected && !isCurrentSlot && !debugMode) {
                    className += ' disabled';
                    clickHandler = '';
                    statusText = '<div class="task-unavailable-reason">已在其他位置选择</div>';
                    canSelect = false;
                } else if (isCurrentSlot) {
                    statusText = '<div style="color: #28a745; font-size: 0.9em; margin-top: 5px;">✓ 当前选择</div>';
                } else if (isSelected && !isCurrentSlot && debugMode) {
                    statusText = '<div style="color: #ffc107; font-size: 0.9em; margin-top: 5px;">🔧 调试模式：可重复选择</div>';
                }

                return `
                    <div class="${className}">
                        <div class="available-task-header" ${clickHandler ? `onclick="${clickHandler}"` : ''}>
                            <div style="font-weight: bold; display: flex; align-items: center; justify-content: space-between;">
                                <span>${poolTask.name}</span>
                                ${poolTask.description ? `<span class="available-task-expand" onclick="event.stopPropagation(); toggleTaskDetails('available-${poolTask.id}')" style="cursor: pointer; color: #007bff; font-size: 0.8em; margin-left: 8px;">▼</span>` : ''}
                            </div>
                            ${getTaskSpecialAttributes(poolTask)}
                            ${statusText}
                        </div>
                        ${poolTask.description ? `
                            <div class="available-task-details" id="available-${poolTask.id}" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.85em; color: #666; line-height: 1.4;">
                                ${poolTask.description}
                            </div>
                        ` : ''}
                    </div>
                `;
                    }).join('')}
                </div>
            `;
        }

        function selectTaskFromPool(poolTaskId, taskName) {
            const user = currentEditingUser;
            const slotIndex = currentEditingSlot;

            // 获取任务池中的任务信息
            const poolTask = taskPool.find(task => task.id === poolTaskId);
            const basePoints = poolTask ? (poolTask.basePoints || 1) : 1;

            dailyTasks[user][slotIndex] = {
                poolTaskId: poolTaskId,
                name: taskName,
                completed: false,
                multiplier: 1,
                completedAt: null,
                basePoints: basePoints,  // 从任务池获取基础积分
                completionType: null // 完成方式：'normal', 'double', 'super'
            };

            console.log('选择任务:', taskName, '用户:', user, '槽位:', slotIndex);
            console.log('当前dailyTasks状态:', JSON.stringify(dailyTasks));
            
            saveData();
            refreshDailyTasks();
            closeDailyTaskSelectModal();
        }

        // 放弃每日任务
        function abandonDailyTask(user, slotIndex) {
            requireAuth(() => {
                if (confirm('确定要放弃这个任务吗？放弃后可以重新选择其他任务。')) {
                    dailyTasks[user][slotIndex] = null;
                    dailyTasks.progress[user] = dailyTasks[user].filter(t => t && t.completed).length;
                    
                    const userName = user === 'qiqi' ? '七七' : '一一';
                    console.log(`${userName} 放弃了位置 ${slotIndex + 1} 的任务`);
                    
                    saveData();
                    refreshDailyTasks();
                }
            });
        }

        // 获取用户本周任务使用次数统计
        function getWeeklyTaskUsage(user) {
            const usage = {};
            
            // 获取本周的开始日期（周一）
            const now = new Date();
            const currentDay = now.getDay(); // 0=周日, 1=周一, ..., 6=周六
            const daysSinceMonday = currentDay === 0 ? 6 : currentDay - 1; // 计算从周一开始的天数
            const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysSinceMonday);
            
            // 遍历历史记录，统计本周完成的任务
            historyData.forEach(record => {
                // 检查历史记录的消息内容是否包含任务完成信息
                const isTaskCompletion = record.message && (
                    record.message.includes('完成每日任务') || 
                    record.message.includes('完成超额任务')
                );
                
                if (isTaskCompletion && record.details && record.details.user === user) {
                    const recordDate = new Date(record.timestamp || record.time);
                    if (recordDate >= weekStart) {
                        const poolTaskId = record.details.poolTaskId;
                        if (poolTaskId) {
                            usage[poolTaskId] = (usage[poolTaskId] || 0) + 1;
                        }
                    }
                }
            });
            
            return usage;
        }

        // 完成每日任务
        // 编辑已完成任务
        function editCompletedTask(user, slotIndex) {
            requireAuth(() => {
                const task = dailyTasks[user][slotIndex];
                if (!task || !task.completed) return;

                const userName = user === 'qiqi' ? '七七' : '一一';
                const basePoints = task.basePoints || 1;
                const currentType = task.completionType;
                const currentPoints = task.earnedPoints || basePoints;
                
                let options = `🔧 修改${userName}任务"${task.name}"的完成方式\n\n`;
                options += `基础积分：${basePoints}分\n`;
                options += `当前：${getCompletionTypeText(currentType)} (${currentPoints}分)\n\n`;
                options += `请选择新的完成方式：\n`;
                options += `1. 普通完成 - 获得 ${basePoints} 积分\n`;
                options += `2. 加倍完成 - 获得 ${basePoints * 2} 积分\n`;
                options += `3. 超级完成 - 获得 ${basePoints * 3} 积分\n`;
                options += `4. 取消完成状态\n`;
                options += `5. 取消修改\n\n`;
                options += `注意：修改完成方式会影响已获得的积分`;

                const choice = prompt(options, getCurrentChoiceNumber(currentType));
                
                if (choice === '1') {
                    updateTaskCompletion(user, slotIndex, 'normal', 1);
                } else if (choice === '2') {
                    updateTaskCompletion(user, slotIndex, 'double', 2);
                } else if (choice === '3') {
                    updateTaskCompletion(user, slotIndex, 'super', 3);
                } else if (choice === '4') {
                    uncompleteTask(user, slotIndex);
                }
                // choice === '5' 或其他值则取消
            });
        }

        // 获取当前完成方式对应的选项数字
        function getCurrentChoiceNumber(completionType) {
            switch(completionType) {
                case 'normal': return '1';
                case 'double': return '2';
                case 'super': return '3';
                default: return '1';
            }
        }

        // 更新任务完成方式
        function updateTaskCompletion(user, slotIndex, newCompletionType, newMultiplier) {
            const task = dailyTasks[user][slotIndex];
            if (!task || !task.completed) return;

            // 撤销原来的积分
            const oldTotalPoints = task.earnedPoints + (task.bonusPoints || 0);
            addToWeeklyGoals(user, -oldTotalPoints); // 减去原积分
            updateWeeklyPointTracking(user, 'dailyIncome', -oldTotalPoints);

            // 重新计算积分
            const basePoints = task.basePoints || 5;
            const newPoints = basePoints * newMultiplier;
            const newTotalPoints = newPoints + (task.bonusPoints || 0);

            // 更新任务信息
            task.completionType = newCompletionType;
            task.multiplier = newMultiplier;
            task.earnedPoints = newPoints;

            // 添加新积分
            addToWeeklyGoals(user, newTotalPoints);
            updateWeeklyPointTracking(user, 'dailyIncome', newTotalPoints);

            saveData();
            refreshDailyTasks();

            const userName = user === 'qiqi' ? '七七' : '一一';
            const changeMsg = `${userName}修改任务完成方式：${task.name} → ${getCompletionTypeText(newCompletionType)} (${newPoints}分)`;
            addHistory(changeMsg, 'system');
            alert(`✅ 修改成功！\n${changeMsg}`);
        }

        // 取消任务完成状态
        function uncompleteTask(user, slotIndex) {
            const task = dailyTasks[user][slotIndex];
            if (!task || !task.completed) return;

            if (confirm('确定要取消此任务的完成状态吗？这将扣除已获得的积分。')) {
                // 撤销积分
                const totalPoints = task.earnedPoints + (task.bonusPoints || 0);
                addToWeeklyGoals(user, -totalPoints);
                updateWeeklyPointTracking(user, 'dailyIncome', -totalPoints);

                // 重置任务状态
                task.completed = false;
                task.completionType = null;
                task.earnedPoints = 0;
                task.completedAt = null;
                task.bonusPoints = 0;

                saveData();
                refreshDailyTasks();

                const userName = user === 'qiqi' ? '七七' : '一一';
                const changeMsg = `${userName}取消任务完成：${task.name} (-${totalPoints}分)`;
                addHistory(changeMsg, 'system');
                alert(`✅ 已取消完成状态！\n${changeMsg}`);
            }
        }

        // 显示任务完成选项
        // 已移除：showCompletionOptions - 现在使用直接按钮操作

        function completeDailyTask(user, slotIndex, completionType, multiplier) {
            requireAuth(() => {
                const task = dailyTasks[user][slotIndex];
                if (!task || task.completed) return;

                const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                const basePoints = task.basePoints || 1;
                let points = basePoints * multiplier; // 基础积分 × 倍数
                let bonusPoints = 0;
                let actualTaskCount = 1;
                
                // 处理以一抵二属性
                if (poolTask && poolTask.doubleValue) {
                    actualTaskCount = 2;
                }
                
                // 处理连胜奖励
                if (poolTask && poolTask.streakBonus && poolTask.streakConfig) {
                    const streakDays = getTaskStreakDays(user, task.poolTaskId);
                    const requiredDays = poolTask.streakConfig.days - 1; // 减1因为今天是第N天
                    
                    if (streakDays >= requiredDays) {
                        // 检查是否已经获得过这次连胜奖励
                        const lastResetDate = streakResetTracker[user][task.poolTaskId];
                        const today = new Date().toDateString();
                        
                        if (!lastResetDate || lastResetDate !== today) {
                            bonusPoints = poolTask.streakConfig.points;
                            
                            // 记录奖励发放并重置连胜
                            streakResetTracker[user][task.poolTaskId] = today;
                            
                            // 重置该任务的连胜记录
                            if (streakData[user] && streakData[user][task.poolTaskId]) {
                                delete streakData[user][task.poolTaskId];
                            }
                        }
                    }
                }
                
                const totalPoints = points + bonusPoints;
                
                task.completed = true;
                task.multiplier = multiplier;
                task.completedAt = new Date().toISOString();
                task.actualTaskCount = actualTaskCount;
                task.bonusPoints = bonusPoints;
                task.completionType = completionType; // 保存完成方式
                task.earnedPoints = points; // 保存获得的基础积分（不含奖励）
                
                // 积分计入周目标进度
                addToWeeklyGoals(user, totalPoints);
                
                // 更新周度跟踪
                updateWeeklyPointTracking(user, 'dailyIncome', totalPoints);
                
                // 检查任务完成奖励（传递实际任务计数）
                const bonusReward = checkTaskCompletionReward(user, actualTaskCount);
                
                // 更新进度（考虑以一抵二）
                dailyTasks.progress[user] = dailyTasks[user].reduce((total, t) => {
                    if (t && t.completed) {
                        return total + (t.actualTaskCount || 1);
                    }
                    return total;
                }, 0);

                // 生成历史记录
                const multiplierText = multiplier === 1 ? '' : multiplier === 2 ? '(加倍)' : '(超级加倍)';
                const specialText = [];
                if (actualTaskCount === 2) specialText.push('以一抵二');
                if (bonusPoints > 0) specialText.push(`连胜奖励+${bonusPoints}分`);
                const specialInfo = specialText.length > 0 ? `(${specialText.join(', ')})` : '';
                
                addHistory(`${user === 'qiqi' ? '七七' : '一一'}完成每日任务"${task.name}"${multiplierText}${specialInfo} +${totalPoints}积分`, 'system', {
                    user: user,
                    poolTaskId: task.poolTaskId,
                    taskName: task.name,
                    basePoints: points,
                    bonusPoints: bonusPoints,
                    totalPoints: totalPoints,
                    actualTaskCount: actualTaskCount
                });

                saveData();
                refreshDailyTasks();
                refreshBankPage();
                updateTaskStats(); // 更新任务统计
                
                // 每次完成任务时也检查待处理的惩罚
                setTimeout(() => processSnapshotPenalties(), 100);
                
                // 特殊属性提示
                let completionMessage = `任务完成！+${totalPoints}积分`;
                if (actualTaskCount === 2) completionMessage += '\n💪 以一抵二效果生效！';
                if (bonusPoints > 0) completionMessage += `\n🔥 连胜奖励+${bonusPoints}分！`;
                
                alert(completionMessage);
            });
        }

        // 获取任务连胜天数
        function getTaskStreakDays(user, poolTaskId) {
            const now = new Date();
            let streakDays = 0;
            
            // 从今天往前检查连续完成天数
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
                const dayStart = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate());
                const dayEnd = new Date(checkDate.getFullYear(), checkDate.getMonth(), checkDate.getDate() + 1);
                
                // 检查这一天是否完成了此任务
                const completed = historyData.some(record => {
                    // 检查历史记录的消息内容是否包含任务完成信息
                    const isTaskCompletion = record.message && (
                        record.message.includes('完成每日任务') || 
                        record.message.includes('完成超额任务')
                    );
                    
                    if (isTaskCompletion && record.details && 
                        record.details.user === user && record.details.poolTaskId === poolTaskId) {
                        const recordDate = new Date(record.timestamp || record.time);
                        return recordDate >= dayStart && recordDate < dayEnd;
                    }
                    return false;
                });
                
                if (completed) {
                    streakDays++;
                } else {
                    break; // 连续中断
                }
            }
            
            return streakDays;
        }

        // 超额补充任务相关函数
        function openExtraTaskSelect(user) {
            // 获取可选择的任务（与任务池共享，可以重复选择）
            const availableTasks = taskPool.filter(task => 
                (task.exclusive === user || !task.exclusive)
            );

            if (availableTasks.length === 0) {
                alert('任务池中没有可选择的任务！请先在任务池管理中添加任务。');
                return;
            }

            // 创建选择界面
            showExtraTaskSelectDialog(user, availableTasks);
        }

        function showExtraTaskSelectDialog(user, availableTasks) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.zIndex = '10000';
            modal.style.display = 'flex';  // 覆盖默认的 display: none
            
            const userColor = user === 'qiqi' ? '#007bff' : '#28a745';
            const userName = user === 'qiqi' ? '七七' : '一一';
            
            modal.innerHTML = `
                <div class="modal-box" style="
                    max-width: 500px; 
                    width: 90vw; 
                    max-height: 70vh; 
                    overflow-y: auto; 
                    padding: 20px; 
                    margin: auto;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div class="modal-header" style="
                        background: ${userColor}; 
                        color: white; 
                        padding: 15px; 
                        margin: -20px -20px 20px -20px; 
                        border-radius: 15px 15px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h3 style="margin: 0; font-size: 1.1em;">✨ ${userName}选择超额任务</h3>
                        <button class="modal-close-btn" onclick="closeExtraTaskModal()" style="
                            background: rgba(255,255,255,0.2); 
                            border: 1px solid rgba(255,255,255,0.3); 
                            color: white; 
                            border-radius: 50%; 
                            width: 30px; 
                            height: 30px;
                            cursor: pointer;
                            font-size: 16px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">×</button>
                    </div>
                    <div class="extra-task-list" style="max-height: 50vh; overflow-y: auto;">
                        ${availableTasks.map(task => `
                            <div class="extra-task-option" onclick="selectExtraTask('${user}', '${task.id}')" style="
                                border: 2px solid #e9ecef; 
                                border-radius: 8px; 
                                padding: 12px; 
                                margin-bottom: 8px; 
                                cursor: pointer; 
                                transition: all 0.3s ease;
                                background: white;
                            " onmouseover="this.style.borderColor='${userColor}'; this.style.backgroundColor='#f8f9fa';" 
                               onmouseout="this.style.borderColor='#e9ecef'; this.style.backgroundColor='white';">
                                <div style="font-weight: bold; margin-bottom: 4px; font-size: 0.95em;">${task.name}</div>
                                ${task.description ? `<div style="color: #666; font-size: 0.8em; margin-bottom: 6px; line-height: 1.3;">${task.description}</div>` : ''}
                                ${getTaskSpecialAttributes(task, user)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function selectExtraTask(user, taskId) {
            const task = taskPool.find(t => t.id === taskId);
            if (!task) return;

            // 添加到超额任务列表
            const extraTask = {
                poolTaskId: taskId,
                name: task.name,
                description: task.description,
                completed: false,
                multiplier: 1,
                completedAt: null,
                addedAt: new Date().toISOString()
            };

            dailyTasks.extraTasks[user].push(extraTask);
            saveData();
            refreshExtraTasks();
            closeExtraTaskModal();
            
            alert(`已添加超额任务："${task.name}"！`);
        }

        function closeExtraTaskModal() {
            // 简化逻辑：查找所有 zIndex 为 10000 的模态框并关闭
            const allModals = document.querySelectorAll('.modal-overlay');
            
            let found = false;
            allModals.forEach((modal) => {
                if (modal.style.zIndex === '10000') {
                    modal.remove();
                    found = true;
                }
            });
            
            // 如果没有找到指定 zIndex 的模态框，关闭最后一个
            if (!found && allModals.length > 0) {
                const lastModal = allModals[allModals.length - 1];
                lastModal.remove();
            }
        }

        function completeExtraTask(user, taskIndex, multiplier) {
            requireAuth(() => {
                const task = dailyTasks.extraTasks[user][taskIndex];
                if (!task || task.completed) return;

                const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                let points = multiplier;
                let bonusPoints = 0;
                let actualTaskCount = 1;
                
                // 处理以一抵二属性
                if (poolTask && poolTask.doubleValue) {
                    actualTaskCount = 2;
                }
                
                // 处理连胜奖励
                if (poolTask && poolTask.streakBonus && poolTask.streakConfig) {
                    const streakDays = getTaskStreakDays(user, task.poolTaskId);
                    const requiredDays = poolTask.streakConfig.days - 1; // 减1因为今天是第N天
                    
                    if (streakDays >= requiredDays) {
                        // 检查是否已经获得过这次连胜奖励
                        const lastResetDate = streakResetTracker[user][task.poolTaskId];
                        const today = new Date().toDateString();
                        
                        if (!lastResetDate || lastResetDate !== today) {
                            bonusPoints = poolTask.streakConfig.points;
                            
                            // 记录奖励发放并重置连胜
                            streakResetTracker[user][task.poolTaskId] = today;
                            
                            // 重置该任务的连胜记录
                            if (streakData[user] && streakData[user][task.poolTaskId]) {
                                delete streakData[user][task.poolTaskId];
                            }
                        }
                    }
                }
                
                const totalPoints = points + bonusPoints;
                
                task.completed = true;
                task.multiplier = multiplier;
                task.completedAt = new Date().toISOString();
                
                // 积分计入周目标进度
                addToWeeklyGoals(user, totalPoints);
                
                // 检查任务完成奖励（传递实际任务计数）
                const bonusReward = checkTaskCompletionReward(user, actualTaskCount);
                
                // 添加历史记录
                const multiplierText = multiplier === 1 ? '' : multiplier === 2 ? '(加倍)' : '(超级加倍)';
                const specialText = [];
                if (actualTaskCount > 1) specialText.push(`以一抵二`);
                if (bonusPoints > 0) specialText.push(`连胜奖励+${bonusPoints}分`);
                const specialInfo = specialText.length > 0 ? `(${specialText.join(', ')})` : '';
                
                addHistory(`${user === 'qiqi' ? '七七' : '一一'}完成超额任务"${task.name}"${multiplierText}${specialInfo} +${totalPoints}积分`, 'system', {
                    user: user,
                    poolTaskId: task.poolTaskId,
                    taskName: task.name,
                    basePoints: points,
                    bonusPoints: bonusPoints,
                    totalPoints: totalPoints,
                    actualTaskCount: actualTaskCount
                });
                
                saveData();
                refreshBankPage();
                refreshExtraTasks();
                updateTaskStats(); // 更新任务统计
                
                let completionMessage = `✅ 超额任务完成！\n🎯 任务: ${task.name}\n💰 获得积分: +${totalPoints}分`;
                if (bonusPoints > 0) completionMessage += `\n🔥 连胜奖励+${bonusPoints}分！`;
                
                alert(completionMessage);
            });
        }

        function removeExtraTask(user, taskIndex) {
            if (confirm('确定要移除这个超额任务吗？')) {
                dailyTasks.extraTasks[user].splice(taskIndex, 1);
                saveData();
                refreshExtraTasks();
            }
        }

        function refreshExtraTasks() {
            ['qiqi', 'yiyi'].forEach(user => {
                const container = document.getElementById(`${user}-extra-tasks`);
                const countSpan = document.getElementById(`${user}-extra-count`);
                const pointsSpan = document.getElementById(`${user}-extra-points`);
                
                if (!container) return;
                
                if (!dailyTasks.extraTasks || !dailyTasks.extraTasks[user]) {
                    dailyTasks.extraTasks = { qiqi: [], yiyi: [] };
                }
                
                const extraTasks = dailyTasks.extraTasks[user];
                const completedCount = extraTasks.filter(t => t.completed).length;
                const totalPoints = extraTasks.reduce((sum, t) => t.completed ? sum + (t.multiplier || 1) : sum, 0);
                
                if (countSpan) countSpan.textContent = completedCount;
                if (pointsSpan) pointsSpan.textContent = totalPoints;
                
                if (extraTasks.length === 0) {
                    container.innerHTML = '<div class="extra-task-placeholder" style="text-align: center; color: #666; font-size: 0.9em; padding: 20px;">点击"+ 添加任务"从任务池选择额外任务获得积分</div>';
                    return;
                }
                
                container.innerHTML = extraTasks.map((task, index) => {
                    const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                    const userColor = user === 'qiqi' ? '#007bff' : '#28a745';
                    
                    if (task.completed) {
                        return `
                            <div class="extra-task-item completed" style="border: 2px solid ${userColor}; background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div class="task-name" style="font-weight: bold; margin-bottom: 5px;">${task.name}</div>
                                ${poolTask ? getTaskSpecialAttributes(poolTask, user) : ''}
                                <div class="task-status" style="color: ${userColor}; font-size: 0.9em;">✅ 已完成 (+${task.multiplier}分)</div>
                                <button onclick="removeExtraTask('${user}', ${index})" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px;">移除</button>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="extra-task-item" style="border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div class="task-name" style="font-weight: bold; margin-bottom: 5px;">${task.name}</div>
                                ${poolTask ? getTaskSpecialAttributes(poolTask, user) : ''}
                                <div class="task-actions" style="margin-top: 8px;">
                                    <button onclick="completeExtraTask('${user}', ${index}, 1)" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px;">完成 +1分</button>
                                    <button onclick="completeExtraTask('${user}', ${index}, 2)" style="background: #ffc107; color: #212529; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px;">加倍 +2分</button>
                                    <button onclick="completeExtraTask('${user}', ${index}, 3)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 5px;">超级 +3分</button>
                                    <button onclick="removeExtraTask('${user}', ${index})" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">移除</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            });
        }

        // 完成每日任务

        function clearDailyTaskSlot(user, slotIndex) {
            requireAuth(() => {
                if (confirm('确定要清除这个任务槽吗？')) {
                    const task = dailyTasks[user][slotIndex];
                    // 如果任务已完成，记录为已清除完成的任务，防止重新选择后取消完成
                    if (task && task.completed) {
                        if (!dailyTasks.clearedCompleted) {
                            dailyTasks.clearedCompleted = { qiqi: [], yiyi: [] };
                        }
                        dailyTasks.clearedCompleted[user].push({
                            poolTaskId: task.poolTaskId,
                            name: task.name,
                            clearedAt: new Date().toISOString()
                        });
                    }
                    
                    dailyTasks[user][slotIndex] = null;
                    dailyTasks.progress[user] = dailyTasks[user].filter(t => t && t.completed).length;
                    saveData();
                    refreshDailyTasks();
                }
            });
        }

        // 更新任务统计显示
        function updateTaskStats() {
            ['qiqi', 'yiyi'].forEach(user => {
                updateUserTaskStats(user);
            });
        }

        function updateUserTaskStats(user) {
            const streakStatsElement = document.getElementById(`${user}-streak-stats`);
            const weeklyStatsElement = document.getElementById(`${user}-weekly-stats`);
            
            if (!streakStatsElement || !weeklyStatsElement) return;
            
            // 获取用户的连胜奖励任务统计
            const streakTasks = taskPool.filter(task => task.streakBonus);
            const streakStats = [];
            
            streakTasks.forEach(task => {
                if (task.exclusive && task.exclusive !== user) return; // 跳过不属于该用户的专属任务
                
                const streakDays = getTaskStreakDays(user, task.id);
                const config = task.streakConfig || { days: 7, points: 3 };
                
                if (streakDays > 0) {
                    const status = streakDays >= config.days - 1 ? `🔥就绪+${config.points}分` : `${streakDays + 1}/${config.days}天`;
                    streakStats.push(`${task.name}(${status})`);
                }
            });
            
            // 获取用户的每周限制任务统计
            const weeklyTasks = taskPool.filter(task => task.weeklyLimit && task.weeklyLimit > 0);
            const weeklyStats = [];
            
            // 计算本周的任务使用次数
            const weeklyTaskUsage = getWeeklyTaskUsage(user);
            
            weeklyTasks.forEach(task => {
                if (task.exclusive && task.exclusive !== user) return; // 跳过不属于该用户的专属任务
                
                const used = weeklyTaskUsage[task.id] || 0;
                const limit = task.weeklyLimit;
                const status = used >= limit ? '⚠️已满' : `${used}/${limit}`;
                weeklyStats.push(`${task.name}(${status})`);
            });
            
            // 更新连胜奖励统计显示
            if (streakStats.length > 0) {
                streakStatsElement.innerHTML = `<strong>🔥 连胜奖励：</strong>${streakStats.join('，')}<br><small style="color: #28a745; font-weight: normal;">💡 连续完成任务达到设定天数可获得一次性奖励（进入积分池），然后重置计数</small>`;
            } else {
                streakStatsElement.innerHTML = `<strong>🔥 连胜奖励：</strong><span style="color: #999;">暂无连胜任务</span><br><small style="color: #666; font-weight: normal;">💡 连续完成任务达到设定天数可获得一次性奖励（进入积分池），然后重置计数</small>`;
            }
            
            // 更新每周限制统计显示
            if (weeklyStats.length > 0) {
                weeklyStatsElement.innerHTML = `<strong>🏃 每周限次：</strong>${weeklyStats.join('，')}`;
            } else {
                weeklyStatsElement.innerHTML = `<strong>🏃 每周限次：</strong><span style="color: #999;">暂无限次任务</span>`;
            }
        }

        function openTaskModal(user) {
            currentEditingUser = user;
            currentEditingTask = null;
            document.getElementById('task-modal-title').textContent = `📝 为${user === 'qiqi' ? '七七' : '一一'}新建任务`;
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-points').value = '';
            document.getElementById('task-modal').style.display = 'flex';
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            currentEditingTask = null;
            currentEditingUser = null;
            // 重置模态框位置
            resetModalPosition(modalBox);
        }
        
        function resetModalPosition(modalBox) {
            if (modalBox) {
                modalBox.style.position = '';
                modalBox.style.top = '';
                modalBox.style.left = '';
                modalBox.style.transform = '';
                modalBox.style.margin = '';
            }
        }

        function saveTask() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const points = parseInt(document.getElementById('task-points').value);

            if (!title) {
                alert('请输入任务名称！');
                return;
            }

            if (!points || points < 1) {
                alert('请输入有效的积分奖励（至少1分）！');
                return;
            }

            requireAuth(() => {
                if (currentEditingTask) {
                    // 编辑现有任务
                    currentEditingTask.title = title;
                    currentEditingTask.description = description;
                    currentEditingTask.points = points;
                } else {
                    // 创建新任务
                    const newTask = {
                        id: taskCounter++,
                        title: title,
                        description: description,
                        points: points,
                        completed: false,
                        completedAt: null
                    };
                    dailyTasks[currentEditingUser].push(newTask);
                }

                saveData();
                refreshDailyTasks();
                closeTaskModal();
                alert('任务保存成功！');
            });
        }

        function completeTask(user, taskId) {
            if (!dailyTasks || !dailyTasks[user]) return;
            const task = dailyTasks[user].find(t => t.id === taskId);
            if (!task) return;

            requireAuth(() => {
                if (task.completed) {
                    // 检查是否是之前清除过的完成任务，如果是则不允许取消完成
                    if (dailyTasks.clearedCompleted && dailyTasks.clearedCompleted[user]) {
                        const wasPreviouslyCleared = dailyTasks.clearedCompleted[user].some(cleared => 
                            cleared.poolTaskId === task.poolTaskId && cleared.name === task.name
                        );
                        if (wasPreviouslyCleared) {
                            alert('此任务之前已完成并清除，不能取消完成状态！');
                            return;
                        }
                    }
                    
                    // 取消完成
                    task.completed = false;
                    task.completedAt = null;
                    // 扣除积分
                    bankData[user].reward -= task.points;
                    addHistory(`${user === 'qiqi' ? '七七' : '一一'}取消完成任务"${task.title}" -${task.points}积分`, 'system');
                } else {
                    // 完成任务
                    task.completed = true;
                    task.completedAt = new Date().toISOString();
                    // 添加积分（系统奖励）
                    bankData[user].reward += task.points;
                    addWeeklyPoints(user, task.points);
                    
                    // 获取任务的实际计数（检查是否有以一抵二属性）
                    let actualTaskCount = 1;
                    if (task.poolTaskId) {
                        const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                        if (poolTask && poolTask.doubleValue) {
                            actualTaskCount = 2;
                        }
                    }
                    
                    // 检查任务完成奖励（传递实际任务计数）
                    const bonusReward = checkTaskCompletionReward(user, actualTaskCount);
                    
                    let message = `${user === 'qiqi' ? '七七' : '一一'}完成任务"${task.title}" +${task.points}积分`;
                    if (bonusReward > 0) {
                        message += `，额外奖励+${bonusReward}分`;
                    }
                    addHistory(message, 'system');
                }

                saveData();
                refreshDailyTasks();
                refreshBankPage();
            });
        }

        function editTask(user, taskId) {
            if (!dailyTasks || !dailyTasks[user]) return;
            const task = dailyTasks[user].find(t => t.id === taskId);
            if (!task) return;

            currentEditingUser = user;
            currentEditingTask = task;
            document.getElementById('task-modal-title').textContent = `✏️ 编辑${user === 'qiqi' ? '七七' : '一一'}的任务`;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-points').value = task.points;
            document.getElementById('task-modal').style.display = 'flex';
        }

        function deleteTask(user, taskId) {
            if (!confirm('确定要删除这个任务吗？')) return;

            requireAuth(() => {
                if (!dailyTasks || !dailyTasks[user]) return;
                const taskIndex = dailyTasks[user].findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    const task = dailyTasks[user][taskIndex];
                    // 如果任务已完成，需要扣除积分
                    if (task.completed) {
                        bankData[user].reward -= task.points;
                        addHistory(`${user === 'qiqi' ? '七七' : '一一'}删除已完成任务"${task.title}" -${task.points}积分`, 'system');
                    }
                    
                    dailyTasks[user].splice(taskIndex, 1);
                    saveData();
                    refreshDailyTasks();
                    refreshBankPage();
                    alert('任务已删除！');
                }
            });
        }

        function openTaskManageModal(user) {
            currentEditingUser = user;
            document.getElementById('task-manage-title').textContent = `📋 管理${user === 'qiqi' ? '七七' : '一一'}的任务`;
            
            const manageList = document.getElementById('task-manage-list');
            manageList.innerHTML = '';

            if (!dailyTasks || !dailyTasks[user] || dailyTasks[user].length === 0) {
                manageList.innerHTML = '<div class="no-tasks">暂无任务</div>';
            } else {
                dailyTasks[user].forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-manage-item';
                    taskItem.innerHTML = `
                        <div class="task-manage-info">
                            <div class="task-title">${task.title} ${task.completed ? '✅' : ''}</div>
                            <div class="task-details">
                                ${task.description ? `<div>${task.description}</div>` : ''}
                                <div class="task-reward">奖励: ${task.points}积分</div>
                            </div>
                        </div>
                        <div class="task-manage-actions">
                            <button class="btn-small btn-primary" onclick="editTask('${user}', ${task.id})">编辑</button>
                            <button class="btn-small btn-danger" onclick="deleteTask('${user}', ${task.id})">删除</button>
                        </div>
                    `;
                    manageList.appendChild(taskItem);
                });
            }

            document.getElementById('task-manage-modal').style.display = 'flex';
        }

        function closeTaskManageModal() {
            const modal = document.getElementById('task-manage-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            currentEditingUser = null;
            // 重置模态框位置
            resetModalPosition(modalBox);
        }

        function refreshDailyTasks() {
            // 确保新的数据结构已初始化
            if (!dailyTasks || !dailyTasks.qiqi || !Array.isArray(dailyTasks.qiqi)) {
                dailyTasks = {
                    qiqi: [null, null, null],
                    yiyi: [null, null, null],
                    progress: { qiqi: 0, yiyi: 0 },
                    extraTasks: { qiqi: [], yiyi: [] },
                    settings: {
                        dailyTaskCount: 3,
                        extraTasksCountAsProgress: true
                    }
                };
            }
            if (!dailyTasks.progress) {
                dailyTasks.progress = { qiqi: 0, yiyi: 0 };
            }
            if (!dailyTasks.extraTasks) {
                dailyTasks.extraTasks = { qiqi: [], yiyi: [] };
            }
            if (!dailyTasks.settings) {
                dailyTasks.settings = {
                    dailyTaskCount: Math.max(dailyTasks.qiqi.length, 3),
                    extraTasksCountAsProgress: true
                };
            }

            // 更新进度（使用新的计算逻辑）
            updateDailyProgress();
            
            // 使用动态生成任务槽
            ['qiqi', 'yiyi'].forEach(user => {
                const container = document.getElementById(`${user}-daily-tasks`);
                if (container) {
                    // 使用新的动态生成函数
                    container.innerHTML = generateTaskSlots(user);
                }
                
                // 更新进度显示
                updateProgressDisplay(user);
            });

            
            // 更新奖励等级显示
            updateTaskRewardDisplay();
            
            // 更新周目标显示  
            updateWeeklyGoalsDisplay();
            
            // 检查周目标结算
            autoWeeklyCheck();

            // 更新任务池计数
            refreshTaskPoolDisplay();
            
            // 更新任务承接详细信息
            updateTaskAcceptanceInfo();
            
            // 更新预计积分显示
            updateExpectedPoints();
            
            // 更新倒计时显示
            updateDailyCountdown();
        }

        function updateTaskAcceptanceInfo() {
            const qiqiDetails = document.getElementById('qiqi-acceptance-details');
            const yiyiDetails = document.getElementById('yiyi-acceptance-details');
            
            // 获取七七承接的任务（一一发布的）
            const qiqiAcceptedTasks = bountyData.filter(bounty => 
                bounty.assignee === 'qiqi' && 
                bounty.status === 'taken' && 
                !bounty.completedAt
            );
            
            // 获取一一承接的任务（七七发布的）
            const yiyiAcceptedTasks = bountyData.filter(bounty => 
                bounty.assignee === 'yiyi' && 
                bounty.status === 'taken' && 
                !bounty.completedAt
            );
            
            // 更新七七的任务承接信息
            if (qiqiAcceptedTasks.length === 0) {
                qiqiDetails.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">暂无承接的悬赏任务</div>';
            } else {
                let html = '<div style="margin-bottom: 5px; font-weight: bold;">承接的任务 (' + qiqiAcceptedTasks.length + '个):</div>';
                qiqiAcceptedTasks.forEach((task, index) => {
                    const timeInfo = getTaskTimeDisplay(task);
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 8px; margin: 5px 0; border-left: 3px solid #007bff;">
                            <div style="font-weight: bold; color: #007bff; margin-bottom: 3px;">${task.title}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                <span>发布者: ${getPlayerName(task.publisher)}</span> | 
                                <span>积分: ${task.points}</span> | 
                                <span>${timeInfo}</span>
                            </div>
                        </div>
                    `;
                });
                qiqiDetails.innerHTML = html;
            }
            
            // 更新一一的任务承接信息
            if (yiyiAcceptedTasks.length === 0) {
                yiyiDetails.innerHTML = '<div style="color: #999; text-align: center; padding: 10px;">暂无承接的悬赏任务</div>';
            } else {
                let html = '<div style="margin-bottom: 5px; font-weight: bold;">承接的任务 (' + yiyiAcceptedTasks.length + '个):</div>';
                yiyiAcceptedTasks.forEach((task, index) => {
                    const timeInfo = getTaskTimeDisplay(task);
                    html += `
                        <div style="background: white; border-radius: 5px; padding: 8px; margin: 5px 0; border-left: 3px solid #28a745;">
                            <div style="font-weight: bold; color: #28a745; margin-bottom: 3px;">${task.title}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                <span>发布者: ${getPlayerName(task.publisher)}</span> | 
                                <span>积分: ${task.points}</span> | 
                                <span>${timeInfo}</span>
                            </div>
                        </div>
                    `;
                });
                yiyiDetails.innerHTML = html;
            }
        }
        
        function getTaskTimeDisplay(task) {
            if (!task.startedAt) return '未开始';
            
            const startTime = new Date(task.startedAt);
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / (1000 * 60 * 60 * 24));
            
            if (elapsed === 0) {
                return '今天开始';
            } else if (elapsed === 1) {
                return '昨天开始';
            } else {
                return `${elapsed}天前开始`;
            }
        }

        // 更新预计积分显示
        function updateExpectedPoints() {
            const users = ['qiqi', 'yiyi'];
            
            users.forEach(user => {
                const userTasks = dailyTasks[user];
                const selectedTasks = userTasks.filter(task => task !== null);
                
                // 计算实际任务数量（考虑以一抵二）
                let totalTaskCount = 0;
                selectedTasks.forEach(task => {
                    const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                    if (poolTask && poolTask.doubleValue) {
                        totalTaskCount += 2; // 以一抵二
                    } else {
                        totalTaskCount += 1;
                    }
                });
                
                let expectedPoints = 0;
                let color = '#28a745';
                let text = '';
                
                if (totalTaskCount >= 3) {
                    // 达到或超过三个任务数量
                    expectedPoints = Math.min(totalTaskCount, 3) * 1;
                    if (totalTaskCount > 3) {
                        text = `预计获得积分: +${expectedPoints}分以上（超额）`;
                    } else {
                        text = `预计获得积分: +${expectedPoints}分（最低）`;
                    }
                } else {
                    // 未达到三个任务数量
                    const missingTasks = 3 - totalTaskCount;
                    expectedPoints = -(missingTasks * 3);
                    color = '#dc3545';
                    
                    if (missingTasks === 3) {
                        text = `预计扣除积分: ${expectedPoints}分（未接任务）`;
                    } else {
                        text = `预计扣除积分: ${expectedPoints}分（少${missingTasks}个任务）`;
                    }
                }
                
                const pointsElement = document.getElementById(`${user}-expected-points`);
                if (pointsElement) {
                    pointsElement.textContent = text;
                    pointsElement.style.color = color;
                }
            });
        }

        // 更新每日倒计时显示
        function updateDailyCountdown() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const deadline = new Date(today.getTime() + 23.5 * 60 * 60 * 1000); // 今天23:30
            
            const timeLeft = deadline.getTime() - now.getTime();
            
            if (timeLeft <= 0) {
                // 已过截止时间
                document.getElementById('daily-countdown').textContent = '任务截止: 已结束';
                const duplicateElement = document.querySelector('.daily-countdown-duplicate');
                if (duplicateElement) {
                    duplicateElement.textContent = '任务截止: 已结束';
                }
            } else {
                // 计算剩余时间
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('daily-countdown').textContent = `任务截止: ${timeString}`;
                
                const duplicateElement = document.querySelector('.daily-countdown-duplicate');
                if (duplicateElement) {
                    duplicateElement.textContent = `任务截止: ${timeString}`;
                }
            }
        }

        // 启动倒计时定时器
        function startDailyCountdownTimer() {
            updateDailyCountdown(); // 立即更新一次
            setInterval(updateDailyCountdown, 1000); // 每秒更新
        }

        function createTaskElement(task, user) {
            const taskElement = document.createElement('div');
            taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
            taskElement.innerHTML = `
                <div class="task-title">${task.title}</div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                <div class="task-reward">奖励: ${task.points}积分</div>
                <div class="task-actions">
                    <button class="btn-small ${task.completed ? 'btn-secondary' : 'btn-success'}" 
                            onclick="completeTask('${user}', ${task.id})">
                        ${task.completed ? '取消完成' : '完成任务'}
                    </button>
                    <button class="btn-small btn-primary" onclick="editTask('${user}', ${task.id})">编辑</button>
                    <button class="btn-small btn-danger" onclick="deleteTask('${user}', ${task.id})">删除</button>
                </div>
            `;
            return taskElement;
        }

        function checkDailyReset() {
            const now = new Date();
            const today = now.toDateString();
            
            // 检查是否是6点重置时间
            if (lastResetDate !== today && now.getHours() >= 6) {
                resetDailyTasks();
                lastResetDate = today;
                saveData();
            }
        }

        function resetDailyTasks() {
            // 清空所有任务槽，让用户重新选择
            dailyTasks.qiqi = [null, null, null];
            dailyTasks.yiyi = [null, null, null];
            dailyTasks.progress = { qiqi: 0, yiyi: 0 };
            
            // 清空超额任务
            dailyTasks.extraTasks = { qiqi: [], yiyi: [] };
            
            // 清空已清除完成任务记录（每日重置）
            dailyTasks.clearedCompleted = { qiqi: [], yiyi: [] };
            
            saveData();
            console.log('每日任务和超额任务已清空，需要重新选择');
            refreshDailyTasks();
            refreshExtraTasks();
            updateTaskStats(); // 更新任务统计
        }

        function checkBountyExpiry() {
            const now = new Date();
            let hasExpired = false;

            bountyData.forEach(bounty => {
                // 只检查开放状态和已接取但未完成的悬赏
                if ((bounty.status === 'open' || bounty.status === 'taken') && bounty.expireAt) {
                    const expireTime = new Date(bounty.expireAt);
                    
                    if (now > expireTime) {
                        // 悬赏过期
                        hasExpired = true;
                        
                        // 如果悬赏已被接取，返还积分给发布者（系统任务不需要返还）
                        if (bounty.status === 'taken' && bounty.publisher !== 'system') {
                            bankData[bounty.publisher].reward += bounty.points;
                            bankData[bounty.publisher].publish += bounty.points; // 撤销发布成本
                            
                            
                            addHistory(`悬赏"${bounty.title}"超期自动放弃，${bounty.points}积分归还给${bounty.publisher === 'qiqi' ? '七七' : '一一'}`, 'system');
                        } else if (bounty.publisher === 'system') {
                            addHistory(`系统任务"${bounty.title}"超期自动取消`, 'system');
                        }
                        
                        // 标记悬赏为过期
                        bounty.status = 'expired';
                        bounty.expiredAt = now.toISOString();
                        
                        console.log(`悬赏"${bounty.title}"已过期`);
                    }
                }
            });

            if (hasExpired) {
                saveData();
                refreshBountyList();
                refreshBankPage();
                console.log('检查到过期悬赏，已自动处理');
            }
        }

        // 严格惩罚管理系统 - 基于23:30时刻快照
        function captureTaskSnapshot(dateString) {
            // 在23:30时刻保存当前任务完成状态
            const snapshot = {
                qiqi: JSON.parse(JSON.stringify(dailyTasks.qiqi || [])),
                yiyi: JSON.parse(JSON.stringify(dailyTasks.yiyi || [])),
                capturedAt: new Date().toISOString()
            };
            
            dailyTaskSnapshots[dateString] = snapshot;
            console.log(`保存任务状态快照: ${dateString}`, snapshot);
            saveData();
            return snapshot;
        }
        
        function processSnapshotPenalties() {
            let processedCount = 0;
            
            // 遍历所有快照，只处理惩罚系统启动之后的日期
            Object.keys(dailyTaskSnapshots).forEach(dateString => {
                const snapshot = dailyTaskSnapshots[dateString];
                if (snapshot.penaltyProcessed) return; // 已处理过
                
                // 只处理惩罚系统启动之后的日期
                if (!isDateAfterPenaltyStart(dateString)) {
                    console.log(`跳过惩罚系统启动前的日期: ${dateString}`);
                    snapshot.penaltyProcessed = true; // 标记为已处理但不扣分
                    snapshot.skippedReason = '在惩罚系统启动之前';
                    return;
                }
                
                console.log(`处理 ${dateString} 的惩罚快照`);
                
                ['qiqi', 'yiyi'].forEach(user => {
                    if (!snapshot[user]) return;
                    
                    // 计算23:30时刻的完成任务数（考虑以一抵二）
                    let completedTaskCount = 0;
                    snapshot[user].forEach(task => {
                        if (task && task.completed) {
                            const poolTask = taskPool.find(pt => pt.id === task.poolTaskId);
                            if (poolTask && poolTask.doubleValue) {
                                completedTaskCount += 2; // 以一抵二
                            } else {
                                completedTaskCount += 1;
                            }
                        }
                    });
                    
                    const missingTaskCount = Math.max(0, 3 - completedTaskCount);
                    
                    if (missingTaskCount > 0) {
                        // 根据缺少的任务数量计算惩罚（每个任务3分）
                        const penaltyPoints = missingTaskCount * 3;
                        
                        // 应用每日任务惩罚
                        bankData[user].dailyPenalty -= penaltyPoints;
                        
                        
                        const userName = user === 'qiqi' ? '七七' : '一一';
                        addHistory(`${userName}在${dateString}少完成${missingTaskCount}个任务，扣除${penaltyPoints}分`, 'system');
                        
                        console.log(`${userName} 在${dateString}少完成 ${missingTaskCount} 个任务，扣除 ${penaltyPoints} 分`);
                    }
                });
                
                // 标记为已处理
                snapshot.penaltyProcessed = true;
                snapshot.processedAt = new Date().toISOString();
                processedCount++;
            });
            
            if (processedCount > 0) {
                console.log(`处理了 ${processedCount} 天的惩罚快照`);
                saveData();
                refreshBankPage();
            }
            
            // 清理超过7天的快照
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            Object.keys(dailyTaskSnapshots).forEach(dateString => {
                if (new Date(dateString) < sevenDaysAgo) {
                    delete dailyTaskSnapshots[dateString];
                }
            });
        }
        
        // 初始化惩罚系统（从今天开始）
        function initializePenaltySystem() {
            const today = new Date().toDateString();
            
            if (!penaltySystemStartDate) {
                penaltySystemStartDate = today;
                console.log(`惩罚系统已启动，从 ${today} 开始严格执行`);
                saveData();
            }
        }
        
        // 检查日期是否在惩罚系统启动之后
        function isDateAfterPenaltyStart(dateString) {
            if (!penaltySystemStartDate) return false;
            return new Date(dateString) >= new Date(penaltySystemStartDate);
        }
        
        // 每周积分系统辅助函数
        function getWeekStart(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 调整到周一
            return new Date(d.setDate(diff));
        }
        
        function getWeekNumber(date = new Date()) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - startOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
        }
        
        // 更新周度统计数据
        function updateWeeklyStats() {
            // 更新当前周数
            weeklyStats.currentWeek = getCurrentWeekNumber();
            
            // 检查是否新的一周开始
            const currentWeekStart = getWeekStartDate().toDateString();
            if (weeklyStats.weekStart !== currentWeekStart) {
                // 新的一周，重置周度统计
                weeklyStats.qiqi = { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 };
                weeklyStats.yiyi = { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 };
                weeklyStats.weekStart = currentWeekStart;
            }
        }
        
        // 周度统计系统函数
        function getWeekStartDate(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // 调整到周一
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        function getCurrentWeekNumber(date = new Date()) {
            // 计算从2025年6月1日起的周次
            const systemStartWeek = getWeekStartDate(SYSTEM_START_DATE);
            const currentWeek = getWeekStartDate(date);
            const weeksDiff = Math.floor((currentWeek - systemStartWeek) / (7 * 24 * 60 * 60 * 1000));
            return weeksDiff + 1; // 第1周开始
        }
        
        // 检查是否需要周度重置
        function checkWeeklyReset() {
            const currentWeekStart = getWeekStartDate().toDateString();
            
            if (weeklyStats.weekStart !== currentWeekStart) {
                console.log('检测到新的一周，生成上周积分汇总...');
                generateWeeklySummary();
                resetWeeklyStats();
            }
        }
        
        // 生成周度积分汇总到历史记录
        function generateWeeklySummary() {
            const weekEnd = new Date();
            weekEnd.setDate(weekEnd.getDate() - 1); // 昨天作为上周结束
            
            const qiqiTotal = weeklyStats.qiqi.reward + weeklyStats.qiqi.penalty + weeklyStats.qiqi.publish + 
                             weeklyStats.qiqi.obtain + weeklyStats.qiqi.trade + weeklyStats.qiqi.dailyIncome + 
                             weeklyStats.qiqi.dailyPenalty + weeklyStats.qiqi.starIncome;
                             
            const yiyiTotal = weeklyStats.yiyi.reward + weeklyStats.yiyi.penalty + weeklyStats.yiyi.publish + 
                             weeklyStats.yiyi.obtain + weeklyStats.yiyi.trade + weeklyStats.yiyi.dailyIncome + 
                             weeklyStats.yiyi.dailyPenalty + weeklyStats.yiyi.starIncome;
            
            const summary = `
📊 第${weeklyStats.currentWeek - 1}周积分汇总 (${weeklyStats.weekStart} ~ ${weekEnd.toDateString()})

🎯 七七本周：
• 奖励：+${weeklyStats.qiqi.reward}分
• 惩罚：${weeklyStats.qiqi.penalty}分  
• 发布：${weeklyStats.qiqi.publish}分
• 获取：+${weeklyStats.qiqi.obtain}分
• 交易：${weeklyStats.qiqi.trade >= 0 ? '+' : ''}${weeklyStats.qiqi.trade}分
• 日收：+${weeklyStats.qiqi.dailyIncome}分
• 日罚：${weeklyStats.qiqi.dailyPenalty}分
• 星收：+${weeklyStats.qiqi.starIncome}分
• 总分：${qiqiTotal >= 0 ? '+' : ''}${qiqiTotal}分

🎯 一一本周：
• 奖励：+${weeklyStats.yiyi.reward}分
• 惩罚：${weeklyStats.yiyi.penalty}分
• 发布：${weeklyStats.yiyi.publish}分
• 获取：+${weeklyStats.yiyi.obtain}分
• 交易：${weeklyStats.yiyi.trade >= 0 ? '+' : ''}${weeklyStats.yiyi.trade}分
• 日收：+${weeklyStats.yiyi.dailyIncome}分
• 日罚：${weeklyStats.yiyi.dailyPenalty}分
• 星收：+${weeklyStats.yiyi.starIncome}分
• 总分：${yiyiTotal >= 0 ? '+' : ''}${yiyiTotal}分
            `.trim();
            
            // 添加到积分历史
            addHistory(summary, 'system', {
                type: 'weekly_summary',
                weekNumber: weeklyStats.currentWeek - 1,
                weekStart: weeklyStats.weekStart,
                weekEnd: weekEnd.toDateString(),
                data: JSON.parse(JSON.stringify(weeklyStats))
            });
            
            console.log('周度积分汇总已生成:', summary);
        }
        
        // 重置周度统计数据
        function resetWeeklyStats() {
            const newWeekStart = getWeekStartDate();
            const newWeekNumber = getCurrentWeekNumber();
            
            weeklyStats = {
                qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
                yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
                currentWeek: newWeekNumber,
                weekStart: newWeekStart.toDateString()
            };
            
            console.log(`新的一周开始: 第${newWeekNumber}周 (${newWeekStart.toDateString()})`);
            saveData();
        }
        
        // 更新周度积分跟踪
        function updateWeeklyPointTracking(user, category, points) {
            if (!weeklyStats[user] || weeklyStats[user][category] === undefined) return;
            
            // 检查是否需要周度重置
            checkWeeklyReset();
            
            // 更新对应类别的积分
            weeklyStats[user][category] += points;
            
            console.log(`${user}本周${category}: ${weeklyStats[user][category]}`);
        }
        

        // 检查并处理所有待处理的惩罚
        function checkAndApplyPendingPenalties() {
            // 只处理启动日期之后的快照
            processSnapshotPenalties();
        }

        // 每日任务截止时间检查 - 在23:30时刻捕获状态快照
        function checkDailyTaskDeadline() {
            const now = new Date();
            const currentDate = now.toDateString();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // 精确在23:30时刻捕获任务状态快照
            if (currentHour === 23 && currentMinute >= 30 && currentMinute < 35) {
                // 检查是否已经为今天创建了快照
                if (!dailyTaskSnapshots[currentDate]) {
                    console.log(`23:30截止时间到！保存 ${currentDate} 的任务状态快照`);
                    captureTaskSnapshot(currentDate);
                }
            }
            
            // 处理所有快照的惩罚（延迟执行，确保快照创建后再处理）
            setTimeout(() => processSnapshotPenalties(), 1000);
        }



        function formatTimeRemaining(expireAt) {
            const now = new Date();
            const expireTime = new Date(expireAt);
            const diffMs = expireTime - now;
            
            if (diffMs <= 0) {
                return '已过期';
            }
            
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffHours >= 24) {
                const days = Math.floor(diffHours / 24);
                const hours = diffHours % 24;
                return `${days}天${hours > 0 ? hours + '小时' : ''}`;
            } else if (diffHours > 0) {
                return `${diffHours}小时${diffMinutes > 0 ? diffMinutes + '分钟' : ''}`;
            } else {
                return `${diffMinutes}分钟`;
            }
        }

        // 数据持久化
        function saveData() {
            const data = {
                bountyData,
                bankData,
                historyData,
                bountyCounter,
                dailyTasksContent,
                dailyTasks,
                taskPool,
                taskCounter,
                lastResetDate,
                weeklyData,
                monthlyStarBonus,
                dailyTaskSnapshots, // 保存任务状态快照
                penaltySystemStartDate, // 保存惩罚系统开始日期
                weeklyStats, // 保存周度积分统计数据
                taskRewardSystem, // 保存任务奖励系统数据
                weeklyGoals, // 保存周目标数据
                streakResetTracker, // 保存连胜重置跟踪器
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('pointSystemV2', JSON.stringify(data));
            
            // 自动同步到云端
            if (isOnline && isFirebaseReady) {
                autoUploadToFirebase(data); // 自动上传
            }
        }

        // 自动上传到Firebase（静默，带防抖）
        let uploadTimeout = null;
        async function autoUploadToFirebase(data) {
            // 防抖：500ms内多次调用只执行最后一次
            if (uploadTimeout) {
                clearTimeout(uploadTimeout);
            }
            
            uploadTimeout = setTimeout(async () => {
                if (!isFirebaseReady || !isOnline) {
                    return;
                }

                try {
                    await window.firebaseDb.set(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'), data);
                    updateLastSyncTime();
                    updateConnectionStatus(true, '数据已自动同步');
                    console.log('数据自动上传成功');
                } catch (error) {
                    console.error('自动上传失败:', error);
                    updateConnectionStatus(false, '自动上传失败：' + error.message);
                }
            }, 500);
        }

        // Firebase 同步功能
        function updateConnectionStatus(online, message = '') {
            isOnline = online;
            const statusElement = document.getElementById('connection-status');
            const syncStatusElement = document.getElementById('sync-status');
            
            if (online) {
                statusElement.className = 'connection-status status-online';
                statusElement.innerHTML = '🟢<span class="status-text"> 在线同步</span>';
                if (syncStatusElement) {
                    syncStatusElement.textContent = message || '已连接到云端数据库，自动同步已启用';
                }
            } else {
                statusElement.className = 'connection-status status-offline';
                statusElement.innerHTML = '🔴<span class="status-text"> 离线模式</span>';
                if (syncStatusElement) {
                    syncStatusElement.textContent = message || '无法连接到云端数据库，使用本地模式';
                }
            }
        }

        function updateSyncingStatus(message) {
            const statusElement = document.getElementById('connection-status');
            const syncStatusElement = document.getElementById('sync-status');
            
            statusElement.className = 'connection-status status-syncing';
            statusElement.innerHTML = '🟡<span class="status-text"> 同步中</span>';
            if (syncStatusElement) {
                syncStatusElement.textContent = message || '正在自动同步数据...';
            }
        }

        // 移除了手动同步按钮控制函数，改为全自动同步

        function updateLastSyncTime() {
            lastSyncTime = new Date();
            const lastSyncElement = document.getElementById('last-sync');
            if (lastSyncElement) {
                lastSyncElement.textContent = `上次同步：${lastSyncTime.toLocaleString()}`;
            }
        }

        // 旧的手动同步函数已移除，现在使用全自动同步


        // 密码保护功能
        function checkAuthentication() {
            const storedAuthTime = localStorage.getItem(PASSWORD_STORAGE_KEY);
            if (storedAuthTime) {
                const authTime = new Date(parseInt(storedAuthTime));
                const now = new Date();
                const hoursDiff = (now - authTime) / (1000 * 60 * 60);
                
                if (hoursDiff < PASSWORD_VALID_HOURS) {
                    isAuthenticated = true;
                    updateAuthStatus(true, PASSWORD_VALID_HOURS - hoursDiff);
                    return true;
                }
            }
            isAuthenticated = false;
            updateAuthStatus(false);
            return false;
        }

        function updateAuthStatus(authenticated, remainingHours = 0) {
            const authElement = document.getElementById('auth-status');
            if (authenticated) {
                const hours = Math.floor(remainingHours);
                const minutes = Math.floor((remainingHours - hours) * 60);
                authElement.style.background = '#d4edda';
                authElement.style.color = '#155724';
                authElement.style.border = '1px solid #c3e6cb';
                authElement.innerHTML = `🔓<span class="status-text"> 已认证 (${hours}h${minutes}m后过期)</span>`;
            } else {
                authElement.style.background = '#e8f4fd';
                authElement.style.color = '#1976d2';
                authElement.style.border = '1px solid #bee5eb';
                authElement.innerHTML = '🔒<span class="status-text"> 需要密码</span>';
            }
        }

        // 显示密码输入模态框
        function showPasswordModal(callback) {
            passwordCallback = callback;
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('admin-password');
            
            modal.style.display = 'flex';
            passwordInput.value = '';
            
            // 自动聚焦到密码输入框
            setTimeout(() => {
                passwordInput.focus();
            }, 100);
        }
        
        // 确认密码输入
        function confirmPasswordInput() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput.value;
            
            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                localStorage.setItem(PASSWORD_STORAGE_KEY, Date.now().toString());
                updateAuthStatus(true, PASSWORD_VALID_HOURS);
                hidePasswordModal();
                
                // 执行回调函数
                if (passwordCallback) {
                    passwordCallback();
                    passwordCallback = null;
                }
            } else {
                // 显示错误提示
                passwordInput.style.borderColor = '#dc3545';
                passwordInput.style.boxShadow = '0 0 0 2px rgba(220, 53, 69, 0.1)';
                
                // 添加震动效果
                passwordInput.style.animation = 'shake 0.5s ease-in-out';
                
                // 清空输入框并重新聚焦
                passwordInput.value = '';
                passwordInput.focus();
                
                // 恢复正常样式
                setTimeout(() => {
                    passwordInput.style.borderColor = '#ccc';
                    passwordInput.style.boxShadow = 'none';
                    passwordInput.style.animation = 'none';
                }, 1000);
                
                // 显示错误消息
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = `
                    position: absolute;
                    top: -35px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #dc3545;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 0.85em;
                    z-index: 1000;
                    white-space: nowrap;
                    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
                    animation: slideIn 0.3s ease;
                `;
                errorMsg.textContent = '❌ 密码错误，请重试';
                passwordInput.parentNode.style.position = 'relative';
                passwordInput.parentNode.appendChild(errorMsg);
                
                setTimeout(() => {
                    if (errorMsg.parentNode) {
                        errorMsg.parentNode.removeChild(errorMsg);
                    }
                }, 2000);
            }
        }
        
        // 取消密码输入
        function cancelPasswordInput() {
            hidePasswordModal();
            passwordCallback = null;
        }
        
        // 隐藏密码输入模态框
        function hidePasswordModal() {
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('admin-password');
            
            modal.style.display = 'none';
            passwordInput.value = '';
            passwordInput.style.borderColor = '#ccc';
            passwordInput.style.boxShadow = 'none';
            passwordInput.style.animation = 'none';
        }

        function requestPassword(action, callback) {
            if (checkAuthentication()) {
                callback();
                return;
            }

            // 使用新的模态框替代 prompt
            showPasswordModal(callback);
        }

        function requireAuth(callback) {
            requestPassword('modify', callback);
        }

        // 用户选择相关函数
        function showUserSelectModal(title, label, options, callback) {
            userSelectCallback = callback;
            
            // 设置标题和标签
            document.getElementById('user-select-title').textContent = title;
            document.getElementById('user-select-label').textContent = label;
            
            // 生成选项按钮
            const optionsContainer = document.getElementById('user-select-options');
            optionsContainer.innerHTML = '';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'user-select-option';
                button.textContent = option.text;
                button.onclick = () => confirmUserSelect(option.value);
                
                // 添加样式
                button.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 12px;
                    padding: 15px 20px;
                    font-size: 1em;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                `;
                
                // 添加悬停效果
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.3)';
                });
                
                optionsContainer.appendChild(button);
            });
            
            // 显示模态框
            document.getElementById('user-select-modal').style.display = 'flex';
        }
        
        function confirmUserSelect(selectedValue) {
            hideUserSelectModal();
            
            if (userSelectCallback) {
                userSelectCallback(selectedValue);
                userSelectCallback = null;
            }
        }
        
        function cancelUserSelect() {
            hideUserSelectModal();
            userSelectCallback = null;
        }
        
        function hideUserSelectModal() {
            const modal = document.getElementById('user-select-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            document.getElementById('user-select-options').innerHTML = '';
            // 重置模态框位置
            resetModalPosition(modalBox);
        }
        
        // 预定义的用户选择快捷函数
        function selectAssignee(callback) {
            showUserSelectModal(
                '👥 选择承接者',
                '请选择谁来承接这个悬赏任务：',
                [
                    { text: '🌸 七七', value: '七七' },
                    { text: '⭐ 一一', value: '一一' }
                ],
                callback
            );
        }
        
        function selectRewardTarget(callback) {
            showUserSelectModal(
                '🎁 选择奖励对象', 
                '系统任务完成后，奖励积分给谁：',
                [
                    { text: '🌸 七七', value: '七七' },
                    { text: '⭐ 一一', value: '一一' },
                    { text: '🎁 同时给两人', value: 'both' }
                ],
                callback
            );
        }

        // 批量导入功能 - 重写版本
        function showBatchImportModal() {
            console.log('打开批量导入模态框');
            const modal = document.getElementById('batch-import-modal');
            const textarea = document.getElementById('batch-import-text');
            const previewDiv = document.getElementById('batch-preview');
            const confirmBtn = document.getElementById('batch-import-confirm');
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 清空数据
            textarea.value = '';
            batchImportData = [];
            confirmBtn.disabled = true;
            previewDiv.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px;">请在上方输入任务数据，将自动显示解析预览</div>';
            
            // 重新绑定事件监听器（确保事件正常工作）
            textarea.removeEventListener('input', handleTextareaInput);
            textarea.removeEventListener('paste', handleTextareaPaste);
            textarea.addEventListener('input', handleTextareaInput);
            textarea.addEventListener('paste', handleTextareaPaste);
            console.log('事件监听器已重新绑定');
            
            // 自动聚焦
            setTimeout(() => {
                textarea.focus();
            }, 100);
            
            console.log('模态框已打开');
        }
        
        function handleTextareaInput() {
            console.log('检测到输入变化 - handleTextareaInput');
            updateBatchPreview();
        }
        
        function handleTextareaPaste() {
            console.log('检测到粘贴操作 - handleTextareaPaste');
            setTimeout(() => {
                updateBatchPreview();
            }, 50);
        }
        
        // 中文数字转阿拉伯数字函数
        function chineseToNumber(chineseNum) {
            const chineseNums = {
                '零': 0, '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, 
                '六': 6, '七': 7, '八': 8, '九': 9, '十': 10,
                '〇': 0, '壹': 1, '贰': 2, '叁': 3, '肆': 4, '伍': 5,
                '陆': 6, '柒': 7, '捌': 8, '玖': 9, '拾': 10
            };
            
            // 如果是纯数字，直接返回
            if (/^\d+$/.test(chineseNum)) {
                return parseInt(chineseNum);
            }
            
            // 处理简单的中文数字（1-10）
            if (chineseNums.hasOwnProperty(chineseNum)) {
                return chineseNums[chineseNum];
            }
            
            // 处理十几的数字，如"十一"、"十二"等
            if (chineseNum.startsWith('十') && chineseNum.length === 2) {
                const unit = chineseNums[chineseNum.charAt(1)];
                return unit ? 10 + unit : null;
            }
            
            // 处理二十、三十等
            if (chineseNum.endsWith('十') && chineseNum.length === 2) {
                const tens = chineseNums[chineseNum.charAt(0)];
                return tens ? tens * 10 : null;
            }
            
            // 处理二十一、三十五等
            if (chineseNum.includes('十') && chineseNum.length === 3) {
                const parts = chineseNum.split('十');
                const tens = chineseNums[parts[0]];
                const units = chineseNums[parts[1]];
                if (tens && units) {
                    return tens * 10 + units;
                }
            }
            
            return null;
        }
        
        
        function parseBatchImportText(text) {
            console.log('parseBatchImportText 被调用，输入文本:', JSON.stringify(text));
            const lines = text.split('\n').filter(line => line.trim());
            console.log('分行结果:', lines);
            const results = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                let trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                // 移除开头的序号格式（支持多种格式）
                // 匹配模式：数字 + 句号 + 可选空格，例如 "1. ", "10.", "123. "
                // 也支持中文句号：数字 + 中文句号 + 可选空格，例如 "1。", "1。 "
                // 还支持带括号：数字 + 右括号 + 可选空格，例如 "1) ", "10)"
                trimmedLine = trimmedLine.replace(/^\d+[.。)]\s*/, '');
                
                // 如果移除序号后为空，跳过这一行
                if (!trimmedLine) return;
                
                // 使用全角逗号分隔
                const parts = trimmedLine.split('，');
                
                if (parts.length !== 3) {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: `格式错误：需要3个字段，当前有${parts.length}个字段`
                    });
                    return;
                }
                
                const [publisherText, title, pointsText] = parts.map(p => p.trim());
                
                // 验证发布者
                let publisher;
                if (publisherText === '一一') {
                    publisher = 'yiyi';
                } else if (publisherText === '七七') {
                    publisher = 'qiqi';
                } else {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: `发布者错误：'${publisherText}'，应为'一一'或'七七'`
                    });
                    return;
                }
                
                // 验证标题
                if (!title || title.length === 0) {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: '悬赏标题不能为空'
                    });
                    return;
                }
                
                if (title.length > 100) {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: `悬赏标题过长：${title.length}字符，最多100字符`
                    });
                    return;
                }
                
                // 验证积分 - 支持中文数字
                let points = chineseToNumber(pointsText.trim());
                if (points === null || points <= 0) {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: `积分错误: '${pointsText}', 支持阿拉伯数字(1-1000)或中文数字(一到一千)`
                    });
                    return;
                }
                
                if (points > 1000) {
                    errors.push({
                        line: index + 1,
                        text: trimmedLine,
                        error: `积分过大：${points}，最大1000分`
                    });
                    return;
                }
                
                // 数据有效，添加到结果
                results.push({
                    line: index + 1,
                    publisher,
                    publisherName: publisherText,
                    title,
                    points,
                    originalText: trimmedLine
                });
            });
            
            return { results, errors };
        }
        
        function updateBatchPreview() {
            console.log('更新预览');
            
            const textarea = document.getElementById('batch-import-text');
            const previewDiv = document.getElementById('batch-preview');
            const confirmBtn = document.getElementById('batch-import-confirm');
            
            if (!textarea || !previewDiv || !confirmBtn) {
                console.error('找不到需要的元素');
                return;
            }
            
            const text = textarea.value;
            console.log('当前文本:', text);
            
            if (!text.trim()) {
                previewDiv.innerHTML = '<div style="color: #6c757d; text-align: center; padding: 20px;">请在上方输入任务数据</div>';
                batchImportData = [];
                confirmBtn.disabled = true;
                return;
            }
            
            const result = parseBatchImportText(text);
            batchImportData = result.results;
            
            let html = '';
            
            // 成功解析的任务
            if (result.results.length > 0) {
                html += `<div style="color: #28a745; font-weight: bold; margin-bottom: 10px;">✅ 成功解析 ${result.results.length} 个任务</div>`;
                result.results.forEach(task => {
                    html += `<div style="background: #f8f9fa; border-left: 3px solid #28a745; padding: 8px; margin: 5px 0; border-radius: 3px;">
                        <strong>${task.publisherName}</strong> → ${task.title} <span style="color: #666;">(积分: ${task.points})</span>
                    </div>`;
                });
            }
            
            // 错误信息
            if (result.errors.length > 0) {
                html += `<div style="color: #dc3545; font-weight: bold; margin: 15px 0 10px 0;">❌ 错误 ${result.errors.length} 行</div>`;
                result.errors.forEach(error => {
                    html += `<div style="background: #f8d7da; border-left: 3px solid #dc3545; padding: 8px; margin: 5px 0; border-radius: 3px;">
                        <strong>行 ${error.line}:</strong> ${error.error}
                    </div>`;
                });
            }
            
            if (!html) {
                html = '<div style="color: #6c757d; text-align: center; padding: 20px;">请输入有效数据</div>';
            }
            
            previewDiv.innerHTML = html;
            confirmBtn.disabled = result.results.length === 0;
            
            console.log('预览更新完成');
        }
        
        function confirmBatchImport() {
            console.log('confirmBatchImport 被调用，batchImportData:', batchImportData);
            if (batchImportData.length === 0) {
                alert('没有有效的任务数据可以导入！');
                return;
            }
            
            requireAuth(() => {
                let successCount = 0;
                let failCount = 0;
                
                batchImportData.forEach((task, index) => {
                    try {
                        const now = new Date();
                        // 自动分配承接者：一一发布→七七承接，七七发布→一一承接
                        const assignee = task.publisher === 'qiqi' ? 'yiyi' : 'qiqi';
                        
                        const bounty = {
                            id: `batch_bounty_${Date.now()}_${index}`,
                            publisher: task.publisher,
                            assignee: assignee,
                            title: task.title,
                            description: '', // 批量导入暂不支持描述
                            points: task.points,
                            timeLimit: null, // 批量导入暂不支持时间限制
                            status: 'taken', // 自动承接，状态为taken
                            createdAt: now.toISOString(),
                            expireAt: null,
                            startedAt: now.toISOString(),
                            completedAt: null,
                            settledAt: null,
                            displayCreatedAt: now.toLocaleString(),
                            displayExpireAt: null
                        };
                        
                        bountyData.push(bounty);
                        successCount++;
                    } catch (error) {
                        console.error('创建任务失败:', error);
                        failCount++;
                    }
                });
                
                // 保存数据
                saveData();
                refreshBountyList();
                refreshBankPage();
                
                // 显示结果
                let message = `批量导入完成！\n\n✅ 成功创建：${successCount} 个任务`;
                if (failCount > 0) {
                    message += `\n❌ 失败：${failCount} 个任务`;
                }
                message += `\n\n📋 任务已自动分配承接者：\n• 一一发布的任务 → 七七承接\n• 七七发布的任务 → 一一承接`;
                alert(message);
                
                // 关闭模态框
                hideBatchImportModal();
                
                // 如果成功导入了任务，自动切换到悬赏任务页面
                if (successCount > 0) {
                    showPage('cards');
                }
            });
        }
        
        function cancelBatchImport() {
            hideBatchImportModal();
        }
        
        function hideBatchImportModal() {
            const modal = document.getElementById('batch-import-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            
            // 清空数据
            document.getElementById('batch-import-text').value = '';
            batchImportData = [];
            
            // 重置模态框位置
            resetModalPosition(modalBox);
        }
        
        // 确认输入相关函数
        function showConfirmInputModal(title, message, expectedText, callback) {
            confirmInputCallback = callback;
            confirmInputExpectedText = expectedText;
            
            document.getElementById('confirm-input-title').textContent = title;
            document.getElementById('confirm-input-message').innerHTML = message;
            document.getElementById('confirm-input-text').placeholder = `请输入 "${expectedText}" 确认`;
            document.getElementById('confirm-input-text').value = '';
            
            document.getElementById('confirm-input-modal').style.display = 'flex';
            
            // 自动聚焦
            setTimeout(() => {
                document.getElementById('confirm-input-text').focus();
            }, 100);
        }
        
        function submitConfirmInput() {
            const inputText = document.getElementById('confirm-input-text').value;
            
            if (inputText === confirmInputExpectedText) {
                hideConfirmInputModal();
                if (confirmInputCallback) {
                    confirmInputCallback();
                    confirmInputCallback = null;
                }
            } else {
                // 显示错误提示
                const inputElement = document.getElementById('confirm-input-text');
                inputElement.style.borderColor = '#dc3545';
                inputElement.style.boxShadow = '0 0 0 2px rgba(220, 53, 69, 0.1)';
                inputElement.style.animation = 'shake 0.5s ease-in-out';
                
                // 清空输入框并重新聚焦
                inputElement.value = '';
                inputElement.focus();
                
                // 恢复正常样式
                setTimeout(() => {
                    inputElement.style.borderColor = '#ccc';
                    inputElement.style.boxShadow = 'none';
                    inputElement.style.animation = 'none';
                }, 1000);
            }
        }
        
        function cancelConfirmInput() {
            hideConfirmInputModal();
            confirmInputCallback = null;
        }
        
        function hideConfirmInputModal() {
            const modal = document.getElementById('confirm-input-modal');
            const modalBox = modal.querySelector('.modal-box');
            modal.style.display = 'none';
            
            // 清空数据
            document.getElementById('confirm-input-text').value = '';
            confirmInputExpectedText = '';
            
            // 重置模态框位置
            resetModalPosition(modalBox);
        }
        
        // 一键删除所有悬赏
        function clearAllBounties() {
            if (bountyData.length === 0) {
                alert('当前没有悬赏任务可以删除！');
                return;
            }
            
            const confirmMessage = `
                <div style="color: #721c24; font-weight: bold; margin-bottom: 15px;">确定要删除所有 ${bountyData.length} 个悬赏任务吗？</div>
                <div style="margin-bottom: 10px;"><strong>此操作将：</strong></div>
                <ul style="margin: 10px 0; padding-left: 20px; color: #721c24;">
                    <li>删除所有悬赏任务（包括进行中和已完成的）</li>
                    <li>退还未结算悬赏的积分给发布者</li>
                    <li><strong>此操作无法撤销</strong></li>
                </ul>
            `;
            
            showConfirmInputModal(
                '🗑️ 删除所有悬赏',
                confirmMessage,
                'DELETE',
                () => {
                    requireAuth(() => {
                        performClearAllBounties();
                    });
                }
            );
        }
        
        function performClearAllBounties() {
            let refundedPoints = 0;
            let deletedCount = 0;
            
            bountyData.forEach(bounty => {
                // 统计需要退还的积分
                if (bounty.status === 'open' || bounty.status === 'taken') {
                    // 未结算的悬赏，退还积分给发布者
                    if (bounty.publisher !== 'system') {
                        bankData[bounty.publisher].reward += bounty.points;
                        bankData[bounty.publisher].publish += bounty.points; // 撤销发布成本
                        
                        refundedPoints += bounty.points;
                    }
                }
                deletedCount++;
            });
            
            // 清空悬赏数据
            bountyData = [];
            
            // 添加历史记录
            const historyEntry = {
                id: `history_${Date.now()}`,
                type: 'system',
                action: 'clear_all_bounties',
                description: `管理员清空所有悬赏`,
                details: {
                    deletedCount: deletedCount,
                    refundedPoints: refundedPoints,
                    timestamp: new Date().toLocaleString()
                }
            };
            historyData.unshift(historyEntry);
            
            // 保存数据
            saveData();
            refreshBountyList();
            refreshBankPage();
            
            // 显示结果
            let message = `🗑️ 清空完成！\n\n删除了 ${deletedCount} 个悬赏任务`;
            if (refundedPoints > 0) {
                message += `\n退还了 ${refundedPoints} 积分给发布者`;
            }
            message += '\n\n操作已记录到历史中。';
            
            alert(message);
        }

        // Firebase初始化监听
        async function initializeFirebase() {
            try {
                // 测试连接
                const testRef = window.firebaseDb.ref(window.firebaseDb.database, '.info/connected');
                window.firebaseDb.onValue(testRef, (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        updateConnectionStatus(true, 'Firebase连接成功');
                        // 连接成功后自动下载云端数据
                        autoDownloadFromFirebase();
                    } else {
                        updateConnectionStatus(false, 'Firebase连接断开');
                    }
                });
                
                isFirebaseReady = true;
                console.log('Firebase初始化成功');
            } catch (error) {
                console.error('Firebase初始化失败:', error);
                updateConnectionStatus(false, 'Firebase初始化失败');
            }
        }

        // 自动下载云端数据（静默）
        async function autoDownloadFromFirebase() {
            if (!isFirebaseReady || !isOnline) {
                return;
            }

            try {
                updateSyncingStatus('正在同步云端数据...');

                const snapshot = await window.firebaseDb.get(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'));
                
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    const localData = localStorage.getItem('pointSystemV2');
                    
                    // 比较本地和云端数据的更新时间
                    let shouldUpdate = true;
                    let forceUpdateTaskPool = false;
                    
                    if (localData) {
                        try {
                            const parsedLocal = JSON.parse(localData);
                            const localTime = parsedLocal.lastUpdated ? new Date(parsedLocal.lastUpdated) : new Date(0);
                            const cloudTime = cloudData.lastUpdated ? new Date(cloudData.lastUpdated) : new Date(0);
                            
                            // 检查任务池数据是否不同
                            const localTaskPool = parsedLocal.taskPool || [];
                            const cloudTaskPool = cloudData.taskPool || [];
                            const taskPoolDifferent = localTaskPool.length !== cloudTaskPool.length || 
                                JSON.stringify(localTaskPool) !== JSON.stringify(cloudTaskPool);
                            
                            // 如果任务池数据不同且云端数据不为空，则强制更新任务池
                            if (taskPoolDifferent && cloudTaskPool.length > 0) {
                                forceUpdateTaskPool = true;
                                console.log('检测到任务池数据不同，将强制更新');
                            }
                            
                            // 如果本地数据比云端数据更新，则不覆盖（除非需要强制更新任务池）
                            shouldUpdate = cloudTime > localTime || forceUpdateTaskPool;
                            
                            if (forceUpdateTaskPool && cloudTime <= localTime) {
                                console.log('由于任务池数据不同，强制同步云端数据');
                            }
                        } catch (e) {
                            console.log('本地数据解析失败，使用云端数据');
                        }
                    }
                    
                    if (shouldUpdate) {
                        // 恢复云端数据
                        bountyData = cloudData.bountyData || [];
                        bankData = cloudData.bankData || { qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 }, yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 } };
                        // 为现有云端数据添加新字段兼容性
                        // 处理旧的daily字段
                        if (bankData.qiqi.daily !== undefined && bankData.qiqi.dailyIncome === undefined) {
                            // 旧数据迁移：将daily分为dailyIncome和dailyPenalty
                            bankData.qiqi.dailyIncome = Math.max(0, bankData.qiqi.daily);
                            bankData.qiqi.dailyPenalty = Math.min(0, bankData.qiqi.daily);
                            delete bankData.qiqi.daily;
                        }
                        if (bankData.yiyi.daily !== undefined && bankData.yiyi.dailyIncome === undefined) {
                            bankData.yiyi.dailyIncome = Math.max(0, bankData.yiyi.daily);
                            bankData.yiyi.dailyPenalty = Math.min(0, bankData.yiyi.daily);
                            delete bankData.yiyi.daily;
                        }
                        // 添加发布/获取字段兼容性
                        if (bankData.qiqi.bounty !== undefined && bankData.qiqi.publish === undefined) {
                            // 旧数据迁移：将bounty分为publish和obtain
                            bankData.qiqi.publish = Math.min(0, bankData.qiqi.bounty); // 负数部分作为发布成本
                            bankData.qiqi.obtain = Math.max(0, bankData.qiqi.bounty);  // 正数部分作为获得收益
                            delete bankData.qiqi.bounty;
                        }
                        if (bankData.yiyi.bounty !== undefined && bankData.yiyi.publish === undefined) {
                            bankData.yiyi.publish = Math.min(0, bankData.yiyi.bounty);
                            bankData.yiyi.obtain = Math.max(0, bankData.yiyi.bounty);
                            delete bankData.yiyi.bounty;
                        }
                        // 确保新字段存在
                        if (!bankData.qiqi.publish) bankData.qiqi.publish = 0;
                        if (!bankData.qiqi.obtain) bankData.qiqi.obtain = 0;
                        if (!bankData.yiyi.publish) bankData.yiyi.publish = 0;
                        if (!bankData.yiyi.obtain) bankData.yiyi.obtain = 0;
                        if (!bankData.qiqi.dailyIncome) bankData.qiqi.dailyIncome = 0;
                        if (!bankData.qiqi.dailyPenalty) bankData.qiqi.dailyPenalty = 0;
                        if (!bankData.yiyi.dailyIncome) bankData.yiyi.dailyIncome = 0;
                        if (!bankData.yiyi.dailyPenalty) bankData.yiyi.dailyPenalty = 0;
                        historyData = cloudData.historyData || [];
                        bountyCounter = cloudData.bountyCounter || 1;
                        dailyTasksContent = cloudData.dailyTasksContent || '';
                        
                        // 恢复每日任务数据
                        if (cloudData.dailyTasks) {
                            // 检查云端数据格式
                            if (Array.isArray(cloudData.dailyTasks.qiqi) && Array.isArray(cloudData.dailyTasks.yiyi)) {
                                dailyTasks = {
                                    qiqi: cloudData.dailyTasks.qiqi || [null, null, null],
                                    yiyi: cloudData.dailyTasks.yiyi || [null, null, null],
                                    progress: cloudData.dailyTasks.progress || { qiqi: 0, yiyi: 0 },
                                    extraTasks: cloudData.dailyTasks.extraTasks || { qiqi: [], yiyi: [] },
                                    clearedCompleted: cloudData.dailyTasks.clearedCompleted || { qiqi: [], yiyi: [] }
                                };
                            } else {
                                // 格式不正确，使用默认值
                                dailyTasks = {
                                    qiqi: [null, null, null],
                                    yiyi: [null, null, null],
                                    progress: { qiqi: 0, yiyi: 0 },
                                    extraTasks: { qiqi: [], yiyi: [] },
                                    clearedCompleted: { qiqi: [], yiyi: [] }
                                };
                            }
                        } else {
                            // 没有云端数据，使用默认值
                            dailyTasks = {
                                qiqi: [null, null, null],
                                yiyi: [null, null, null],
                                progress: { qiqi: 0, yiyi: 0 },
                                extraTasks: { qiqi: [], yiyi: [] },
                                clearedCompleted: { qiqi: [], yiyi: [] }
                            };
                        }
                        taskPool = cloudData.taskPool || [];
                        taskCounter = cloudData.taskCounter || 1;
                        lastResetDate = cloudData.lastResetDate || null;
                        
                        // 恢复任务奖励系统数据
                        taskRewardSystem = cloudData.taskRewardSystem || {
                            qiqi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null },
                            yiyi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null }
                        };
                        
                        // 恢复周目标数据 - 永远取最高进度
                        if (cloudData.weeklyGoals) {
                            const cloudGoals = cloudData.weeklyGoals;
                            const localGoals = weeklyGoals;
                            
                            // 智能合并 - 按周进度取最优状态
                            const localTotal = {
                                qiqi: localGoals.qiqi?.progress || 0,
                                yiyi: localGoals.yiyi?.progress || 0
                            };
                            const cloudTotal = {
                                qiqi: cloudGoals.qiqi?.progress || 0,
                                yiyi: cloudGoals.yiyi?.progress || 0
                            };
                            
                            weeklyGoals = {
                                qiqi: {
                                    progress: Math.max(localTotal.qiqi, cloudTotal.qiqi),
                                    weekStart: localGoals.qiqi?.weekStart || cloudGoals.qiqi?.weekStart
                                },
                                yiyi: {
                                    progress: Math.max(localTotal.yiyi, cloudTotal.yiyi),
                                    weekStart: localGoals.yiyi?.weekStart || cloudGoals.yiyi?.weekStart
                                },
                                target: cloudGoals.target || localGoals.target || 25,
                                lastPenaltyCheck: cloudGoals.lastPenaltyCheck || localGoals.lastPenaltyCheck
                            };
                            
                            // 自动上传合并后的数据到云端，确保两端同步
                            setTimeout(() => {
                                if (isFirebaseReady && isOnline) {
                                    const syncData = {
                                        bountyData, bankData, historyData, bountyCounter,
                                        dailyTasksContent, dailyTasks, taskPool, taskCounter,
                                        lastResetDate, weeklyData, monthlyStarBonus,
                                        dailyTaskSnapshots, penaltySystemStartDate, weeklyStats,
                                        taskRewardSystem, weeklyGoals, streakResetTracker,
                                        lastUpdated: new Date().toISOString()
                                    };
                                    autoUploadToFirebase(syncData);
                                    console.log('🔄 自动上传合并后的积分池数据');
                                }
                            }, 1000);
                            
                            console.log('🔄 自动智能合并完成：永远取最高分');
                        }
                        
                        // 恢复每周和月度数据
                        weeklyData = cloudData.weeklyData || { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
                        monthlyStarBonus = cloudData.monthlyStarBonus || { qiqi: 0, yiyi: 0, lastBonusDate: new Date().toISOString() };
                        
                        // 加载任务快照数据
                        dailyTaskSnapshots = cloudData.dailyTaskSnapshots || {};
                        penaltySystemStartDate = cloudData.penaltySystemStartDate || null;
                        
                        // 恢复周度积分统计数据
                        weeklyStats = cloudData.weeklyStats || [];
                        
                        // 恢复连胜重置跟踪器数据
                        streakResetTracker = cloudData.streakResetTracker || {
                            qiqi: {}, 
                            yiyi: {}
                        };
                        
                        
                        // 检查是否需要每日重置
                        checkDailyReset();
                        
                        console.log('云端数据加载完成, dailyTasks:', JSON.stringify(dailyTasks));
                        
                        // 更新界面
                        if (dailyTasksContent) {
                            const contentElement = document.getElementById('daily-tasks-content');
                            if (contentElement) {
                                contentElement.innerHTML = dailyTasksContent;
                            }
                        }
                        
                        // 保存到本地
                        localStorage.setItem('pointSystemV2', JSON.stringify({
                            bountyData,
                            bankData,
                            historyData,
                            bountyCounter,
                            dailyTasksContent,
                            dailyTasks,
                            taskPool,
                            taskCounter,
                            lastResetDate,
                            weeklyData,
                            monthlyStarBonus,
                            dailyTaskSnapshots,
                            penaltySystemStartDate,
                            taskRewardSystem,
                                lastUpdated: cloudData.lastUpdated
                        }));
                        
                        // 刷新所有页面
                        refreshBankPage();
                        refreshHistoryPage();
                        refreshBountyList();
                        refreshDailyTasks();
                        updateTaskPoolPreview();
                        refreshTaskPoolDisplay(); // 添加任务池管理界面刷新
                        
                        console.log('任务池同步状态:', taskPool.length, '个任务:', taskPool.map(t => t.name));
                        
                        updateLastSyncTime();
                        updateConnectionStatus(true, '数据同步完成');
                        console.log('自动同步云端数据成功');
                    } else {
                        updateConnectionStatus(true, '本地数据为最新版本');
                        console.log('本地数据较新，跳过同步，当前任务池:', taskPool.length, '个任务');
                    }
                } else {
                    updateConnectionStatus(true, '云端暂无数据');
                    console.log('云端暂无数据');
                }
            } catch (error) {
                console.error('自动同步失败:', error);
                updateConnectionStatus(false, '自动同步失败：' + error.message);
            }
        }

        // 手动同步数据
        // 手动设置积分池功能
        function manualSetPointsPool() {
            // 添加密码保护
            const password = prompt('⚙️ 手动设置周目标需要管理员权限！\n\n请输入管理员密码：');
            if (!password) {
                alert('操作已取消');
                return;
            }
            
            // 验证密码
            if (password !== 'admin2024') {
                alert('❌ 密码错误！无法设置周目标。');
                return;
            }
            
            let settingsText = '🔧 周目标手动设置\n\n';
            settingsText += `当前状态:\n`;
            settingsText += `七七周进度: ${weeklyGoals.qiqi.progress || 0}分\n`;
            settingsText += `一一周进度: ${weeklyGoals.yiyi.progress || 0}分\n`;
            settingsText += `周目标: ${weeklyGoals.target || 25}分\n\n`;
            settingsText += `请输入新的积分值（格式：qiqi进度,yiyi进度,周目标）\n`;
            settingsText += `例如：15,12,25`;
            
            const newValues = prompt(settingsText);
            if (!newValues) return;
            
            try {
                const [qiqiProgress, yiyiProgress, target] = newValues.split(',').map(v => parseInt(v.trim()) || 0);
                
                if (confirm(`确认设置周目标？\n\n七七: ${qiqiProgress}分\n一一: ${yiyiProgress}分\n周目标: ${target}分`)) {
                    const oldData = {
                        qiqiProgress: weeklyGoals.qiqi.progress || 0,
                        yiyiProgress: weeklyGoals.yiyi.progress || 0,
                        target: weeklyGoals.target || 25
                    };
                    
                    weeklyGoals.qiqi.progress = qiqiProgress;
                    weeklyGoals.yiyi.progress = yiyiProgress;
                    weeklyGoals.target = target;
                    
                    addHistory(`管理员手动设置周目标：七七(${oldData.qiqiProgress}→${qiqiProgress}) 一一(${oldData.yiyiProgress}→${yiyiProgress}) 目标(${oldData.target}→${target})`, 'system');
                    
                    saveData();
                    refreshWeeklyGoals();
                    
                    alert('✅ 周目标设置完成！');
                }
            } catch (error) {
                alert('❌ 输入格式错误！请使用正确格式：数字,数字,数字,数字');
            }
        }

        // 积分池备份恢复功能
        function backupPointsPool() {
            const actions = [
                '1. 💾 创建积分池备份',
                '2. 📥 恢复积分池备份',
                '3. 🔍 查看当前备份'
            ];
            
            const choice = prompt('💾 积分池备份恢复系统\n\n请选择操作：\n' + actions.join('\n') + '\n\n请输入数字(1-3):');
            
            switch(choice) {
                case '1':
                    createPointsPoolBackup();
                    break;
                case '2':
                    restorePointsPoolBackup();
                    break;
                case '3':
                    showPointsPoolBackup();
                    break;
                default:
                    if (choice) alert('❌ 无效选择！请输入1-3之间的数字。');
            }
        }
        
        function createWeeklyGoalsBackup() {
            try {
                const backup = {
                    weeklyGoals: JSON.parse(JSON.stringify(weeklyGoals)),
                    backupTime: new Date().toISOString(),
                    backupBy: 'manual'
                };
                
                localStorage.setItem('weeklyGoalsBackup', JSON.stringify(backup));
                
                let info = `💾 周目标备份已创建！\n\n`;
                info += `七七周进度: ${weeklyGoals.qiqi.progress || 0}分\n`;
                info += `一一周进度: ${weeklyGoals.yiyi.progress || 0}分\n`;
                info += `周目标: ${weeklyGoals.target || 25}分\n`;
                info += `备份时间: ${new Date().toLocaleString()}`;
                
                alert(info);
                console.log('周目标备份创建成功:', backup);
            } catch (error) {
                alert('❌ 备份创建失败：' + error.message);
            }
        }
        
        function restorePointsPoolBackup() {
            try {
                const backupData = localStorage.getItem('pointsPoolBackup');
                if (!backupData) {
                    alert('❌ 未找到积分池备份！请先创建备份。');
                    return;
                }
                
                const backup = JSON.parse(backupData);
                const backupTime = new Date(backup.backupTime).toLocaleString();
                
                let confirmMsg = `📥 确认恢复积分池备份？\n\n`;
                confirmMsg += `备份时间: ${backupTime}\n\n`;
                confirmMsg += `备份数据:\n`;
                confirmMsg += `七七待提现: ${backup.pointsPool.qiqi.pending}分\n`;
                confirmMsg += `七七已提现: ${backup.pointsPool.qiqi.withdrawn}分\n`;
                confirmMsg += `一一待提现: ${backup.pointsPool.yiyi.pending}分\n`;
                confirmMsg += `一一已提现: ${backup.pointsPool.yiyi.withdrawn}分\n\n`;
                confirmMsg += `当前数据将被覆盖！`;
                
                if (confirm(confirmMsg)) {
                    const oldData = JSON.parse(JSON.stringify(pointsPool));
                    pointsPool = backup.pointsPool;
                    pointsPool.lastUpdateTime = new Date().toISOString();
                    
                    addHistory(`管理员从备份恢复积分池(${backupTime})`, 'system');
                    saveData();
                    refreshWeeklyGoals();
                    
                    alert(`✅ 积分池已从备份恢复！\n备份时间: ${backupTime}`);
                    console.log('积分池恢复成功:', { old: oldData, restored: pointsPool });
                }
            } catch (error) {
                alert('❌ 恢复失败：' + error.message);
            }
        }
        
        function showPointsPoolBackup() {
            try {
                const backupData = localStorage.getItem('pointsPoolBackup');
                if (!backupData) {
                    alert('❌ 未找到积分池备份！');
                    return;
                }
                
                const backup = JSON.parse(backupData);
                const backupTime = new Date(backup.backupTime).toLocaleString();
                
                let info = `🔍 积分池备份信息\n\n`;
                info += `备份时间: ${backupTime}\n\n`;
                info += `备份数据:\n`;
                info += `七七待提现: ${backup.pointsPool.qiqi.pending}分\n`;
                info += `七七已提现: ${backup.pointsPool.qiqi.withdrawn}分\n`;
                info += `一一待提现: ${backup.pointsPool.yiyi.pending}分\n`;
                info += `一一已提现: ${backup.pointsPool.yiyi.withdrawn}分\n\n`;
                info += `当前数据:\n`;
                info += `七七待提现: ${pointsPool.qiqi.pending}分\n`;
                info += `七七已提现: ${pointsPool.qiqi.withdrawn}分\n`;
                info += `一一待提现: ${pointsPool.yiyi.pending}分\n`;
                info += `一一已提现: ${pointsPool.yiyi.withdrawn}分`;
                
                alert(info);
            } catch (error) {
                alert('❌ 查看备份失败：' + error.message);
            }
        }

        // 积分池同步调试函数
        async function debugPointsPoolSync() {
            try {
                console.log('=== 积分池调试信息 ===');
                console.log('本地积分池数据:', JSON.stringify(pointsPool, null, 2));
                
                if (!isFirebaseReady) {
                    alert('Firebase未初始化，无法检查云端数据');
                    return;
                }
                
                const snapshot = await window.firebaseDb.get(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2/pointsPool'));
                
                if (snapshot.exists()) {
                    const cloudPointsPool = snapshot.val();
                    console.log('云端积分池数据:', JSON.stringify(cloudPointsPool, null, 2));
                    
                    let debugInfo = '=== 积分池同步调试 ===\n\n';
                    debugInfo += '本地数据:\n';
                    debugInfo += `七七待提现: ${pointsPool.qiqi.pending}分\n`;
                    debugInfo += `七七已提现: ${pointsPool.qiqi.withdrawn}分\n`;
                    debugInfo += `一一待提现: ${pointsPool.yiyi.pending}分\n`;
                    debugInfo += `一一已提现: ${pointsPool.yiyi.withdrawn}分\n\n`;
                    
                    debugInfo += '云端数据:\n';
                    debugInfo += `七七待提现: ${cloudPointsPool.qiqi?.pending || 0}分\n`;
                    debugInfo += `七七已提现: ${cloudPointsPool.qiqi?.withdrawn || 0}分\n`;
                    debugInfo += `一一待提现: ${cloudPointsPool.yiyi?.pending || 0}分\n`;
                    debugInfo += `一一已提现: ${cloudPointsPool.yiyi?.withdrawn || 0}分\n\n`;
                    
                    if (JSON.stringify(pointsPool) !== JSON.stringify(cloudPointsPool)) {
                        debugInfo += '⚠️ 数据不同步！建议点击"立即同步"按钮';
                    } else {
                        debugInfo += '✅ 数据已同步';
                    }
                    
                    alert(debugInfo);
                } else {
                    alert('云端暂无积分池数据，这可能是同步问题的原因！\n建议点击"立即同步"按钮上传当前数据。');
                }
                
            } catch (error) {
                console.error('积分池调试失败:', error);
                alert('调试失败: ' + error.message);
            }
        }

        async function manualSyncData() {
            if (!isFirebaseReady) {
                alert('Firebase未初始化，无法同步');
                return;
            }

            if (!isOnline) {
                alert('网络连接断开，无法同步');
                return;
            }

            try {
                // 直接智能合并同步，不用选择
                const snapshot = await window.firebaseDb.get(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'));
                
                if (snapshot.exists()) {
                    const cloudData = snapshot.val();
                    const cloudPoints = cloudData.pointsPool || {};
                    const localPoints = pointsPool;
                    
                    // 智能合并 - 按总积分取最优状态，防止重复计分
                    const localTotal = {
                        qiqi: (localPoints.qiqi.pending || 0) + (localPoints.qiqi.withdrawn || 0),
                        yiyi: (localPoints.yiyi.pending || 0) + (localPoints.yiyi.withdrawn || 0)
                    };
                    const cloudTotal = {
                        qiqi: (cloudPoints.qiqi?.pending || 0) + (cloudPoints.qiqi?.withdrawn || 0),
                        yiyi: (cloudPoints.yiyi?.pending || 0) + (cloudPoints.yiyi?.withdrawn || 0)
                    };
                    
                    const mergedPoints = {
                        qiqi: localTotal.qiqi >= cloudTotal.qiqi ? {
                            // 本地总积分更高，使用本地数据
                            pending: localPoints.qiqi.pending || 0,
                            withdrawn: localPoints.qiqi.withdrawn || 0,
                            lastWithdrawDate: localPoints.qiqi.lastWithdrawDate || null,
                            weekStart: localPoints.qiqi.weekStart
                        } : {
                            // 云端总积分更高，使用云端数据
                            pending: cloudPoints.qiqi?.pending || 0,
                            withdrawn: cloudPoints.qiqi?.withdrawn || 0,
                            lastWithdrawDate: cloudPoints.qiqi?.lastWithdrawDate || null,
                            weekStart: cloudPoints.qiqi?.weekStart
                        },
                        yiyi: localTotal.yiyi >= cloudTotal.yiyi ? {
                            // 本地总积分更高，使用本地数据
                            pending: localPoints.yiyi.pending || 0,
                            withdrawn: localPoints.yiyi.withdrawn || 0,
                            lastWithdrawDate: localPoints.yiyi.lastWithdrawDate || null,
                            weekStart: localPoints.yiyi.weekStart
                        } : {
                            // 云端总积分更高，使用云端数据
                            pending: cloudPoints.yiyi?.pending || 0,
                            withdrawn: cloudPoints.yiyi?.withdrawn || 0,
                            lastWithdrawDate: cloudPoints.yiyi?.lastWithdrawDate || null,
                            weekStart: cloudPoints.yiyi?.weekStart
                        },
                        autoWithdrawTime: localPoints.autoWithdrawTime || '23:30',
                        lastAutoWithdraw: localPoints.lastAutoWithdraw,
                        protectionLevel: 'HIGH',
                        lastUpdateTime: new Date().toISOString()
                    };
                    
                    // 更新本地数据已移除 - 使用新的周目标系统
                    
                    // 同步所有数据到云端
                    const syncData = {
                        bountyData, bankData, historyData, bountyCounter,
                        dailyTasksContent, dailyTasks, taskPool, taskCounter,
                        lastResetDate, weeklyData, monthlyStarBonus,
                        dailyTaskSnapshots, penaltySystemStartDate, weeklyStats,
                        taskRewardSystem, weeklyGoals, streakResetTracker,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    await window.firebaseDb.set(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'), syncData);
                    saveData();
                    refreshWeeklyGoals();
                    
                    alert(`🔄 智能同步完成！积分已合并：\n七七: 待提现${mergedPoints.qiqi.pending}分, 已提现${mergedPoints.qiqi.withdrawn}分 (总计${localTotal.qiqi >= cloudTotal.qiqi ? localTotal.qiqi : cloudTotal.qiqi}分)\n一一: 待提现${mergedPoints.yiyi.pending}分, 已提现${mergedPoints.yiyi.withdrawn}分 (总计${localTotal.yiyi >= cloudTotal.yiyi ? localTotal.yiyi : cloudTotal.yiyi}分)`);
                } else {
                    // 云端无数据，直接上传本地数据
                    const currentData = {
                        bountyData, bankData, historyData, bountyCounter,
                        dailyTasksContent, dailyTasks, taskPool, taskCounter,
                        lastResetDate, weeklyData, monthlyStarBonus,
                        dailyTaskSnapshots, penaltySystemStartDate, weeklyStats,
                        taskRewardSystem, weeklyGoals, streakResetTracker,
                        lastUpdated: new Date().toISOString()
                    };
                    await window.firebaseDb.set(window.firebaseDb.ref(window.firebaseDb.database, 'pointSystemV2'), currentData);
                    alert('✅ 本地数据已上传到云端！');
                }
                
                updateLastSyncTime();
                updateConnectionStatus(true, '智能同步完成');
                console.log('智能同步操作完成');
                
            } catch (error) {
                console.error('同步失败:', error);
                alert('❌ 同步失败：' + error.message);
            }
        }

        // 显示同步调试信息
        function showSyncDebugInfo() {
            const debugInfo = [
                `Firebase就绪状态: ${isFirebaseReady ? '✅ 已初始化' : '❌ 未初始化'}`,
                `网络连接状态: ${isOnline ? '✅ 已连接' : '❌ 离线'}`,
                `上次同步时间: ${lastSyncTime ? new Date(lastSyncTime).toLocaleString() : '未同步'}`,
                `当前任务池数量: ${taskPool.length}个任务`,
                `当前每日任务: 七七${dailyTasks.qiqi.filter(t => t).length}/3, 一一${dailyTasks.yiyi.filter(t => t).length}/3`,
                `浏览器: ${navigator.userAgent.includes('Mobile') ? '移动端' : '桌面端'}`,
                `时间: ${new Date().toLocaleString()}`
            ].join('\n');

            alert('🔍 同步状态信息：\n\n' + debugInfo);
            console.log('同步调试信息:', {
                isFirebaseReady,
                isOnline,
                lastSyncTime,
                taskPoolLength: taskPool.length,
                dailyTasksStatus: dailyTasks,
                userAgent: navigator.userAgent
            });
        }

        function loadData() {
            const saved = localStorage.getItem('pointSystemV2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    bountyData = data.bountyData || [];
                    bankData = data.bankData || { qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 }, yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0 } };
                    // 为现有数据添加新字段兼容性
                    // 处理旧的daily字段
                    if (bankData.qiqi.daily !== undefined && bankData.qiqi.dailyIncome === undefined) {
                        // 旧数据迁移：将daily分为dailyIncome和dailyPenalty
                        bankData.qiqi.dailyIncome = Math.max(0, bankData.qiqi.daily);
                        bankData.qiqi.dailyPenalty = Math.min(0, bankData.qiqi.daily);
                        delete bankData.qiqi.daily;
                    }
                    if (bankData.yiyi.daily !== undefined && bankData.yiyi.dailyIncome === undefined) {
                        bankData.yiyi.dailyIncome = Math.max(0, bankData.yiyi.daily);
                        bankData.yiyi.dailyPenalty = Math.min(0, bankData.yiyi.daily);
                        delete bankData.yiyi.daily;
                    }
                    // 添加发布/获取字段兼容性
                    if (bankData.qiqi.bounty !== undefined && bankData.qiqi.publish === undefined) {
                        // 旧数据迁移：将bounty分为publish和obtain
                        bankData.qiqi.publish = Math.min(0, bankData.qiqi.bounty); // 负数部分作为发布成本
                        bankData.qiqi.obtain = Math.max(0, bankData.qiqi.bounty);  // 正数部分作为获得收益
                        delete bankData.qiqi.bounty;
                    }
                    if (bankData.yiyi.bounty !== undefined && bankData.yiyi.publish === undefined) {
                        bankData.yiyi.publish = Math.min(0, bankData.yiyi.bounty);
                        bankData.yiyi.obtain = Math.max(0, bankData.yiyi.bounty);
                        delete bankData.yiyi.bounty;
                    }
                    // 确保新字段存在
                    if (!bankData.qiqi.publish) bankData.qiqi.publish = 0;
                    if (!bankData.qiqi.obtain) bankData.qiqi.obtain = 0;
                    if (!bankData.yiyi.publish) bankData.yiyi.publish = 0;
                    if (!bankData.yiyi.obtain) bankData.yiyi.obtain = 0;
                    if (!bankData.qiqi.dailyIncome) bankData.qiqi.dailyIncome = 0;
                    if (!bankData.qiqi.dailyPenalty) bankData.qiqi.dailyPenalty = 0;
                    if (!bankData.yiyi.dailyIncome) bankData.yiyi.dailyIncome = 0;
                    if (!bankData.yiyi.dailyPenalty) bankData.yiyi.dailyPenalty = 0;
                    historyData = data.historyData || [];
                    bountyCounter = data.bountyCounter || 1;
                    dailyTasksContent = data.dailyTasksContent || '';
                    
                    // 加载每日任务数据 - 兼容旧格式
                    if (data.dailyTasks) {
                        // 检查数据格式并加载
                        if (Array.isArray(data.dailyTasks.qiqi) && Array.isArray(data.dailyTasks.yiyi)) {
                            // 新格式，直接使用
                            dailyTasks = {
                                qiqi: data.dailyTasks.qiqi || [null, null, null],
                                yiyi: data.dailyTasks.yiyi || [null, null, null],
                                progress: data.dailyTasks.progress || { qiqi: 0, yiyi: 0 },
                                extraTasks: data.dailyTasks.extraTasks || { qiqi: [], yiyi: [] },
                                clearedCompleted: data.dailyTasks.clearedCompleted || { qiqi: [], yiyi: [] }
                            };
                        } else {
                            // 其他格式，使用默认值
                            dailyTasks = {
                                qiqi: [null, null, null],
                                yiyi: [null, null, null],
                                progress: { qiqi: 0, yiyi: 0 },
                                extraTasks: { qiqi: [], yiyi: [] },
                                clearedCompleted: { qiqi: [], yiyi: [] }
                            };
                        }
                    } else {
                        // 没有数据，使用默认值
                        dailyTasks = {
                            qiqi: [null, null, null],
                            yiyi: [null, null, null],
                            progress: { qiqi: 0, yiyi: 0 },
                            extraTasks: { qiqi: [], yiyi: [] },
                            clearedCompleted: { qiqi: [], yiyi: [] }
                        };
                    }
                    
                    taskPool = data.taskPool || [];
                    taskCounter = data.taskCounter || 1;
                    lastResetDate = data.lastResetDate || null;
                    
                    // 加载每周积分数据
                    weeklyData = data.weeklyData || { qiqi: 0, yiyi: 0, lastResetDate: new Date().toISOString() };
                    
                    // 加载月度星星奖励数据
                    monthlyStarBonus = data.monthlyStarBonus || { qiqi: 0, yiyi: 0, lastBonusDate: new Date().toISOString() };
                    
                    // 加载任务快照数据
                    dailyTaskSnapshots = data.dailyTaskSnapshots || {};
                    penaltySystemStartDate = data.penaltySystemStartDate || null;
                    
                    // 加载周度统计数据
                    weeklyStats = data.weeklyStats || {
                        qiqi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
                        yiyi: { reward: 0, penalty: 0, publish: 0, obtain: 0, trade: 0, dailyIncome: 0, dailyPenalty: 0, starIncome: 0 },
                        currentWeek: getCurrentWeekNumber(),
                        weekStart: getWeekStartDate().toDateString()
                    };
                    
                    // 加载任务奖励系统数据
                    taskRewardSystem = data.taskRewardSystem || {
                        qiqi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null },
                        yiyi: { level: 0, tasksCompleted: 0, pendingReward: 0, lastClaimDate: null }
                    };
                    
                    // 加载周目标数据
                    weeklyGoals = data.weeklyGoals || {
                        qiqi: { progress: 0, weekStart: null },
                        yiyi: { progress: 0, weekStart: null },
                        target: 25,
                        lastPenaltyCheck: null
                    };
                    
                    // 加载连胜重置跟踪器
                    streakResetTracker = data.streakResetTracker || {
                        qiqi: {},
                        yiyi: {}
                    };
                    
                    
                    // 检查是否需要每日重置
                    checkDailyReset();
                    
                    console.log('本地数据加载完成, dailyTasks:', JSON.stringify(dailyTasks));
                    console.log('任务池加载状态:', taskPool.length, '个任务:', taskPool.map(t => t.name));
                    
                    if (dailyTasksContent) {
                        const contentElement = document.getElementById('daily-tasks-content');
                        if (contentElement) {
                            contentElement.innerHTML = dailyTasksContent;
                        }
                    }
                    
                    // 刷新界面显示
                    setTimeout(() => {
                        updateTaskPoolPreview();
                        refreshTaskPoolDisplay();
                        refreshDailyTasks();
                    }, 100);
                } catch (e) {
                    console.error('数据加载失败:', e);
                }
            }
        }

        // PWA Service Worker 注册
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    console.log('PWA: 开始注册 Service Worker');
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });
                    
                    console.log('PWA: Service Worker 注册成功', registration.scope);
                    
                    // 监听 Service Worker 更新
                    registration.addEventListener('updatefound', () => {
                        console.log('PWA: 发现 Service Worker 更新');
                        const newWorker = registration.installing;
                        
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('PWA: 新版本可用，建议刷新页面');
                                    // 可以在这里显示更新提示
                                    showUpdateNotification();
                                }
                            });
                        }
                    });
                    
                    return registration;
                } catch (error) {
                    console.error('PWA: Service Worker 注册失败:', error);
                }
            } else {
                console.log('PWA: 浏览器不支持 Service Worker');
            }
        }

        // PWA 安装提示
        let deferredPrompt;
        function setupPWAInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA: 安装提示事件触发');
                e.preventDefault(); // 阻止默认的安装提示
                deferredPrompt = e;
                showInstallButton();
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA: 应用安装成功');
                hideInstallButton();
                // 显示安装成功消息
                setTimeout(() => {
                    alert('🎉 积分管理系统已成功安装到主屏幕！\n\n您现在可以像使用原生App一样使用它了。');
                }, 1000);
            });
        }

        // 显示安装按钮
        function showInstallButton() {
            // 创建安装按钮
            const installButton = document.createElement('div');
            installButton.id = 'pwa-install-button';
            installButton.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(45deg, #28a745, #20c997);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 25px;
                    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                    cursor: pointer;
                    z-index: 9999;
                    font-size: 14px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    animation: pulse 2s infinite;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <span>📱</span>
                    <span>安装到主屏幕</span>
                    <button onclick="hideInstallButton()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        font-size: 12px;
                        cursor: pointer;
                        margin-left: 8px;
                    ">×</button>
                </div>
                <style>
                    @keyframes pulse {
                        0% { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
                        50% { box-shadow: 0 4px 20px rgba(40, 167, 69, 0.6); }
                        100% { box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
                    }
                </style>
            `;
            
            installButton.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    installPWA();
                }
            });
            
            document.body.appendChild(installButton);
        }

        // 隐藏安装按钮
        function hideInstallButton() {
            const installButton = document.getElementById('pwa-install-button');
            if (installButton) {
                installButton.remove();
            }
        }

        // 安装PWA
        async function installPWA() {
            if (deferredPrompt) {
                console.log('PWA: 显示安装提示');
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                console.log('PWA: 用户选择:', result.outcome);
                
                if (result.outcome === 'accepted') {
                    console.log('PWA: 用户接受安装');
                } else {
                    console.log('PWA: 用户拒绝安装');
                }
                
                deferredPrompt = null;
                hideInstallButton();
            }
        }

        // 显示更新通知
        function showUpdateNotification() {
            const updateNotification = document.createElement('div');
            updateNotification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fff3cd;
                    color: #856404;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    z-index: 9999;
                    border: 1px solid #ffeaa7;
                    text-align: center;
                    min-width: 300px;
                ">
                    <div style="margin-bottom: 10px;">🔄 发现新版本</div>
                    <button onclick="location.reload()" style="
                        background: #856404;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">立即更新</button>
                    <button onclick="this.closest('div').parentElement.remove()" style="
                        background: transparent;
                        color: #856404;
                        border: 1px solid #856404;
                        padding: 8px 16px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">稍后提醒</button>
                </div>
            `;
            document.body.appendChild(updateNotification);
            
            // 10秒后自动隐藏
            setTimeout(() => {
                if (updateNotification.parentNode) {
                    updateNotification.remove();
                }
            }, 10000);
        }

        // Service Worker 消息监听
        function setupServiceWorkerMessages() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', (event) => {
                    console.log('PWA: 收到 Service Worker 消息:', event.data);
                    
                    switch (event.data.type) {
                        case 'APP_INSTALLED':
                            console.log('PWA: 应用安装成功消息');
                            break;
                        case 'BACKGROUND_SYNC':
                            console.log('PWA: 后台同步消息');
                            // 触发数据同步
                            if (isOnline && isFirebaseReady) {
                                autoUploadToFirebase({
                                    bountyData,
                                    bankData,
                                    historyData,
                                    bountyCounter,
                                    dailyTasksContent,
                                    lastUpdated: new Date().toISOString()
                                });
                            }
                            break;
                    }
                });
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication(); // 检查认证状态
            loadData();
            initializePenaltySystem(); // 初始化惩罚系统
            checkWeeklyReset(); // 检查周度重置
            refreshBankPage();
            refreshHistoryPage();
            refreshBountyList();
            refreshDailyTasks(); // 初始化每日任务显示
            refreshExtraTasks(); // 初始化超额任务显示
            updateTaskStats(); // 初始化任务统计显示
            updateTaskPoolPreview(); // 初始化任务池预览
            refreshTaskPoolDisplay(); // 初始化任务池管理显示
            
            // 调试信息
            console.log('页面初始化完成，任务池状态:', taskPool.length, '个任务');
            startDailyCountdownTimer(); // 启动倒计时定时器
            
            // 每分钟检查一次认证状态
            setInterval(checkAuthentication, 60000);
            
            // 每5分钟检查一次悬赏过期
            setInterval(checkBountyExpiry, 5 * 60 * 1000);
            
            // 每分钟检查一次每日任务截止时间
            setInterval(checkDailyTaskDeadline, 60 * 1000);
            
            // 每分钟检查一次周目标结算
            setInterval(autoWeeklyCheck, 60 * 1000);
            
            // 页面加载时立即检查一次
            checkBountyExpiry();
            checkDailyTaskDeadline();
            checkAndApplyPendingPenalties(); // 检查是否有待处理的惩罚
            
            // 多重触发机制 - 确保惩罚100%执行
            document.addEventListener('visibilitychange', function() {
                processSnapshotPenalties(); // 页面隐藏/显示时都检查
            });
            
            // 每隔30秒强制检查一次（更频繁）
            setInterval(() => {
                checkDailyTaskDeadline();
                processSnapshotPenalties();
            }, 30 * 1000);
            
            // 页面关闭前最后检查一次
            window.addEventListener('beforeunload', function() {
                processSnapshotPenalties();
            });
            
            // 初始化 PWA 功能
            registerServiceWorker();
            setupPWAInstallPrompt();
            setupServiceWorkerMessages();
            
            console.log('PWA: 应用初始化完成');
        });

        // Firebase准备就绪后初始化
        window.addEventListener('firebaseReady', function() {
            console.log('Firebase SDK 加载完成');
            initializeFirebase();
            
            // 在移动端延迟一下再尝试同步，确保网络稳定
            if (navigator.userAgent.includes('Mobile')) {
                setTimeout(() => {
                    if (isFirebaseReady && isOnline) {
                        console.log('移动端延迟同步启动');
                        // 检查本地是否有积分池数据，如果有则保护
                        const hasLocalPoints = (pointsPool.qiqi.pending > 0 || pointsPool.yiyi.pending > 0);
                        if (hasLocalPoints) {
                            console.log('🛡️ 移动端检测到本地积分，启用保护模式同步');
                            // 先上传本地数据，再下载
                            const localData = {
                                bountyData,
                                bankData,
                                historyData,
                                penaltyHistory,
                                taskList,
                                taskPool,
                                dailyTasks,
                                pointsPool,
                                weeklyData,
                                monthlyStarBonus,
                                taskRewardSystem,
                                dailyTaskSnapshots,
                                streakResetTracker,
                                lastUpdated: new Date().toISOString()
                            };
                            autoUploadToFirebase(localData);
                        } else {
                            autoDownloadFromFirebase();
                        }
                    }
                }, 2000);
            }
        });

        // 模态框拖拽功能
        function makeDraggable(modalSelector) {
            const modal = document.querySelector(modalSelector);
            const modalBox = modal.querySelector('.modal-box');
            const modalHeader = modal.querySelector('.modal-header');
            
            if (!modalHeader || !modalBox) return;
            
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            
            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                modalBox.style.position = 'fixed';
                modalBox.style.margin = '0';
                
                // 获取当前位置
                const rect = modalBox.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                // 获取起始点击位置
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
                
                modalBox.style.left = initialLeft + 'px';
                modalBox.style.top = initialTop + 'px';
                modalBox.style.transform = 'none';
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', drag, {passive: false});
                document.addEventListener('touchend', stopDrag);
                
                modalBox.style.cursor = 'move';
                document.body.style.userSelect = 'none';
            }
            
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                let clientX, clientY;
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else if (e.type === 'touchmove') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                
                let newLeft = initialLeft + deltaX;
                let newTop = initialTop + deltaY;
                
                // 限制在屏幕范围内
                const maxLeft = window.innerWidth - modalBox.offsetWidth;
                const maxTop = window.innerHeight - modalBox.offsetHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));
                
                modalBox.style.left = newLeft + 'px';
                modalBox.style.top = newTop + 'px';
            }
            
            function stopDrag() {
                isDragging = false;
                modalBox.style.cursor = 'default';
                document.body.style.userSelect = '';
                
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('touchend', stopDrag);
            }
            
            // 绑定事件
            modalHeader.addEventListener('mousedown', startDrag);
            modalHeader.addEventListener('touchstart', startDrag, {passive: false});
        }
        
        // 键盘弹出时的自动调整
        function handleKeyboardResize() {
            const modals = [
                document.getElementById('task-modal'),
                document.getElementById('bounty-modal'),
                document.getElementById('task-manage-modal')
            ];
            
            let originalViewportHeight = window.innerHeight;
            
            function adjustModalPosition() {
                const currentHeight = window.innerHeight;
                const heightDiff = originalViewportHeight - currentHeight;
                
                modals.forEach(modal => {
                    if (modal && modal.style.display === 'flex') {
                        const modalBox = modal.querySelector('.modal-box');
                        if (modalBox) {
                            if (heightDiff > 150) { // 键盘弹出，高度差超过150px
                                modalBox.style.maxHeight = `${currentHeight - 40}px`;
                                modalBox.style.top = '20px';
                                modalBox.style.transform = 'translateX(-50%)';
                                modalBox.style.left = '50%';
                                modalBox.style.position = 'fixed';
                                modalBox.style.overflowY = 'auto';
                            } else { // 键盘收起
                                if (!modalBox.style.left || modalBox.style.left === '50%') {
                                    // 只有当模态框没有被拖拽过才重置位置
                                    modalBox.style.position = 'relative';
                                    modalBox.style.top = '';
                                    modalBox.style.left = '';
                                    modalBox.style.transform = '';
                                }
                                modalBox.style.maxHeight = 'calc(100vh - 80px)';
                            }
                        }
                    }
                });
            }
            
            // 监听视口大小变化
            window.addEventListener('resize', adjustModalPosition);
            
            // 监听orientationchange事件（移动端屏幕旋转）
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    originalViewportHeight = window.innerHeight;
                    adjustModalPosition();
                }, 500);
            });
            
            // 监听focusin和focusout事件
            document.addEventListener('focusin', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    setTimeout(adjustModalPosition, 300);
                }
            });
            
            document.addEventListener('focusout', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    setTimeout(adjustModalPosition, 300);
                }
            });
        }
        
        // 初始化所有模态框的拖拽功能
        document.addEventListener('DOMContentLoaded', function() {
            makeDraggable('#task-modal');
            makeDraggable('#bounty-modal');
            makeDraggable('#task-manage-modal');
            makeDraggable('#password-modal');
            makeDraggable('#user-select-modal');
            makeDraggable('#batch-import-modal');
            makeDraggable('#confirm-input-modal');
            handleKeyboardResize();
            
            // 为密码输入框添加回车键支持
            const passwordInput = document.getElementById('admin-password');
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmPasswordInput();
                }
            });
            
            // 为批量导入文本框添加实时解析功能
            const batchImportTextarea = document.getElementById('batch-import-text');
            if (batchImportTextarea) {
                batchImportTextarea.addEventListener('input', function() {
                    console.log('检测到输入变化');
                    updateBatchPreview();
                });
                batchImportTextarea.addEventListener('paste', function() {
                    console.log('检测到粘贴操作');
                    setTimeout(() => {
                        updateBatchPreview();
                    }, 50);
                });
                console.log('批量导入事件监听器已绑定');
            } else {
                console.error('找不到batch-import-text元素');
            }
            
            // 为确认输入框添加回车键支持
            const confirmInputText = document.getElementById('confirm-input-text');
            confirmInputText.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitConfirmInput();
                }
            });
        });
        
        // 模态框点击外部关闭
        document.getElementById('bounty-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBountyModal();
            }
        });

        document.getElementById('task-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskModal();
            }
        });

        document.getElementById('task-manage-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskManageModal();
            }
        });
        
        document.getElementById('password-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelPasswordInput();
            }
        });
        
        document.getElementById('user-select-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelUserSelect();
            }
        });
        
        document.getElementById('batch-import-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelBatchImport();
            }
        });
        
        document.getElementById('confirm-input-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelConfirmInput();
            }
        });
    </script>
</body>
</html>
